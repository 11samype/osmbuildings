(function(j){function M(n,u){var x=n[0]-u[0],g=n[1]-u[1];return x*x+g*g}function Ma(n){for(var u=0,x=0,g=0,i=n.length-3;g<i;g+=2){u+=n[g];x+=n[g+1]}n=(n.length-2)*2;return[u/n<<0,x/n<<0]}function Na(n){var u=n.length/2,x=new Oa(u),g=0,i=u-1,l,s,p,D,J=[],S=[],K=[];for(x[g]=x[i]=1;i;){s=0;for(l=g+1;l<i;l++){p=n[l*2];var aa=n[l*2+1],X=n[g*2],F=n[g*2+1],ja=n[i*2],Y=n[i*2+1],y=ja-X,q=Y-F,A=void 0;if(y!==0||q!==0){A=((p-X)*y+(aa-F)*q)/(y*y+q*q);if(A>1){X=ja;F=Y}else if(A>0){X+=y*A;F+=q*A}}y=p-X;q=aa-F;
p=y*y+q*q;if(p>s){D=l;s=p}}if(s>2){x[D]=1;J.push(g);S.push(D);J.push(D);S.push(i)}g=J.pop();i=S.pop()}for(l=0;l<u;l++)x[l]&&K.push(n[l*2],n[l*2+1]);return K}var Pa=Pa||Array,Oa=Oa||Array,da=Math,Sa=da.exp,Ta=da.log,Ua=da.sin,Va=da.cos,Ga=da.tan,Wa=da.atan,oa=da.min,Ha=da.max,Aa=j.document,T=function(){function n(g,i,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return g+(i-g)*6*l;if(l<0.5)return i;if(l<2/3)return g+(i-g)*(2/3-l)*6;return g}function u(g,i,l,s){this.r=g;this.g=i;this.b=l;this.a=arguments.length<
4?1:s}var x=u.prototype;x.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};x.adjustLightness=function(g){var i=T.toHSLA(this);i.l*=g;i.l=Math.min(1,Math.max(0,i.l));var l,s;if(i.s===0)g=l=s=i.l;else{s=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var p=2*i.l-s;g=n(p,s,i.h+1/3);l=n(p,s,i.h);s=n(p,s,i.h-1/3)}return new T(g*255<<0,l*255<<0,s*255<<0,i.a)};x.adjustAlpha=function(g){return new T(this.r,this.g,this.b,this.a*g)};u.parse=function(g){g+="";if(~g.indexOf("#")){g=
g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new T(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new T(parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};u.toHSLA=function(g){var i=g.r/255,l=g.g/255,s=g.b/255,p=Math.max(i,l,s),D=Math.min(i,l,s),J,S=(p+D)/2,K;if(p===D)J=D=0;else{K=p-D;D=S>0.5?K/(2-p-D):K/(p+D);switch(p){case i:J=(l-s)/K+(l<s?6:0);break;case l:J=
(s-i)/K+2;break;case s:J=(i-l)/K+4;break}J/=6}return{h:J,s:D,l:S,a:g.a}};return u}(),Xa=function(){var n=Math,u=n.sin,x=n.cos,g=n.tan,i=n.asin,l=n.atan2,s=n.PI,p=180/s,D=357.5291/p,J=0.98560028/p,S=1.9148/p,K=0.02/p,aa=3.0E-4/p,X=102.9372/p,F=23.45/p,ja=280.16/p,Y=360.9856235/p;return function(y,q,A){A=-A/p;q=q/p;y=y.valueOf()/864E5-0.5+2440588;var N=D+J*(y-2451545),G=S*u(N)+K*u(2*N)+aa*u(3*N);G=N+X+G+s;N=i(u(G)*u(F));G=l(u(G)*x(F),x(G));A=ja+Y*(y-2451545)-A-G;return{altitude:i(u(q)*u(N)+x(q)*x(N)*
x(A)),azimuth:l(u(A),x(A)*u(q)-g(N)*x(q))-s/2}}}(),pa=Math.PI,Qa=pa/2,Ya=pa/4,Za=180/pa,$a=256,Ia=14,qa="latitude",ra="longitude",I=0,O=1,R=2,ea=3,Ba=4,ka=5,U=6;j.OSMBuildings=function(n){function u(a){var d=Aa.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering="optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;a.appendChild(d);a=d.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=false}catch(c){}return d}
function x(a,d){var c={};a/=sa;d/=sa;c[qa]=d<=0?90:d>=1?-90:Za*(2*Wa(Sa(pa*(1-2*d)))-Qa);c[ra]=(a===1?1:(a%1+1)%1)*360-180;return c}function g(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(c,b){return d[b]})}function i(a,d,c,b,h){a=oa(Ha(a,d),c);return oa(Ha(b+(a-d)/(c-d)*(h-b),b),h)}function l(a,d){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState===4)!c.status||c.status<200||c.status>299||c.responseText&&d(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}
function s(){if(!(!Ja||P<Ia)){var a=x(G-A,ba-N),d=x(G+y+A,ba+q+N);Ca&&Ca.abort();Ca=l(g(Ja,{w:a[ra],n:a[qa],e:d[ra],s:d[qa],z:P}),p)}}function p(a){var d,c,b,h=[],e,f=e=0;ma=Ia;aa(P);Ca=null;if(!(!a||a.meta.z!==P)){b=a.meta;c=a.data;if(B&&z&&B.z===b.z){e=B.x-b.x;f=B.y-b.y;a=0;for(d=z.length;a<d;a++)h[a]=z[a][R][0]+e+","+(z[a][R][1]+f)}B=b;z=[];a=0;for(d=c.length;a<d;a++){b=[];if(!(c[a][O]>ta)){e=Na(c[a][R]);if(!(e.length<8)){b[R]=e;b[Ba]=Ma(e);b[I]=oa(c[a][I],ta);b[O]=c[a][O];e=b[R][0]+","+b[R][1];
b[ka]=!(h&&~h.indexOf(e));b[ea]=[];b[U]=[];z.push(b)}}}X()}}function D(a,d){var c=[],b,h,e,f,m,k,v,H,C,r=Ka-P;b=0;for(h=a.length;b<h;b++){m=a[b];H=m[O]>>r;if(!(H>ta)){k=m[R];C=new Pa(k.length);e=0;for(f=k.length-1;e<f;e+=2){v=k[e+1];var o=oa(1,Ha(0,0.5-Ta(Ga(Ya+Qa*k[e]/180))/pa/2));v={x:(v/360+0.5)*sa<<0,y:o*sa<<0};C[e]=v.x;C[e+1]=v.y}C=Na(C);if(!(C.length<8)){f=[];f[R]=C;f[Ba]=Ma(C);f[I]=oa(m[I]>>r,ta);f[O]=H;f[ka]=d;f[ea]=m[ea];f[U]=[];for(e=0;e<3;e++)if(f[ea][e])f[U][e]=f[ea][e].adjustAlpha(V)+
"";c.push(f)}}}return c}function J(a,d){if(typeof a==="object")K(a,!d);else{var c=Aa.documentElement,b=Aa.createElement("script");j.jsonpCallback=function(h){delete j.jsonpCallback;c.removeChild(b);K(h,!d)};c.insertBefore(b,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function S(a,d,c){if(c===undefined)c=[];var b,h,e,f=a[0]?a:a.features,m,k,v,H,C,r=d?1:0,o=d?0:1;if(f){b=0;for(a=f.length;b<a;b++)S(f[b],d,c);return c}if(a.type==="Feature"){m=a.geometry;b=a.properties}if(m.type==="Polygon")k=
[m.coordinates];if(m.type==="MultiPolygon")k=m.coordinates;if(k){d=b.height;if(b.color||b.wallColor)H=T.parse(b.color||b.wallColor);if(b.roofColor)C=T.parse(b.roofColor);b=0;for(a=k.length;b<a;b++){f=k[b][0];v=[];h=m=0;for(e=f.length;h<e;h++){v.push(f[h][r],f[h][o]);m+=d||f[h][2]||0}if(m){h=[];e=R;var t=void 0,w=void 0,E=void 0,Z=void 0,ca=0,Q=void 0,Ra=void 0;Q=0;for(Ra=v.length-3;Q<Ra;Q+=2){t=v[Q];w=v[Q+1];E=v[Q+2];Z=v[Q+3];ca+=t*Z-E*w}if((ca/2>0?"CW":"CCW")==="CW")v=v;else{t=[];for(w=v.length-
2;w>=0;w-=2)t.push(v[w],v[w+1]);v=t}h[e]=v;h[I]=m/f.length<<0;h[ea]=[H||null,H?H.adjustLightness(0.8):null,C?C:H?H.adjustLightness(1.2):la];c.push(h)}}}return c}function K(a,d){if(a){ua=S(a,d);ma=0;aa(P);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:P};z=D(ua,true);X()}else{ua=null;F()}}function aa(a){var d,c,b;P=a;sa=$a<<P;V=1-i(P,ma,Ka,0,0.4);Da=fa.adjustAlpha(V)+"";va=Ea.adjustAlpha(V)+"";wa=la.adjustAlpha(V)+"";ga.setAlpha(V);if(z){a=0;for(d=z.length;a<d;a++){b=z[a];b[U]=[];for(c=0;c<3;c++)if(b[ea][c])b[U][c]=
b[ea][c].adjustAlpha(V)+""}}}function X(){clearInterval(La);ha=0;La=setInterval(function(){ha+=0.1;if(ha>1){clearInterval(La);ha=1;for(var a=0,d=z.length;a<d;a++)z[a][ka]=0}ga.render();F()},33)}function F(){W.clearRect(0,0,y,q);na.render();if(!(!B||!z||P<ma||xa)){var a,d,c,b,h,e,f,m,k,v=G-B.x,H=ba-B.y,C=[ya+v,za+H],r,o,t,w,E,Z;z.sort(function(ca,Q){return M(Q[Ba],C)/Q[I]-M(ca[Ba],C)/ca[I]});a=0;for(d=z.length;a<d;a++){h=z[a];if(!(h[I]<=na.maxHeight)){o=false;e=h[R];r=[];c=0;for(b=e.length-1;c<b;c+=
2){r[c]=m=e[c]-v;r[c+1]=k=e[c+1]-H;o||(o=m>0&&m<y&&k>0&&k<q)}if(o){c=h[ka]?h[I]*ha:h[I];e=ia/(ia-c);if(h[O]){c=h[ka]?h[O]*ha:h[O];f=ia/(ia-c)}m=[];c=0;for(b=r.length-3;c<b;c+=2){k=r[c];t=r[c+1];o=r[c+2];w=r[c+3];E=Y(k,t,e);Z=Y(o,w,e);if(h[O]){t=Y(k,t,f);w=Y(o,w,f);k=t.x;t=t.y;o=w.x;w=w.y}if((o-k)*(E.y-t)>(E.x-k)*(w-t)){W.fillStyle=k<o&&t<w||k>o&&t>w?h[U][1]||va:h[U][0]||Da;ja([o,w,k,t,E.x,E.y,Z.x,Z.y])}m[c]=E.x;m[c+1]=E.y}W.fillStyle=h[U][2]||wa;W.strokeStyle=h[U][1]||va;ja(m,true)}}}}}function ja(a,
d){if(a.length){W.beginPath();W.moveTo(a[0],a[1]);for(var c=2,b=a.length;c<b;c+=2)W.lineTo(a[c],a[c+1]);W.closePath();d&&W.stroke();W.fill()}}function Y(a,d,c){return{x:(a-ya)*c+ya<<0,y:(d-za)*c+za<<0}}var y=0,q=0,A=0,N=0,G=0,ba=0,P,sa,Ca,$,Fa,W,Ja,fa=new T(200,190,180),Ea=fa.adjustLightness(0.8),la=fa.adjustLightness(1.2),Da=fa+"",va=Ea+"",wa=la+"",ua,B,z,ha=1,La,V=1,ma=Ia,Ka=20,ta,ya,za,ia,xa,ga={enabled:true,canvas:null,context:null,color:new T(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,
directionY:0,init:function(a){this.canvas=u(a);this.context=this.canvas.getContext("2d")},render:function(){var a=this.context;a.clearRect(0,0,y,q);if(!(!this.enabled||!B||!z||P<ma||xa||!this.length)){var d,c,b,h,e,f,m,k,v=G-B.x,H=ba-B.y,C=na.maxHeight,r,o,t,w,E,Z,ca=[],Q=[];a.beginPath();d=0;for(c=z.length;d<c;d++){e=z[d];o=false;f=e[R];r=[];b=0;for(h=f.length-1;b<h;b+=2){r[b]=m=f[b]-v;r[b+1]=k=f[b+1]-H;o||(o=m>0&&m<y&&k>0&&k<q)}if(o){f=e[ka]&&e[I]>C?e[I]*ha:e[I];if(e[O])f=e[ka]?e[O]*ha:e[O];m=null;
b=0;for(h=r.length-3;b<h;b+=2){k=r[b];t=r[b+1];o=r[b+2];w=r[b+3];E=this.project(k,t,f);Z=this.project(o,w,f);if(e[O]){t=this.project(k,t,f);w=this.project(o,w,f);k=t.x;t=t.y;o=w.x;w=w.y}if((o-k)*(E.y-t)>(E.x-k)*(w-t)){m===1&&a.lineTo(k,t);m=0;b||a.moveTo(k,t);a.lineTo(o,w)}else{m===0&&a.lineTo(E.x,E.y);m=1;b||a.moveTo(E.x,E.y);a.lineTo(Z.x,Z.y)}}a.closePath();e[I]>C?ca.push(r):Q.push(r)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=ca.length;d<
c;d++){e=ca[d];a.moveTo(e[0],e[1]);b=2;for(h=e.length;b<h;b+=2)a.lineTo(e[b],e[b+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over";na.renderWalls(a,Q)}},project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=x(G+A,ba+N);a=Xa(a,d.latitude,d.longitude);if(a.altitude<=
0){this.length=0;this.alpha=i(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Ga(a.altitude);this.alpha=0.4/this.length;this.directionX=Va(a.azimuth)*this.length;this.directionY=Ua(a.azimuth)*this.length}this.color.a=this.alpha;this.colorStr=this.color+"";this.render()},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d}},na={enabled:true,canvas:null,context:null,maxHeight:8,init:function(a){this.canvas=u(a);this.canvas.id="flat";this.context=this.canvas.getContext("2d")},render:function(){var a=
this.context;a.clearRect(0,0,y,q);if(!(!this.enabled||!B||!z||P<ma||xa)){var d,c,b,h,e,f,m,k,v,H=G-B.x,C=ba-B.y,r,o;m=ia/(ia-this.maxHeight);a.beginPath();d=0;for(c=z.length;d<c;d++){e=z[d];if(!(e[I]>this.maxHeight)){o=false;f=e[R];r=[];b=0;for(h=f.length-1;b<h;b+=2){r[b]=k=f[b]-H;r[b+1]=v=f[b+1]-C;o||(o=k>0&&k<y&&v>0&&v<q)}if(o){b=0;for(h=r.length-3;b<h;b+=2){f=r[b];k=r[b+1];f=Y(f,k,m);b?a.lineTo(f.x,f.y):a.moveTo(f.x,f.y)}a.closePath()}}}a.fillStyle=e[U][2]||wa;a.strokeStyle=e[U][1]||va;a.stroke();
a.fill()}},renderWalls:function(a,d){if(this.enabled){var c,b,h,e,f;a.beginPath();b=0;for(h=d.length;b<h;b++){c=d[b];a.moveTo(c[0],c[1]);e=2;for(f=c.length;e<f;e+=2)a.lineTo(c[e],c[e+1]);a.lineTo(c[0],c[1]);a.closePath()}a.fillStyle=Da;a.fill()}},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){fa=T.parse(a.color||a.wallColor);Da=fa.adjustAlpha(V)+"";Ea=fa.adjustLightness(0.8);va=Ea.adjustAlpha(V)+"";la=fa.adjustLightness(1.2);
wa=la.adjustAlpha(V)+""}if(a.roofColor){la=T.parse(a.roofColor);wa=la.adjustAlpha(V)+""}a.shadows!==undefined&&ga.setEnabled(a.shadows);F();return this};this.geoJSON=function(a,d){J(a,d);return this};this.setCamOffset=function(a,d){ya=A+a;za=q+d};this.setMaxZoom=function(a){Ka=a};this.setDate=function(a){ga.setDate(a);return this};this.appendTo=function(a){$=Aa.createElement("DIV");$.style.pointerEvents="none";$.style.position="absolute";$.style.left=0;$.style.top=0;ga.init($);na.init($);Fa=u($);
W=Fa.getContext("2d");a.appendChild($);return $};this.loadData=s;this.onMoveEnd=function(){var a=x(G,ba),d=x(G+y,ba+q);ga.render();F();if(B&&(a[qa]>B.n||a[ra]<B.w||d[qa]<B.s||d[ra]>B.e))s()};this.onZoomEnd=function(a){xa=false;aa(a.zoom);if(ua){z=D(ua);F()}else{F();s()}};this.onZoomStart=function(){xa=true;ga.render();F()};this.setOrigin=function(a,d){G=a;ba=d};this.setSize=function(a,d){y=a;q=d;A=y/2<<0;N=q/2<<0;ya=A;za=q;ia=y/1.5/Ga(45)<<0;ga.setSize(y,q);na.setSize(y,q);Fa.width=y;Fa.height=q;
ta=ia-50};this.setZoom=aa;this.render=F;Ja=n};j.OSMBuildings.VERSION="0.1.8a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),M=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.container.style.left=-j.x+
"px";this.container.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(M.x-j.x,M.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),M=this.map.getPixelOrigin();this.osmb.setOrigin(M.x-j.x,M.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=
j;j=this.map._panes.overlayPane;if(this.osmb)j.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(j);this.osmb.maxZoom=this.map._layersMaxZoom}j=L.DomUtil.getPosition(this.map._mapPane);var M=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(M.x-j.x,M.y-j.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-j.x+"px";this.container.style.top=-j.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(j,M){return this.osmb.geoJSON(j,M)},setStyle:function(j){return this.osmb.setStyle(j)},
setDate:function(j){return this.osmb.setDate(j)}});
