var OSMBuildings=function(){function c(d,b){var a=d[0]-b[0],k=d[1]-b[1];return a*a+k*k}function m(d){for(var b=0,a=0,k=0,c=d.length-3;k<c;k+=2)b+=d[k],a+=d[k+1];d=2*(d.length-2);return[b/d<<0,a/d<<0]}function ua(d){var b,a,k,c,f=0,g,t;g=0;for(t=d.length-3;g<t;g+=2)b=d[g],a=d[g+1],k=d[g+2],c=d[g+3],f+=b*c-k*a;if("CW"===(0<f/2?"CW":"CCW"))return d;b=[];for(a=d.length-2;0<=a;a-=2)b.push(d[a],d[a+1]);return b}var la=la||Array,ma=ma||Array,f=Math,va=f.exp,wa=f.log,xa=f.sin,ya=f.cos,ia=f.tan,za=f.atan,
Q=f.min,T=f.max,ea=document,J,U=function(d){var b,a,k;if(0===d.s)b=a=k=d.l;else{k=0.5>d.l?d.l*(1+d.s):d.l+d.s-d.l*d.s;var c=2*d.l-k;d.h/=360;b=K(c,k,d.h+1/3);a=K(c,k,d.h);k=K(c,k,d.h-1/3)}return new w(255*b<<0,255*a<<0,255*k<<0,d.a)},K=function(d,b,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?d+6*(b-d)*a:0.5>a?b:a<2/3?d+6*(b-d)*(2/3-a):d},w=function(d,b,a,c){this.r=d;this.g=b;this.b=a;this.a=4>arguments.length?1:c},f=w.prototype;f.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};f.adjustLightness=function(d){var b=w.toHSLA(this);b.l*=d;b.l=Math.min(1,Math.max(0,b.l));return U(b)};f.adjustAlpha=function(d){return new w(this.r,this.g,this.b,this.a*d)};w.parse=function(d){var b;d+="";if(~d.indexOf("#"))return b=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),new w(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new w(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),
b[4]?parseFloat(b[5]):1);if(b=d.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return U({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};w.toHSLA=function(d){var b=d.r/255,a=d.g/255,c=d.b/255,P=Math.max(b,a,c),f=Math.min(b,a,c),g,t=(P+f)/2,A;if(P===f)g=f=0;else{A=P-f;f=0.5<t?A/(2-P-f):A/(P+f);switch(P){case b:g=(a-c)/A+(a<c?6:0);break;case a:g=(c-b)/A+2;break;case c:g=(b-a)/A+4}g/=6}return{h:360*g,s:f,l:t,a:d.a}};J=w;var na,f=Math,x=f.sin,F=f.cos,
Aa=f.tan,oa=f.asin,pa=f.atan2,M=f.PI,h=180/M,Ba=357.5291/h,Ca=0.98560028/h,Da=1.9148/h,Ea=0.02/h,Fa=3E-4/h,Ga=102.9372/h,qa=23.45/h,Ha=280.16/h,Ia=360.9856235/h;na=function(d,b,a){a=-a/h;b/=h;d=d.valueOf()/864E5-0.5+2440588;var c=Ba+Ca*(d-2451545),f=Da*x(c)+Ea*x(2*c)+Fa*x(3*c),f=c+Ga+f+M,c=oa(x(f)*x(qa)),f=pa(x(f)*F(qa),F(f));a=Ha+Ia*(d-2451545)-a-f;return{altitude:oa(x(b)*x(c)+F(b)*F(c)*F(a)),azimuth:pa(x(a),F(a)*x(b)-Aa(c)*F(b))-M/2}};var ra=function(d,b){var a,c;void 0===b&&(b=[]);var f=d[0]?d:
d.features;if(f){a=0;for(c=f.length;a<c;a++)ra(f[a],b);return b}if("Feature"!==d.type)return b;a=d.geometry;var f=d.properties,m;"Polygon"===a.type&&(m=[a.coordinates]);"MultiPolygon"===a.type&&(m=a.coordinates);if(!m)return b;var g,t;if(f.color||f.wallColor)a=f.color||f.wallColor,g=J.parse(materialColors[a]||a);f.roofColor&&(a=f.roofColor,t=J.parse(materialColors[a]||a));var A=f.height,h,D,E,y,x;a=0;for(c=m.length;a<c;a++){h=m[a][0];D=[];y=E=0;for(x=h.length;y<x;y++)D.push(h[y][1],h[y][0]),E+=A||
h[y][2]||0;E&&b.push({id:f.id||D[0]+","+D[1],footprint:ua(D),height:E/h.length<<0||Ja,minHeight:f.minHeight,wallColor:g,altColor:g&&g.adjustLightness(0.8),roofColor:t})}return b},V=Math.PI,sa=V/2,Ka=V/4,La=180/V,Ma=256,W="latitude",X="longitude",Ja=5,f=function(){function d(e,l){var q={};e/=F;l/=F;q[W]=0>=l?90:1<=l?-90:La*(2*za(va(V*(1-2*l)))-sa);q[X]=360*(1===e?1:(e%1+1)%1)-180;return q}function b(e){y=e;F=Ma<<y;e=y;var l=fa,q=ja;e=Q(T(e,l),q);G=1-Q(T(0+0.3*((e-l)/(q-l)),0),0.3);K=I.adjustAlpha(G)+
"";Y=ga.adjustAlpha(G)+"";Z=R.adjustAlpha(G)+"";C.scale(y)}function a(){$.render();ha.render();f()}function f(){n.clearRect(0,0,g,t);if(!(y<fa||aa)){var e,l,q,d,a,b,ba,N,j,B=D,u=E,s=ha.getMaxHeight(),k=[ca+B,da+u],z,p,r,v,O,m;C.rendering.sort(function(e,l){return c(l.center,k)/l.height-c(e.center,k)/e.height});e=0;for(l=C.rendering.length;e<l;e++)if(a=C.rendering[e],!(a.height<=s)){p=!1;b=a.footprint;z=[];q=0;for(d=b.length-1;q<d;q+=2)z[q]=N=b[q]-B,z[q+1]=j=b[q+1]-u,p||(p=0<N&&N<g&&0<j&&j<t);if(p){q=
a.isNew?a.height*H:a.height;b=S/(S-q);a.minHeight&&(q=a.isNew?a.minHeight*H:a.minHeight,ba=S/(S-q));N=[];q=0;for(d=z.length-3;q<d;q+=2)j=z[q],r=z[q+1],p=z[q+2],v=z[q+3],O=x(j,r,b),m=x(p,v,b),a.minHeight&&(r=x(j,r,ba),v=x(p,v,ba),j=r.x,r=r.y,p=v.x,v=v.y),(p-j)*(O.y-r)>(O.x-j)*(v-r)&&(n.fillStyle=j<p&&r<v||j>p&&r>v?a.altColor||Y:a.wallColor||K,h([p,v,j,r,O.x,O.y,m.x,m.y])),N[q]=O.x,N[q+1]=O.y;n.fillStyle=a.roofColor||Z;n.strokeStyle=a.altColor||Y;h(N,!0)}}}}function h(e,l){if(e.length){n.beginPath();
n.moveTo(e[0],e[1]);for(var a=2,d=e.length;a<d;a+=2)n.lineTo(e[a],e[a+1]);n.closePath();l&&n.stroke();n.fill()}}function x(e,l,a){return{x:(e-ca)*a+ca<<0,y:(l-da)*a+da<<0}}var g=0,t=0,A=0,w=0,D=0,E=0,y,F,n,I=new J(200,190,180),ga=I.adjustLightness(0.8),R=I.adjustLightness(1.2),K=I+"",Y=ga+"",Z=R+"",H=1,M,G=1,fa=14,ja=20,ka,ca,da,S,aa,U={container:null,items:[],init:function(e){var l=this.container=ea.createElement("DIV");l.style.pointerEvents="none";l.style.position="absolute";l.style.left=0;l.style.top=
0;$.init(this.create());ha.init(this.create());n=this.create();e.appendChild(l);return l},create:function(){var e=ea.createElement("CANVAS");e.style.webkitTransform="translate3d(0,0,0)";e.style.imageRendering="optimizeSpeed";e.style.position="absolute";e.style.left=0;e.style.top=0;var l=e.getContext("2d");l.lineCap="round";l.lineJoin="round";l.lineWidth=1;l.mozImageSmoothingEnabled=!1;l.webkitImageSmoothingEnabled=!1;this.items.push(e);this.container.appendChild(e);return l},setSize:function(e,l){for(var a=
this.items,d=0,b=a.length;d<b;d++)a[d].width=e,a[d].height=l}},C={url:"",type:"",raw:[],rendering:[],init:function(){},load:function(e,a){this.url=e;this.type=a;this.update()},update:function(){if(this.url&&!(14>y)){var e=d(D-A,E-w),a=d(D+g+A,E+t+w),b={w:e[X],n:e[W],e:a[X],s:a[W]},e=this.url.replace(/\{ *([\w_]+) *\}/g,function(e,a){return b[a]||e}),c=function(e){this.set(e,this.type)}.bind(this),f=ea.documentElement,ta=ea.createElement("script");window.jsonpCallback=function(e){delete window.jsonpCallback;
f.removeChild(ta);c(e)};f.insertBefore(ta,f.lastChild).src=e.replace(/\{callback\}/,"jsonpCallback")}},set:function(e){if(e){var a,d,b=this.raw,c={};a=0;for(d=b.length;a<d;a++)c[b[a].id]=1;b=this.raw=ra(e);this.n=-90;this.w=180;this.s=90;this.e=-180;a=0;for(d=b.length;a<d;a++){b[a].isNew=!c[b[a].id];e=b[a].footprint;for(var g=0,ba=e.length-1;g<ba;g+=2)this.n=T(e[g],this.n),this.e=T(e[g+1],this.e),this.s=Q(e[g],this.s),this.w=Q(e[g+1],this.w)}this.scale(y);clearInterval(M);H=0;ha.render();M=setInterval(function(){H+=
0.1;if(1<H){clearInterval(M);H=1;for(var e=0,a=C.rendering.length;e<a;e++)C.rendering[e].isNew=0}$.render();f()},33)}},scale:function(e){var a,d,b,c,f,g=this.raw,k=[],j,B,u,s,t=ja-e;e=0;for(b=g.length;e<b;e++)if(j=g[e],u=j.minHeight>>t,!(u>ka)){B=j.footprint;s=new la(B.length);c=0;for(f=B.length-1;c<f;c+=2)a=B[c+1],d=Q(1,T(0,0.5-wa(ia(Ka+sa*B[c]/180))/V/2)),a=(a/360+0.5)*F<<0,d=d*F<<0,s[c]=a,s[c+1]=d;c=s;f=c.length/2;B=new ma(f);s=0;a=f-1;var z=d=void 0,p=void 0,r=void 0,v=[],h=[],x=[];for(B[s]=B[a]=
1;a;){z=0;for(d=s+1;d<a;d++){var p=c[2*d],C=c[2*d+1],y=c[2*s],A=c[2*s+1],D=c[2*a],E=c[2*a+1],w=D-y,n=E-A,H=void 0;if(0!==w||0!==n)H=((p-y)*w+(C-A)*n)/(w*w+n*n),1<H?(y=D,A=E):0<H&&(y+=w*H,A+=n*H);w=p-y;n=C-A;p=w*w+n*n;p>z&&(r=d,z=p)}2<z&&(B[r]=1,v.push(s),h.push(r),v.push(r),h.push(a));s=v.pop();a=h.pop()}for(d=0;d<f;d++)B[d]&&x.push(c[2*d],c[2*d+1]);s=x;8>s.length||k.push({footprint:s,height:Q(j.height>>t,ka),minHeight:u,wallColor:j.wallColor&&j.wallColor.adjustAlpha(G)+"",altColor:j.wallColor&&j.altColor.adjustAlpha(G)+
"",roofColor:j.roofColor&&j.roofColor.adjustAlpha(G)+"",center:m(s),isNew:j.isNew})}this.rendering=k}},$={enabled:!0,context:null,color:new J(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(e){this.context=e;this.setDate((new Date).setHours(10))},setEnabled:function(e){this.enabled=!!e},render:function(){var e=this.context,a,c,b,f;e.clearRect(0,0,g,t);if(this.enabled&&!(y<fa||aa))if(a=d(D+A,E+w),a=na(this.date,a.latitude,a.longitude),!(0>=a.altitude)){c=
1/ia(a.altitude);b=0.4/c;this.directionX=ya(a.azimuth)*c;this.directionY=xa(a.azimuth)*c;this.color.a=b;f=this.color+"";var k,h,m,j,B,u,s=D,x=E,z,p,r,v,n,F,G=[];e.beginPath();a=0;for(c=C.rendering.length;a<c;a++){h=C.rendering[a];p=!1;m=h.footprint;z=[];b=0;for(k=m.length-1;b<k;b+=2)z[b]=B=m[b]-s,z[b+1]=u=m[b+1]-x,p||(p=0<B&&B<g&&0<u&&u<t);if(p){m=h.isNew?h.height*H:h.height;h.minHeight&&(j=h.isNew?h.minHeight*H:h.minHeight);B=null;b=0;for(k=z.length-3;b<k;b+=2)u=z[b],r=z[b+1],p=z[b+2],v=z[b+3],n=
this.project(u,r,m),F=this.project(p,v,m),h.minHeight&&(r=this.project(u,r,j),v=this.project(p,v,j),u=r.x,r=r.y,p=v.x,v=v.y),(p-u)*(n.y-r)>(n.x-u)*(v-r)?(1===B&&e.lineTo(u,r),B=0,b||e.moveTo(u,r),e.lineTo(p,v)):(0===B&&e.lineTo(n.x,n.y),B=1,b||e.moveTo(n.x,n.y),e.lineTo(F.x,F.y));e.closePath();G.push(z)}}e.fillStyle=f;e.fill();e.globalCompositeOperation="destination-out";e.beginPath();a=0;for(c=G.length;a<c;a++){j=G[a];e.moveTo(j[0],j[1]);b=2;for(k=j.length;b<k;b+=2)e.lineTo(j[b],j[b+1]);e.lineTo(j[0],
j[1]);e.closePath()}e.fillStyle="#00ff00";e.fill();e.globalCompositeOperation="source-over"}},project:function(a,b,d){return{x:a+this.directionX*d,y:b+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},ha={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,g,t);if(!(y<fa||aa)){var b,d,c,f,h,k,m,j=D,n=E,u,s;a.beginPath();b=0;for(d=C.rendering.length;b<d;b++){c=C.rendering[b];s=!1;h=c.footprint;u=[];c=0;for(f=h.length-1;c<
f;c+=2)u[c]=k=h[c]-j,u[c+1]=m=h[c+1]-n,s||(s=0<k&&k<g&&0<m&&m<t);if(s){c=0;for(f=u.length-3;c<f;c+=2)s=u[c],h=u[c+1],c?a.lineTo(s,h):a.moveTo(s,h);a.closePath()}}a.fillStyle=Z;a.strokeStyle=Y;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(b){b=b||{};if(b.color||b.wallColor)I=J.parse(b.color||b.wallColor),K=I.adjustAlpha(G)+"",ga=I.adjustLightness(0.8),Y=ga.adjustAlpha(G)+"",R=I.adjustLightness(1.2),Z=R.adjustAlpha(G)+"";b.roofColor&&(R=J.parse(b.roofColor),
Z=R.adjustAlpha(G)+"");void 0!==b.shadows&&$.setEnabled(b.shadows);a();return this};this.setCamOffset=function(a,b){ca=A+a;da=t+b};this.setMaxZoom=function(a){ja=a};this.setDate=function(a){$.setDate(a);return this};this.appendTo=function(a){return U.init(a)};this.loadData=function(a,b){C.load(a,b);return this};this.setData=function(a,b){C.set(a,b);return this};this.onMoveEnd=function(){var b=d(D,E),c=d(D+g,E+t);a();(b[W]>C.n||b[X]<C.w||c[W]<C.s||c[X]>C.e)&&C.update()};this.onZoomEnd=function(c){aa=
!1;b(c.zoom);C.update();a()};this.onZoomStart=function(){aa=!0;a()};this.setOrigin=function(a,b){D=a;E=b};this.setSize=function(a,b){g=a;t=b;A=g/2<<0;w=t/2<<0;ca=A;da=t;S=g/(1.5/(window.devicePixelRatio||1))/ia(45)<<0;U.setSize(g,t);ka=S-50};this.setZoom=b;this.render=f};f.VERSION="0.1.8a";f.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';f.OSM_XAPI_URL=OSM_XAPI_URL;return f}();
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(c){L.Util.setOptions(this,c)},onMove:function(){var c=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-c.x,this.lastY-c.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var c=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.lastX=c.x;this.lastY=c.y;this.container.style.left=-c.x+"px";
this.container.style.top=-c.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-c.x,m.y-c.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var c=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.osmb.setOrigin(m.x-c.x,m.y-c.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(c){c.addLayer(this);return this},onAdd:function(c){this.map=c;
c=this.map._panes.overlayPane;this.osmb?c.appendChild(this.container):(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(c),this.osmb.maxZoom=this.map._layersMaxZoom);c=L.DomUtil.getPosition(this.map._mapPane);var m=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-c.x,m.y-c.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-c.x+"px";this.container.style.top=-c.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.render()},onRemove:function(c){c.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);c.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(c){return this.osmb.geoJSON(c)},setStyle:function(c){return this.osmb.setStyle(c)},setDate:function(c){return this.osmb.setDate(c)},
load:function(c,m){this.osmb.loadData(c,m)}});
