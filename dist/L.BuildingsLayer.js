<<<<<<< HEAD
(function(g){function D(l,r){var w=l[0]-r[0],d=l[1]-r[1];return w*w+d*d}function Da(l){for(var r=0,w=0,d=0,f=l.length-3;d<f;d+=2){r+=l[d];w+=l[d+1]}l=(l.length-2)*2;return[r/l<<0,w/l<<0]}function Ea(l){var r=l.length/2,w=new Fa(r),d=0,f=r-1,h,m,s,x,E=[],K=[],F=[];for(w[d]=w[f]=1;f;){m=0;for(h=d+1;h<f;h++){s=l[h*2];var M=l[h*2+1],X=l[d*2],O=l[d*2+1],P=l[f*2],G=l[f*2+1],z=P-X,H=G-O,I=void 0;if(z!==0||H!==0){I=((s-X)*z+(M-O)*H)/(z*z+H*H);if(I>1){X=P;O=G}else if(I>0){X+=z*I;O+=H*I}}z=s-X;H=M-O;s=z*z+
H*H;if(s>m){x=h;m=s}}if(m>7){w[x]=1;E.push(d);K.push(x);E.push(x);K.push(f)}d=E.pop();f=K.pop()}for(h=0;h<r;h++)w[h]&&F.push(l[h*2],l[h*2+1]);return F}var Ga=Ga||Array,Fa=Fa||Array,Ka=Math.exp,La=Math.log,Ma=Math.tan,Na=Math.atan,va=Math.min,Oa=Math.max,wa=g.document,Q=function(){function l(d,f,h){if(h<0)h+=1;if(h>1)h-=1;if(h<1/6)return d+(f-d)*6*h;if(h<0.5)return f;if(h<2/3)return d+(f-d)*(2/3-h)*6;return d}function r(d,f,h,m){this.r=d;this.g=f;this.b=h;this.a=arguments.length<4?1:m}var w=r.prototype;
w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(d){var f=Q.toHSLA(this);f.l*=d;f.l=Math.min(1,Math.max(0,f.l));var h,m;if(f.s===0)d=h=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var s=2*f.l-m;d=l(s,m,f.h+1/3);h=l(s,m,f.h);m=l(s,m,f.h-1/3)}return new Q(d*255<<0,h*255<<0,m*255<<0,f.a)};w.adjustAlpha=function(d){return new Q(this.r,this.g,this.b,this.a*d)};r.parse=function(d){d+="";if(~d.indexOf("#")){d=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);
return new Q(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16),d[4]?parseInt(d[4],16)/255:1)}if(d=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5],10):1)};r.toHSLA=function(d){var f=d.r/255,h=d.g/255,m=d.b/255,s=Math.max(f,h,m),x=Math.min(f,h,m),E,K=(s+x)/2,F;if(s===x)E=x=0;else{F=s-x;x=K>0.5?F/(2-s-x):F/(s+x);switch(s){case f:E=(h-m)/F+(h<m?6:0);break;case h:E=(m-f)/F+2;break;case m:E=(f-h)/F+4;break}E/=
6}return{h:E,s:x,l:K,a:d.a}};return r}(),fa=Math.PI,Ha=fa/2,Pa=fa/4,Qa=180/fa,Ra=256,xa=14,ga=400,Ia=ga-50,ha="latitude",ia="longitude",V=0,Y=1,R=2,Z=3,qa=4,ja=5,W=6;g.OSMBuildings=function(l){function r(a,e){var b={};a/=ka;e/=ka;b[ha]=e<=0?90:e>=1?-90:Qa*(2*Na(Ka(fa*(1-2*e)))-Ha);b[ia]=(a===1?1:(a%1+1)%1)*360-180;return b}function w(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return e[c]})}function d(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||
b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!ya||N<xa)){var a=r(I-z,da-H),e=r(I+P+z,da+G+H);ra&&ra.abort();ra=d(w(ya,{w:a[ia],n:a[ha],e:e[ia],s:e[ha],z:N}),h)}}function h(a){var e,b,c,j=[],i,k=i=0;la=xa;K(N);ra=null;if(!(!a||a.meta.z!==N)){c=a.meta;b=a.data;if(A&&v&&A.z===c.z){i=A.x-c.x;k=A.y-c.y;a=0;for(e=v.length;a<e;a++)j[a]=v[a][R][0]+i+","+(v[a][R][1]+k)}A=c;v=[];a=0;for(e=b.length;a<e;a++){c=[];i=Ea(b[a][R]);
if(!(i.length<8)){c[R]=i;c[qa]=Da(i);c[V]=va(b[a][V],Ia);c[Y]=b[a][Y];i=c[R][0]+","+c[R][1];c[ja]=!(j&&~j.indexOf(i));c[Z]=[];c[W]=[];v.push(c)}}F()}}function m(a,e){var b=[],c,j,i,k,o,n,p,t,$=za-N;c=0;for(j=a.length;c<j;c++){o=a[c];n=o[R];t=new Ga(n.length);i=0;for(k=n.length-1;i<k;i+=2){p=n[i+1];var J=va(1,Oa(0,0.5-La(Ma(Pa+Ha*n[i]/180))/fa/2));p={x:(p/360+0.5)*ka<<0,y:J*ka<<0};t[i]=p.x;t[i+1]=p.y}t=Ea(t);if(!(t.length<8)){k=[];k[R]=t;k[qa]=Da(t);k[V]=va(o[V]>>$,Ia);k[Y]=o[Y];k[ja]=e;k[Z]=o[Z];
k[W]=[];for(i=0;i<3;i++)if(k[Z][i])k[W][i]=k[Z][i].adjustAlpha(S)+"";b.push(k)}}return b}function s(a,e){if(typeof a==="object")E(a,!e);else{var b=wa.documentElement,c=wa.createElement("script");g.jsonpCallback=function(j){delete g.jsonpCallback;b.removeChild(c);E(j,!e)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function x(a,e,b){if(b===undefined)b=[];var c,j,i,k=a[0]?a:a.features,o,n,p,t,$,J=e?1:0,aa=e?0:1;if(k){c=0;for(a=k.length;c<a;c++)x(k[c],e,b);return b}if(a.type===
"Feature"){o=a.geometry;c=a.properties}if(o.type==="Polygon")n=[o.coordinates];if(o.type==="MultiPolygon")n=o.coordinates;if(n){e=c.height;if(c.color||c.wallColor)t=Q.parse(c.color||c.wallColor);if(c.roofColor)$=Q.parse(c.roofColor);c=0;for(a=n.length;c<a;c++){k=n[c][0];p=[];j=o=0;for(i=k.length;j<i;j++){p.push(k[j][J],k[j][aa]);o+=e||k[j][2]||0}if(o){j=[];i=R;var u=void 0,q=void 0,B=void 0,T=void 0,ma=0,U=void 0,Ja=void 0;U=0;for(Ja=p.length-3;U<Ja;U+=2){u=p[U];q=p[U+1];B=p[U+2];T=p[U+3];ma+=u*T-
B*q}if((ma/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}j[i]=p;j[V]=o/k.length<<0;j[Z]=[t||null,t?t.adjustLightness(0.8):null,$?$:t?t.adjustLightness(1.2):ca];b.push(j)}}}return b}function E(a,e){if(a){na=x(a,e);la=0;K(N);A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:N};v=m(na,true);F()}else{na=null;M()}}function K(a){var e,b,c;N=a;ka=Ra<<N;S=1-(N-la)*0.3/(za-la);Aa=ba.adjustAlpha(S)+"";sa=ta.adjustAlpha(S)+"";ua=ca.adjustAlpha(S)+"";if(v){a=0;for(e=v.length;a<e;a++){c=
v[a];c[W]=[];for(b=0;b<3;b++)if(c[Z][b])c[W][b]=c[Z][b].adjustAlpha(S)+""}}}function F(){ea=0;clearInterval(Ba);Ba=setInterval(function(){ea+=0.1;if(ea>1){clearInterval(Ba);ea=1;for(var a=0,e=v.length;a<e;a++)v[a][ja]=0}M()},33)}function M(){y.clearRect(0,0,P,G);if(A&&v)if(!(N<la||Ca)){var a,e,b,c,j,i,k,o,n,p=I-A.x,t=da-A.y,$=[oa+p,pa+t],J,aa,u,q,B,T;v.sort(function(ma,U){return D(U[qa],$)/U[V]-D(ma[qa],$)/ma[V]});a=0;for(e=v.length;a<e;a++){j=v[a];u=false;i=j[R];J=[];b=0;for(c=i.length-1;b<c;b+=
2){J[b]=o=i[b]-p;J[b+1]=n=i[b+1]-t;u||(u=o>0&&o<P&&n>0&&n<G)}if(u){b=j[ja]?j[V]*ea:j[V];i=ga/(ga-b);if(j[Y]){b=j[ja]?j[Y]*ea:j[Y];k=ga/(ga-b)}o=[];aa=[];b=0;for(c=J.length-3;b<c;b+=2){n=J[b];q=J[b+1];u=J[b+2];B=J[b+3];T=O(n,q,i);aa=O(u,B,i);if(j[Y]){q=O(n,q,k);B=O(u,B,k);n=q.x;q=q.y;u=B.x;B=B.y}if((u-n)*(T.y-q)>(T.x-n)*(B-q)){aa=[u+0.5,B+0.5,n+0.5,q+0.5,T.x,T.y,aa.x,aa.y];y.fillStyle=n<u&&q<B||n>u&&q>B?j[W][1]||sa:j[W][0]||Aa;X(aa)}o[b]=T.x;o[b+1]=T.y}y.fillStyle=j[W][2]||ua;y.strokeStyle=j[W][1]||
sa;X(o,true)}}}}function X(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function O(a,e,b){return{x:((a-oa)*b+oa<<0)+0.5,y:((e-pa)*b+pa<<0)+0.5}}var P=0,G=0,z=0,H=0,I=0,da=0,N,ka,ra,C,y,ya,ba=new Q(200,190,180),ta=ba.adjustLightness(0.8),ca=ba.adjustLightness(1.2),Aa=ba+"",sa=ta+"",ua=ca+"",na,A,v,ea=1,Ba,S=1,la=xa,za=20,oa,pa,Ca;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ba=Q.parse(a.color||
a.wallColor);Aa=ba.adjustAlpha(S)+"";ta=ba.adjustLightness(0.8);sa=ta.adjustAlpha(S)+"";ca=ba.adjustLightness(1.2);ua=ca.adjustAlpha(S)+""}if(a.roofColor){ca=Q.parse(a.roofColor);ua=ca.adjustAlpha(S)+""}M();return this};this.geoJSON=function(a,e){s(a,e);return this};this.setCamOffset=function(a,e){oa=z+a;pa=G+e};this.setMaxZoom=function(a){za=a};this.createCanvas=function(a){C=wa.createElement("canvas");C.style.webkitTransform="translate3d(0,0,0)";C.style.imageRendering="optimizeSpeed";C.style.position=
"absolute";C.style.pointerEvents="none";C.style.left=0;C.style.top=0;a.appendChild(C);y=C.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return C};this.destroyCanvas=function(){C.parentNode.removeChild(C)};this.loadData=f;this.onMoveEnd=function(){var a=r(I,da),e=r(I+P,da+G);M();if(A&&(a[ha]>A.n||a[ia]<A.w||e[ha]<A.s||e[ia]>A.e))f()};this.onZoomEnd=function(a){Ca=false;K(a.zoom);if(na){v=m(na);M()}else{M();f()}};this.onZoomStart=
function(){Ca=true;M()};this.render=M;this.setOrigin=function(a,e){I=a;da=e};this.setSize=function(a,e){P=a;G=e;z=P/2<<0;H=G/2<<0;oa=z;pa=G;C.width=P;C.height=G};this.setZoom=K;ya=l};g.OSMBuildings.VERSION="0.1.7a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.canvas.style.left=-g.x+"px";
this.canvas.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=g;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;g=L.DomUtil.getPosition(this.map._mapPane);var D=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-g.x+"px";this.canvas.style.top=-g.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(g,D){return this.osmb.geoJSON(g,D)},
=======
(function(g){function E(j,s){for(var z=s>3?5:1E3,c,f=[j[0],j[1]],k,m=[j[0],j[1]],r=2,F=j.length-3;r<F;r+=2){c=[j[r],j[r+1]];k=[j[r+2]||j[0],j[r+3]||j[1]];var G=f,w=G[0],x=G[1],A=k[0]-w,T=k[1]-x,K=void 0;if(A!==0||T!==0){K=((c[0]-w)*A+(c[1]-x)*T)/(A*A+T*T);if(K>1){w=k[0];x=k[1]}else if(K>0){w+=A*K;x+=T*K}}w=pa(c,[w,x])*2;k=pa(G,k);if(w*k>z){m.push(c[0],c[1]);f=c}}if(c[0]!==j[0]||c[1]!==j[1])m.push(j[0],j[1]);console.log(j.length,m.length,s,z);return m}function pa(j,s){var z=j[0]-s[0],c=j[1]-s[1];return z*
z+c*c}function Ea(j){for(var s=0,z=0,c=0,f=j.length-3;c<f;c+=2){s+=j[c];z+=j[c+1]}j=(j.length-2)*2;return[s/j<<0,z/j<<0]}var Fa=Fa||Array,Ja=Math.exp,Ka=Math.log,La=Math.tan,Ma=Math.atan,va=Math.min,Na=Math.max,wa=g.document,M=function(){function j(c,f,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return c+(f-c)*6*k;if(k<0.5)return f;if(k<2/3)return c+(f-c)*(2/3-k)*6;return c}function s(c,f,k,m){this.r=c;this.g=f;this.b=k;this.a=arguments.length<4?1:m}var z=s.prototype;z.toString=function(){return"rgba("+[this.r<<
0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};z.adjustLightness=function(c){var f=M.toHSLA(this);f.l*=c;f.l=Math.min(1,Math.max(0,f.l));var k,m;if(f.s===0)c=k=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var r=2*f.l-m;c=j(r,m,f.h+1/3);k=j(r,m,f.h);m=j(r,m,f.h-1/3)}return new M(c*255<<0,k*255<<0,m*255<<0,f.a)};z.adjustAlpha=function(c){return new M(this.r,this.g,this.b,this.a*c)};s.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new M(parseInt(c[1],
16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new M(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};s.toHSLA=function(c){var f=c.r/255,k=c.g/255,m=c.b/255,r=Math.max(f,k,m),F=Math.min(f,k,m),G,w=(r+F)/2,x;if(r===F)G=F=0;else{x=r-F;F=w>0.5?x/(2-r-F):x/(r+F);switch(r){case f:G=(k-m)/x+(k<m?6:0);break;case k:G=(m-f)/x+2;break;case m:G=(f-k)/x+4;break}G/=6}return{h:G,s:F,l:w,
a:c.a}};return s}(),da=Math.PI,Ga=da/2,Oa=da/4,Pa=180/da,Qa=256,xa=14,ea=400,Ha=ea-50,fa="latitude",ga="longitude",I=0,U=1,N=2,V=3,qa=4,ha=5,R=6;g.OSMBuildings=function(j){function s(a,e){var b={};a/=ia;e/=ia;b[fa]=e<=0?90:e>=1?-90:Pa*(2*Ma(Ja(da*(1-2*e)))-Ga);b[ga]=(a===1?1:(a%1+1)%1)*360-180;return b}function z(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||
b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!ya||J<xa)){var a=s(aa-ja,ba-za),e=s(aa+Z+ja,ba+S+za);ra&&ra.abort();ra=c(z(ya,{w:a[ga],n:a[fa],e:e[ga],s:e[fa],z:J}),k)}}function k(a){var e,b,d,i=[],h,l=h=0;ka=xa;w(J);ra=null;if(!(!a||a.meta.z!==J)){d=a.meta;b=a.data;if(B&&v&&B.z===d.z){h=B.x-d.x;l=B.y-d.y;a=0;for(e=v.length;a<e;a++)i[a]=v[a][N][0]+h+","+(v[a][N][1]+l)}B=d;v=[];a=0;for(e=b.length;a<e;a++){d=[];h=E(b[a][N],b[a][I]);
if(!(h.length<8)){d[N]=h;d[qa]=Ea(h);d[I]=va(b[a][I],Ha);d[U]=b[a][U];h=d[N][0]+","+d[N][1];d[ha]=!(i&&~i.indexOf(h));d[V]=[];d[R]=[];v.push(d)}}x()}}function m(a,e){var b=[],d,i,h,l,n,o,p,t,W=Aa-J;d=0;for(i=a.length;d<i;d++){n=a[d];o=n[N];t=new Fa(o.length);h=0;for(l=o.length-1;h<l;h+=2){p=o[h+1];var H=va(1,Na(0,0.5-Ka(La(Oa+Ga*o[h]/180))/da/2));p={x:(p/360+0.5)*ia<<0,y:H*ia<<0};t[h]=p.x;t[h+1]=p.y}t=E(t,n[I]);if(!(t.length<8)){l=[];l[N]=t;l[qa]=Ea(t);l[I]=va(n[I]>>W,Ha);l[U]=n[U];l[ha]=e;l[V]=n[V];
l[R]=[];for(h=0;h<3;h++)if(l[V][h])l[R][h]=l[V][h].adjustAlpha(O)+"";b.push(l)}}return b}function r(a,e){if(typeof a==="object")G(a,!e);else{var b=wa.documentElement,d=wa.createElement("script");g.jsonpCallback=function(i){delete g.jsonpCallback;b.removeChild(d);G(i,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function F(a,e,b){if(b===undefined)b=[];var d,i,h,l=a[0]?a:a.features,n,o,p,t,W,H=e?1:0,X=e?0:1;if(l){d=0;for(a=l.length;d<a;d++)F(l[d],e,b);return b}if(a.type===
"Feature"){n=a.geometry;d=a.properties}if(n.type==="Polygon")o=[n.coordinates];if(n.type==="MultiPolygon")o=n.coordinates;if(o){e=d.height;if(d.color||d.wallColor)t=M.parse(d.color||d.wallColor);if(d.roofColor)W=M.parse(d.roofColor);d=0;for(a=o.length;d<a;d++){l=o[d][0];p=[];i=n=0;for(h=l.length;i<h;i++){p.push(l[i][H],l[i][X]);n+=e||l[i][2]||0}if(n){i=[];h=N;var u=void 0,q=void 0,C=void 0,P=void 0,la=0,Q=void 0,Ia=void 0;Q=0;for(Ia=p.length-3;Q<Ia;Q+=2){u=p[Q];q=p[Q+1];C=p[Q+2];P=p[Q+3];la+=u*P-
C*q}if((la/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}i[h]=p;i[I]=n/l.length<<0;i[V]=[t||null,t?t.adjustLightness(0.8):null,W?W:t?t.adjustLightness(1.2):$];b.push(i)}}}return b}function G(a,e){if(a){ma=F(a,e);ka=0;w(J);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:J};v=m(ma,true);x()}else{ma=null;A()}}function w(a){var e,b,d;J=a;ia=Qa<<J;O=1-(J-ka)*0.3/(Aa-ka);Ba=Y.adjustAlpha(O)+"";sa=ta.adjustAlpha(O)+"";ua=$.adjustAlpha(O)+"";if(v){a=0;for(e=v.length;a<e;a++){d=
v[a];d[R]=[];for(b=0;b<3;b++)if(d[V][b])d[R][b]=d[V][b].adjustAlpha(O)+""}}}function x(){ca=0;clearInterval(Ca);Ca=setInterval(function(){ca+=0.1;if(ca>1){clearInterval(Ca);ca=1;for(var a=0,e=v.length;a<e;a++)v[a][ha]=0}A()},33)}function A(){y.clearRect(0,0,Z,S);if(B&&v)if(!(J<ka||Da)){var a,e,b,d,i,h,l,n,o,p=aa-B.x,t=ba-B.y,W=[na+p,oa+t],H,X,u,q,C,P;v.sort(function(la,Q){return pa(Q[qa],W)/Q[I]-pa(la[qa],W)/la[I]});a=0;for(e=v.length;a<e;a++){i=v[a];u=false;h=i[N];H=[];b=0;for(d=h.length-1;b<d;b+=
2){H[b]=n=h[b]-p;H[b+1]=o=h[b+1]-t;u||(u=n>0&&n<Z&&o>0&&o<S)}if(u){b=i[ha]?i[I]*ca:i[I];h=ea/(ea-b);if(i[U]){b=i[ha]?i[U]*ca:i[U];l=ea/(ea-b)}n=[];X=[];b=0;for(d=H.length-3;b<d;b+=2){o=H[b];q=H[b+1];u=H[b+2];C=H[b+3];P=K(o,q,h);X=K(u,C,h);if(i[U]){q=K(o,q,l);C=K(u,C,l);o=q.x;q=q.y;u=C.x;C=C.y}if((u-o)*(P.y-q)>(P.x-o)*(C-q)){X=[u+0.5,C+0.5,o+0.5,q+0.5,P.x,P.y,X.x,X.y];y.fillStyle=o<u&&q<C||o>u&&q>C?i[R][1]||sa:i[R][0]||Ba;T(X)}n[b]=P.x;n[b+1]=P.y}y.fillStyle=i[R][2]||ua;y.strokeStyle=i[R][1]||sa;T(n,
true)}}}}function T(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function K(a,e,b){return{x:((a-na)*b+na<<0)+0.5,y:((e-oa)*b+oa<<0)+0.5}}var Z=0,S=0,ja=0,za=0,aa=0,ba=0,J,ia,ra,D,y,ya,Y=new M(200,190,180),ta=Y.adjustLightness(0.8),$=Y.adjustLightness(1.2),Ba=Y+"",sa=ta+"",ua=$+"",ma,B,v,ca=1,Ca,O=1,ka=xa,Aa=20,na,oa,Da;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){Y=M.parse(a.color||
a.wallColor);Ba=Y.adjustAlpha(O)+"";ta=Y.adjustLightness(0.8);sa=ta.adjustAlpha(O)+"";$=Y.adjustLightness(1.2);ua=$.adjustAlpha(O)+""}if(a.roofColor){$=M.parse(a.roofColor);ua=$.adjustAlpha(O)+""}A();return this};this.geoJSON=function(a,e){r(a,e);return this};this.setCamOffset=function(a,e){na=ja+a;oa=S+e};this.setMaxZoom=function(a){Aa=a};this.createCanvas=function(a){D=wa.createElement("canvas");D.style.webkitTransform="translate3d(0,0,0)";D.style.imageRendering="optimizeSpeed";D.style.position=
"absolute";D.style.pointerEvents="none";D.style.left=0;D.style.top=0;a.appendChild(D);y=D.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return D};this.destroyCanvas=function(){D.parentNode.removeChild(D)};this.loadData=f;this.onMoveEnd=function(){var a=s(aa,ba),e=s(aa+Z,ba+S);A();if(B&&(a[fa]>B.n||a[ga]<B.w||e[fa]<B.s||e[ga]>B.e))f()};this.onZoomEnd=function(a){Da=false;w(a.zoom);if(ma){v=m(ma);A()}else{A();f()}};this.onZoomStart=
function(){Da=true;A()};this.render=A;this.setOrigin=function(a,e){aa=a;ba=e};this.setSize=function(a,e){Z=a;S=e;ja=Z/2<<0;za=S/2<<0;na=ja;oa=S;D.width=Z;D.height=S};this.setZoom=w;ya=j};g.OSMBuildings.VERSION="0.1.7a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.canvas.style.left=-g.x+"px";
this.canvas.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=g;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;g=L.DomUtil.getPosition(this.map._mapPane);var E=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-g.x+"px";this.canvas.style.top=-g.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(g,E){return this.osmb.geoJSON(g,E)},
>>>>>>> e309b6dd2b9a918e68b9e961e9a6bb348ea608b3
setStyle:function(g){return this.osmb.setStyle(g)}});
