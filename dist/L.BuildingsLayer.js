(function(i){function w(Q,D){var R=Q[0]-D[0],g=Q[1]-D[1];return R*R+g*g}var wa=wa||Array,Ba=Math.exp,Ca=Math.log,Da=Math.tan,Ea=Math.atan,la=Math.min,Fa=Math.max,ma=i.document,F=function(){function Q(g,l,m){if(m<0)m+=1;if(m>1)m-=1;if(m<1/6)return g+(l-g)*6*m;if(m<0.5)return l;if(m<2/3)return g+(l-g)*(2/3-m)*6;return g}function D(g,l,m,q){this.r=g;this.g=l;this.b=m;this.a=arguments.length<4?1:q}var R=D.prototype;R.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};R.adjustLightness=function(g){var l=F.toHSLA(this);l.l*=g;l.l=Math.min(1,Math.max(0,l.l));var m,q;if(l.s===0)g=m=q=l.l;else{q=l.l<0.5?l.l*(1+l.s):l.l+l.s-l.l*l.s;var E=2*l.l-q;g=Q(E,q,l.h+1/3);m=Q(E,q,l.h);q=Q(E,q,l.h-1/3)}return new F(g*255<<0,m*255<<0,q*255<<0,l.a)};R.adjustAlpha=function(g){return new F(this.r,this.g,this.b,this.a*g)};D.parse=function(g){g+="";if(~g.indexOf("#")){g=g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new F(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],
16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new F(parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};D.toHSLA=function(g){var l=g.r/255,m=g.g/255,q=g.b/255,E=Math.max(l,m,q),G=Math.min(l,m,q),K,U=(E+G)/2,M;if(E===G)K=G=0;else{M=E-G;G=U>0.5?M/(2-E-G):M/(E+G);switch(E){case l:K=(m-q)/M+(m<q?6:0);break;case m:K=(q-l)/M+2;break;case q:K=(l-m)/M+4;break}K/=6}return{h:K,s:G,l:U,a:g.a}};return D}(),$=Math.PI,xa=$/2,
Ga=$/4,Ha=180/$,Ia=256,na=14,oa=400,ya=oa-50,aa="latitude",ba="longitude",N=0,J=1,C=2,pa=3,ha=4;i.OSMBuildings=function(Q){function D(a,d){var b={};a/=ca;d/=ca;b[aa]=d<=0?90:d>=1?-90:Ha*(2*Ea(Ba($*(1-2*d)))-xa);b[ba]=(a===1?1:(a%1+1)%1)*360-180;return b}function R(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function g(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function l(){if(!(!qa||H<na)){var a=D(Y-da,Z-ra),d=D(Y+V+da,Z+O+ra);ia&&ia.abort();ia=g(R(qa,{w:a[ba],n:a[aa],e:d[ba],s:d[aa],z:H}),m)}}function m(a){var d,b,c,h=[],f=0,j=0;ea=na;U(H);ia=null;if(!(!a||a.meta.z!==H)){c=a.meta;b=a.data;if(z&&A&&z.z===c.z){f=z.x-c.x;j=z.y-c.y;a=0;for(d=A.length;a<d;a++)h[a]=A[a][J][0]+f+","+(A[a][J][1]+j)}z=c;A=[];a=0;for(d=b.length;a<d;a++){var e=b[a][J];c=[];var k=void 0;k=void 0;var n=void 0;j=f=0;e=e;k=void 0;n=[e[0],e[1]];for(var p=
void 0,o=[e[0],e[1]],r=2,x=e.length-3;r<x;r+=2){k=[e[r],e[r+1]];p=[e[r+2]||e[0],e[r+3]||e[1]];var y=n;p=p;var s=y[0],t=y[1],u=p[0]-s,I=p[1]-t,S=void 0;if(u!==0||I!==0){S=((k[0]-s)*u+(k[1]-t)*I)/(u*u+I*I);if(S>1){s=p[0];t=p[1]}else if(S>0){s+=u*S;t+=I*S}}s=w(k,[s,t])*2;y=w(y,p);if(s*y>750){o.push(k[0],k[1]);n=k}}if(k[0]!==e[0]||k[1]!==e[1])o.push(e[0],e[1]);e=o;if(e.length<8)f=void 0;else{o=0;for(r=e.length-3;o<r;o+=2){k=e[o];n=e[o+1];f+=k;j+=n}k=(e.length-2)*2;c[J]=e;c[pa]=[f/k<<0,j/k<<0];f=c}if(f){f[N]=
la(b[a][N],ya);c=f[J][0]+","+f[J][1];f[ha]=!(h&&~h.indexOf(c));A.push(f)}}M()}}function q(a,d){var b=[],c,h,f,j,e,k,n,p,o=sa-H;c=0;for(h=a.length;c<h;c++){e=a[c];k=e[J];n=new wa(k.length);f=0;for(j=k.length-1;f<j;f+=2){p=k[f+1];var r=la(1,Fa(0,0.5-Ca(Da(Ga+xa*k[f]/180))/$/2));p={x:(p/360+0.5)*ca<<0,y:r*ca<<0};n[f]=p.x;n[f+1]=p.y}b[c]=[];b[c][N]=la(e[N]>>o,ya);b[c][J]=n;b[c][C]=e[C];b[c][ha]=d}return b}function E(a,d){if(typeof a==="object")K(a,!d);else{var b=ma.documentElement,c=ma.createElement("script");
i.jsonpCallback=function(h){delete i.jsonpCallback;b.removeChild(c);K(h,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function G(a,d,b){if(b===undefined)b=[];var c,h,f,j=a[0]?a:a.features,e,k,n,p,o,r=d?1:0,x=d?0:1;if(j){c=0;for(a=j.length;c<a;c++)G(j[c],d,b);return b}if(a.type==="Feature"){h=a.geometry;c=a.properties}if(h.type==="Polygon")e=[h.coordinates];if(h.type==="MultiPolygon")e=h.coordinates;if(e){d=c.height;if(c.color||c.wallColor)p=F.parse(c.color||c.wallColor);
if(c.roofColor)o=F.parse(c.roofColor);c=0;for(a=e.length;c<a;c++){k=e[c][0];j=[];h=n=0;for(f=k.length;h<f;h++){j.push(k[h][r],k[h][x]);n+=d||k[h][2]||0}if(n){h=[];h[N]=n/k.length<<0;k=J;n=void 0;f=void 0;var y=void 0,s=void 0,t=0,u=void 0,I=void 0;u=0;for(I=j.length-3;u<I;u+=2){n=j[u];f=j[u+1];y=j[u+2];s=j[u+3];t+=n*s-y*f}if((t/2>0?"CW":"CCW")==="CW")j=j;else{n=[];for(f=j.length-2;f>=0;f-=2)n.push(j[f],j[f+1]);j=n}h[k]=j;if(p||o)h[C]=[p,o];b.push(h)}}}return b}function K(a,d){if(a){fa=G(a,d);ea=0;
U(H);z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:H};A=q(fa,true);M()}else{fa=null;T()}}function U(a){H=a;ca=Ia<<H;P=1-(H-ea)*0.3/(sa-ea)}function M(){ga=0;clearInterval(ta);ta=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(ta);ga=1;for(var a=0,d=A.length;a<d;a++)A[a][ha]=0}T()},33)}function T(){v.clearRect(0,0,V,O);if(z&&A)if(!(H<ea||ua)){var a,d,b,c,h,f,j,e,k=Y-z.x,n=Z-z.y,p=[W+k,X+n],o,r,x,y,s,t,u=ja.adjustAlpha(P)+"",I=(va||ja.adjustLightness(1.2)).adjustAlpha(P)+"";if(ka)v.strokeStyle=Ja.adjustAlpha(P)+
"";A.sort(function(S,za){return w(za[pa],p)/za[N]-w(S[pa],p)/S[N]});a=0;for(d=A.length;a<d;a++){h=A[a];x=false;f=h[J];o=[];b=0;for(c=f.length-1;b<c;b+=2){o[b]=j=f[b]-k;o[b+1]=e=f[b+1]-n;x||(x=j>0&&j<V&&e>0&&e<O)}if(x){v.fillStyle=h[C]&&h[C][0]?h[C][0].adjustAlpha(P)+"":u;b=h[ha]?h[N]*ga:h[N];f=oa/(oa-b);j=[];r=[];b=0;for(c=o.length-3;b<c;b+=2){e=o[b];x=o[b+1];y=o[b+2];s=o[b+3];t={x:((e-W)*f+W<<0)+0.5,y:((x-X)*f+X<<0)+0.5};r={x:((y-W)*f+W<<0)+0.5,y:((s-X)*f+X<<0)+0.5};if((y-e)*(t.y-x)>(t.x-e)*(s-x)){r=
[y+0.5,s+0.5,e+0.5,x+0.5,t.x,t.y,r.x,r.y];v.fillStyle=e<y&&x<s||e>y&&x>s?ja.adjustAlpha(P).adjustLightness(0.8)+"":h[C]&&h[C][0]?h[C][0].adjustAlpha(P)+"":u;Aa(r)}j[b]=t.x;j[b+1]=t.y}v.fillStyle=!h[C]?I:h[C][1]?h[C][1].adjustAlpha(P)+"":va?I:h[C][0].adjustLightness(1.2).adjustAlpha(P)+"";Aa(j,ka)}}}}function Aa(a,d){if(a.length){v.beginPath();v.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)v.lineTo(a[b],a[b+1]);v.closePath();d&&v.stroke();v.fill()}}var V=0,O=0,da=0,ra=0,Y=0,Z=0,H,ca,ia,B,v,qa,
ka,ja=new F(200,190,180),va,Ja=new F(145,140,135),fa,z,A,P=1,ga=1,ta,ea=na,sa=20,W,X,ua;this.setStyle=function(a){a=(a=a)||{};ka=a.strokeRoofs!==undefined?a.strokeRoofs:ka;if(a.color||a.wallColor)ja=F.parse(a.color||a.wallColor);if(a.roofColor!==undefined)va=F.parse(a.roofColor);T();return this};this.geoJSON=function(a,d){E(a,d);return this};this.setCamOffset=function(a,d){W=da+a;X=O+d};this.setMaxZoom=function(a){sa=a};this.createCanvas=function(a){B=ma.createElement("canvas");B.style.webkitTransform=
"translate3d(0,0,0)";B.style.imageRendering="optimizeSpeed";B.style.position="absolute";B.style.pointerEvents="none";B.style.left=0;B.style.top=0;a.appendChild(B);v=B.getContext("2d");v.lineCap="round";v.lineJoin="round";v.lineWidth=1;try{v.mozImageSmoothingEnabled=false}catch(d){}return B};this.destroyCanvas=function(){B.parentNode.removeChild(B)};this.loadData=l;this.onMoveEnd=function(){var a=D(Y,Z),d=D(Y+V,Z+O);T();if(z&&(a[aa]>z.n||a[ba]<z.w||d[aa]<z.s||d[ba]>z.e))l()};this.onZoomEnd=function(a){ua=
false;U(a.zoom);if(fa){A=q(fa);T()}else{T();l()}};this.onZoomStart=function(){ua=true;T()};this.render=T;this.setOrigin=function(a,d){Y=a;Z=d};this.setSize=function(a,d){V=a;O=d;da=V/2<<0;ra=O/2<<0;W=da;X=O;B.width=V;B.height=O};this.setZoom=U;qa=Q};i.OSMBuildings.VERSION="0.1.7a";i.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(i){L.Util.setOptions(this,i)},onMove:function(){var i=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-i.x,this.lastY-i.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var i=L.DomUtil.getPosition(this.map._mapPane),w=this.map.getPixelOrigin();this.lastX=i.x;this.lastY=i.y;this.canvas.style.left=-i.x+"px";
this.canvas.style.top=-i.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(w.x-i.x,w.y-i.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var i=L.DomUtil.getPosition(this.map._mapPane),w=this.map.getPixelOrigin();this.osmb.setOrigin(w.x-i.x,w.y-i.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(i){i.addLayer(this);return this},onAdd:function(i){this.map=i;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;i=L.DomUtil.getPosition(this.map._mapPane);var w=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(w.x-i.x,w.y-i.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-i.x+"px";this.canvas.style.top=-i.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(i){i.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);i.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(i,w){return this.osmb.geoJSON(i,w)},
setStyle:function(i){return this.osmb.setStyle(i)}});
