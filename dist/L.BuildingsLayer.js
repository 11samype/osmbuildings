(function(a){function v(e,c){var m=e[0]-c[0],g=e[1]-c[1];return m*m+g*g}function Ba(e){for(var c=0,m=0,g=0,a=e.length-3;g<a;g+=2)c+=e[g],m+=e[g+1];e=2*(e.length-2);return[c/e<<0,m/e<<0]}function Ca(e){var c=e.length/2,m=new $(c),g=0,a=c-1,l,f,j,A,v=[],E=[],G=[];for(m[g]=m[a]=1;a;){f=0;for(l=g+1;l<a;l++){j=e[2*l];var q=e[2*l+1],r=e[2*g],p=e[2*g+1],z=e[2*a],n=e[2*a+1],I=z-r,C=n-p,F=void 0;if(0!==I||0!==C)F=((j-r)*I+(q-p)*C)/(I*I+C*C),1<F?(r=z,p=n):0<F&&(r+=I*F,p+=C*F);I=j-r;C=q-p;j=I*I+C*C;j>f&&(A=
l,f=j)}2<f&&(m[A]=1,v.push(g),E.push(A),v.push(A),E.push(a));g=v.pop();a=E.pop()}for(l=0;l<c;l++)m[l]&&G.push(e[2*l],e[2*l+1]);return G}var Da=Da||Array,$=$||Array,f=Math,Na=f.exp,Oa=f.log,Pa=f.sin,Qa=f.cos,va=f.tan,Ra=f.atan,ba=f.min,oa=f.max,pa=document,j,Ea=function(e){var c,a,g;if(0===e.s)c=a=g=e.l;else{g=0.5>e.l?e.l*(1+e.s):e.l+e.s-e.l*e.s;var f=2*e.l-g;e.h/=360;c=V(f,g,e.h+1/3);a=V(f,g,e.h);g=V(f,g,e.h-1/3)}return new j(255*c<<0,255*a<<0,255*g<<0,e.a)},V=function(e,c,a){0>a&&(a+=1);1<a&&(a-=
1);return a<1/6?e+6*(c-e)*a:0.5>a?c:a<2/3?e+6*(c-e)*(2/3-a):e},f=function(e,a,m,g){this.r=e;this.g=a;this.b=m;this.a=4>arguments.length?1:g},W=f.prototype;W.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};W.adjustLightness=function(a){var c=j.toHSLA(this);c.l*=a;c.l=Math.min(1,Math.max(0,c.l));return Ea(c)};W.adjustAlpha=function(a){return new j(this.r,this.g,this.b,this.a*a)};f.parse=function(a){var c;a+="";if(~a.indexOf("#"))return c=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new j(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1);if(c=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new j(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5]):1);if(c=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ea({h:parseInt(c[1],10),s:parseFloat(c[2]),l:parseFloat(c[3]),a:c[4]?parseFloat(c[5]):1})};f.toHSLA=function(a){var c=a.r/255,m=a.g/255,g=a.b/255,f=Math.max(c,m,g),l=Math.min(c,m,g),
j,A=(f+l)/2,r;if(f===l)j=l=0;else{r=f-l;l=0.5<A?r/(2-f-l):r/(f+l);switch(f){case c:j=(m-g)/r+(m<g?6:0);break;case m:j=(g-c)/r+2;break;case g:j=(c-m)/r+4}j/=6}return{h:360*j,s:l,l:A,a:a.a}};j=f;var Fa,f=Math,n=f.sin,K=f.cos,Sa=f.tan,Ga=f.asin,Ha=f.atan2,X=f.PI,q=180/X,Ta=357.5291/q,Ua=0.98560028/q,Va=1.9148/q,Wa=0.02/q,Xa=3E-4/q,Ya=102.9372/q,Ia=23.45/q,Za=280.16/q,$a=360.9856235/q;Fa=function(a,c,f){f=-f/q;c/=q;a=a.valueOf()/864E5-0.5+2440588;var g=Ta+Ua*(a-2451545),j=Va*n(g)+Wa*n(2*g)+Xa*n(3*g),
j=g+Ya+j+X,g=Ga(n(j)*n(Ia)),j=Ha(n(j)*K(Ia),K(j));f=Za+$a*(a-2451545)-f-j;return{altitude:Ga(n(c)*n(g)+K(c)*K(g)*K(f)),azimuth:Ha(n(f),K(f)*n(c)-Sa(g)*K(c))-X/2}};var ca=Math.PI,Ja=ca/2,ab=ca/4,bb=180/ca,cb=256,wa=14,da="latitude",ea="longitude",Ka=3,La=4,E=0,A=1,G=2,r=3,qa=4,T=5,O=6;a.OSMBuildings=function(e){function c(b,R){var d={};b/=fa;R/=fa;d[da]=0>=R?90:1<=R?-90:bb*(2*Ra(Na(ca*(1-2*R)))-Ja);d[ea]=360*(1===b?1:(b%1+1)%1)-180;return d}function f(){if(xa&&!(J<wa)){var b=c(C-U,F-I),R=c(C+p+U,F+
z+I);ra&&ra.abort();var d={w:b[ea],n:b[da],e:R[ea],s:R[da],z:J},b=xa.replace(/\{ *([\w_]+) *\}/g,function(b,a){return d[a]}),h=g,a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&a.status&&!(200>a.status||299<a.status)&&a.responseText&&h(JSON.parse(a.responseText))};a.open("GET",b);a.send(null);ra=a}}function g(b){var a,d,h,y,c=[],f=d=0;Y=wa;K(J);ra=null;if(b&&b.meta.z===J){y=b.meta;h=b.data;if(B&&s&&B.z===y.z){d=B.x-y.x;f=B.y-y.y;b=0;for(a=s.length;b<a;b++)c[b]=s[b][G][0]+d+
","+(s[b][G][1]+f)}B=y;s=[];b=0;for(a=h.length;b<a;b++)if(y=[],!(h[b][A]>ga)&&(d=Ca(h[b][G]),!(8>d.length))){y[G]=d;y[qa]=Ba(d);y[E]=ba(h[b][E],ga);y[A]=h[b][A];d=y[G][0]+","+y[G][1];y[T]=!(c&&~c.indexOf(d));y[r]=[];y[O]=[];d=h[b][Ka]?j.parse(h[b][Ka]):null;f=h[b][La]?j.parse(h[b][La]):null;y[r]=[d||null,d?d.adjustLightness(0.8):null,f?f:d?d.adjustLightness(1.2):P];for(d=0;3>d;d++)y[r][d]&&(y[O][d]=y[r][d].adjustAlpha(M)+"");s.push(y)}V()}}function q(b,a){var d,h,y=[],c,f,H,k,e,g,j,l,p=ya-J;c=0;for(f=
b.length;c<f;c++)if(e=b[c],j=e[A]>>p,!(j>ga)){g=e[G];l=new Da(g.length);H=0;for(k=g.length-1;H<k;H+=2)d=g[H+1],h=ba(1,oa(0,0.5-Oa(va(ab+Ja*g[H]/180))/ca/2)),d=(d/360+0.5)*fa<<0,h=h*fa<<0,l[H]=d,l[H+1]=h;l=Ca(l);if(!(8>l.length)){k=[];k[G]=l;k[qa]=Ba(l);k[E]=ba(e[E]>>p,ga);k[A]=j;k[T]=a;k[r]=e[r];k[O]=[];for(H=0;3>H;H++)k[r][H]&&(k[O][H]=k[r][H].adjustAlpha(M)+"");y.push(k)}}return y}function l(b,a,d){void 0===d&&(d=[]);var h,c,f,e=b[0]?b:b.features,g,k,p,Ma,s,m,B=a?1:0,w=a?0:1;if(e){b=0;for(h=e.length;b<
h;b++)l(e[b],a,d);return d}"Feature"===b.type&&(h=b.geometry,k=b.properties);"Polygon"===h.type&&(g=[h.coordinates]);"MultiPolygon"===h.type&&(g=h.coordinates);if(g){Ma=k.height;if(k.color||k.wallColor)s=j.parse(k.color||k.wallColor);k.roofColor&&(m=j.parse(k.roofColor));b=0;for(h=g.length;b<h;b++){a=g[b][0];p=[];c=e=0;for(f=a.length;c<f;c++)p.push(a[c][B],a[c][w]),e+=Ma||a[c][2]||0;if(e){f=c=[];var u=G;for(var t=void 0,x=void 0,z=void 0,C=void 0,v=0,q=void 0,n=void 0,q=0,n=p.length-3;q<n;q+=2)t=
p[q],x=p[q+1],z=p[q+2],C=p[q+3],v+=t*C-z*x;if("CW"!==(0<v/2?"CW":"CCW")){t=[];for(x=p.length-2;0<=x;x-=2)t.push(p[x],p[x+1]);p=t}f[u]=p;c[E]=e/a.length<<0;c[A]=k.minHeight;c[r]=[s||null,s?s.adjustLightness(0.8):null,m?m:s?s.adjustLightness(1.2):P];d.push(c)}}}return d}function n(b,a){b?(ha=l(b,a),Y=0,K(J),B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:J},s=q(ha,!0),V()):(ha=null,aa())}function K(b){var a,d,h;J=b;fa=cb<<J;b=J;a=Y;d=ya;b=ba(oa(b,a),d);M=1-ba(oa(0+0.4*((b-a)/(d-a)),0),0.4);za=S.adjustAlpha(M)+
"";ia=sa.adjustAlpha(M)+"";ja=P.adjustAlpha(M)+"";if(s){b=0;for(a=s.length;b<a;b++){h=s[b];h[O]=[];for(d=0;3>d;d++)h[r][d]&&(h[O][d]=h[r][d].adjustAlpha(M)+"")}}}function V(){clearInterval(Aa);Q=0;ta.render();Aa=setInterval(function(){Q+=0.1;if(1<Q){clearInterval(Aa);Q=1;for(var b=0,a=s.length;b<a;b++)s[b][T]=0}ua.render();aa()},33)}function ma(){ua.render();ta.render();aa()}function W(){D.clearRect(0,0,p,z);if(B&&s&&!(J<Y||ka)){var b,a,d,h,c,e,f,g,k,j=C-B.x,l=F-B.y,q=ta.getMaxHeight(),r=[N+j,la+
l],m,w,u,t,x,n;s.sort(function(b,a){return v(a[qa],r)/a[E]-v(b[qa],r)/b[E]});b=0;for(a=s.length;b<a;b++)if(c=s[b],!(c[E]<=q)){w=!1;e=c[G];m=[];d=0;for(h=e.length-1;d<h;d+=2)m[d]=g=e[d]-j,m[d+1]=k=e[d+1]-l,w||(w=0<g&&g<p&&0<k&&k<z);if(w){d=c[T]?c[E]*Q:c[E];e=Z/(Z-d);c[A]&&(d=c[T]?c[A]*Q:c[A],f=Z/(Z-d));g=[];d=0;for(h=m.length-3;d<h;d+=2)k=m[d],u=m[d+1],w=m[d+2],t=m[d+3],x=na(k,u,e),n=na(w,t,e),c[A]&&(u=na(k,u,f),t=na(w,t,f),k=u.x,u=u.y,w=t.x,t=t.y),(w-k)*(x.y-u)>(x.x-k)*(t-u)&&(D.fillStyle=k<w&&u<
t||k>w&&u>t?c[O][1]||ia:c[O][0]||za,X([w,t,k,u,x.x,x.y,n.x,n.y])),g[d]=x.x,g[d+1]=x.y;D.fillStyle=c[O][2]||ja;D.strokeStyle=c[O][1]||ia;X(g,!0)}}}}function aa(){var b=p/(window.devicePixelRatio||1)/30;N-=b;W();var a=D.getImageData(0,0,p,z);N+=2*b;W();var d=D.getImageData(0,0,p,z);N-=b;for(var b=a.data,d=d.data,c,e,f,g,j=0,k=b.length;j<k;j+=4)if(c=j,e=j+1,f=j+2,g=j+3,b[g]||d[g])b[c]=0.7*(b[e]||235)+0.3*(b[f]||230),b[e]=d[e]||P.g,b[f]=d[f]||P.b,b[g]=oa(d[g],d[g]);D.clearRect(0,0,p,z);D.putImageData(a,
0,0)}function X(b,a){if(b.length){D.beginPath();D.moveTo(b[0],b[1]);for(var d=2,c=b.length;d<c;d+=2)D.lineTo(b[d],b[d+1]);D.closePath();a&&D.stroke();D.fill()}}function na(b,a,d){return{x:(b-N)*d+N<<0,y:(a-la)*d+la<<0}}var p=0,z=0,U=0,I=0,C=0,F=0,J,fa,ra,D,xa,S=new j(200,190,180),sa=S.adjustLightness(0.8),P=S.adjustLightness(1.2),za=S+"",ia=sa+"",ja=P+"",ha,B,s,Q=1,Aa,M=1,Y=wa,ya=20,ga,N,la,Z,ka,$={container:null,items:[],init:function(b){var a=this.container=pa.createElement("DIV");a.style.pointerEvents=
"none";a.style.position="absolute";a.style.left=0;a.style.top=0;ua.init(this.create());ta.init(this.create());D=this.create();b.appendChild(a);return a},create:function(){var b=pa.createElement("CANVAS");b.style.webkitTransform="translate3d(0,0,0)";b.style.imageRendering="optimizeSpeed";b.style.position="absolute";b.style.left=0;b.style.top=0;var a=b.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=!1}catch(d){}this.items.push(b);this.container.appendChild(b);
return a},setSize:function(b,a){for(var d=this.items,c=0,e=d.length;c<e;c++)d[c].width=b,d[c].height=a}},ua={context:null,color:new j(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(b){this.context=b;this.setDate((new Date).setHours(10))},render:function(){var b=this.context,a,d,h,e;b.clearRect(0,0,p,z);if(B&&s&&!(J<Y||ka))if(a=c(C+U,F+I),a=Fa(this.date,a.latitude,a.longitude),!(0>=a.altitude)){d=1/va(a.altitude);h=0.4/d;this.directionX=Qa(a.azimuth)*
d;this.directionY=Pa(a.azimuth)*d;this.color.a=h;e=this.color+"";var g,f,j,k,l,m,q=C-B.x,r=F-B.y,n,w,u,t,x,v,D=[];b.beginPath();a=0;for(d=s.length;a<d;a++){f=s[a];w=!1;j=f[G];n=[];h=0;for(g=j.length-1;h<g;h+=2)n[h]=l=j[h]-q,n[h+1]=m=j[h+1]-r,w||(w=0<l&&l<p&&0<m&&m<z);if(w){j=f[T]?f[E]*Q:f[E];f[A]&&(k=f[T]?f[A]*Q:f[A]);l=null;h=0;for(g=n.length-3;h<g;h+=2)m=n[h],u=n[h+1],w=n[h+2],t=n[h+3],x=this.project(m,u,j),v=this.project(w,t,j),f[A]&&(u=this.project(m,u,k),t=this.project(w,t,k),m=u.x,u=u.y,w=t.x,
t=t.y),(w-m)*(x.y-u)>(x.x-m)*(t-u)?(1===l&&b.lineTo(m,u),l=0,h||b.moveTo(m,u),b.lineTo(w,t)):(0===l&&b.lineTo(x.x,x.y),l=1,h||b.moveTo(x.x,x.y),b.lineTo(v.x,v.y));b.closePath();D.push(n)}}b.fillStyle=e;b.fill();b.globalCompositeOperation="destination-out";b.beginPath();a=0;for(d=D.length;a<d;a++){k=D[a];b.moveTo(k[0],k[1]);h=2;for(g=k.length;h<g;h+=2)b.lineTo(k[h],k[h+1]);b.lineTo(k[0],k[1]);b.closePath()}b.fillStyle="#00ff00";b.fill();b.globalCompositeOperation="source-over"}},project:function(b,
a,d){return{x:b+this.directionX*d,y:a+this.directionY*d}},setDate:function(b){this.date=b;this.render()}},ta={context:null,maxHeight:8,init:function(b){this.context=b},render:function(){var b=this.context;b.clearRect(0,0,p,z);if(B&&s&&!(J<Y||ka)){var a,d,c,f,e,g,j,k=C-B.x,m=F-B.y,l,n;b.beginPath();a=0;for(d=s.length;a<d;a++){c=s[a];n=!1;e=c[G];l=[];c=0;for(f=e.length-1;c<f;c+=2)l[c]=g=e[c]-k,l[c+1]=j=e[c+1]-m,n||(n=0<g&&g<p&&0<j&&j<z);if(n){c=0;for(f=l.length-3;c<f;c+=2)n=l[c],e=l[c+1],c?b.lineTo(n,
e):b.moveTo(n,e);b.closePath()}}b.fillStyle=ja;b.strokeStyle=ia;b.stroke();b.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)S=j.parse(a.color||a.wallColor),za=S.adjustAlpha(M)+"",sa=S.adjustLightness(0.8),ia=sa.adjustAlpha(M)+"",P=S.adjustLightness(1.2),ja=P.adjustAlpha(M)+"";a.roofColor&&(P=j.parse(a.roofColor),ja=P.adjustAlpha(M)+"");ma();return this};this.geoJSON=function(b,c){if("object"===typeof b)n(b,!c);else{var d=pa.documentElement,
e=pa.createElement("script");a.jsonpCallback=function(b){delete a.jsonpCallback;d.removeChild(e);n(b,!c)};d.insertBefore(e,d.lastChild).src=b.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,c){N=U+a;la=z+c};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return $.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=c(C,F),e=c(C+p,F+z);ma();B&&(a[da]>B.n||a[ea]<B.w||e[da]<B.s||e[ea]>B.e)&&f()};this.onZoomEnd=
function(a){ka=!1;K(a.zoom);ha?(s=q(ha),ma()):(aa(),f())};this.onZoomStart=function(){ka=!0;ma()};this.setOrigin=function(a,c){C=a;F=c};this.setSize=function(a,c){p=a;z=c;U=p/2<<0;I=z/2<<0;N=U;la=z;Z=p/(1.5/(window.devicePixelRatio||1))/va(45)<<0;$.setSize(p,z);ga=Z-50};this.setZoom=K;this.render=aa;xa=e};a.OSMBuildings.VERSION="0.1.8a";a.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),v=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(v.x-a.x,v.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),v=this.map.getPixelOrigin();this.osmb.setOrigin(v.x-a.x,v.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var v=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(v.x-a.x,v.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(a,v){return this.osmb.geoJSON(a,v)},setStyle:function(a){return this.osmb.setStyle(a)},
setDate:function(a){return this.osmb.setDate(a)}});
