(function(h){function E(j){for(var m,x=[j[0],j[1]],c,f=[j[0],j[1]],k=2,p=j.length-3;k<p;k+=2){m=[j[k],j[k+1]];c=[j[k+2]||j[0],j[k+3]||j[1]];var t=x,q=t[0],u=t[1],F=c[0]-q,v=c[1]-u,y=void 0;if(F!==0||v!==0){y=((m[0]-q)*F+(m[1]-u)*v)/(F*F+v*v);if(y>1){q=c[0];u=c[1]}else if(y>0){q+=F*y;u+=v*y}}q=ka(m,[q,u])*2;c=ka(t,c);if(q*c>750){f.push(m[0],m[1]);x=m}}if(m[0]!==j[0]||m[1]!==j[1])f.push(j[0],j[1]);return f}function ka(j,m){var x=j[0]-m[0],c=j[1]-m[1];return x*x+c*c}function Ba(j){for(var m=0,x=0,c=
0,f=j.length-3;c<f;c+=2){m+=j[c];x+=j[c+1]}j=(j.length-2)*2;return[m/j<<0,x/j<<0]}var Ca=Ca||Array,Ha=Math.exp,Ia=Math.log,Ja=Math.tan,Ka=Math.atan,qa=Math.min,La=Math.max,ra=h.document,J=function(){function j(c,f,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return c+(f-c)*6*k;if(k<0.5)return f;if(k<2/3)return c+(f-c)*(2/3-k)*6;return c}function m(c,f,k,p){this.r=c;this.g=f;this.b=k;this.a=arguments.length<4?1:p}var x=m.prototype;x.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};x.adjustLightness=function(c){var f=J.toHSLA(this);f.l*=c;f.l=Math.min(1,Math.max(0,f.l));var k,p;if(f.s===0)c=k=p=f.l;else{p=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var t=2*f.l-p;c=j(t,p,f.h+1/3);k=j(t,p,f.h);p=j(t,p,f.h-1/3)}return new J(c*255<<0,k*255<<0,p*255<<0,f.a)};x.adjustAlpha=function(c){return new J(this.r,this.g,this.b,this.a*c)};m.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new J(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],
16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new J(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};m.toHSLA=function(c){var f=c.r/255,k=c.g/255,p=c.b/255,t=Math.max(f,k,p),q=Math.min(f,k,p),u,F=(t+q)/2,v;if(t===q)u=q=0;else{v=t-q;q=F>0.5?v/(2-t-q):v/(t+q);switch(t){case f:u=(k-p)/v+(k<p?6:0);break;case k:u=(p-f)/v+2;break;case p:u=(f-k)/v+4;break}u/=6}return{h:u,s:q,l:F,a:c.a}};return m}(),$=Math.PI,Da=$/2,
Ma=$/4,Na=180/$,Oa=256,sa=14,ta=400,Ea=ta-50,aa="latitude",ba="longitude",O=0,K=1,S=2,la=3,ma=4,P=5;h.OSMBuildings=function(j){function m(a,e){var b={};a/=ca;e/=ca;b[aa]=e<=0?90:e>=1?-90:Na*(2*Ka(Ha($*(1-2*e)))-Da);b[ba]=(a===1?1:(a%1+1)%1)*360-180;return b}function x(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function f(){if(!(!ua||I<sa)){var a=m(Y-da,Z-va),e=m(Y+U+da,Z+Q+va);na&&na.abort();na=c(x(ua,{w:a[ba],n:a[aa],e:e[ba],s:e[aa],z:I}),k)}}function k(a){var e,b,d,l=[],g,i=g=0;ea=sa;F(I);na=null;if(!(!a||a.meta.z!==I)){d=a.meta;b=a.data;if(z&&s&&z.z===d.z){g=z.x-d.x;i=z.y-d.y;a=0;for(e=s.length;a<e;a++)l[a]=s[a][K][0]+g+","+(s[a][K][1]+i)}z=d;s=[];a=0;for(e=b.length;a<e;a++){d=[];g=E(b[a][K]);if(!(g.length<8)){d[K]=g;d[la]=Ba(g);d[O]=qa(b[a][O],Ea);g=d[K][0]+","+
d[K][1];d[ma]=!(l&&~l.indexOf(g));d[S]=[];d[P]=[];s.push(d)}}v()}}function p(a,e){var b=[],d,l,g,i,n,A,o,r,B=wa-I;d=0;for(l=a.length;d<l;d++){n=a[d];A=n[K];r=new Ca(A.length);g=0;for(i=A.length-1;g<i;g+=2){o=A[g+1];var M=qa(1,La(0,0.5-Ia(Ja(Ma+Da*A[g]/180))/$/2));o={x:(o/360+0.5)*ca<<0,y:M*ca<<0};r[g]=o.x;r[g+1]=o.y}r=E(r);if(!(r.length<8)){i=[];i[K]=r;i[la]=Ba(r);i[O]=qa(n[O]>>B,Ea);i[ma]=e;i[S]=n[S];i[P]=[];for(g=0;g<3;g++)if(i[S][g])i[P][g]=i[S][g].adjustAlpha(R)+"";b.push(i)}}return b}function t(a,
e){if(typeof a==="object")u(a,!e);else{var b=ra.documentElement,d=ra.createElement("script");h.jsonpCallback=function(l){delete h.jsonpCallback;b.removeChild(d);u(l,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function q(a,e,b){if(b===undefined)b=[];var d,l,g,i=a[0]?a:a.features,n,A,o,r,B,M=e?1:0,G=e?0:1;if(i){d=0;for(a=i.length;d<a;d++)q(i[d],e,b);return b}if(a.type==="Feature"){n=a.geometry;d=a.properties}if(n.type==="Polygon")A=[n.coordinates];if(n.type==="MultiPolygon")A=
n.coordinates;if(A){e=d.height;if(d.color||d.wallColor)r=J.parse(d.color||d.wallColor);if(d.roofColor)B=J.parse(d.roofColor);d=0;for(a=A.length;d<a;d++){i=A[d][0];o=[];l=n=0;for(g=i.length;l<g;l++){o.push(i[l][M],i[l][G]);n+=e||i[l][2]||0}if(n){l=[];g=K;var H=void 0,C=void 0,N=void 0,fa=void 0,ga=0,V=void 0,Fa=void 0;V=0;for(Fa=o.length-3;V<Fa;V+=2){H=o[V];C=o[V+1];N=o[V+2];fa=o[V+3];ga+=H*fa-N*C}if((ga/2>0?"CW":"CCW")==="CW")o=o;else{H=[];for(C=o.length-2;C>=0;C-=2)H.push(o[C],o[C+1]);o=H}l[g]=o;
l[O]=n/i.length<<0;l[S]=[r||null,r?r.adjustLightness(0.8):null,B?B:r?r.adjustLightness(1.2):null];b.push(l)}}}return b}function u(a,e){if(a){ha=q(a,e);ea=0;F(I);z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:I};s=p(ha,true);v()}else{ha=null;y()}}function F(a){var e,b,d;I=a;ca=Oa<<I;R=1-(I-ea)*0.3/(wa-ea);xa=T.adjustAlpha(R)+"";oa=pa.adjustAlpha(R)+"";ya=ia.adjustAlpha(R)+"";if(s){a=0;for(e=s.length;a<e;a++){d=s[a];d[P]=[];for(b=0;b<3;b++)if(d[S][b])d[P][b]=d[S][b].adjustAlpha(R)+""}}}function v(){ja=0;clearInterval(za);
za=setInterval(function(){ja+=0.1;if(ja>1){clearInterval(za);ja=1;for(var a=0,e=s.length;a<e;a++)s[a][ma]=0}y()},33)}function y(){w.clearRect(0,0,U,Q);if(z&&s)if(!(I<ea||Aa)){var a,e,b,d,l,g,i,n,A=Y-z.x,o=Z-z.y,r=[W+A,X+o],B,M,G,H,C,N;s.sort(function(fa,ga){return ka(ga[la],r)/ga[O]-ka(fa[la],r)/fa[O]});a=0;for(e=s.length;a<e;a++){l=s[a];G=false;g=l[K];B=[];b=0;for(d=g.length-1;b<d;b+=2){B[b]=i=g[b]-A;B[b+1]=n=g[b+1]-o;G||(G=i>0&&i<U&&n>0&&n<Q)}if(G){b=l[ma]?l[O]*ja:l[O];g=ta/(ta-b);i=[];M=[];b=0;
for(d=B.length-3;b<d;b+=2){n=B[b];G=B[b+1];H=B[b+2];C=B[b+3];N={x:((n-W)*g+W<<0)+0.5,y:((G-X)*g+X<<0)+0.5};M={x:((H-W)*g+W<<0)+0.5,y:((C-X)*g+X<<0)+0.5};if((H-n)*(N.y-G)>(N.x-n)*(C-G)){M=[H+0.5,C+0.5,n+0.5,G+0.5,N.x,N.y,M.x,M.y];w.fillStyle=n<H&&G<C||n>H&&G>C?l[P][1]||oa:l[P][0]||xa;Ga(M)}i[b]=N.x;i[b+1]=N.y}w.fillStyle=l[P][2]||ya;w.strokeStyle=l[P][1]||oa;Ga(i,true)}}}}function Ga(a,e){if(a.length){w.beginPath();w.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)w.lineTo(a[b],a[b+1]);w.closePath();
e&&w.stroke();w.fill()}}var U=0,Q=0,da=0,va=0,Y=0,Z=0,I,ca,na,D,w,ua,T=new J(200,190,180),pa=T.adjustLightness(0.8),ia=T.adjustLightness(1.2),xa=T+"",oa=pa+"",ya=ia+"",ha,z,s,ja=1,za,R=1,ea=sa,wa=20,W,X,Aa;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){T=J.parse(a.color||a.wallColor);pa=T.adjustLightness(0.8);ia=T.adjustLightness(1.2);xa=T.adjustAlpha(R)+"";oa=pa.adjustAlpha(R)+""}if(a.roofColor)ia=J.parse(a.roofColor);ya=ia.adjustAlpha(R)+"";y();return this};this.geoJSON=function(a,
e){t(a,e);return this};this.setCamOffset=function(a,e){W=da+a;X=Q+e};this.setMaxZoom=function(a){wa=a};this.createCanvas=function(a){D=ra.createElement("canvas");D.style.webkitTransform="translate3d(0,0,0)";D.style.imageRendering="optimizeSpeed";D.style.position="absolute";D.style.pointerEvents="none";D.style.left=0;D.style.top=0;a.appendChild(D);w=D.getContext("2d");w.lineCap="round";w.lineJoin="round";w.lineWidth=1;try{w.mozImageSmoothingEnabled=false}catch(e){}return D};this.destroyCanvas=function(){D.parentNode.removeChild(D)};
this.loadData=f;this.onMoveEnd=function(){var a=m(Y,Z),e=m(Y+U,Z+Q);y();if(z&&(a[aa]>z.n||a[ba]<z.w||e[aa]<z.s||e[ba]>z.e))f()};this.onZoomEnd=function(a){Aa=false;F(a.zoom);if(ha){s=p(ha);y()}else{y();f()}};this.onZoomStart=function(){Aa=true;y()};this.render=y;this.setOrigin=function(a,e){Y=a;Z=e};this.setSize=function(a,e){U=a;Q=e;da=U/2<<0;va=Q/2<<0;W=da;X=Q;D.width=U;D.height=Q};this.setZoom=F;ua=j};h.OSMBuildings.VERSION="0.1.7a";h.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(h){L.Util.setOptions(this,h)},onMove:function(){var h=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-h.x,this.lastY-h.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var h=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.lastX=h.x;this.lastY=h.y;this.canvas.style.left=-h.x+"px";
this.canvas.style.top=-h.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-h.x,E.y-h.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var h=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.osmb.setOrigin(E.x-h.x,E.y-h.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(h){h.addLayer(this);return this},onAdd:function(h){this.map=h;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;h=L.DomUtil.getPosition(this.map._mapPane);var E=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-h.x,E.y-h.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-h.x+"px";this.canvas.style.top=-h.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(h){h.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);h.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(h,E){return this.osmb.geoJSON(h,E)},
setStyle:function(h){return this.osmb.setStyle(h)}});
