(function(g){function F(k){for(var m,A=[k[0],k[1]],d,f=[k[0],k[1]],l=2,q=k.length-3;l<q;l+=2){m=[k[l],k[l+1]];d=[k[l+2]||k[0],k[l+3]||k[1]];var w=A,s=w[0],x=w[1],G=d[0]-s,y=d[1]-x,B=void 0;if(G!==0||y!==0){B=((m[0]-s)*G+(m[1]-x)*y)/(G*G+y*y);if(B>1){s=d[0];x=d[1]}else if(B>0){s+=G*B;x+=y*B}}s=na(m,[s,x])*2;d=na(w,d);if(s*d>750){f.push(m[0],m[1]);A=m}}if(m[0]!==k[0]||m[1]!==k[1])f.push(k[0],k[1]);return f}function na(k,m){var A=k[0]-m[0],d=k[1]-m[1];return A*A+d*d}function Da(k){for(var m=0,A=0,d=
0,f=k.length-3;d<f;d+=2){m+=k[d];A+=k[d+1]}k=(k.length-2)*2;return[m/k<<0,A/k<<0]}var Ea=Ea||Array,Ja=Math.exp,Ka=Math.log,La=Math.tan,Ma=Math.atan,ua=Math.min,Na=Math.max,va=g.document,J=function(){function k(d,f,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return d+(f-d)*6*l;if(l<0.5)return f;if(l<2/3)return d+(f-d)*(2/3-l)*6;return d}function m(d,f,l,q){this.r=d;this.g=f;this.b=l;this.a=arguments.length<4?1:q}var A=m.prototype;A.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+
")"};A.adjustLightness=function(d){var f=J.toHSLA(this);f.l*=d;f.l=Math.min(1,Math.max(0,f.l));var l,q;if(f.s===0)d=l=q=f.l;else{q=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var w=2*f.l-q;d=k(w,q,f.h+1/3);l=k(w,q,f.h);q=k(w,q,f.h-1/3)}return new J(d*255<<0,l*255<<0,q*255<<0,f.a)};A.adjustAlpha=function(d){return new J(this.r,this.g,this.b,this.a*d)};m.parse=function(d){d+="";if(~d.indexOf("#")){d=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new J(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],
16),d[4]?parseInt(d[4],16)/255:1)}if(d=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new J(parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5],10):1)};m.toHSLA=function(d){var f=d.r/255,l=d.g/255,q=d.b/255,w=Math.max(f,l,q),s=Math.min(f,l,q),x,G=(w+s)/2,y;if(w===s)x=s=0;else{y=w-s;s=G>0.5?y/(2-w-s):y/(w+s);switch(w){case f:x=(l-q)/y+(l<q?6:0);break;case l:x=(q-f)/y+2;break;case q:x=(f-l)/y+4;break}x/=6}return{h:x,s:s,l:G,a:d.a}};return m}(),ba=Math.PI,Fa=ba/
2,Oa=ba/4,Pa=180/ba,Qa=256,wa=14,ca=400,Ga=ca-50,da="latitude",ea="longitude",P=0,W=1,K=2,S=3,oa=4,fa=5,Q=6;g.OSMBuildings=function(k){function m(a,e){var b={};a/=ga;e/=ga;b[da]=e<=0?90:e>=1?-90:Pa*(2*Ma(Ja(ba*(1-2*e)))-Fa);b[ea]=(a===1?1:(a%1+1)%1)*360-180;return b}function A(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return e[c]})}function d(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function f(){if(!(!xa||I<wa)){var a=m(Z-ha,$-ya),e=m(Z+X+ha,$+R+ya);pa&&pa.abort();pa=d(A(xa,{w:a[ea],n:a[da],e:e[ea],s:e[da],z:I}),l)}}function l(a){var e,b,c,i=[],h,j=h=0;ia=wa;G(I);pa=null;if(!(!a||a.meta.z!==I)){c=a.meta;b=a.data;if(C&&v&&C.z===c.z){h=C.x-c.x;j=C.y-c.y;a=0;for(e=v.length;a<e;a++)i[a]=v[a][K][0]+h+","+(v[a][K][1]+j)}C=c;v=[];a=0;for(e=b.length;a<e;a++){c=[];h=F(b[a][K]);if(!(h.length<8)){c[K]=h;c[oa]=Da(h);c[P]=ua(b[a][P],Ga);c[W]=b[a][W];
h=c[K][0]+","+c[K][1];c[fa]=!(i&&~i.indexOf(h));c[S]=[];c[Q]=[];v.push(c)}}y()}}function q(a,e){var b=[],c,i,h,j,o,n,p,t,T=za-I;c=0;for(i=a.length;c<i;c++){o=a[c];n=o[K];t=new Ea(n.length);h=0;for(j=n.length-1;h<j;h+=2){p=n[h+1];var H=ua(1,Na(0,0.5-Ka(La(Oa+Fa*n[h]/180))/ba/2));p={x:(p/360+0.5)*ga<<0,y:H*ga<<0};t[h]=p.x;t[h+1]=p.y}t=F(t);if(!(t.length<8)){j=[];j[K]=t;j[oa]=Da(t);j[P]=ua(o[P]>>T,Ga);j[W]=o[W];j[fa]=e;j[S]=o[S];j[Q]=[];for(h=0;h<3;h++)if(j[S][h])j[Q][h]=j[S][h].adjustAlpha(M)+"";b.push(j)}}return b}
function w(a,e){if(typeof a==="object")x(a,!e);else{var b=va.documentElement,c=va.createElement("script");g.jsonpCallback=function(i){delete g.jsonpCallback;b.removeChild(c);x(i,!e)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function s(a,e,b){if(b===undefined)b=[];var c,i,h,j=a[0]?a:a.features,o,n,p,t,T,H=e?1:0,U=e?0:1;if(j){c=0;for(a=j.length;c<a;c++)s(j[c],e,b);return b}if(a.type==="Feature"){o=a.geometry;c=a.properties}if(o.type==="Polygon")n=[o.coordinates];
if(o.type==="MultiPolygon")n=o.coordinates;if(n){e=c.height;if(c.color||c.wallColor)t=J.parse(c.color||c.wallColor);if(c.roofColor)T=J.parse(c.roofColor);c=0;for(a=n.length;c<a;c++){j=n[c][0];p=[];i=o=0;for(h=j.length;i<h;i++){p.push(j[i][H],j[i][U]);o+=e||j[i][2]||0}if(o){i=[];h=K;var u=void 0,r=void 0,D=void 0,N=void 0,ja=0,O=void 0,Ha=void 0;O=0;for(Ha=p.length-3;O<Ha;O+=2){u=p[O];r=p[O+1];D=p[O+2];N=p[O+3];ja+=u*N-D*r}if((ja/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(r=p.length-2;r>=0;r-=2)u.push(p[r],
p[r+1]);p=u}i[h]=p;i[P]=o/j.length<<0;i[S]=[t||null,t?t.adjustLightness(0.8):null,T?T:t?t.adjustLightness(1.2):Y];b.push(i)}}}return b}function x(a,e){if(a){ka=s(a,e);ia=0;G(I);C={n:90,w:-180,s:-90,e:180,x:0,y:0,z:I};v=q(ka,true);y()}else{ka=null;B()}}function G(a){var e,b,c;I=a;ga=Qa<<I;M=1-(I-ia)*0.3/(za-ia);Aa=V.adjustAlpha(M)+"";qa=ra.adjustAlpha(M)+"";sa=Y.adjustAlpha(M)+"";if(v){a=0;for(e=v.length;a<e;a++){c=v[a];c[Q]=[];for(b=0;b<3;b++)if(c[S][b])c[Q][b]=c[S][b].adjustAlpha(M)+""}}}function y(){aa=
0;clearInterval(Ba);Ba=setInterval(function(){aa+=0.1;if(aa>1){clearInterval(Ba);aa=1;for(var a=0,e=v.length;a<e;a++)v[a][fa]=0}B()},33)}function B(){z.clearRect(0,0,X,R);if(C&&v)if(!(I<ia||Ca)){var a,e,b,c,i,h,j,o,n,p=Z-C.x,t=$-C.y,T=[la+p,ma+t],H,U,u,r,D,N;v.sort(function(ja,O){return na(O[oa],T)/O[P]-na(ja[oa],T)/ja[P]});a=0;for(e=v.length;a<e;a++){i=v[a];u=false;h=i[K];H=[];b=0;for(c=h.length-1;b<c;b+=2){H[b]=o=h[b]-p;H[b+1]=n=h[b+1]-t;u||(u=o>0&&o<X&&n>0&&n<R)}if(u){b=i[fa]?i[P]*aa:i[P];h=ca/
(ca-b);o=[];U=[];b=0;for(c=H.length-3;b<c;b+=2){n=H[b];r=H[b+1];u=H[b+2];D=H[b+3];N=ta(n,r,h);U=ta(u,D,h);if(i[W]){j=i[fa]?i[W]*aa:i[W];j=ca/(ca-j);r=ta(n,r,j);D=ta(u,D,j);n=r.x;r=r.y;u=D.x;D=D.y}if((u-n)*(N.y-r)>(N.x-n)*(D-r)){U=[u+0.5,D+0.5,n+0.5,r+0.5,N.x,N.y,U.x,U.y];z.fillStyle=n<u&&r<D||n>u&&r>D?i[Q][1]||qa:i[Q][0]||Aa;Ia(U)}o[b]=N.x;o[b+1]=N.y}z.fillStyle=i[Q][2]||sa;z.strokeStyle=i[Q][1]||qa;Ia(o,true)}}}}function Ia(a,e){if(a.length){z.beginPath();z.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<
c;b+=2)z.lineTo(a[b],a[b+1]);z.closePath();e&&z.stroke();z.fill()}}function ta(a,e,b){return{x:((a-la)*b+la<<0)+0.5,y:((e-ma)*b+ma<<0)+0.5}}var X=0,R=0,ha=0,ya=0,Z=0,$=0,I,ga,pa,E,z,xa,V=new J(200,190,180),ra=V.adjustLightness(0.8),Y=V.adjustLightness(1.2),Aa=V+"",qa=ra+"",sa=Y+"",ka,C,v,aa=1,Ba,M=1,ia=wa,za=20,la,ma,Ca;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){V=J.parse(a.color||a.wallColor);Aa=V.adjustAlpha(M)+"";ra=V.adjustLightness(0.8);qa=ra.adjustAlpha(M)+"";Y=V.adjustLightness(1.2);
sa=Y.adjustAlpha(M)+""}if(a.roofColor){Y=J.parse(a.roofColor);sa=Y.adjustAlpha(M)+""}B();return this};this.geoJSON=function(a,e){w(a,e);return this};this.setCamOffset=function(a,e){la=ha+a;ma=R+e};this.setMaxZoom=function(a){za=a};this.createCanvas=function(a){E=va.createElement("canvas");E.style.webkitTransform="translate3d(0,0,0)";E.style.imageRendering="optimizeSpeed";E.style.position="absolute";E.style.pointerEvents="none";E.style.left=0;E.style.top=0;a.appendChild(E);z=E.getContext("2d");z.lineCap=
"round";z.lineJoin="round";z.lineWidth=1;try{z.mozImageSmoothingEnabled=false}catch(e){}return E};this.destroyCanvas=function(){E.parentNode.removeChild(E)};this.loadData=f;this.onMoveEnd=function(){var a=m(Z,$),e=m(Z+X,$+R);B();if(C&&(a[da]>C.n||a[ea]<C.w||e[da]<C.s||e[ea]>C.e))f()};this.onZoomEnd=function(a){Ca=false;G(a.zoom);if(ka){v=q(ka);B()}else{B();f()}};this.onZoomStart=function(){Ca=true;B()};this.render=B;this.setOrigin=function(a,e){Z=a;$=e};this.setSize=function(a,e){X=a;R=e;ha=X/2<<
0;ya=R/2<<0;la=ha;ma=R;E.width=X;E.height=R};this.setZoom=G;xa=k};g.OSMBuildings.VERSION="0.1.7a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),F=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.canvas.style.left=-g.x+"px";
this.canvas.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(F.x-g.x,F.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),F=this.map.getPixelOrigin();this.osmb.setOrigin(F.x-g.x,F.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=g;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;g=L.DomUtil.getPosition(this.map._mapPane);var F=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(F.x-g.x,F.y-g.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-g.x+"px";this.canvas.style.top=-g.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(g,F){return this.osmb.geoJSON(g,F)},
setStyle:function(g){return this.osmb.setStyle(g)}});
