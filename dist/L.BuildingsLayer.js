(function(h){var v=v||Array,ya=Math.exp,za=Math.log,Aa=Math.tan,Ba=Math.atan,ja=Math.min,ta=Math.max,ka=h.document,C=function(){function W(g,j,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return g+(j-g)*6*l;if(l<0.5)return j;if(l<2/3)return g+(j-g)*(2/3-l)*6;return g}function H(g,j,l,o){this.r=g;this.g=j;this.b=l;this.a=arguments.length<4?1:o}var X=H.prototype;X.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};X.adjustLightness=function(g){var j=C.toHSLA(this);j.l*=
g;j.l=Math.min(1,Math.max(0,j.l));var l,o;if(j.s===0)g=l=o=j.l;else{o=j.l<0.5?j.l*(1+j.s):j.l+j.s-j.l*j.s;var z=2*j.l-o;g=W(z,o,j.h+1/3);l=W(z,o,j.h);o=W(z,o,j.h-1/3)}return new C(g*255<<0,l*255<<0,o*255<<0,j.a)};X.adjustAlpha=function(g){return new C(this.r,this.g,this.b,this.a*g)};H.parse=function(g){g+="";if(~g.indexOf("#")){g=g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new C(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new C(parseInt(g[1],
10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};H.toHSLA=function(g){var j=g.r/255,l=g.g/255,o=g.b/255,z=Math.max(j,l,o),D=Math.min(j,l,o),I,O=(z+D)/2,J;if(z===D)I=D=0;else{J=z-D;D=O>0.5?J/(2-z-D):J/(z+D);switch(z){case j:I=(l-o)/J+(l<o?6:0);break;case l:I=(o-j)/J+2;break;case o:I=(j-l)/J+4;break}I/=6}return{h:I,s:D,l:O,a:g.a}};return H}(),Y=Math.PI,ua=Y/2,Ca=Y/4,Da=180/Y,Ea=256,la=14,ma=400,va=ma-50,Z="latitude",$="longitude",P=0,E=1,w=2,fa=3;h.OSMBuildings=function(W){function H(a,
d){var b={};a/=aa;d/=aa;b[Z]=d<=0?90:d>=1?-90:Da*(2*Ba(ya(Y*(1-2*d)))-ua);b[$]=(a===1?1:(a%1+1)%1)*360-180;return b}function X(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function g(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function j(){if(!(!na||A<la)){var a=H(R-ba,S-oa),d=H(R+Q+ba,S+K+oa);ga&&ga.abort();ga=g(X(na,
{w:a[$],n:a[Z],e:d[$],s:d[Z],z:A}),l)}}function l(a){var d,b,c,f=[],i,e=i=0,m=ta(1,(A-T)*2);T=la;O(A);ga=null;if(!(!a||a.meta.z!==A)){c=a.meta;b=a.data;if(t&&x&&t.z===c.z){i=t.x-c.x;e=t.y-c.y;a=0;for(d=x.length;a<d;a++)f[a]=x[a][E][0]+i+","+(x[a][E][1]+e)}t=c;x=[];a=0;for(d=b.length;a<d;a++){c={};i=E;e=b[a][E];for(var q=m*m,k=void 0,n=[e[0],e[1]],s=[e[0],e[1]],p=2,F=e.length-3;p<F;p+=2){k=[e[p],e[p+1]];var B=k[0]-n[0],y=k[1]-n[1];if(B*B+y*y>q){s.push(k[0],k[1]);n=k}}if(k[0]!==e[0]||k[1]!==e[1])s.push(e[0],
e[1]);c[i]=s;if(!(c[E].length<8)){c[P]=ja(b[a][P],va);i=b[a][E][0]+","+b[a][E][1];c[fa]=!(f&&~f.indexOf(i));x.push(c)}}J()}}function o(a,d){var b=[],c,f,i,e,m,q,k,n,s=pa-A;c=0;for(f=a.length;c<f;c++){m=a[c];q=m[E];k=new v(q.length);i=0;for(e=q.length-1;i<e;i+=2){n=q[i+1];var p=ja(1,ta(0,0.5-za(Aa(Ca+ua*q[i]/180))/Y/2));n={x:(n/360+0.5)*aa<<0,y:p*aa<<0};k[i]=n.x;k[i+1]=n.y}b[c]=[];b[c][P]=ja(m[P]>>s,va);b[c][E]=k;b[c][w]=m[w];b[c][fa]=d}return b}function z(a,d){if(typeof a==="object")I(a,!d);else{var b=
ka.documentElement,c=ka.createElement("script");h.jsonpCallback=function(f){delete h.jsonpCallback;b.removeChild(c);I(f,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,d,b){if(b===undefined)b=[];var c,f,i,e=a[0]?a:a.features,m,q,k,n,s,p=d?1:0,F=d?0:1;if(e){c=0;for(a=e.length;c<a;c++)D(e[c],d,b);return b}if(a.type==="Feature"){f=a.geometry;c=a.properties}if(f.type==="Polygon")m=[f.coordinates];if(f.type==="MultiPolygon")m=f.coordinates;if(m){d=c.height;
if(c.color||c.wallColor)n=C.parse(c.color||c.wallColor);if(c.roofColor)s=C.parse(c.roofColor);c=0;for(a=m.length;c<a;c++){q=m[c][0];e=[];f=k=0;for(i=q.length;f<i;f++){e.push(q[f][p],q[f][F]);k+=d||q[f][2]||0}if(k){f=[];f[P]=k/q.length<<0;q=E;k=void 0;i=void 0;var B=void 0,y=void 0,ca=0,G=void 0,wa=void 0;G=0;for(wa=e.length-3;G<wa;G+=2){k=e[G];i=e[G+1];B=e[G+2];y=e[G+3];ca+=k*y-B*i}if((ca/2>0?"CW":"CCW")==="CW")e=e;else{k=[];for(i=e.length-2;i>=0;i-=2)k.push(e[i],e[i+1]);e=k}f[q]=e;if(n||s)f[w]=[n,
s];b.push(f)}}}return b}function I(a,d){if(a){da=D(a,d);T=0;O(A);t={n:90,w:-180,s:-90,e:180,x:0,y:0,z:A};x=o(da,true);J()}else{da=null;N()}}function O(a){A=a;aa=Ea<<A;M=1-(A-T)*0.3/(pa-T)}function J(){ea=0;clearInterval(qa);qa=setInterval(function(){ea+=0.1;if(ea>1){clearInterval(qa);ea=1;for(var a=0,d=x.length;a<d;a++)x[a][fa]=0}N()},33)}function N(){r.clearRect(0,0,Q,K);if(t&&x)if(!(A<T||ra)){var a,d,b,c,f,i,e,m,q=R-t.x,k=S-t.y,n,s,p,F,B,y,ca=ha.adjustAlpha(M)+"",G=(sa||ha.adjustLightness(1.2)).adjustAlpha(M)+
"";if(ia)r.strokeStyle=Fa.adjustAlpha(M)+"";a=0;for(d=x.length;a<d;a++){f=x[a];p=false;i=f[E];n=[];b=0;for(c=i.length-1;b<c;b+=2){n[b]=e=i[b]-q;n[b+1]=m=i[b+1]-k;p||(p=e>0&&e<Q&&m>0&&m<K)}if(p){r.fillStyle=f[w]&&f[w][0]?f[w][0].adjustAlpha(M)+"":ca;b=f[fa]?f[P]*ea:f[P];i=ma/(ma-b);e=[];b=0;for(c=n.length-3;b<c;b+=2){m=n[b];p=n[b+1];F=n[b+2];B=n[b+3];y={x:((m-U)*i+U<<0)+0.5,y:((p-V)*i+V<<0)+0.5};s={x:((F-U)*i+U<<0)+0.5,y:((B-V)*i+V<<0)+0.5};if((F-m)*(y.y-p)>(y.x-m)*(B-p)){s=[F+0.5,B+0.5,m+0.5,p+0.5,
y.x,y.y,s.x,s.y];r.fillStyle=m<F&&p<B||m>F&&p>B?ha.adjustAlpha(M).adjustLightness(0.8)+"":f[w]&&f[w][0]?f[w][0].adjustAlpha(M)+"":ca;xa(s)}e[b]=y.x;e[b+1]=y.y}r.fillStyle=!f[w]?G:f[w][1]?f[w][1].adjustAlpha(M)+"":sa?G:f[w][0].adjustLightness(1.2).adjustAlpha(M)+"";xa(e,ia)}}}}function xa(a,d){if(a.length){r.beginPath();r.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)r.lineTo(a[b],a[b+1]);r.closePath();d&&r.stroke();r.fill()}}var Q=0,K=0,ba=0,oa=0,R=0,S=0,A,aa,ga,u,r,na,ia,ha=new C(200,190,180),
sa,Fa=new C(145,140,135),da,t,x,M=1,ea=1,qa,T=la,pa=20,U,V,ra;this.setStyle=function(a){a=(a=a)||{};ia=a.strokeRoofs!==undefined?a.strokeRoofs:ia;if(a.color||a.wallColor)ha=C.parse(a.color||a.wallColor);if(a.roofColor!==undefined)sa=C.parse(a.roofColor);N();return this};this.geoJSON=function(a,d){z(a,d);return this};this.setCamOffset=function(a,d){U=ba+a;V=K+d};this.setMaxZoom=function(a){pa=a};this.createCanvas=function(a){u=ka.createElement("canvas");u.style.webkitTransform="translate3d(0,0,0)";
u.style.imageRendering="optimizeSpeed";u.style.position="absolute";u.style.pointerEvents="none";u.style.left=0;u.style.top=0;a.appendChild(u);r=u.getContext("2d");r.lineCap="round";r.lineJoin="round";r.lineWidth=1;try{r.mozImageSmoothingEnabled=false}catch(d){}return u};this.destroyCanvas=function(){u.parentNode.removeChild(u)};this.loadData=j;this.onMoveEnd=function(){var a=H(R,S),d=H(R+Q,S+K);N();if(t&&(a[Z]>t.n||a[$]<t.w||d[Z]<t.s||d[$]>t.e))j()};this.onZoomEnd=function(a){ra=false;O(a.zoom);if(da){x=
o(da);N()}else{N();j()}};this.onZoomStart=function(){ra=true;N()};this.render=N;this.setOrigin=function(a,d){R=a;S=d};this.setSize=function(a,d){Q=a;K=d;ba=Q/2<<0;oa=K/2<<0;U=ba;V=K;u.width=Q;u.height=K};this.setZoom=O;na=W};h.OSMBuildings.VERSION="0.1.7a";h.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(h){L.Util.setOptions(this,h)},onMove:function(){var h=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-h.x,this.lastY-h.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var h=L.DomUtil.getPosition(this.map._mapPane),v=this.map.getPixelOrigin();this.lastX=h.x;this.lastY=h.y;this.canvas.style.left=-h.x+"px";
this.canvas.style.top=-h.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(v.x-h.x,v.y-h.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var h=L.DomUtil.getPosition(this.map._mapPane),v=this.map.getPixelOrigin();this.osmb.setOrigin(v.x-h.x,v.y-h.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(h){h.addLayer(this);return this},onAdd:function(h){this.map=h;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;h=L.DomUtil.getPosition(this.map._mapPane);var v=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(v.x-h.x,v.y-h.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-h.x+"px";this.canvas.style.top=-h.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(h){h.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);h.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(h,v){return this.osmb.geoJSON(h,v)},
setStyle:function(h){return this.osmb.setStyle(h)}});
