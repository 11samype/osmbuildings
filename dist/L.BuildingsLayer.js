(function(k){function N(o,q){var w=o[0]-q[0],g=o[1]-q[1];return w*w+g*g}function La(o){for(var q=0,w=0,g=0,i=o.length-3;g<i;g+=2){q+=o[g];w+=o[g+1]}o=(o.length-2)*2;return[q/o<<0,w/o<<0]}function Ma(o){var q=o.length/2,w=new Na(q),g=0,i=q-1,l,v,r,E,H=[],O=[],J=[];for(w[g]=w[i]=1;i;){v=0;for(l=g+1;l<i;l++){r=o[l*2];var Z=o[l*2+1],V=o[g*2],K=o[g*2+1],ia=o[i*2],$=o[i*2+1],s=ia-V,p=$-K,C=void 0;if(s!==0||p!==0){C=((r-V)*s+(Z-K)*p)/(s*s+p*p);if(C>1){V=ia;K=$}else if(C>0){V+=s*C;K+=p*C}}s=r-V;p=Z-K;r=s*
s+p*p;if(r>v){E=l;v=r}}if(v>2){w[E]=1;H.push(g);O.push(E);H.push(E);O.push(i)}g=H.pop();i=O.pop()}for(l=0;l<q;l++)w[l]&&J.push(o[l*2],o[l*2+1]);return J}var Oa=Oa||Array,Na=Na||Array,da=Math,Ra=da.exp,Sa=da.log,Ta=da.sin,Ua=da.cos,Fa=da.tan,Va=da.atan,ma=da.min,ya=da.max,za=k.document,U=function(){function o(g,i,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return g+(i-g)*6*l;if(l<0.5)return i;if(l<2/3)return g+(i-g)*(2/3-l)*6;return g}function q(g,i,l,v){this.r=g;this.g=i;this.b=l;this.a=arguments.length<
4?1:v}var w=q.prototype;w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(g){var i=U.toHSLA(this);i.l*=g;i.l=Math.min(1,Math.max(0,i.l));var l,v;if(i.s===0)g=l=v=i.l;else{v=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var r=2*i.l-v;g=o(r,v,i.h+1/3);l=o(r,v,i.h);v=o(r,v,i.h-1/3)}return new U(g*255<<0,l*255<<0,v*255<<0,i.a)};w.adjustAlpha=function(g){return new U(this.r,this.g,this.b,this.a*g)};q.parse=function(g){g+="";if(~g.indexOf("#")){g=
g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new U(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new U(parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};q.toHSLA=function(g){var i=g.r/255,l=g.g/255,v=g.b/255,r=Math.max(i,l,v),E=Math.min(i,l,v),H,O=(r+E)/2,J;if(r===E)H=E=0;else{J=r-E;E=O>0.5?J/(2-r-E):J/(r+E);switch(r){case i:H=(l-v)/J+(l<v?6:0);break;case l:H=
(v-i)/J+2;break;case v:H=(i-l)/J+4;break}H/=6}return{h:H,s:E,l:O,a:g.a}};return q}(),Wa=function(){var o=Math,q=o.sin,w=o.cos,g=o.tan,i=o.asin,l=o.atan2,v=o.PI,r=180/v,E=357.5291/r,H=0.98560028/r,O=1.9148/r,J=0.02/r,Z=3.0E-4/r,V=102.9372/r,K=23.45/r,ia=280.16/r,$=360.9856235/r;return function(s,p,C){C=-C/r;p=p/r;s=s.valueOf()/864E5-0.5+2440588;var P=E+H*(s-2451545),F=O*q(P)+J*q(2*P)+Z*q(3*P);F=P+V+F+v;P=i(q(F)*q(K));F=l(q(F)*w(K),w(F));C=ia+$*(s-2451545)-C-F;return{altitude:i(q(p)*q(P)+w(p)*w(P)*
w(C)),azimuth:l(q(C),w(C)*q(p)-g(P)*w(p))-v/2}}}(),na=Math.PI,Pa=na/2,Xa=na/4,Ya=180/na,Za=256,Ga=14,oa="latitude",pa="longitude",S=0,Q=1,T=2,ea=3,Aa=4,ja=5,aa=6;k.OSMBuildings=function(o){function q(a,d){var c={};a/=qa;d/=qa;c[oa]=d<=0?90:d>=1?-90:Ya*(2*Va(Ra(na*(1-2*d)))-Pa);c[pa]=(a===1?1:(a%1+1)%1)*360-180;return c}function w(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(c,b){return d[b]})}function g(a,d){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState===4)!c.status||
c.status<200||c.status>299||c.responseText&&d(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}function i(){if(!(!Ha||R<Ga)){var a=q(F-C,ba-P),d=q(F+s+C,ba+p+P);Ba&&Ba.abort();Ba=g(w(Ha,{w:a[pa],n:a[oa],e:d[pa],s:d[oa],z:R}),l)}}function l(a){var d,c,b,e=[],f,h=f=0;ka=Ga;O(R);Ba=null;if(!(!a||a.meta.z!==R)){b=a.meta;c=a.data;if(D&&y&&D.z===b.z){f=D.x-b.x;h=D.y-b.y;a=0;for(d=y.length;a<d;a++)e[a]=y[a][T][0]+f+","+(y[a][T][1]+h)}D=b;y=[];a=0;for(d=c.length;a<d;a++){b=[];if(!(c[a][Q]>
ra)){f=Ma(c[a][T]);if(!(f.length<8)){b[T]=f;b[Aa]=La(f);b[S]=ma(c[a][S],ra);b[Q]=c[a][Q];f=b[T][0]+","+b[T][1];b[ja]=!(e&&~e.indexOf(f));b[ea]=[];b[aa]=[];y.push(b)}}}J()}}function v(a,d){var c=[],b,e,f,h,j,m,n,A,x,G=Ia-R;b=0;for(e=a.length;b<e;b++){j=a[b];A=j[Q]>>G;if(!(A>ra)){m=j[T];x=new Oa(m.length);f=0;for(h=m.length-1;f<h;f+=2){n=m[f+1];var z=ma(1,ya(0,0.5-Sa(Fa(Xa+Pa*m[f]/180))/na/2));n={x:(n/360+0.5)*qa<<0,y:z*qa<<0};x[f]=n.x;x[f+1]=n.y}x=Ma(x);if(!(x.length<8)){h=[];h[T]=x;h[Aa]=La(x);h[S]=
ma(j[S]>>G,ra);h[Q]=A;h[ja]=d;h[ea]=j[ea];h[aa]=[];for(f=0;f<3;f++)if(h[ea][f])h[aa][f]=h[ea][f].adjustAlpha(W)+"";c.push(h)}}}return c}function r(a,d){if(typeof a==="object")H(a,!d);else{var c=za.documentElement,b=za.createElement("script");k.jsonpCallback=function(e){delete k.jsonpCallback;c.removeChild(b);H(e,!d)};c.insertBefore(b,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function E(a,d,c){if(c===undefined)c=[];var b,e,f,h=a[0]?a:a.features,j,m,n,A,x,G=d?1:0,z=d?0:1;if(h){b=0;
for(a=h.length;b<a;b++)E(h[b],d,c);return c}if(a.type==="Feature"){j=a.geometry;b=a.properties}if(j.type==="Polygon")m=[j.coordinates];if(j.type==="MultiPolygon")m=j.coordinates;if(m){d=b.height;if(b.color||b.wallColor)A=U.parse(b.color||b.wallColor);if(b.roofColor)x=U.parse(b.roofColor);b=0;for(a=m.length;b<a;b++){h=m[b][0];n=[];e=j=0;for(f=h.length;e<f;e++){n.push(h[e][G],h[e][z]);j+=d||h[e][2]||0}if(j){e=[];f=T;var t=void 0,u=void 0,B=void 0,M=void 0,X=0,Y=void 0,sa=void 0;Y=0;for(sa=n.length-
3;Y<sa;Y+=2){t=n[Y];u=n[Y+1];B=n[Y+2];M=n[Y+3];X+=t*M-B*u}if((X/2>0?"CW":"CCW")==="CW")n=n;else{t=[];for(u=n.length-2;u>=0;u-=2)t.push(n[u],n[u+1]);n=t}e[f]=n;e[S]=j/h.length<<0;e[ea]=[A||null,A?A.adjustLightness(0.8):null,x?x:A?A.adjustLightness(1.2):ca];c.push(e)}}}return c}function H(a,d){if(a){ta=E(a,d);ka=0;O(R);D={n:90,w:-180,s:-90,e:180,x:0,y:0,z:R};y=v(ta,true);J()}else{ta=null;K()}}function O(a){var d,c,b;R=a;qa=Za<<R;a=R;d=ka;c=Ia;a=ma(ya(a,d),c);W=1-ma(ya(0+(a-d)/(c-d)*0.4,0),0.4);Ja=fa.adjustAlpha(W)+
"";ua=Ca.adjustAlpha(W)+"";va=ca.adjustAlpha(W)+"";if(y){a=0;for(d=y.length;a<d;a++){b=y[a];b[aa]=[];for(c=0;c<3;c++)if(b[ea][c])b[aa][c]=b[ea][c].adjustAlpha(W)+""}}}function J(){clearInterval(Ka);ga=0;Da.render();Ka=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(Ka);ga=1;for(var a=0,d=y.length;a<d;a++)y[a][ja]=0}Ea.render();K()},33)}function Z(){Ea.render();Da.render();K()}function V(){I.clearRect(0,0,s,p);if(!(!D||!y||R<ka||wa)){var a,d,c,b,e,f,h,j,m,n=F-D.x,A=ba-D.y,x=Da.getMaxHeight(),
G=[ha+n,xa+A],z,t,u,B,M,X;y.sort(function(Y,sa){return N(sa[Aa],G)/sa[S]-N(Y[Aa],G)/Y[S]});a=0;for(d=y.length;a<d;a++){e=y[a];if(!(e[S]<=x)){t=false;f=e[T];z=[];c=0;for(b=f.length-1;c<b;c+=2){z[c]=j=f[c]-n;z[c+1]=m=f[c+1]-A;t||(t=j>0&&j<s&&m>0&&m<p)}if(t){c=e[ja]?e[S]*ga:e[S];f=la/(la-c);if(e[Q]){c=e[ja]?e[Q]*ga:e[Q];h=la/(la-c)}j=[];c=0;for(b=z.length-3;c<b;c+=2){m=z[c];u=z[c+1];t=z[c+2];B=z[c+3];M=$(m,u,f);X=$(t,B,f);if(e[Q]){u=$(m,u,h);B=$(t,B,h);m=u.x;u=u.y;t=B.x;B=B.y}if((t-m)*(M.y-u)>(M.x-m)*
(B-u)){I.fillStyle=m<t&&u<B||m>t&&u>B?e[aa][1]||ua:e[aa][0]||Ja;ia([t,B,m,u,M.x,M.y,X.x,X.y])}j[c]=M.x;j[c+1]=M.y}I.fillStyle=e[aa][2]||va;I.strokeStyle=e[aa][1]||ua;ia(j,true)}}}}}function K(){var a=s/(window.devicePixelRatio||1)/30;ha-=a;V();var d=I.getImageData(0,0,s,p);ha+=2*a;V();var c=I.getImageData(0,0,s,p);ha-=a;a=d.data;c=c.data;for(var b,e,f,h,j=0,m=a.length;j<m;j+=4){b=j;e=j+1;f=j+2;h=j+3;if(a[h]||c[h]){a[b]=0.7*(a[e]||235)+0.3*(a[f]||230);a[e]=c[e]||ca.g;a[f]=c[f]||ca.b;a[h]=ya(a[h],c[h])}}I.clearRect(0,
0,s,p);I.putImageData(d,0,0)}function ia(a,d){if(a.length){I.beginPath();I.moveTo(a[0],a[1]);for(var c=2,b=a.length;c<b;c+=2)I.lineTo(a[c],a[c+1]);I.closePath();d&&I.stroke();I.fill()}}function $(a,d,c){return{x:(a-ha)*c+ha<<0,y:(d-xa)*c+xa<<0}}var s=0,p=0,C=0,P=0,F=0,ba=0,R,qa,Ba,I,Ha,fa=new U(200,190,180),Ca=fa.adjustLightness(0.8),ca=fa.adjustLightness(1.2),Ja=fa+"",ua=Ca+"",va=ca+"",ta,D,y,ga=1,Ka,W=1,ka=Ga,Ia=20,ra,ha,xa,la,wa,Qa={container:null,items:[],init:function(a){var d=this.container=
za.createElement("DIV");d.style.pointerEvents="none";d.style.position="absolute";d.style.left=0;d.style.top=0;Ea.init(this.create());Da.init(this.create());I=this.create();a.appendChild(d);return d},create:function(){var a=za.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var d=a.getContext("2d");d.lineCap="round";d.lineJoin="round";d.lineWidth=1;try{d.mozImageSmoothingEnabled=false}catch(c){}this.items.push(a);
this.container.appendChild(a);return d},setSize:function(a,d){for(var c=this.items,b=0,e=c.length;b<e;b++){c[b].width=a;c[b].height=d}}},Ea={context:null,color:new U(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,d,c,b,e;a.clearRect(0,0,s,p);if(!(!D||!y||R<ka||wa)){d=q(F+C,ba+P);d=Wa(this.date,d.latitude,d.longitude);if(!(d.altitude<=0)){c=1/Fa(d.altitude);
b=0.4/c;this.directionX=Ua(d.azimuth)*c;this.directionY=Ta(d.azimuth)*c;this.color.a=b;e=this.color+"";var f,h,j,m,n,A=F-D.x,x=ba-D.y,G,z,t,u,B,M,X=[];a.beginPath();d=0;for(c=y.length;d<c;d++){h=y[d];z=false;j=h[T];G=[];b=0;for(f=j.length-1;b<f;b+=2){G[b]=m=j[b]-A;G[b+1]=n=j[b+1]-x;z||(z=m>0&&m<s&&n>0&&n<p)}if(z){j=h[ja]?h[S]*ga:h[S];if(h[Q])j=h[ja]?h[Q]*ga:h[Q];m=null;b=0;for(f=G.length-3;b<f;b+=2){n=G[b];t=G[b+1];z=G[b+2];u=G[b+3];B=this.project(n,t,j);M=this.project(z,u,j);if(h[Q]){t=this.project(n,
t,j);u=this.project(z,u,j);n=t.x;t=t.y;z=u.x;u=u.y}if((z-n)*(B.y-t)>(B.x-n)*(u-t)){m===1&&a.lineTo(n,t);m=0;b||a.moveTo(n,t);a.lineTo(z,u)}else{m===0&&a.lineTo(B.x,B.y);m=1;b||a.moveTo(B.x,B.y);a.lineTo(M.x,M.y)}}a.closePath();X.push(G)}}a.fillStyle=e;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=X.length;d<c;d++){e=X[d];a.moveTo(e[0],e[1]);b=2;for(f=e.length;b<f;b+=2)a.lineTo(e[b],e[b+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation=
"source-over"}}},project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},Da={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,s,p);if(!(!D||!y||R<ka||wa)){var d,c,b,e,f,h,j,m=F-D.x,n=ba-D.y,A,x;a.beginPath();d=0;for(c=y.length;d<c;d++){b=y[d];x=false;f=b[T];A=[];b=0;for(e=f.length-1;b<e;b+=2){A[b]=h=f[b]-m;A[b+1]=j=f[b+1]-n;x||(x=h>0&&h<s&&j>0&&j<p)}if(x){b=0;for(e=A.length-
3;b<e;b+=2){x=A[b];f=A[b+1];b?a.lineTo(x,f):a.moveTo(x,f)}a.closePath()}}a.fillStyle=va;a.strokeStyle=ua;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){fa=U.parse(a.color||a.wallColor);Ja=fa.adjustAlpha(W)+"";Ca=fa.adjustLightness(0.8);ua=Ca.adjustAlpha(W)+"";ca=fa.adjustLightness(1.2);va=ca.adjustAlpha(W)+""}if(a.roofColor){ca=U.parse(a.roofColor);va=ca.adjustAlpha(W)+""}Z();return this};this.geoJSON=function(a,
d){r(a,d);return this};this.setCamOffset=function(a,d){ha=C+a;xa=p+d};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){Ea.setDate(a);return this};this.appendTo=function(a){return Qa.init(a)};this.loadData=i;this.onMoveEnd=function(){var a=q(F,ba),d=q(F+s,ba+p);Z();if(D&&(a[oa]>D.n||a[pa]<D.w||d[oa]<D.s||d[pa]>D.e))i()};this.onZoomEnd=function(a){wa=false;O(a.zoom);if(ta){y=v(ta);Z()}else{K();i()}};this.onZoomStart=function(){wa=true;Z()};this.setOrigin=function(a,d){F=a;ba=d};this.setSize=
function(a,d){s=a;p=d;C=s/2<<0;P=p/2<<0;ha=C;xa=p;la=s/((window.devicePixelRatio||1)*1.5)/Fa(45)<<0;Qa.setSize(s,p);ra=la-50};this.setZoom=O;this.render=K;Ha=o};k.OSMBuildings.VERSION="0.1.8a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(k){L.Util.setOptions(this,k)},onMove:function(){var k=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-k.x,this.lastY-k.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var k=L.DomUtil.getPosition(this.map._mapPane),N=this.map.getPixelOrigin();this.lastX=k.x;this.lastY=k.y;this.container.style.left=-k.x+
"px";this.container.style.top=-k.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(N.x-k.x,N.y-k.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var k=L.DomUtil.getPosition(this.map._mapPane),N=this.map.getPixelOrigin();this.osmb.setOrigin(N.x-k.x,N.y-k.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(k){k.addLayer(this);return this},onAdd:function(k){this.map=
k;k=this.map._panes.overlayPane;if(this.osmb)k.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(k);this.osmb.maxZoom=this.map._layersMaxZoom}k=L.DomUtil.getPosition(this.map._mapPane);var N=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(N.x-k.x,N.y-k.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-k.x+"px";this.container.style.top=-k.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(k){k.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);k.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(k,N){return this.osmb.geoJSON(k,N)},setStyle:function(k){return this.osmb.setStyle(k)},
setDate:function(k){return this.osmb.setDate(k)}});
