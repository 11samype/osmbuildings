(function(h){function D(j){for(var l,x=[j[0],j[1]],c,g=[j[0],j[1]],k=2,p=j.length-3;k<p;k+=2){l=[j[k],j[k+1]];c=[j[k+2]||j[0],j[k+3]||j[1]];var t=x,q=t[0],u=t[1],E=c[0]-q,v=c[1]-u,P=void 0;if(E!==0||v!==0){P=((l[0]-q)*E+(l[1]-u)*v)/(E*E+v*v);if(P>1){q=c[0];u=c[1]}else if(P>0){q+=E*P;u+=v*P}}q=ja(l,[q,u])*2;c=ja(t,c);if(q*c>750){g.push(l[0],l[1]);x=l}}if(l[0]!==j[0]||l[1]!==j[1])g.push(j[0],j[1]);return g}function ja(j,l){var x=j[0]-l[0],c=j[1]-l[1];return x*x+c*c}function za(j){for(var l=0,x=0,c=
0,g=j.length-3;c<g;c+=2){l+=j[c];x+=j[c+1]}j=(j.length-2)*2;return[l/j<<0,x/j<<0]}var Aa=Aa||Array,Ha=Math.exp,Ia=Math.log,Ja=Math.tan,Ka=Math.atan,pa=Math.min,La=Math.max,qa=h.document,I=function(){function j(c,g,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return c+(g-c)*6*k;if(k<0.5)return g;if(k<2/3)return c+(g-c)*(2/3-k)*6;return c}function l(c,g,k,p){this.r=c;this.g=g;this.b=k;this.a=arguments.length<4?1:p}var x=l.prototype;x.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};x.adjustLightness=function(c){var g=I.toHSLA(this);g.l*=c;g.l=Math.min(1,Math.max(0,g.l));var k,p;if(g.s===0)c=k=p=g.l;else{p=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var t=2*g.l-p;c=j(t,p,g.h+1/3);k=j(t,p,g.h);p=j(t,p,g.h-1/3)}return new I(c*255<<0,k*255<<0,p*255<<0,g.a)};x.adjustAlpha=function(c){return new I(this.r,this.g,this.b,this.a*c)};l.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new I(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],
16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new I(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};l.toHSLA=function(c){var g=c.r/255,k=c.g/255,p=c.b/255,t=Math.max(g,k,p),q=Math.min(g,k,p),u,E=(t+q)/2,v;if(t===q)u=q=0;else{v=t-q;q=E>0.5?v/(2-t-q):v/(t+q);switch(t){case g:u=(k-p)/v+(k<p?6:0);break;case k:u=(p-g)/v+2;break;case p:u=(g-k)/v+4;break}u/=6}return{h:u,s:q,l:E,a:c.a}};return l}(),aa=Math.PI,Ba=aa/
2,Ma=aa/4,Na=180/aa,Oa=256,ra=14,sa=400,Ca=sa-50,ba="latitude",ca="longitude",N=0,J=1,Y=2,ka=3,la=4,Q=5;h.OSMBuildings=function(j){function l(a,e){var b={};a/=da;e/=da;b[ba]=e<=0?90:e>=1?-90:Na*(2*Ka(Ha(aa*(1-2*e)))-Ba);b[ca]=(a===1?1:(a%1+1)%1)*360-180;return b}function x(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function g(){if(!(!ta||G<ra)){var a=l(Z-ea,$-ua),e=l(Z+S+ea,$+O+ua);ma&&ma.abort();ma=c(x(ta,{w:a[ca],n:a[ba],e:e[ca],s:e[ba],z:G}),k)}}function k(a){var e,b,d,i=[],f,n=f=0;T=ra;E(G);ma=null;if(!(!a||a.meta.z!==G)){d=a.meta;b=a.data;if(y&&s&&y.z===d.z){f=y.x-d.x;n=y.y-d.y;a=0;for(e=s.length;a<e;a++)i[a]=s[a][J][0]+f+","+(s[a][J][1]+n)}y=d;s=[];a=0;for(e=b.length;a<e;a++){d=[];f=D(b[a][J]);if(!(f.length<8)){d[J]=f;d[ka]=za(f);d[N]=pa(b[a][N],Ca);f=d[J][0]+","+
d[J][1];d[la]=!(i&&~i.indexOf(f));d[Y]=[];d[Q]=[];s.push(d)}}P()}}function p(a,e){var b=[],d,i,f,n,m,z,o,r,A=na-G;d=0;for(i=a.length;d<i;d++){m=a[d];z=m[J];r=new Aa(z.length);f=0;for(n=z.length-1;f<n;f+=2){o=z[f+1];var K=pa(1,La(0,0.5-Ia(Ja(Ma+Ba*z[f]/180))/aa/2));o={x:(o/360+0.5)*da<<0,y:K*da<<0};r[f]=o.x;r[f+1]=o.y}r=D(r);if(!(r.length<8)){f=[];f[J]=r;f[ka]=za(r);f[N]=pa(m[N]>>A,Ca);f[la]=e;f[Y]=m[Y];f[Q]=[];b.push(f)}}return b}function t(a,e){if(typeof a==="object")u(a,!e);else{var b=qa.documentElement,
d=qa.createElement("script");h.jsonpCallback=function(i){delete h.jsonpCallback;b.removeChild(d);u(i,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function q(a,e,b){if(b===undefined)b=[];var d,i,f,n=a[0]?a:a.features,m,z,o,r,A,K=e?1:0,F=e?0:1;if(n){d=0;for(a=n.length;d<a;d++)q(n[d],e,b);return b}if(a.type==="Feature"){m=a.geometry;d=a.properties}if(m.type==="Polygon")z=[m.coordinates];if(m.type==="MultiPolygon")z=m.coordinates;if(z){e=d.height;if(d.color||d.wallColor)r=
I.parse(d.color||d.wallColor);if(d.roofColor)A=I.parse(d.roofColor);d=0;for(a=z.length;d<a;d++){n=z[d][0];o=[];i=m=0;for(f=n.length;i<f;i++){o.push(n[i][K],n[i][F]);m+=e||n[i][2]||0}if(m){i=[];f=J;var H=void 0,B=void 0,M=void 0,fa=void 0,ga=0,U=void 0,Da=void 0;U=0;for(Da=o.length-3;U<Da;U+=2){H=o[U];B=o[U+1];M=o[U+2];fa=o[U+3];ga+=H*fa-M*B}if((ga/2>0?"CW":"CCW")==="CW")o=o;else{H=[];for(B=o.length-2;B>=0;B-=2)H.push(o[B],o[B+1]);o=H}i[f]=o;i[N]=m/n.length<<0;i[Y]=[r||null,r?r.adjustLightness(0.8):
null,A?A:r?r.adjustLightness(1.2):null];b.push(i)}}}return b}function u(a,e){if(a){ha=q(a,e);T=0;E(G);y={n:90,w:-180,s:-90,e:180,x:0,y:0,z:G};s=p(ha,true);P()}else{ha=null;R()}}function E(a){var e,b,d,i;G=a;da=Oa<<G;d=1-(G-T)*0.3/(na-T);v();if(s){a=0;for(e=s.length;a<e;a++){i=s[a];i[Q]=[];for(b=0;b<3;b++)if(i[Y][b])i[Q][b]=i[Y][b].adjustAlpha(d)+""}}}function v(){var a=1-(G-T)*0.3/(na-T);Ea=V.adjustAlpha(a)+"";va=wa.adjustAlpha(a)+"";Fa=oa.adjustAlpha(a)+""}function P(){ia=0;clearInterval(xa);xa=
setInterval(function(){ia+=0.1;if(ia>1){clearInterval(xa);ia=1;for(var a=0,e=s.length;a<e;a++)s[a][la]=0}R()},33)}function R(){w.clearRect(0,0,S,O);if(y&&s)if(!(G<T||ya)){var a,e,b,d,i,f,n,m,z=Z-y.x,o=$-y.y,r=[W+z,X+o],A,K,F,H,B,M;s.sort(function(fa,ga){return ja(ga[ka],r)/ga[N]-ja(fa[ka],r)/fa[N]});a=0;for(e=s.length;a<e;a++){i=s[a];F=false;f=i[J];A=[];b=0;for(d=f.length-1;b<d;b+=2){A[b]=n=f[b]-z;A[b+1]=m=f[b+1]-o;F||(F=n>0&&n<S&&m>0&&m<O)}if(F){b=i[la]?i[N]*ia:i[N];f=sa/(sa-b);n=[];K=[];b=0;for(d=
A.length-3;b<d;b+=2){m=A[b];F=A[b+1];H=A[b+2];B=A[b+3];M={x:((m-W)*f+W<<0)+0.5,y:((F-X)*f+X<<0)+0.5};K={x:((H-W)*f+W<<0)+0.5,y:((B-X)*f+X<<0)+0.5};if((H-m)*(M.y-F)>(M.x-m)*(B-F)){K=[H+0.5,B+0.5,m+0.5,F+0.5,M.x,M.y,K.x,K.y];w.fillStyle=m<H&&F<B||m>H&&F>B?i[Q][1]||va:i[Q][0]||Ea;Ga(K)}n[b]=M.x;n[b+1]=M.y}w.fillStyle=i[Q][2]||Fa;w.strokeStyle=i[Q][1]||va;Ga(n,true)}}}}function Ga(a,e){if(a.length){w.beginPath();w.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)w.lineTo(a[b],a[b+1]);w.closePath();e&&
w.stroke();w.fill()}}var S=0,O=0,ea=0,ua=0,Z=0,$=0,G,da,ma,C,w,ta,V=new I(200,190,180),wa=V.adjustLightness(0.8),oa=V.adjustLightness(1.2),Ea=V+"",va=wa+"",Fa=oa+"",ha,y,s,ia=1,xa,T=ra,na=20,W,X,ya;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){V=I.parse(a.color||a.wallColor);wa=V.adjustLightness(0.8);oa=V.adjustLightness(1.2)}if(a.roofColor)oa=I.parse(a.roofColor);v();R();return this};this.geoJSON=function(a,e){t(a,e);return this};this.setCamOffset=function(a,e){W=ea+a;X=O+e};this.setMaxZoom=
function(a){na=a};this.createCanvas=function(a){C=qa.createElement("canvas");C.style.webkitTransform="translate3d(0,0,0)";C.style.imageRendering="optimizeSpeed";C.style.position="absolute";C.style.pointerEvents="none";C.style.left=0;C.style.top=0;a.appendChild(C);w=C.getContext("2d");w.lineCap="round";w.lineJoin="round";w.lineWidth=1;try{w.mozImageSmoothingEnabled=false}catch(e){}return C};this.destroyCanvas=function(){C.parentNode.removeChild(C)};this.loadData=g;this.onMoveEnd=function(){var a=l(Z,
$),e=l(Z+S,$+O);R();if(y&&(a[ba]>y.n||a[ca]<y.w||e[ba]<y.s||e[ca]>y.e))g()};this.onZoomEnd=function(a){ya=false;E(a.zoom);if(ha){s=p(ha);R()}else{R();g()}};this.onZoomStart=function(){ya=true;R()};this.render=R;this.setOrigin=function(a,e){Z=a;$=e};this.setSize=function(a,e){S=a;O=e;ea=S/2<<0;ua=O/2<<0;W=ea;X=O;C.width=S;C.height=O};this.setZoom=E;ta=j};h.OSMBuildings.VERSION="0.1.7a";h.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(h){L.Util.setOptions(this,h)},onMove:function(){var h=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-h.x,this.lastY-h.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var h=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.lastX=h.x;this.lastY=h.y;this.canvas.style.left=-h.x+"px";
this.canvas.style.top=-h.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-h.x,D.y-h.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var h=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.osmb.setOrigin(D.x-h.x,D.y-h.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(h){h.addLayer(this);return this},onAdd:function(h){this.map=h;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;h=L.DomUtil.getPosition(this.map._mapPane);var D=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-h.x,D.y-h.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-h.x+"px";this.canvas.style.top=-h.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(h){h.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);h.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(h,D){return this.osmb.geoJSON(h,D)},
setStyle:function(h){return this.osmb.setStyle(h)}});
