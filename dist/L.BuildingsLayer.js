(function(j){function I(q,w){var B=q[0]-w[0],e=q[1]-w[1];return B*B+e*e}function Ja(q){for(var w=0,B=0,e=0,h=q.length-3;e<h;e+=2){w+=q[e];B+=q[e+1]}q=(q.length-2)*2;return[w/q<<0,B/q<<0]}function Ka(q){var w=q.length/2,B=new La(w),e=0,h=w-1,k,r,x,C,J=[],O=[],M=[];for(B[e]=B[h]=1;h;){r=0;for(k=e+1;k<h;k++){x=q[k*2];var sa=q[k*2+1],P=q[e*2],F=q[e*2+1],fa=q[h*2],$=q[h*2+1],A=fa-P,y=$-F,Q=void 0;if(A!==0||y!==0){Q=((x-P)*A+(sa-F)*y)/(A*A+y*y);if(Q>1){P=fa;F=$}else if(Q>0){P+=A*Q;F+=y*Q}}A=x-P;y=sa-F;
x=A*A+y*y;if(x>r){C=k;r=x}}if(r>2){B[C]=1;J.push(e);O.push(C);J.push(C);O.push(h)}e=J.pop();h=O.pop()}for(k=0;k<w;k++)B[k]&&M.push(q[k*2],q[k*2+1]);return M}var Ma=Ma||Array,La=La||Array,Qa=Math.exp,Ra=Math.log,Na=Math.tan,Sa=Math.atan,ya=Math.min,Ta=Math.max,za=j.document,T=function(){function q(e,h,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return e+(h-e)*6*k;if(k<0.5)return h;if(k<2/3)return e+(h-e)*(2/3-k)*6;return e}function w(e,h,k,r){this.r=e;this.g=h;this.b=k;this.a=arguments.length<4?1:r}var B=
w.prototype;B.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};B.adjustLightness=function(e){var h=T.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var k,r;if(h.s===0)e=k=r=h.l;else{r=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var x=2*h.l-r;e=q(x,r,h.h+1/3);k=q(x,r,h.h);r=q(x,r,h.h-1/3)}return new T(e*255<<0,k*255<<0,r*255<<0,h.a)};B.adjustAlpha=function(e){return new T(this.r,this.g,this.b,this.a*e)};w.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new T(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new T(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};w.toHSLA=function(e){var h=e.r/255,k=e.g/255,r=e.b/255,x=Math.max(h,k,r),C=Math.min(h,k,r),J,O=(x+C)/2,M;if(x===C)J=C=0;else{M=x-C;C=O>0.5?M/(2-x-C):M/(x+C);switch(x){case h:J=(k-r)/M+(k<r?6:0);break;case k:J=
(r-h)/M+2;break;case r:J=(h-k)/M+4;break}J/=6}return{h:J,s:C,l:O,a:e.a}};return w}(),ja=Math.PI,Oa=ja/2,Ua=ja/4,Va=180/ja,Wa=256,Aa=14,ka="latitude",la="longitude",N=0,K=1,R=2,X=3,ta=4,aa=5,W=6;j.OSMBuildings=function(q){function w(a,d){var b={};a/=ma;d/=ma;b[ka]=d<=0?90:d>=1?-90:Va*(2*Sa(Qa(ja*(1-2*d)))-Oa);b[la]=(a===1?1:(a%1+1)%1)*360-180;return b}function B(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function e(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===
4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function h(){if(!(!Ba||S<Aa)){var a=w(ba-Q,ca-Ca),d=w(ba+A+Q,ca+y+Ca);ua&&ua.abort();ua=e(B(Ba,{w:a[la],n:a[ka],e:d[la],s:d[ka],z:S}),k)}}function k(a){var d,b,c,f=[],g,m=g=0;na=Aa;O(S);ua=null;if(!(!a||a.meta.z!==S)){c=a.meta;b=a.data;if(D&&z&&D.z===c.z){g=D.x-c.x;m=D.y-c.y;a=0;for(d=z.length;a<d;a++)f[a]=z[a][R][0]+g+","+(z[a][R][1]+m)}D=c;z=[];a=0;for(d=b.length;a<d;a++){c=
[];if(!(b[a][K]>oa)){g=Ka(b[a][R]);if(!(g.length<8)){c[R]=g;c[ta]=Ja(g);c[N]=ya(b[a][N],oa);c[K]=b[a][K];g=c[R][0]+","+c[R][1];c[aa]=!(f&&~f.indexOf(g));c[X]=[];c[W]=[];z.push(c)}}}M()}}function r(a,d){var b=[],c,f,g,m,l,i,s,E,p,v=Da-S;c=0;for(f=a.length;c<f;c++){l=a[c];E=l[K]>>v;if(!(E>oa)){i=l[R];p=new Ma(i.length);g=0;for(m=i.length-1;g<m;g+=2){s=i[g+1];var n=ya(1,Ta(0,0.5-Ra(Na(Ua+Oa*i[g]/180))/ja/2));s={x:(s/360+0.5)*ma<<0,y:n*ma<<0};p[g]=s.x;p[g+1]=s.y}p=Ka(p);if(!(p.length<8)){m=[];m[R]=p;
m[ta]=Ja(p);m[N]=ya(l[N]>>v,oa);m[K]=E;m[aa]=d;m[X]=l[X];m[W]=[];for(g=0;g<3;g++)if(m[X][g])m[W][g]=m[X][g].adjustAlpha(U)+"";b.push(m)}}}return b}function x(a,d){if(typeof a==="object")J(a,!d);else{var b=za.documentElement,c=za.createElement("script");j.jsonpCallback=function(f){delete j.jsonpCallback;b.removeChild(c);J(f,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function C(a,d,b){if(b===undefined)b=[];var c,f,g,m=a[0]?a:a.features,l,i,s,E,p,v=d?1:0,n=d?0:
1;if(m){c=0;for(a=m.length;c<a;c++)C(m[c],d,b);return b}if(a.type==="Feature"){l=a.geometry;c=a.properties}if(l.type==="Polygon")i=[l.coordinates];if(l.type==="MultiPolygon")i=l.coordinates;if(i){d=c.height;if(c.color||c.wallColor)E=T.parse(c.color||c.wallColor);if(c.roofColor)p=T.parse(c.roofColor);c=0;for(a=i.length;c<a;c++){m=i[c][0];s=[];f=l=0;for(g=m.length;f<g;f++){s.push(m[f][v],m[f][n]);l+=d||m[f][2]||0}if(l){f=[];g=R;var t=void 0,o=void 0,G=void 0,ga=void 0,pa=0,V=void 0,Pa=void 0;V=0;for(Pa=
s.length-3;V<Pa;V+=2){t=s[V];o=s[V+1];G=s[V+2];ga=s[V+3];pa+=t*ga-G*o}if((pa/2>0?"CW":"CCW")==="CW")s=s;else{t=[];for(o=s.length-2;o>=0;o-=2)t.push(s[o],s[o+1]);s=t}f[g]=s;f[N]=l/m.length<<0;f[X]=[E||null,E?E.adjustLightness(0.8):null,p?p:E?E.adjustLightness(1.2):da];b.push(f)}}}return b}function J(a,d){if(a){qa=C(a,d);na=0;O(S);D={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};z=r(qa,true);M()}else{qa=null;F()}}function O(a){var d,b,c;S=a;ma=Wa<<S;U=1-(S-na)*0.3/(Da-na);Ea=Y.adjustAlpha(U)+"";va=wa.adjustAlpha(U)+
"";xa=da.adjustAlpha(U)+"";if(z){a=0;for(d=z.length;a<d;a++){c=z[a];c[W]=[];for(b=0;b<3;b++)if(c[X][b])c[W][b]=c[X][b].adjustAlpha(U)+""}}}function M(){Z=0;clearInterval(Fa);Fa=setInterval(function(){Z+=0.1;if(Z>1){clearInterval(Fa);Z=1;for(var a=0,d=z.length;a<d;a++)z[a][aa]=0}F()},33)}function sa(){Ga=ha;Ha=ia*1.2;ra=ea/1.5;var a,d,b,c,f,g,m,l,i,s=ba-D.x,E=ca-D.y,p,v,n,t,o,G;u.fillStyle="rgba(0,0,0,0.4)";a=0;for(d=z.length;a<d;a++){f=z[a];v=false;g=f[R];p=[];b=0;for(c=g.length-1;b<c;b+=2){p[b]=
l=g[b]-s;p[b+1]=i=g[b+1]-E;v||(v=l>0&&l<A&&i>0&&i<y)}if(v){b=f[aa]?f[N]*Z:f[N];g=ra/(ra-b);if(f[K]){b=f[aa]?f[K]*Z:f[K];m=ra/(ra-b)}if(f[N]<6){f=[];b=0;for(c=p.length-3;b<c;b+=2){l=p[b];n=p[b+1];i=P(l,n,g);f[b]=i.x;f[b+1]=i.y}fa(f)}else{v=null;u.beginPath();b=0;for(c=p.length-3;b<c;b+=2){l=p[b];n=p[b+1];t=p[b+2];o=p[b+3];i=P(l,n,g);G=P(t,o,g);if(f[K]){n=P(l,n,m);o=P(t,o,m);l=n.x;n=n.y;t=o.x;o=o.y}if((t-l)*(i.y-n)>(i.x-l)*(o-n)){v===1&&u.lineTo(l,n);v=0;b||u.moveTo(l,n);u.lineTo(t,o)}else{v===0&&u.lineTo(i.x,
i.y);v=1;b||u.moveTo(i.x,i.y);u.lineTo(G.x,G.y)}}u.closePath();u.fill()}}}}function P(a,d,b){return{x:(a-Ga)*b+Ga,y:(d-Ha)*b+Ha}}function F(){u.clearRect(0,0,A,y);if(D&&z)if(!(S<na||Ia)){sa();var a,d,b,c,f,g,m,l,i,s=ba-D.x,E=ca-D.y,p=[ha+s,ia+E],v,n,t,o,G,ga;z.sort(function(pa,V){return I(V[ta],p)/V[N]-I(pa[ta],p)/pa[N]});a=0;for(d=z.length;a<d;a++){f=z[a];n=false;g=f[R];v=[];b=0;for(c=g.length-1;b<c;b+=2){v[b]=l=g[b]-s;v[b+1]=i=g[b+1]-E;n||(n=l>0&&l<A&&i>0&&i<y)}if(n){b=f[aa]?f[N]*Z:f[N];g=ea/(ea-
b);if(f[K]){b=f[aa]?f[K]*Z:f[K];m=ea/(ea-b)}l=[];b=0;for(c=v.length-3;b<c;b+=2){i=v[b];t=v[b+1];n=v[b+2];o=v[b+3];G=$(i,t,g);ga=$(n,o,g);if(f[K]){t=$(i,t,m);o=$(n,o,m);i=t.x;t=t.y;n=o.x;o=o.y}if((n-i)*(G.y-t)>(G.x-i)*(o-t)){u.fillStyle=i<n&&t<o||i>n&&t>o?f[W][1]||va:f[W][0]||Ea;fa([n+0.5,o+0.5,i+0.5,t+0.5,G.x,G.y,ga.x,ga.y])}l[b]=G.x;l[b+1]=G.y}u.fillStyle=f[W][2]||xa;u.strokeStyle=f[W][1]||va;fa(l)}}}}function fa(a,d){if(a.length){u.beginPath();u.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)u.lineTo(a[b],
a[b+1]);u.closePath();d&&u.stroke();u.fill()}}function $(a,d,b){return{x:((a-ha)*b+ha<<0)+0.5,y:((d-ia)*b+ia<<0)+0.5}}var A=0,y=0,Q=0,Ca=0,ba=0,ca=0,S,ma,ua,H,u,Ba,Y=new T(200,190,180),wa=Y.adjustLightness(0.8),da=Y.adjustLightness(1.2),Ea=Y+"",va=wa+"",xa=da+"",qa,D,z,Z=1,Fa,U=1,na=Aa,Da=20,oa,ha,ia,ea,Ia,Ga,Ha,ra;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){Y=T.parse(a.color||a.wallColor);Ea=Y.adjustAlpha(U)+"";wa=Y.adjustLightness(0.8);va=wa.adjustAlpha(U)+"";da=Y.adjustLightness(1.2);
xa=da.adjustAlpha(U)+""}if(a.roofColor){da=T.parse(a.roofColor);xa=da.adjustAlpha(U)+""}F();return this};this.geoJSON=function(a,d){x(a,d);return this};this.setCamOffset=function(a,d){ha=Q+a;ia=y+d};this.setMaxZoom=function(a){Da=a};this.createCanvas=function(a){H=za.createElement("CANVAS");H.style.webkitTransform="translate3d(0,0,0)";H.style.imageRendering="optimizeSpeed";H.style.position="absolute";H.style.pointerEvents="none";H.style.left=0;H.style.top=0;a.appendChild(H);u=H.getContext("2d");u.lineCap=
"round";u.lineJoin="round";u.lineWidth=1;try{u.mozImageSmoothingEnabled=false}catch(d){}return H};this.destroyCanvas=function(){H.parentNode.removeChild(H)};this.loadData=h;this.onMoveEnd=function(){var a=w(ba,ca),d=w(ba+A,ca+y);F();if(D&&(a[ka]>D.n||a[la]<D.w||d[ka]<D.s||d[la]>D.e))h()};this.onZoomEnd=function(a){Ia=false;O(a.zoom);if(qa){z=r(qa);F()}else{F();h()}};this.onZoomStart=function(){Ia=true;F()};this.render=F;this.setOrigin=function(a,d){ba=a;ca=d};this.setSize=function(a,d){A=a;y=d;Q=
A/2<<0;Ca=y/2<<0;ha=Q;ia=y;ea=A/1.5/Na(45)<<0;H.width=A;H.height=y;oa=ea-50};this.setZoom=O;Ba=q};j.OSMBuildings.VERSION="0.1.7a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.canvas.style.left=-j.x+"px";
this.canvas.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=j;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;j=L.DomUtil.getPosition(this.map._mapPane);var I=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-j.x+"px";this.canvas.style.top=-j.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(j,I){return this.osmb.geoJSON(j,I)},
setStyle:function(j){return this.osmb.setStyle(j)}});
