(function(j){function N(o,p){var v=o[0]-p[0],f=o[1]-p[1];return v*v+f*f}function Ka(o){for(var p=0,v=0,f=0,h=o.length-3;f<h;f+=2){p+=o[f];v+=o[f+1]}o=(o.length-2)*2;return[p/o<<0,v/o<<0]}function La(o){var p=o.length/2,v=new Ma(p),f=0,h=p-1,k,t,q,D,J=[],O=[],K=[];for(v[f]=v[h]=1;h;){t=0;for(k=f+1;k<h;k++){q=o[k*2];var ba=o[k*2+1],P=o[f*2],V=o[f*2+1],ca=o[h*2],G=o[h*2+1],u=ca-P,z=G-V,E=void 0;if(u!==0||z!==0){E=((q-P)*u+(ba-V)*z)/(u*u+z*z);if(E>1){P=ca;V=G}else if(E>0){P+=u*E;V+=z*E}}u=q-P;z=ba-V;
q=u*u+z*z;if(q>t){D=k;t=q}}if(t>2){v[D]=1;J.push(f);O.push(D);J.push(D);O.push(h)}f=J.pop();h=O.pop()}for(k=0;k<p;k++)v[k]&&K.push(o[k*2],o[k*2+1]);return K}var Na=Na||Array,Ma=Ma||Array,da=Math,Sa=da.exp,Ta=da.log,Ua=da.sin,Va=da.cos,Da=da.tan,Wa=da.atan,ka=da.min,Ea=da.max,xa=j.document,Q=function(){function o(f,h,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return f+(h-f)*6*k;if(k<0.5)return h;if(k<2/3)return f+(h-f)*(2/3-k)*6;return f}function p(f,h,k,t){this.r=f;this.g=h;this.b=k;this.a=arguments.length<
4?1:t}var v=p.prototype;v.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};v.adjustLightness=function(f){var h=Q.toHSLA(this);h.l*=f;h.l=Math.min(1,Math.max(0,h.l));var k,t;if(h.s===0)f=k=t=h.l;else{t=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var q=2*h.l-t;f=o(q,t,h.h+1/3);k=o(q,t,h.h);t=o(q,t,h.h-1/3)}return new Q(f*255<<0,k*255<<0,t*255<<0,h.a)};v.adjustAlpha=function(f){return new Q(this.r,this.g,this.b,this.a*f)};p.parse=function(f){f+="";if(~f.indexOf("#")){f=
f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};p.toHSLA=function(f){var h=f.r/255,k=f.g/255,t=f.b/255,q=Math.max(h,k,t),D=Math.min(h,k,t),J,O=(q+D)/2,K;if(q===D)J=D=0;else{K=q-D;D=O>0.5?K/(2-q-D):K/(q+D);switch(q){case h:J=(k-t)/K+(k<t?6:0);break;case k:J=
(t-h)/K+2;break;case t:J=(h-k)/K+4;break}J/=6}return{h:J,s:D,l:O,a:f.a}};return p}(),Xa=function(){var o=Math,p=o.sin,v=o.cos,f=o.tan,h=o.asin,k=o.atan2,t=o.PI,q=180/t,D=357.5291/q,J=0.98560028/q,O=1.9148/q,K=0.02/q,ba=3.0E-4/q,P=102.9372/q,V=23.45/q,ca=280.16/q,G=360.9856235/q;return function(u,z,E){E=-E/q;z=z/q;u=u.valueOf()/864E5-0.5+2440588;var F=D+J*(u-2451545),H=O*p(F)+K*p(2*F)+ba*p(3*F);H=F+P+H+t;F=h(p(H)*p(V));H=k(p(H)*v(V),v(H));E=ca+G*(u-2451545)-E-H;return{altitude:h(p(z)*p(F)+v(z)*v(F)*
v(E)),azimuth:k(p(E),v(E)*p(z)-f(F)*v(z))-t/2}}}(),la=Math.PI,Oa=la/2,Ya=la/4,Za=180/la,$a=256,Fa=14,ma="latitude",na="longitude",Pa=3,Qa=4,T=0,R=1,U=2,W=3,ya=4,ha=5,Z=6;j.OSMBuildings=function(o){function p(a,c){var b={};a/=oa;c/=oa;b[ma]=c<=0?90:c>=1?-90:Za*(2*Wa(Sa(la*(1-2*c)))-Oa);b[na]=(a===1?1:(a%1+1)%1)*360-180;return b}function v(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function f(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===
4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function h(){if(!(!Ga||S<Fa)){var a=p(F-z,H-E),c=p(F+G+z,H+u+E);za&&za.abort();za=f(v(Ga,{w:a[na],n:a[ma],e:c[na],s:c[ma],z:S}),k)}}function k(a){var c,b,d,e,i=[],g=b=0;ia=Fa;O(S);za=null;if(!(!a||a.meta.z!==S)){e=a.meta;d=a.data;if(C&&x&&C.z===e.z){b=C.x-e.x;g=C.y-e.y;a=0;for(c=x.length;a<c;a++)i[a]=x[a][U][0]+b+","+(x[a][U][1]+g)}C=e;x=[];a=0;for(c=d.length;a<c;a++){e=[];
if(!(d[a][R]>pa)){b=La(d[a][U]);if(!(b.length<8)){e[U]=b;e[ya]=Ka(b);e[T]=ka(d[a][T],pa);e[R]=d[a][R];b=e[U][0]+","+e[U][1];e[ha]=!(i&&~i.indexOf(b));e[W]=[];e[Z]=[];b=d[a][Pa]?Q.parse(d[a][Pa]):null;g=d[a][Qa]?Q.parse(d[a][Qa]):null;e[W]=[b||null,b?b.adjustLightness(0.8):null,g?g:b?b.adjustLightness(1.2):ea];for(b=0;b<3;b++)if(e[W][b])e[Z][b]=e[W][b].adjustAlpha(X)+"";x.push(e)}}}K()}}function t(a,c){var b=[],d,e,i,g,l,n,m,A,w,I=Ha-S;d=0;for(e=a.length;d<e;d++){l=a[d];A=l[R]>>I;if(!(A>pa)){n=l[U];
w=new Na(n.length);i=0;for(g=n.length-1;i<g;i+=2){m=n[i+1];var y=ka(1,Ea(0,0.5-Ta(Da(Ya+Oa*n[i]/180))/la/2));m={x:(m/360+0.5)*oa<<0,y:y*oa<<0};w[i]=m.x;w[i+1]=m.y}w=La(w);if(!(w.length<8)){g=[];g[U]=w;g[ya]=Ka(w);g[T]=ka(l[T]>>I,pa);g[R]=A;g[ha]=c;g[W]=l[W];g[Z]=[];for(i=0;i<3;i++)if(g[W][i])g[Z][i]=g[W][i].adjustAlpha(X)+"";b.push(g)}}}return b}function q(a,c){if(typeof a==="object")J(a,!c);else{var b=xa.documentElement,d=xa.createElement("script");j.jsonpCallback=function(e){delete j.jsonpCallback;
b.removeChild(d);J(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,c,b){if(b===undefined)b=[];var d,e,i,g=a[0]?a:a.features,l,n,m,A,w,I=c?1:0,y=c?0:1;if(g){d=0;for(a=g.length;d<a;d++)D(g[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")n=[l.coordinates];if(l.type==="MultiPolygon")n=l.coordinates;if(n){c=d.height;if(d.color||d.wallColor)A=Q.parse(d.color||d.wallColor);if(d.roofColor)w=Q.parse(d.roofColor);d=0;
for(a=n.length;d<a;d++){g=n[d][0];m=[];e=l=0;for(i=g.length;e<i;e++){m.push(g[e][I],g[e][y]);l+=c||g[e][2]||0}if(l){e=[];i=U;var r=void 0,s=void 0,B=void 0,M=void 0,$=0,aa=void 0,qa=void 0;aa=0;for(qa=m.length-3;aa<qa;aa+=2){r=m[aa];s=m[aa+1];B=m[aa+2];M=m[aa+3];$+=r*M-B*s}if(($/2>0?"CW":"CCW")==="CW")m=m;else{r=[];for(s=m.length-2;s>=0;s-=2)r.push(m[s],m[s+1]);m=r}e[i]=m;e[T]=l/g.length<<0;e[W]=[A||null,A?A.adjustLightness(0.8):null,w?w:A?A.adjustLightness(1.2):ea];b.push(e)}}}return b}function J(a,
c){if(a){ra=D(a,c);ia=0;O(S);C={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};x=t(ra,true);K()}else{ra=null;P()}}function O(a){var c,b,d;S=a;oa=$a<<S;a=S;c=ia;b=Ha;a=ka(Ea(a,c),b);X=1-ka(Ea(0+(a-c)/(b-c)*0.4,0),0.4);Ia=fa.adjustAlpha(X)+"";sa=Aa.adjustAlpha(X)+"";ta=ea.adjustAlpha(X)+"";if(x){a=0;for(c=x.length;a<c;a++){d=x[a];d[Z]=[];for(b=0;b<3;b++)if(d[W][b])d[Z][b]=d[W][b].adjustAlpha(X)+""}}}function K(){clearInterval(Ja);ga=0;Ba.render();Ja=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(Ja);ga=
1;for(var a=0,c=x.length;a<c;a++)x[a][ha]=0}Ca.render();P()},33)}function ba(){Ca.render();Ba.render();P()}function P(){Y.clearRect(0,0,G,u);if(!(!C||!x||S<ia||ua)){var a,c,b,d,e,i,g,l,n,m=F-C.x,A=H-C.y,w=Ba.getMaxHeight(),I=[va+m,wa+A],y,r,s,B,M,$;x.sort(function(aa,qa){return N(qa[ya],I)/qa[T]-N(aa[ya],I)/aa[T]});a=0;for(c=x.length;a<c;a++){e=x[a];if(!(e[T]<=w)){r=false;i=e[U];y=[];b=0;for(d=i.length-1;b<d;b+=2){y[b]=l=i[b]-m;y[b+1]=n=i[b+1]-A;r||(r=l>0&&l<G&&n>0&&n<u)}if(r){b=e[ha]?e[T]*ga:e[T];
i=ja/(ja-b);if(e[R]){b=e[ha]?e[R]*ga:e[R];g=ja/(ja-b)}l=[];b=0;for(d=y.length-3;b<d;b+=2){n=y[b];s=y[b+1];r=y[b+2];B=y[b+3];M=ca(n,s,i);$=ca(r,B,i);if(e[R]){s=ca(n,s,g);B=ca(r,B,g);n=s.x;s=s.y;r=B.x;B=B.y}if((r-n)*(M.y-s)>(M.x-n)*(B-s)){Y.fillStyle=n<r&&s<B||n>r&&s>B?e[Z][1]||sa:e[Z][0]||Ia;V([r,B,n,s,M.x,M.y,$.x,$.y])}l[b]=M.x;l[b+1]=M.y}Y.fillStyle=e[Z][2]||ta;Y.strokeStyle=e[Z][1]||sa;V(l,true)}}}}}function V(a,c){if(a.length){Y.beginPath();Y.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)Y.lineTo(a[b],
a[b+1]);Y.closePath();c&&Y.stroke();Y.fill()}}function ca(a,c,b){return{x:(a-va)*b+va<<0,y:(c-wa)*b+wa<<0}}var G=0,u=0,z=0,E=0,F=0,H=0,S,oa,za,Y,Ga,fa=new Q(200,190,180),Aa=fa.adjustLightness(0.8),ea=fa.adjustLightness(1.2),Ia=fa+"",sa=Aa+"",ta=ea+"",ra,C,x,ga=1,Ja,X=1,ia=Fa,Ha=20,pa,va,wa,ja,ua,Ra={container:null,items:[],init:function(a){var c=this.container=xa.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;Ca.init(this.create());Ba.init(this.create());
Y=this.create();a.appendChild(c);return c},create:function(){var a=xa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,e=b.length;d<e;d++){b[d].width=a;b[d].height=
c}}},Ca={context:null,color:new Q(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,c,b,d,e;a.clearRect(0,0,G,u);if(!(!C||!x||S<ia||ua)){c=p(F+z,H+E);c=Xa(this.date,c.latitude,c.longitude);if(!(c.altitude<=0)){b=1/Da(c.altitude);d=0.4/b;this.directionX=Va(c.azimuth)*b;this.directionY=Ua(c.azimuth)*b;this.color.a=d;e=this.color+"";var i,g,l,n,m,A=F-C.x,w=H-C.y,
I,y,r,s,B,M,$=[];a.beginPath();c=0;for(b=x.length;c<b;c++){g=x[c];y=false;l=g[U];I=[];d=0;for(i=l.length-1;d<i;d+=2){I[d]=n=l[d]-A;I[d+1]=m=l[d+1]-w;y||(y=n>0&&n<G&&m>0&&m<u)}if(y){l=g[ha]?g[T]*ga:g[T];if(g[R])l=g[ha]?g[R]*ga:g[R];n=null;d=0;for(i=I.length-3;d<i;d+=2){m=I[d];r=I[d+1];y=I[d+2];s=I[d+3];B=this.project(m,r,l);M=this.project(y,s,l);if(g[R]){r=this.project(m,r,l);s=this.project(y,s,l);m=r.x;r=r.y;y=s.x;s=s.y}if((y-m)*(B.y-r)>(B.x-m)*(s-r)){n===1&&a.lineTo(m,r);n=0;d||a.moveTo(m,r);a.lineTo(y,
s)}else{n===0&&a.lineTo(B.x,B.y);n=1;d||a.moveTo(B.x,B.y);a.lineTo(M.x,M.y)}}a.closePath();$.push(I)}}a.fillStyle=e;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();c=0;for(b=$.length;c<b;c++){e=$[c];a.moveTo(e[0],e[1]);d=2;for(i=e.length;d<i;d+=2)a.lineTo(e[d],e[d+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},setDate:function(a){this.date=
a;this.render()}},Ba={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,G,u);if(!(!C||!x||S<ia||ua)){var c,b,d,e,i,g,l,n=F-C.x,m=H-C.y,A,w;a.beginPath();c=0;for(b=x.length;c<b;c++){d=x[c];w=false;i=d[U];A=[];d=0;for(e=i.length-1;d<e;d+=2){A[d]=g=i[d]-n;A[d+1]=l=i[d+1]-m;w||(w=g>0&&g<G&&l>0&&l<u)}if(w){d=0;for(e=A.length-3;d<e;d+=2){w=A[d];i=A[d+1];d?a.lineTo(w,i):a.moveTo(w,i)}a.closePath()}}a.fillStyle=ta;a.strokeStyle=sa;a.stroke();a.fill()}},
getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){fa=Q.parse(a.color||a.wallColor);Ia=fa.adjustAlpha(X)+"";Aa=fa.adjustLightness(0.8);sa=Aa.adjustAlpha(X)+"";ea=fa.adjustLightness(1.2);ta=ea.adjustAlpha(X)+""}if(a.roofColor){ea=Q.parse(a.roofColor);ta=ea.adjustAlpha(X)+""}ba();return this};this.geoJSON=function(a,c){q(a,c);return this};this.setCamOffset=function(a,c){va=z+a;wa=u+c};this.setMaxZoom=function(a){Ha=a};this.setDate=function(a){Ca.setDate(a);
return this};this.appendTo=function(a){return Ra.init(a)};this.loadData=h;this.onMoveEnd=function(){var a=p(F,H),c=p(F+G,H+u);ba();if(C&&(a[ma]>C.n||a[na]<C.w||c[ma]<C.s||c[na]>C.e))h()};this.onZoomEnd=function(a){ua=false;O(a.zoom);if(ra){x=t(ra);ba()}else{P();h()}};this.onZoomStart=function(){ua=true;ba()};this.setOrigin=function(a,c){F=a;H=c};this.setSize=function(a,c){G=a;u=c;z=G/2<<0;E=u/2<<0;va=z;wa=u;ja=G/(1.5/(window.devicePixelRatio||1))/Da(45)<<0;Ra.setSize(G,u);pa=ja-50};this.setZoom=O;
this.render=P;Ga=o};j.OSMBuildings.VERSION="0.1.8a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),N=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.container.style.left=-j.x+
"px";this.container.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(N.x-j.x,N.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),N=this.map.getPixelOrigin();this.osmb.setOrigin(N.x-j.x,N.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=
j;j=this.map._panes.overlayPane;if(this.osmb)j.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(j);this.osmb.maxZoom=this.map._layersMaxZoom}j=L.DomUtil.getPosition(this.map._mapPane);var N=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(N.x-j.x,N.y-j.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-j.x+"px";this.container.style.top=-j.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(j,N){return this.osmb.geoJSON(j,N)},setStyle:function(j){return this.osmb.setStyle(j)},
setDate:function(j){return this.osmb.setDate(j)}});
