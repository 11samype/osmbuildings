<<<<<<< HEAD
var OSMBuildings=function(){function d(a,b){var f=a[0]-b[0],e=a[1]-b[1];return f*f+e*e}function K(a){for(var b=0,f=0,e=0,g=a.length-3;e<g;e+=2)b+=a[e],f+=a[e+1];a=(a.length-2)/2;return[b/a<<0,f/a<<0]}function Ba(a){var b,f,e,g,d=0,m,h;m=0;for(h=a.length-3;m<h;m+=2)b=a[m],f=a[m+1],e=a[m+2],g=a[m+3],d+=b*g-e*f;if("CW"===(0<d/2?"CW":"CCW"))return a;b=[];for(f=a.length-2;0<=f;f-=2)b.push(a[f],a[f+1]);return b}var Ca=Ca||Array,Da=Da||Array,h=Math,La=h.exp,Ma=h.log,Na=h.sin,Oa=h.cos,ua=h.tan,Pa=h.atan,
oa=h.min,va=h.max,Ea=document,S,aa=function(a){var b,f,e;if(0===a.s)b=f=e=a.l;else{e=0.5>a.l?a.l*(1+a.s):a.l+a.s-a.l*a.s;var g=2*a.l-e;a.h/=360;b=T(g,e,a.h+1/3);f=T(g,e,a.h);e=T(g,e,a.h-1/3)}return new y(255*b<<0,255*f<<0,255*e<<0,a.a)},T=function(a,b,f){0>f&&(f+=1);1<f&&(f-=1);return f<1/6?a+6*(b-a)*f:0.5>f?b:f<2/3?a+6*(b-a)*(2/3-f):a},y=function(a,b,f,e){this.r=a;this.g=b;this.b=f;this.a=4>arguments.length?1:e},h=y.prototype;h.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};h.setLightness=function(a){var b=y.toHSLA(this);b.l*=a;b.l=Math.min(1,Math.max(0,b.l));return aa(b)};h.setAlpha=function(a){return new y(this.r,this.g,this.b,this.a*a)};y.parse=function(a){var b;a+="";if(~a.indexOf("#")&&(b=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new y(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new y(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?
parseFloat(b[5]):1);if(b=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return aa({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};y.toHSLA=function(a){var b=a.r/255,f=a.g/255,e=a.b/255,g=Math.max(b,f,e),d=Math.min(b,f,e),m,h=(g+d)/2,t;if(g===d)m=d=0;else{t=g-d;d=0.5<h?t/(2-g-d):t/(g+d);switch(g){case b:m=(f-e)/t+(f<e?6:0);break;case f:m=(e-b)/t+2;break;case e:m=(b-f)/t+4}m/=6}return{h:360*m,s:d,l:h,a:a.a}};S=y;var Fa,h=Math,x=h.sin,E=h.cos,
Qa=h.tan,ba=h.asin,ca=h.atan2,U=h.PI,k=180/U,Ra=357.5291/k,Sa=0.98560028/k,Ta=1.9148/k,Ua=0.02/k,Va=3E-4/k,Wa=102.9372/k,da=23.45/k,Xa=280.16/k,Ya=360.9856235/k;Fa=function(a,b,f){f=-f/k;b/=k;a=a.valueOf()/864E5-0.5+2440588;var e=Ra+Sa*(a-2451545),g=Ta*x(e)+Ua*x(2*e)+Va*x(3*e),g=e+Wa+g+U,e=ba(x(g)*x(da)),g=ca(x(g)*E(da),E(g));f=Xa+Ya*(a-2451545)-f-g;return{altitude:ba(x(b)*x(e)+E(b)*E(e)*E(f)),azimuth:ca(x(f),E(f)*x(b)-Qa(e)*E(b))-U/2}};var Ga,O=function(a){var b=parseFloat(a);return~a.indexOf("m")?
b<<0:~a.indexOf("yd")?b*Za<<0:~a.indexOf("ft")?b*ea<<0:~a.indexOf("'")?(a=a.split("'"),a[0]*ea+a[1]*$a<<0):b<<0},u=function(a){a=a.toLowerCase();return"#"===a[0]?a:ab[a]||null},G=function(a){a=a.toLowerCase();return"#"===a[0]?a:bb[cb[a]||a]||null},Ha=function(a){return(a=a.tags)&&!a.landuse&&(a.building||a["building:part"])&&(!a.layer||0<=a.layer)},Ia=function(a){if(a){for(var b=[],f,e=0,g=a.length;e<g;e++)f=M[a[e]],b.push(f[0],f[1]);b[b.length-2]!==b[0]&&b[b.length-1]!==b[1]&&b.push(b[0],b[1]);if(!(8>
b.length))return b}},F=function(a){var b=0,f=0;a.height&&(b=O(a.height));!b&&a["building:height"]&&(b=O(a["building:height"]));!b&&a.levels&&(b=a.levels*H<<0);!b&&a["building:levels"]&&(b=a["building:levels"]*H<<0);a.min_height&&(f=O(a.min_height));!f&&a["building:min_height"]&&(f=O(a["building:min_height"]));!f&&a.min_level&&(f=a.min_level*H<<0);!f&&a["building:min_level"]&&(f=a["building:min_level"]*H<<0);var e,g;a["building:material"]&&(e=G(a["building:material"]));a["building:facade:material"]&&
(e=G(a["building:facade:material"]));a["building:cladding"]&&(e=G(a["building:cladding"]));a["building:color"]&&(e=u(a["building:color"]));a["building:colour"]&&(e=u(a["building:colour"]));a["roof:material"]&&(g=G(a["roof:material"]));a["building:roof:material"]&&(g=G(a["building:roof:material"]));a["roof:color"]&&(g=u(a["roof:color"]));a["roof:colour"]&&(g=u(a["roof:colour"]));a["building:roof:color"]&&(g=u(a["building:roof:color"]));a["building:roof:colour"]&&(g=u(a["building:roof:colour"]));return{height:b,
minHeight:f,wallColor:e,roofColor:g}},Ja=function(a,b,f){a={id:a,footprint:Ba(f)};b.height&&(a.height=b.height);b.minHeight&&(a.minHeight=b.minHeight);b.wallColor&&(a.wallColor=b.wallColor);b.roofColor&&(a.roofColor=b.roofColor);fa.push(a)},Za=0.9144,ea=0.3048,$a=0.0254,H=3,ab={black:"#000000",white:"#ffffff",brown:"#8b4513",green:"#00ff7f",grey:"#bebebe",gray:"#bebebe",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",yellow:"#ffff00",red:"#ff0000",blue:"#0000ff"},cb={asphalt:"tar_paper",bitumen:"tar_paper",
block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},bb={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",
glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},M,X,fa;Ga=function(a){M={};X={};fa=[];for(var b,f=0,e=a.length;f<e;f++)switch(b=a[f],b.type){case "node":M[b.id]=[b.lat,b.lon];break;case "way":var g=void 0,d=void 0;Ha(b)?(g=F(b.tags),(d=Ia(b.nodes))&&Ja(b.id,g,d)):(g=b.tags)&&(!g.highway&&!g.railway&&!g.landuse)&&(X[b.id]=b);break;case "relation":var h=
g=g=void 0,d=void 0;if(Ha(b)&&("multipolygon"===b.tags.type||"building"===b.tags.type)){a:{for(var g=b.members,d=void 0,h=0,k=g.length;h<k;h++)if(d=g[h],"way"===d.type&&"outer"===d.role){g=d;break a}g=void 0}if(g&&(b=F(b.tags),g=X[g.ref]))if(h=F(g.tags),d=Ia(g.nodes)){k=void 0;for(k in b)h[k]||(h[k]=b[k]);Ja(g.id,h,d)}}}return fa};var ga=Math.PI,Ka=ga/2,db=ga/4,eb=180/ga,fb=256,gb="latitude",hb="longitude",h=function(){function a(a,b){var c={};a/=E;b/=E;c[gb]=0>=b?90:1<=b?-90:eb*(2*Pa(La(ga*(1-2*
b)))-Ka);c[hb]=360*(1===a?1:(a%1+1)%1)-180;return c}function b(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,ib){return b[ib]||a})}function f(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&c.status&&!(200>c.status||299<c.status)&&b&&c.responseText&&b(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}function e(){ha.render();pa.render();g()}function g(){v.clearRect(0,0,t,w);if(!(P<H||ia)){var a,b,c,f,e,g,wa,B,j,n=pa.MAX_HEIGHT,p=[ja+z,ka+A],
I,q,l,r,V,k;C.renderItems.sort(function(a,b){return d(b.center,p)/b.height-d(a.center,p)/a.height});a=0;for(b=C.renderItems.length;a<b;a++)if(e=C.renderItems[a],!(e.height<=n)){q=!1;g=e.footprint;I=[];c=0;for(f=g.length-1;c<f;c+=2)I[c]=B=g[c]-z,I[c+1]=j=g[c+1]-A,q||(q=0<B&&B<t&&0<j&&j<w);if(q){c=1>e.scale?e.height*e.scale:e.height;g=Y/(Y-c);e.minHeight&&(c=1>e.scale?e.minHeight*e.scale:e.minHeight,wa=Y/(Y-c));B=[];c=0;for(f=I.length-3;c<f;c+=2)j=I[c],l=I[c+1],q=I[c+2],r=I[c+3],V=m(j,l,g),k=m(q,r,
g),e.minHeight&&(l=m(j,l,wa),r=m(q,r,wa),j=l.x,l=l.y,q=r.x,r=r.y),(q-j)*(V.y-l)>(V.x-j)*(r-l)&&(v.fillStyle=j<q&&l<r||j>q&&l>r?e.altColor||la:e.wallColor||G,h([q,r,j,l,V.x,V.y,k.x,k.y])),B[c]=V.x,B[c+1]=V.y;v.fillStyle=e.roofColor||ma;v.strokeStyle=e.altColor||la;h(B,!0)}}}}function h(a,b){if(a.length){v.beginPath();v.moveTo(a[0],a[1]);for(var c=2,e=a.length;c<e;c+=2)v.lineTo(a[c],a[c+1]);v.closePath();b&&v.stroke();v.fill()}}function m(a,b,c){return{x:(a-ja)*c+ja<<0,y:(b-ka)*c+ka<<0}}function k(a){P=
a;E=fb<<P;a=P;var b=H,c=T;a=oa(va(a,b),c);N=1-oa(va(0+0.3*((a-b)/(c-b)),0),0.3);G=J.setAlpha(N)+"";la=u.setAlpha(N)+"";ma=Z.setAlpha(N)+""}var t=0,w=0,x=0,y=0,z=0,A=0,P,E,v,J=new S(200,190,180),u=J.setLightness(0.8),Z=J.setLightness(1.2),G=J+"",la=u+"",ma=Z+"",O,N=1,H=15,T=20,U,ja,ka,Y,ia,M=new Date,$={},F={add:function(a,b){$[a]={data:b,time:Date.now()}},get:function(a){return $[a]&&$[a].data},purge:function(){M.setMinutes(M.getMinutes()-5);for(var a in $)$[a].time<M&&delete $[a]}},C,fa=function(a){return function(b){X(b,
a)}},X=function(a,b){if(a){var c;if("FeatureCollection"===a.type){c=a.features;var e,f,d,g,h=[],j,n,p,I,q,l,r,k;e=0;for(f=c.length;e<f;e++)if(j=c[e],"Feature"===j.type&&(n=j.geometry,j=j.properties,"LineString"===n.type&&(l=p.length-1,p[0][0]===p[l][0]&&p[0][1]===p[l][1]&&(p=n.coordinates)),"Polygon"===n.type&&(p=n.coordinates),"MultiPolygon"===n.type&&(p=n.coordinates[0]),p)){if(j.color||j.wallColor)I=j.color||j.wallColor;j.roofColor&&(q=j.roofColor);n=p[0];k=[];r=j.height;d=l=0;for(g=n.length;d<
g;d++)k.push(n[d][1],n[d][0]),l+=r||n[d][2]||0;d={id:j.id||k[0]+","+k[1],footprint:Ba(k)};l&&(d.height=l/n.length<<0);j.minHeight&&(d.minHeight=j.minHeight);I&&(d.wallColor=I);q&&(d.roofColor=q);h.push(d)}c=h}else a.osm3s&&(c=Ga(a.elements));b&&F.add(b,c);aa(c,!0)}},aa=function(a,b){var c,d,f,g,h,B,j=[],n,p,k,q,l,r,m,s,t,x=T-P;f=0;for(g=a.length;f<g;f++)if(t=s=m=null,n=a[f],k=3*(n.height||15)>>x)if(q=3*n.minHeight>>x,!(q>U)){p=n.footprint;l=new Ca(p.length);h=0;for(B=p.length-1;h<B;h+=2)c=p[h+1],
d=oa(1,va(0,0.5-Ma(ua(db+Ka*p[h]/180))/ga/2)),c=(c/360+0.5)*E<<0,d=d*E<<0,l[h]=c,l[h+1]=d;h=l;B=h.length/2;p=new Da(B);l=0;c=B-1;var y=d=void 0,w=void 0,u=void 0,v=[],D=[],G=[];for(p[l]=p[c]=1;c;){y=0;for(d=l+1;d<c;d++){var w=h[2*d],H=h[2*d+1],z=h[2*l],A=h[2*l+1],J=h[2*c],M=h[2*c+1],Q=J-z,R=M-A,F=void 0;if(0!==Q||0!==R)F=((w-z)*Q+(H-A)*R)/(Q*Q+R*R),1<F?(z=J,A=M):0<F&&(z+=Q*F,A+=R*F);Q=w-z;R=H-A;w=Q*Q+R*R;w>y&&(u=d,y=w)}2<y&&(p[u]=1,v.push(l),D.push(u),v.push(u),D.push(c));l=v.pop();c=D.pop()}for(d=
0;d<B;d++)p[d]&&G.push(h[2*d],h[2*d+1]);l=G;if(!(8>l.length)){if(n.wallColor&&(r=S.parse(n.wallColor)))m=r.setAlpha(N),s=""+m.setLightness(0.8),m=""+m;if(n.roofColor&&(r=S.parse(n.roofColor)))t=""+r.setAlpha(N);j.push({id:n.id,footprint:l,height:oa(k,U),minHeight:q,wallColor:m,altColor:s,roofColor:t,center:K(l)})}}g=0;for(n=j.length;g<n;g++)f=j[g],qa[f.id]||(f.scale=b?0:1,na.renderItems.push(j[g]),qa[f.id]=1);O||(O=setInterval(function(){for(var a,b=!1,c=0,d=C.renderItems.length;c<d;c++)a=C.renderItems[c],
1>a.scale&&(a.scale+=0.1,1<a.scale&&(a.scale=1),b=!0);e();b||(clearInterval(O),O=null)},33))},xa,qa={},na={renderItems:[],load:function(a){xa=a;na.update()},update:function(){if(xa&&!(15>P)){var d=a(z,A),e=a(z+t,A+w),c=0.0075*(d.latitude/0.0075<<0)+0.0075,g=0.015*(e.longitude/0.015<<0)+0.015,e=0.0075*(e.latitude/0.0075<<0),d=0.015*(d.longitude/0.015<<0);F.purge();na.renderItems=[];qa={};for(var h,k,m;e<=c;e+=0.0075)for(h=d;h<=g;h+=0.015)m=e+","+h,(k=F.get(m))?aa(k):f(b(xa,{n:(1E4*(e+0.0075)<<0)/1E4,
e:(1E4*(h+0.015)<<0)/1E4,s:(1E4*e<<0)/1E4,w:(1E4*h<<0)/1E4}),fa(m))}},set:function(a){na.renderItems=[];qa={};X(a)}};C=na;var ha,sa=function(a,b,c){return{x:a+ra.x*c,y:b+ra.y*c}},s,ba=!0,ca=new S(0,0,0),da=null,ra={x:0,y:0},ya={setContext:function(a){s=a;ya.setDate((new Date).setHours(10))},enable:function(a){ba=!!a},render:function(){var b,d,c,e;s.clearRect(0,0,t,w);if(ba&&!(P<H||ia))if(b=a(z+x,A+y),b=Fa(da,b.latitude,b.longitude),!(0>=b.altitude)){d=1/ua(b.altitude);c=0.4/d;ra.x=Oa(b.azimuth)*d;
ra.y=Na(b.azimuth)*d;ca.a=c;e=ca+"";var f,g,h,k,j,n,p,m,q,l,r,u,v=[];s.beginPath();b=0;for(d=C.renderItems.length;b<d;b++){g=C.renderItems[b];m=!1;h=g.footprint;p=[];c=0;for(f=h.length-1;c<f;c+=2)p[c]=j=h[c]-z,p[c+1]=n=h[c+1]-A,m||(m=0<j&&j<t&&0<n&&n<w);if(m){h=1>g.scale?g.height*g.scale:g.height;g.minHeight&&(k=1>g.scale?g.minHeight*g.scale:g.minHeight);j=null;c=0;for(f=p.length-3;c<f;c+=2)n=p[c],q=p[c+1],m=p[c+2],l=p[c+3],r=sa(n,q,h),u=sa(m,l,h),g.minHeight&&(q=sa(n,q,k),l=sa(m,l,k),n=q.x,q=q.y,
m=l.x,l=l.y),(m-n)*(r.y-q)>(r.x-n)*(l-q)?(1===j&&s.lineTo(n,q),j=0,c||s.moveTo(n,q),s.lineTo(m,l)):(0===j&&s.lineTo(r.x,r.y),j=1,c||s.moveTo(r.x,r.y),s.lineTo(u.x,u.y));s.closePath();v.push(p)}}s.fillStyle=e;s.fill();s.globalCompositeOperation="destination-out";s.beginPath();b=0;for(d=v.length;b<d;b++){k=v[b];s.moveTo(k[0],k[1]);c=2;for(f=k.length;c<f;c+=2)s.lineTo(k[c],k[c+1]);s.lineTo(k[0],k[1]);s.closePath()}s.fillStyle="#00ff00";s.fill();s.globalCompositeOperation="source-over"}},setDate:function(a){da=
a;ya.render()}};ha=ya;var pa,D,ea={MAX_HEIGHT:8,setContext:function(a){D=a},render:function(){D.clearRect(0,0,t,w);if(!(P<H||ia)){var a,b,c,d,e,f,g,h,j;D.beginPath();a=0;for(b=C.renderItems.length;a<b;a++)if(c=C.renderItems[a],!(c.height>ea.MAX_HEIGHT)){j=!1;e=c.footprint;h=[];c=0;for(d=e.length-1;c<d;c+=2)h[c]=f=e[c]-z,h[c+1]=g=e[c+1]-A,j||(j=0<f&&f<t&&0<g&&g<w);if(j){c=0;for(d=h.length-3;c<d;c+=2)j=h[c],e=h[c+1],c?D.lineTo(j,e):D.moveTo(j,e);D.closePath()}}D.fillStyle=ma;D.strokeStyle=la;D.stroke();
D.fill()}}};pa=ea;var za,Aa=function(){var a=Ea.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";b.lineJoin="round";b.lineWidth=1;b.mozImageSmoothingEnabled=!1;b.webkitImageSmoothingEnabled=!1;ta.push(a);W.appendChild(a);return b},W=Ea.createElement("DIV");W.style.pointerEvents="none";W.style.position="absolute";W.style.left=0;W.style.top=0;
var ta=[];ha.setContext(Aa());pa.setContext(Aa());v=Aa();za={appendTo:function(a){a.appendChild(W);return W},setSize:function(a,b){for(var c=0,d=ta.length;c<d;c++)ta[c].width=a,ta[c].height=b}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)J=S.parse(a.color||a.wallColor),G=J.setAlpha(N)+"",u=J.setLightness(0.8),la=u.setAlpha(N)+"",Z=J.setLightness(1.2),ma=Z.setAlpha(N)+"";a.roofColor&&(Z=S.parse(a.roofColor),ma=Z.setAlpha(N)+"");void 0!==a.shadows&&ha.enable(a.shadows);e();return this};
this.setCamOffset=function(a,b){ja=x+a;ka=w+b};this.setMaxZoom=function(a){T=a};this.setDate=function(a){ha.setDate(a);return this};this.appendTo=function(a){return za.appendTo(a)};this.loadData=function(a){C.load(a);return this};this.setData=function(a){C.set(a);return this};this.onMoveEnd=function(){e();C.update()};this.onZoomEnd=function(a){ia=!1;k(a.zoom);C.update();e()};this.onZoomStart=function(){ia=!0;e()};this.setOrigin=function(a,b){z=a;A=b};this.setSize=function(a,b){t=a;w=b;x=t/2<<0;y=
w/2<<0;ja=x;ka=w;Y=t/(1.5/(window.devicePixelRatio||1))/ua(45)<<0;za.setSize(t,w);U=Y-50};this.setZoom=k;this.render=g};h.VERSION="0.1.8a";h.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';h.OSM_XAPI_URL="http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";return h}();
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(d){L.Util.setOptions(this,d)},onMove:function(){var d=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-d.x,this.lastY-d.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var d=L.DomUtil.getPosition(this.map._mapPane),K=this.map.getPixelOrigin();this.lastX=d.x;this.lastY=d.y;this.container.style.left=-d.x+"px";
this.container.style.top=-d.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(K.x-d.x,K.y-d.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var d=L.DomUtil.getPosition(this.map._mapPane),K=this.map.getPixelOrigin();this.osmb.setOrigin(K.x-d.x,K.y-d.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(d){d.addLayer(this);return this},onAdd:function(d){this.map=d;
d=this.map._panes.overlayPane;this.osmb?d.appendChild(this.container):(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(d),this.osmb.maxZoom=this.map._layersMaxZoom);d=L.DomUtil.getPosition(this.map._mapPane);var K=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(K.x-d.x,K.y-d.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-d.x+"px";this.container.style.top=-d.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.render()},onRemove:function(d){d.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);d.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},setStyle:function(d){return this.osmb.setStyle(d)},setDate:function(d){return this.osmb.setDate(d)},load:function(d){this.osmb.loadData(d)},
geoJSON:function(d){this.osmb.setData(d)}});
=======
var OSMBuildings=function(){function a(h,b){var wa=h[0]-b[0],a=h[1]-b[1];return wa*wa+a*a}function q(h){for(var b=0,a=0,j=0,e=h.length-3;j<e;j+=2)b+=h[j],a+=h[j+1];h=(h.length-2)/2;return[b/h<<0,a/h<<0]}var xa=xa||Array,ya=ya||Array,g=Math,Ga=g.exp,Ha=g.log,Ia=g.sin,Ja=g.cos,na=g.tan,Ka=g.atan,ea=g.min,oa=g.max,za=document,O,T=function(h){var b,a,j;if(0===h.s)b=a=j=h.l;else{j=0.5>h.l?h.l*(1+h.s):h.l+h.s-h.l*h.s;var e=2*h.l-j;h.h/=360;b=E(e,j,h.h+1/3);a=E(e,j,h.h);j=E(e,j,h.h-1/3)}return new x(255*
b<<0,255*a<<0,255*j<<0,h.a)},E=function(h,b,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?h+6*(b-h)*a:0.5>a?b:a<2/3?h+6*(b-h)*(2/3-a):h},x=function(a,b,g,j){this.r=a;this.g=b;this.b=g;this.a=4>arguments.length?1:j},g=x.prototype;g.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};g.setLightness=function(a){var b=x.toHSLA(this);b.l*=a;b.l=Math.min(1,Math.max(0,b.l));return T(b)};g.setAlpha=function(a){return new x(this.r,this.g,this.b,this.a*a)};x.parse=function(a){var b;
a+="";if(~a.indexOf("#")&&(b=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new x(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new x(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?parseFloat(b[5]):1);if(b=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return T({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};x.toHSLA=
function(a){var b=a.r/255,g=a.g/255,j=a.b/255,e=Math.max(b,g,j),l=Math.min(b,g,j),q,t=(e+l)/2,v;if(e===l)q=l=0;else{v=e-l;l=0.5<t?v/(2-e-l):v/(e+l);switch(e){case b:q=(g-j)/v+(g<j?6:0);break;case g:q=(j-b)/v+2;break;case j:q=(b-g)/v+4}q/=6}return{h:360*q,s:l,l:t,a:a.a}};O=x;var Aa,g=Math,t=g.sin,w=g.cos,La=g.tan,U=g.asin,V=g.atan2,H=g.PI,l=180/H,Ma=357.5291/l,Na=0.98560028/l,Oa=1.9148/l,Pa=0.02/l,Qa=3E-4/l,Ra=102.9372/l,W=23.45/l,Sa=280.16/l,Ta=360.9856235/l;Aa=function(a,b,g){g=-g/l;b/=l;a=a.valueOf()/
864E5-0.5+2440588;var j=Ma+Na*(a-2451545),e=Oa*t(j)+Pa*t(2*j)+Qa*t(3*j),e=j+Ra+e+H,j=U(t(e)*t(W)),e=V(t(e)*w(W),w(e));g=Sa+Ta*(a-2451545)-g-e;return{altitude:U(t(b)*t(j)+w(b)*w(j)*w(g)),azimuth:V(t(g),w(g)*t(b)-La(j)*w(b))-H/2}};var X=Math.PI,Ba=X/2,Ua=X/4,Va=180/X,Wa=256,Xa="latitude",Ya="longitude",g=function(){function g(d,a){var c={};d/=Y;a/=Y;c[Xa]=0>=a?90:1<=a?-90:Va*(2*Ka(Ga(X*(1-2*a)))-Ba);c[Ya]=360*(1===d?1:(d%1+1)%1)-180;return c}function b(d,a){return d.replace(/\{ *([\w_]+) *\}/g,function(d,
b){return a[b]||d})}function l(d,a){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&c.status&&!(200>c.status||299<c.status)&&a&&c.responseText&&a(JSON.parse(c.responseText))};c.open("GET",d);c.send(null);return c}function j(d){F=d;Y=Wa<<F;d=F;var a=fa,c=pa;d=ea(oa(d,a),c);I=1-ea(oa(0+0.3*((d-a)/(c-a)),0),0.3);H=G.setAlpha(I)+"";Z=ga.setAlpha(I)+"";$=P.setAlpha(I)+"";y.renderItems=y.scale(y.rawItems,F)}function e(){aa.render();ha.render();t()}function t(){A.clearRect(0,0,
v,z);if(!(F<fa||ba)){var d,Ca,c,b,f,g,m,n,r,j=ha.MAX_HEIGHT,h=[ca+B,da+C],K,p,k,u,e,l;y.renderItems.sort(function(d,c){return a(c.center,h)/c.height-a(d.center,h)/d.height});d=0;for(Ca=y.renderItems.length;d<Ca;d++)if(f=y.renderItems[d],!(f.height<=j)){p=!1;g=f.footprint;K=[];c=0;for(b=g.length-1;c<b;c+=2)K[c]=n=g[c]-B,K[c+1]=r=g[c+1]-C,p||(p=0<n&&n<v&&0<r&&r<z);if(p){c=1>f.scale?f.height*f.scale:f.height;g=Q/(Q-c);f.minHeight&&(c=1>f.scale?f.minHeight*f.scale:f.minHeight,m=Q/(Q-c));n=[];c=0;for(b=
K.length-3;c<b;c+=2)r=K[c],k=K[c+1],p=K[c+2],u=K[c+3],e=w(r,k,g),l=w(p,u,g),f.minHeight&&(k=w(r,k,m),u=w(p,u,m),r=k.x,k=k.y,p=u.x,u=u.y),(p-r)*(e.y-k)>(e.x-r)*(u-k)&&(A.fillStyle=r<p&&k<u||r>p&&k>u?f.altColor||Z:f.wallColor||H,x([p,u,r,k,e.x,e.y,l.x,l.y])),n[c]=e.x,n[c+1]=e.y;A.fillStyle=f.roofColor||$;A.strokeStyle=f.altColor||Z;x(n,!0)}}}}function x(d,a){if(d.length){A.beginPath();A.moveTo(d[0],d[1]);for(var c=2,b=d.length;c<b;c+=2)A.lineTo(d[c],d[c+1]);A.closePath();a&&A.stroke();A.fill()}}function w(d,
a,c){return{x:(d-ca)*c+ca<<0,y:(a-da)*c+da<<0}}var v=0,z=0,ia=0,E=0,B=0,C=0,F,Y,A,G=new O(200,190,180),ga=G.setLightness(0.8),P=G.setLightness(1.2),H=G+"",Z=ga+"",$=P+"",ja,I=1,fa=15,pa=20,qa,ca,da,Q,ba,ra,sa=function(){var d=za.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering="optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;var a=d.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.mozImageSmoothingEnabled=!1;a.webkitImageSmoothingEnabled=
!1;ka.push(d);J.appendChild(d);return a},J=za.createElement("DIV");J.style.pointerEvents="none";J.style.position="absolute";J.style.left=0;J.style.top=0;var ka=[];aa.setContext(sa());ha.setContext(sa());A=sa();ra={appendTo:function(d){d.appendChild(J);return J},setSize:function(d,a){for(var c=0,b=ka.length;c<b;c++)ka[c].width=d,ka[c].height=a}};var ta=new Date,R={},T={add:function(d,a){R[d]={data:a,time:Date.now()}},get:function(d){return R[d]&&R[d].data},purge:function(){ta.setMinutes(ta.getMinutes()-
5);for(var d in R)R[d].time<ta&&delete R[d]}},y,U=function(){S.rawItems=[];S.renderItems=[];T.purge()},V=function(d,a){for(var c=S.scale(d,F,a),b=0,f=c.length;b<f;b++)S.renderItems.push(c[b]);ja||(ja=setInterval(function(){for(var d,a=!1,c=0,b=y.renderItems.length;c<b;c++)d=y.renderItems[c],1>d.scale&&(d.scale+=0.1,1<d.scale&&(d.scale=1),a=!0);e();a||(clearInterval(ja),ja=null)},33))},ua,S={rawItems:[],renderItems:[],load:function(d){ua=d;S.update()},update:function(){if(ua&&!(15>F)){var d=g(B,C),
a=g(B+v,C+z),c=0.0075*(d.latitude/0.0075<<0)+0.0075,j=0.015*(a.longitude/0.015<<0)+0.015,a=0.0075*(a.latitude/0.0075<<0),d=0.015*(d.longitude/0.015<<0);U();for(var f,e,m;a<=c;a+=0.0075)for(e=d;e<=j;e+=0.015)m=a+","+e,(f=T.get(m))?V(f):l(b(ua,{n:(1E4*(a+0.0075)<<0)/1E4,e:(1E4*(e+0.015)<<0)/1E4,s:(1E4*a<<0)/1E4,w:(1E4*e<<0)/1E4}))}},set:function(d){U();if(d){d=d.features;var a,c,b,f,g=[],m,n,r,e,j,h,p,k;a=0;for(c=d.length;a<c;a++)if(m=d[a],"Feature"===m.type&&(n=m.geometry,m=m.properties,"LineString"===
n.type&&(h=r.length-1,r[0][0]===r[h][0]&&r[0][1]===r[h][1]&&(r=n.coordinates)),"Polygon"===n.type&&(r=n.coordinates),"MultiPolygon"===n.type&&(r=n.coordinates[0]),r)){if(m.color||m.wallColor)e=m.color||m.wallColor;m.roofColor&&(j=m.roofColor);n=r[0];k=[];p=m.height;b=h=0;for(f=n.length;b<f;b++)k.push(n[b][1],n[b][0]),h+=p||n[b][2]||0;b=m.id||k[0]+","+k[1];for(var u=p=f=void 0,l=void 0,s=0,q=void 0,v=void 0,q=0,v=k.length-3;q<v;q+=2)f=k[q],p=k[q+1],u=k[q+2],l=k[q+3],s+=f*l-u*p;if("CW"!==(0<s/2?"CW":
"CCW")){f=[];for(p=k.length-2;0<=p;p-=2)f.push(k[p],k[p+1]);k=f}b={id:b,footprint:k};h&&(b.height=h/n.length<<0);m.minHeight&&(b.minHeight=m.minHeight);e&&(b.wallColor=e);j&&(b.roofColor=j);g.push(b)}V(g,!0)}},scale:function(d,a,c){var b,f,g,m,n,e=[],h,j,l,p,k,u,s,v,y,t=pa-a;a=0;for(g=d.length;a<g;a++)if(y=v=s=null,h=d[a],l=3*(h.height||15)>>t)if(p=3*h.minHeight>>t,!(p>qa)){j=h.footprint;k=new xa(j.length);m=0;for(n=j.length-1;m<n;m+=2)b=j[m+1],f=ea(1,oa(0,0.5-Ha(na(Ua+Ba*j[m]/180))/X/2)),b=(b/360+
0.5)*Y<<0,f=f*Y<<0,k[m]=b,k[m+1]=f;m=k;n=m.length/2;j=new ya(n);k=0;b=n-1;var x=f=void 0,w=void 0,z=void 0,A=[],D=[],F=[];for(j[k]=j[b]=1;b;){x=0;for(f=k+1;f<b;f++){var w=m[2*f],G=m[2*f+1],B=m[2*k],C=m[2*k+1],H=m[2*b],J=m[2*b+1],M=H-B,N=J-C,E=void 0;if(0!==M||0!==N)E=((w-B)*M+(G-C)*N)/(M*M+N*N),1<E?(B=H,C=J):0<E&&(B+=M*E,C+=N*E);M=w-B;N=G-C;w=M*M+N*N;w>x&&(z=f,x=w)}2<x&&(j[z]=1,A.push(k),D.push(z),A.push(z),D.push(b));k=A.pop();b=D.pop()}for(f=0;f<n;f++)j[f]&&F.push(m[2*f],m[2*f+1]);k=F;if(!(8>k.length)){if(h.wallColor&&
(u=O.parse(h.wallColor)))s=u.setAlpha(I),v=""+s.setLightness(0.8),s=""+s;if(h.roofColor&&(u=O.parse(h.roofColor)))y=""+u.setAlpha(I);e.push({id:h.id,footprint:k,height:ea(l,qa),minHeight:p,wallColor:s,altColor:v,roofColor:y,center:q(k),scale:c?0:1})}}return e}};y=S;var aa,ma=function(a,b,c){return{x:a+la.x*c,y:b+la.y*c}},s,W=!0,Da=new O(0,0,0),Ea=null,la={x:0,y:0},va={setContext:function(a){s=a;va.setDate((new Date).setHours(10))},enable:function(a){W=!!a},render:function(){var a,b,c,j;s.clearRect(0,
0,v,z);if(W&&!(F<fa||ba))if(a=g(B+ia,C+E),a=Aa(Ea,a.latitude,a.longitude),!(0>=a.altitude)){b=1/na(a.altitude);c=0.4/b;la.x=Ja(a.azimuth)*b;la.y=Ia(a.azimuth)*b;Da.a=c;j=Da+"";var f,e,m,n,r,l,q,t,p,k,u,w,x=[];s.beginPath();a=0;for(b=y.renderItems.length;a<b;a++){e=y.renderItems[a];t=!1;m=e.footprint;q=[];c=0;for(f=m.length-1;c<f;c+=2)q[c]=r=m[c]-B,q[c+1]=l=m[c+1]-C,t||(t=0<r&&r<v&&0<l&&l<z);if(t){m=1>e.scale?e.height*e.scale:e.height;e.minHeight&&(n=1>e.scale?e.minHeight*e.scale:e.minHeight);r=null;
c=0;for(f=q.length-3;c<f;c+=2)l=q[c],p=q[c+1],t=q[c+2],k=q[c+3],u=ma(l,p,m),w=ma(t,k,m),e.minHeight&&(p=ma(l,p,n),k=ma(t,k,n),l=p.x,p=p.y,t=k.x,k=k.y),(t-l)*(u.y-p)>(u.x-l)*(k-p)?(1===r&&s.lineTo(l,p),r=0,c||s.moveTo(l,p),s.lineTo(t,k)):(0===r&&s.lineTo(u.x,u.y),r=1,c||s.moveTo(u.x,u.y),s.lineTo(w.x,w.y));s.closePath();x.push(q)}}s.fillStyle=j;s.fill();s.globalCompositeOperation="destination-out";s.beginPath();a=0;for(b=x.length;a<b;a++){n=x[a];s.moveTo(n[0],n[1]);c=2;for(f=n.length;c<f;c+=2)s.lineTo(n[c],
n[c+1]);s.lineTo(n[0],n[1]);s.closePath()}s.fillStyle="#00ff00";s.fill();s.globalCompositeOperation="source-over"}},setDate:function(a){Ea=a;va.render()}};aa=va;var ha,D,Fa={MAX_HEIGHT:8,setContext:function(a){D=a},render:function(){D.clearRect(0,0,v,z);if(!(F<fa||ba)){var a,b,c,e,f,g,j,h,l;D.beginPath();a=0;for(b=y.renderItems.length;a<b;a++)if(c=y.renderItems[a],!(c.height>Fa.MAX_HEIGHT)){l=!1;f=c.footprint;h=[];c=0;for(e=f.length-1;c<e;c+=2)h[c]=g=f[c]-B,h[c+1]=j=f[c+1]-C,l||(l=0<g&&g<v&&0<j&&
j<z);if(l){c=0;for(e=h.length-3;c<e;c+=2)l=h[c],f=h[c+1],c?D.lineTo(l,f):D.moveTo(l,f);D.closePath()}}D.fillStyle=$;D.strokeStyle=Z;D.stroke();D.fill()}}};ha=Fa;this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)G=O.parse(a.color||a.wallColor),H=G.setAlpha(I)+"",ga=G.setLightness(0.8),Z=ga.setAlpha(I)+"",P=G.setLightness(1.2),$=P.setAlpha(I)+"";a.roofColor&&(P=O.parse(a.roofColor),$=P.setAlpha(I)+"");void 0!==a.shadows&&aa.enable(a.shadows);e();return this};this.setCamOffset=function(a,b){ca=
ia+a;da=z+b};this.setMaxZoom=function(a){pa=a};this.setDate=function(a){aa.setDate(a);return this};this.appendTo=function(a){return ra.appendTo(a)};this.loadData=function(a){y.load(a);return this};this.setData=function(a){y.set(a);return this};this.onMoveEnd=function(){e();y.update()};this.onZoomEnd=function(a){ba=!1;j(a.zoom);y.update();e()};this.onZoomStart=function(){ba=!0;e()};this.setOrigin=function(a,b){B=a;C=b};this.setSize=function(a,b){v=a;z=b;ia=v/2<<0;E=z/2<<0;ca=ia;da=z;Q=v/(1.5/(window.devicePixelRatio||
1))/na(45)<<0;ra.setSize(v,z);qa=Q-50};this.setZoom=j;this.render=t};g.VERSION="0.1.8a";g.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';g.OSM_XAPI_URL="http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";return g}();
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),q=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(q.x-a.x,q.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),q=this.map.getPixelOrigin();this.osmb.setOrigin(q.x-a.x,q.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var q=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(q.x-a.x,q.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},setStyle:function(a){return this.osmb.setStyle(a)},setDate:function(a){return this.osmb.setDate(a)},load:function(a){this.osmb.loadData(a)},
geoJSON:function(a){this.osmb.setData(a)}});
>>>>>>> be06c3628419de661af2c8bb557af93385a05bab
