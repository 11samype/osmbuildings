(function(i){function I(t,x){var C=t[0]-x[0],e=t[1]-x[1];return C*C+e*e}function Pa(t){for(var x=0,C=0,e=0,h=t.length-3;e<h;e+=2){x+=t[e];C+=t[e+1]}t=(t.length-2)*2;return[x/t<<0,C/t<<0]}function Qa(t){var x=t.length/2,C=new Ra(x),e=0,h=x-1,j,u,z,D,J=[],O=[],P=[];for(C[e]=C[h]=1;h;){u=0;for(j=e+1;j<h;j++){z=t[j*2];var ea=t[j*2+1],aa=t[e*2],F=t[e*2+1],ja=t[h*2],fa=t[h*2+1],A=ja-aa,y=fa-F,K=void 0;if(A!==0||y!==0){K=((z-aa)*A+(ea-F)*y)/(A*A+y*y);if(K>1){aa=ja;F=fa}else if(K>0){aa+=A*K;F+=y*K}}A=z-aa;
y=ea-F;z=A*A+y*y;if(z>u){D=j;u=z}}if(u>2){C[D]=1;J.push(e);O.push(D);J.push(D);O.push(h)}e=J.pop();h=O.pop()}for(j=0;j<x;j++)C[j]&&P.push(t[j*2],t[j*2+1]);return P}var Sa=Sa||Array,Ra=Ra||Array,$a=Math.exp,ab=Math.log,Fa=Math.tan,bb=Math.atan,Ga=Math.min,cb=Math.max,Ha=i.document,M=function(){function t(e,h,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return e+(h-e)*6*j;if(j<0.5)return h;if(j<2/3)return e+(h-e)*(2/3-j)*6;return e}function x(e,h,j,u){this.r=e;this.g=h;this.b=j;this.a=arguments.length<4?1:u}
var C=x.prototype;C.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};C.adjustLightness=function(e){var h=M.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var j,u;if(h.s===0)e=j=u=h.l;else{u=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var z=2*h.l-u;e=t(z,u,h.h+1/3);j=t(z,u,h.h);u=t(z,u,h.h-1/3)}return new M(e*255<<0,j*255<<0,u*255<<0,h.a)};C.adjustAlpha=function(e){return new M(this.r,this.g,this.b,this.a*e)};x.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new M(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new M(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};x.toHSLA=function(e){var h=e.r/255,j=e.g/255,u=e.b/255,z=Math.max(h,j,u),D=Math.min(h,j,u),J,O=(z+D)/2,P;if(z===D)J=D=0;else{P=z-D;D=O>0.5?P/(2-z-D):P/(z+D);switch(z){case h:J=(j-u)/P+(j<u?6:0);break;case j:J=
(u-h)/P+2;break;case u:J=(h-j)/P+4;break}J/=6}return{h:J,s:D,l:O,a:e.a}};return x}(),ga=Math.PI,Ta=ga/2,db=ga/4,eb=180/ga,fb=256,Ia=14,na="latitude",oa="longitude",U=0,N=1,Q=2,ba=3,xa=4,pa=5,$=6;i.OSMBuildings=function(t){function x(a,c){var b={};a/=qa;c/=qa;b[na]=c<=0?90:c>=1?-90:eb*(2*bb($a(ga*(1-2*c)))-Ta);b[oa]=(a===1?1:(a%1+1)%1)*360-180;return b}function C(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===
4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function h(){if(!(!Ja||R<Ia)){var a=x(V-K,W-ya),c=x(V+A+K,W+y+ya);za&&za.abort();za=e(C(Ja,{w:a[oa],n:a[na],e:c[oa],s:c[na],z:R}),j)}}function j(a){var c,b,d,f=[],g,k=g=0;ra=Ia;O(R);za=null;if(!(!a||a.meta.z!==R)){d=a.meta;b=a.data;if(E&&B&&E.z===d.z){g=E.x-d.x;k=E.y-d.y;a=0;for(c=B.length;a<c;a++)f[a]=B[a][Q][0]+g+","+(B[a][Q][1]+k)}E=d;B=[];a=0;for(c=b.length;a<c;a++){d=
[];if(!(b[a][N]>sa)){g=Qa(b[a][Q]);if(!(g.length<8)){d[Q]=g;d[xa]=Pa(g);d[U]=Ga(b[a][U],sa);d[N]=b[a][N];g=d[Q][0]+","+d[Q][1];d[pa]=!(f&&~f.indexOf(g));d[ba]=[];d[$]=[];B.push(d)}}}aa()}}function u(a,c){var b=[],d,f,g,k,m,l,o,w,r,v=Ka-R;d=0;for(f=a.length;d<f;d++){m=a[d];w=m[N]>>v;if(!(w>sa)){l=m[Q];r=new Sa(l.length);g=0;for(k=l.length-1;g<k;g+=2){o=l[g+1];var p=Ga(1,cb(0,0.5-ab(Fa(db+Ta*l[g]/180))/ga/2));o={x:(o/360+0.5)*qa<<0,y:p*qa<<0};r[g]=o.x;r[g+1]=o.y}r=Qa(r);if(!(r.length<8)){k=[];k[Q]=
r;k[xa]=Pa(r);k[U]=Ga(m[U]>>v,sa);k[N]=w;k[pa]=c;k[ba]=m[ba];k[$]=[];for(g=0;g<3;g++)if(k[ba][g])k[$][g]=k[ba][g].adjustAlpha(S)+"";b.push(k)}}}return b}function z(a,c){if(typeof a==="object")J(a,!c);else{var b=Ha.documentElement,d=Ha.createElement("script");i.jsonpCallback=function(f){delete i.jsonpCallback;b.removeChild(d);J(f,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,c,b){if(b===undefined)b=[];var d,f,g,k=a[0]?a:a.features,m,l,o,w,r,v=c?1:0,
p=c?0:1;if(k){d=0;for(a=k.length;d<a;d++)D(k[d],c,b);return b}if(a.type==="Feature"){m=a.geometry;d=a.properties}if(m.type==="Polygon")l=[m.coordinates];if(m.type==="MultiPolygon")l=m.coordinates;if(l){c=d.height;if(d.color||d.wallColor)w=M.parse(d.color||d.wallColor);if(d.roofColor)r=M.parse(d.roofColor);d=0;for(a=l.length;d<a;d++){k=l[d][0];o=[];f=m=0;for(g=k.length;f<g;f++){o.push(k[f][v],k[f][p]);m+=c||k[f][2]||0}if(m){f=[];g=Q;var q=void 0,s=void 0,H=void 0,X=void 0,ta=0,Y=void 0,Ua=void 0;Y=
0;for(Ua=o.length-3;Y<Ua;Y+=2){q=o[Y];s=o[Y+1];H=o[Y+2];X=o[Y+3];ta+=q*X-H*s}if((ta/2>0?"CW":"CCW")==="CW")o=o;else{q=[];for(s=o.length-2;s>=0;s-=2)q.push(o[s],o[s+1]);o=q}f[g]=o;f[U]=m/k.length<<0;f[ba]=[w||null,w?w.adjustLightness(0.8):null,r?r:w?w.adjustLightness(1.2):ha];b.push(f)}}}return b}function J(a,c){if(a){ua=D(a,c);ra=0;O(R);E={n:90,w:-180,s:-90,e:180,x:0,y:0,z:R};B=u(ua,true);aa()}else{ua=null;F()}}function O(a){var c,b,d;R=a;qa=fb<<R;S=1-(R-ra)*0.3/(Ka-ra);Aa=ca.adjustAlpha(S)+"";Ba=
Ca.adjustAlpha(S)+"";Da=ha.adjustAlpha(S)+"";La=Va.adjustAlpha(S)+"";if(B){a=0;for(c=B.length;a<c;a++){d=B[a];d[$]=[];for(b=0;b<3;b++)if(d[ba][b])d[$][b]=d[ba][b].adjustAlpha(S)+""}}}function P(){var a,c,b,d,f,g,k,m,l,o=V-E.x,w=W-E.y,r,v,p,q,s,H,X=[];n.fillStyle=La;a=0;for(c=B.length;a<c;a++){f=B[a];v=false;g=f[Q];r=[];b=0;for(d=g.length-1;b<d;b+=2){r[b]=m=g[b]-o;r[b+1]=l=g[b+1]-w;v||(v=m>0&&m<A&&l>0&&l<y)}if(v){b=f[U];g=va/(va-b);if(f[N]){b=f[N];k=va/(va-b)}m=null;n.beginPath();b=0;for(d=r.length-
3;b<d;b+=2){l=r[b];p=r[b+1];v=r[b+2];q=r[b+3];s=ea(l,p,g);H=ea(v,q,g);if(f[N]){p=ea(l,p,k);q=ea(v,q,k);l=p.x;p=p.y;v=q.x;q=q.y}if((v-l)*(s.y-p)>(s.x-l)*(q-p)){m===1&&n.lineTo(l,p);m=0;b||n.moveTo(l,p);n.lineTo(v,q)}else{m===0&&n.lineTo(s.x,s.y);m=1;b||n.moveTo(s.x,s.y);n.lineTo(H.x,H.y)}}n.closePath();n.fill();X.push(r)}}n.fillStyle=Aa;a=0;for(c=X.length;a<c;a++)ja(X[a]);a=n.getImageData(0,0,A,y);c=a.data;f=M.parse(La).a*255<<0;w=0;for(r=c.length;w<r;w+=4){k=c[w+0];o=c[w+3];if(k&&o>=255)c[w+3]=0;
else if(o>f)c[w+3]=f}n.putImageData(a,0,0);da=new Image;da.src=G.toDataURL()}function ea(a,c,b){return{x:(a-Ma)*b+Ma,y:(c-Ea)*b+Ea}}function aa(){ka=0;da=null;clearInterval(Na);Na=setInterval(function(){ka+=0.1;if(ka>1){clearInterval(Na);ka=1;for(var a=0,c=B.length;a<c;a++)B[a][pa]=0}F()},33)}function F(){n.clearRect(0,0,A,y);if(E&&B)if(!(R<ra||Oa)){if(Wa)if(da)n.drawImage(da,Xa-V,Ya-W);else{P();Xa=V;Ya=W}var a,c,b,d,f,g,k,m,l,o=V-E.x,w=W-E.y,r=[la+o,wa+w],v,p,q,s,H,X;B.sort(function(ta,Y){return I(Y[xa],
r)/Y[U]-I(ta[xa],r)/ta[U]});a=0;for(c=B.length;a<c;a++){f=B[a];p=false;g=f[Q];v=[];b=0;for(d=g.length-1;b<d;b+=2){v[b]=m=g[b]-o;v[b+1]=l=g[b+1]-w;p||(p=m>0&&m<A&&l>0&&l<y)}if(p){b=f[pa]?f[U]*ka:f[U];g=ma/(ma-b);if(f[N]){b=f[pa]?f[N]*ka:f[N];k=ma/(ma-b)}m=[];b=0;for(d=v.length-3;b<d;b+=2){l=v[b];q=v[b+1];p=v[b+2];s=v[b+3];H=fa(l,q,g);X=fa(p,s,g);if(f[N]){q=fa(l,q,k);s=fa(p,s,k);l=q.x;q=q.y;p=s.x;s=s.y}if((p-l)*(H.y-q)>(H.x-l)*(s-q)){n.fillStyle=l<p&&q<s||l>p&&q>s?f[$][1]||Ba:f[$][0]||Aa;ja([p,s,l,
q,H.x,H.y,X.x,X.y])}m[b]=H.x;m[b+1]=H.y}n.fillStyle=f[$][2]||Da;n.strokeStyle=f[$][1]||Ba;ja(m,true)}}}}function ja(a,c){if(a.length){n.beginPath();n.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)n.lineTo(a[b],a[b+1]);n.closePath();c&&n.stroke();n.fill()}}function fa(a,c,b){return{x:(a-la)*b+la<<0,y:(c-wa)*b+wa<<0}}var A=0,y=0,K=0,ya=0,V=0,W=0,R,qa,za,G,n,Ja,ca=new M(200,190,180),Ca=ca.adjustLightness(0.8),ha=ca.adjustLightness(1.2),Va=new M(0,0,0,0.4),Aa=ca+"",Ba=Ca+"",Da=ha+"",La=Va+"",Wa=true,
ua,E,B,ka=1,Na,S=1,ra=Ia,Ka=20,sa,la,wa,ma,Oa,Ma,Ea,va,Xa,Ya,da,Z=Math.sin,ia=Math.cos,T=ga/180,gb=T*357.5291,hb=T*0.98560028,ib=T*1.9148,jb=T*0.02,kb=T*3.0E-4,lb=T*102.9372,Za=T*23.45,mb=T*280.16,nb=T*360.9856235;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ca=M.parse(a.color||a.wallColor);Aa=ca.adjustAlpha(S)+"";Ca=ca.adjustLightness(0.8);Ba=Ca.adjustAlpha(S)+"";ha=ca.adjustLightness(1.2);Da=ha.adjustAlpha(S)+""}if(a.roofColor){ha=M.parse(a.roofColor);Da=ha.adjustAlpha(S)+""}if(a.shadows!==
undefined)Wa=!!a.shadows;F();return this};this.geoJSON=function(a,c){z(a,c);return this};this.setCamOffset=function(a,c){la=K+a;wa=y+c};this.setMaxZoom=function(a){Ka=a};this.createCanvas=function(a){G=Ha.createElement("CANVAS");G.style.webkitTransform="translate3d(0,0,0)";G.style.imageRendering="optimizeSpeed";G.style.position="absolute";G.style.pointerEvents="none";G.style.left=0;G.style.top=0;a.appendChild(G);n=G.getContext("2d");n.lineCap="round";n.lineJoin="round";n.lineWidth=1;try{n.mozImageSmoothingEnabled=
false}catch(c){}return G};this.destroyCanvas=function(){G.parentNode.removeChild(G)};this.loadData=h;this.onMoveEnd=function(){var a=x(V,W),c=x(V+A,W+y);da=null;F();if(E&&(a[na]>E.n||a[oa]<E.w||c[na]<E.s||c[oa]>E.e))h()};this.onZoomEnd=function(a){Oa=false;O(a.zoom);if(ua){B=u(ua);da=null;F()}else{F();h()}};this.onZoomStart=function(){Oa=true;F()};this.render=F;this.setOrigin=function(a,c){V=a;W=c};this.setSize=function(a,c){A=a;y=c;K=A/2<<0;ya=y/2<<0;la=K;wa=y;ma=A/1.5/Fa(45)<<0;G.width=A;G.height=
y;sa=ma-50};this.setZoom=O;this.setDate=function(a){if(a){var c=x(V+K,W+ya),b;b=T*-c.longitude;c=T*c.latitude;a=a.valueOf()/864E5-0.5+2440588;var d=gb+hb*(a-2451545),f=ib*Z(d)+jb*Z(2*d)+kb*Z(3*d);f=d+lb+f+ga;d=Math.asin(Z(f)*Z(Za));f=Math.atan2(Z(f)*ia(Za),ia(f));b=mb+nb*(a-2451545)-b-f;b={azimuth:Math.atan2(Z(b),ia(b)*Z(c)-Math.tan(d)*ia(c)),altitude:Math.asin(Z(c)*Z(d)+ia(c)*ia(d)*ia(b))};if(!(b.altitude<0)){Ma=la;Ea=5E4;va=2*Ea*Fa(b.altitude);da=null;F()}}};Ja=t};i.OSMBuildings.VERSION="0.1.7a";
i.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(i){L.Util.setOptions(this,i)},onMove:function(){var i=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-i.x,this.lastY-i.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var i=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.lastX=i.x;this.lastY=i.y;this.canvas.style.left=-i.x+"px";
this.canvas.style.top=-i.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-i.x,I.y-i.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var i=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.osmb.setOrigin(I.x-i.x,I.y-i.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(i){i.addLayer(this);return this},onAdd:function(i){this.map=i;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;i=L.DomUtil.getPosition(this.map._mapPane);var I=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-i.x,I.y-i.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-i.x+"px";this.canvas.style.top=-i.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(i){i.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);i.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(i,I){return this.osmb.geoJSON(i,I)},
setStyle:function(i){return this.osmb.setStyle(i)},setDate:function(i){return this.osmb.setDate(i)}});
