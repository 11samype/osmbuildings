(function(a){function m(c,b){var d=c[0]-b[0],n=c[1]-b[1];return d*d+n*n}function ra(c){for(var b=0,d=0,n=0,a=c.length-3;n<a;n+=2)b+=c[n],d+=c[n+1];c=2*(c.length-2);return[b/c<<0,d/c<<0]}function sa(c){var b,d,n,a,w=0,k,s;k=0;for(s=c.length-3;k<s;k+=2)b=c[k],d=c[k+1],n=c[k+2],a=c[k+3],w+=b*a-n*d;if("CW"===(0<w/2?"CW":"CCW"))return c;b=[];for(d=c.length-2;0<=d;d-=2)b.push(c[d],c[d+1]);return b}var ia=ia||Array,ja=ja||Array,g=Math,ta=g.exp,ua=g.log,va=g.sin,wa=g.cos,fa=g.tan,xa=g.atan,O=g.min,R=g.max,
ba=document,G,S=function(c){var b,d,n;if(0===c.s)b=d=n=c.l;else{n=0.5>c.l?c.l*(1+c.s):c.l+c.s-c.l*c.s;var a=2*c.l-n;c.h/=360;b=K(a,n,c.h+1/3);d=K(a,n,c.h);n=K(a,n,c.h-1/3)}return new x(255*b<<0,255*d<<0,255*n<<0,c.a)},K=function(c,b,d){0>d&&(d+=1);1<d&&(d-=1);return d<1/6?c+6*(b-c)*d:0.5>d?b:d<2/3?c+6*(b-c)*(2/3-d):c},x=function(c,b,d,a){this.r=c;this.g=b;this.b=d;this.a=4>arguments.length?1:a},g=x.prototype;g.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};g.adjustLightness=function(c){var b=x.toHSLA(this);b.l*=c;b.l=Math.min(1,Math.max(0,b.l));return S(b)};g.adjustAlpha=function(c){return new x(this.r,this.g,this.b,this.a*c)};x.parse=function(c){var b;c+="";if(~c.indexOf("#"))return b=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),new x(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new x(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),
b[4]?parseFloat(b[5]):1);if(b=c.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return S({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};x.toHSLA=function(c){var b=c.r/255,d=c.g/255,a=c.b/255,f=Math.max(b,d,a),w=Math.min(b,d,a),k,s=(f+w)/2,g;if(f===w)k=w=0;else{g=f-w;w=0.5<s?g/(2-f-w):g/(f+w);switch(f){case b:k=(d-a)/g+(d<a?6:0);break;case d:k=(a-b)/g+2;break;case a:k=(b-d)/g+4}k/=6}return{h:360*k,s:w,l:s,a:c.a}};G=x;var ka,g=Math,h=g.sin,H=g.cos,
ya=g.tan,la=g.asin,ma=g.atan2,M=g.PI,j=180/M,za=357.5291/j,Aa=0.98560028/j,Ba=1.9148/j,Ca=0.02/j,Da=3E-4/j,Ea=102.9372/j,na=23.45/j,Fa=280.16/j,Ga=360.9856235/j;ka=function(c,b,d){d=-d/j;b/=j;c=c.valueOf()/864E5-0.5+2440588;var a=za+Aa*(c-2451545),f=Ba*h(a)+Ca*h(2*a)+Da*h(3*a),f=a+Ea+f+M,a=la(h(f)*h(na)),f=ma(h(f)*H(na),H(f));d=Fa+Ga*(c-2451545)-d-f;return{altitude:la(h(b)*h(a)+H(b)*H(a)*H(d)),azimuth:ma(h(d),H(d)*h(b)-ya(a)*H(b))-M/2}};var oa=function(c,b){var d,a;void 0===b&&(b=[]);var f=c[0]?c:
c.features;if(f){d=0;for(a=f.length;d<a;d++)oa(f[d],b);return b}if("Feature"!==c.type)return b;d=c.geometry;var f=c.properties,g;"Polygon"===d.type&&(g=[d.coordinates]);"MultiPolygon"===d.type&&(g=d.coordinates);if(!g)return b;var k,s;if(f.color||f.wallColor)d=f.color||f.wallColor,k=G.parse(materialColors[d]||d);f.roofColor&&(d=f.roofColor,s=G.parse(materialColors[d]||d));var m=f.height,j,B,y,z,h;d=0;for(a=g.length;d<a;d++){j=g[d][0];B=[];z=y=0;for(h=j.length;z<h;z++)B.push(j[z][1],j[z][0]),y+=m||
j[z][2]||0;y&&b.push({id:f.id||B[0]+","+B[1],footprint:sa(B),height:y/j.length<<0||Ha,minHeight:f.minHeight,wallColor:k,altColor:k&&k.adjustLightness(0.8),roofColor:s})}return b},T=Math.PI,pa=T/2,Ia=T/4,Ja=180/T,Ka=256,U="latitude",V="longitude",Ha=5;a.OSMBuildings=function(){function c(e,I){var p={};e/=H;I/=H;p[U]=0>=I?90:1<=I?-90:Ja*(2*xa(ta(T*(1-2*I)))-pa);p[V]=360*(1===e?1:(e%1+1)%1)-180;return p}function b(e){z=e;H=Ka<<z;e=z;var I=ca,p=ga;e=O(R(e,I),p);J=1-O(R(0+0.3*((e-I)/(p-I)),0),0.3);K=A.adjustAlpha(J)+
"";W=da.adjustAlpha(J)+"";X=P.adjustAlpha(J)+"";u.scale(z)}function d(){Y.render();ea.render();g()}function g(){C.clearRect(0,0,k,s);if(u.rendering&&!(z<ca||Z)){var e,I,p,c,a,d,b,N,l,qa=B,D=y,t=ea.getMaxHeight(),n=[$+qa,aa+D],E,v,q,r,h,x;u.rendering.sort(function(e,a){return m(a.center,n)/a.height-m(e.center,n)/e.height});e=0;for(I=u.rendering.length;e<I;e++)if(a=u.rendering[e],!(a.height<=t)){v=!1;d=a.footprint;E=[];p=0;for(c=d.length-1;p<c;p+=2)E[p]=N=d[p]-qa,E[p+1]=l=d[p+1]-D,v||(v=0<N&&N<k&&0<
l&&l<s);if(v){p=a.isNew?a.height*F:a.height;d=Q/(Q-p);a.minHeight&&(p=a.isNew?a.minHeight*F:a.minHeight,b=Q/(Q-p));N=[];p=0;for(c=E.length-3;p<c;p+=2)l=E[p],q=E[p+1],v=E[p+2],r=E[p+3],h=j(l,q,d),x=j(v,r,d),a.minHeight&&(q=j(l,q,b),r=j(v,r,b),l=q.x,q=q.y,v=r.x,r=r.y),(v-l)*(h.y-q)>(h.x-l)*(r-q)&&(C.fillStyle=l<v&&q<r||l>v&&q>r?a.altColor||W:a.wallColor||K,f([v,r,l,q,h.x,h.y,x.x,x.y])),N[p]=h.x,N[p+1]=h.y;C.fillStyle=a.roofColor||X;C.strokeStyle=a.altColor||W;f(N,!0)}}}}function f(e,a){if(e.length){C.beginPath();
C.moveTo(e[0],e[1]);for(var c=2,d=e.length;c<d;c+=2)C.lineTo(e[c],e[c+1]);C.closePath();a&&C.stroke();C.fill()}}function j(e,a,c){return{x:(e-$)*c+$<<0,y:(a-aa)*c+aa<<0}}var k=0,s=0,h=0,x=0,B=0,y=0,z,H,C,A=new G(200,190,180),da=A.adjustLightness(0.8),P=A.adjustLightness(1.2),K=A+"",W=da+"",X=P+"",F=1,M,J=1,ca=14,ga=20,ha,$,aa,Q,Z,S={container:null,items:[],init:function(e){var a=this.container=ba.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=
0;Y.init(this.create());ea.init(this.create());C=this.create();e.appendChild(a);return a},create:function(){var e=ba.createElement("CANVAS");e.style.webkitTransform="translate3d(0,0,0)";e.style.imageRendering="optimizeSpeed";e.style.position="absolute";e.style.left=0;e.style.top=0;var a=e.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.mozImageSmoothingEnabled=!1;a.webkitImageSmoothingEnabled=!1;this.items.push(e);this.container.appendChild(e);return a},setSize:function(e,a){for(var c=
this.items,d=0,b=c.length;d<b;d++)c[d].width=e,c[d].height=a}},u={raw:[],rendering:[],init:function(){},setUrl:function(e){this.url=e},setLatLon:function(e){this.isLatLon=e},load:function(){if(this.url&&!(14>z)){var e=c(B-h,y-x),d=c(B+k+h,y+s+x),b={w:e[V],n:e[U],e:d[V],s:d[U]},e=this.url.replace(/\{ *([\w_]+) *\}/g,function(e,a){return b[a]||e}),La=this.set.bind(this),g=ba.documentElement,f=ba.createElement("script");a.jsonpCallback=function(e){delete a.jsonpCallback;g.removeChild(f);La(e)};g.insertBefore(f,
g.lastChild).src=e.replace(/\{callback\}/,"jsonpCallback")}},set:function(e){if(e){e=this.raw=oa(e);var a;this.n=-90;this.w=180;this.s=90;this.e=-180;for(var c=0,d=e.length;c<d;c++){a=e[c].footprint;for(var b=0,f=a.length-1;b<f;b+=2)this.n=R(a[b],this.n),this.e=R(a[b+1],this.e),this.s=O(a[b],this.s),this.w=O(a[b+1],this.w)}this.scale(z,!0);clearInterval(M);F=0;ea.render();M=setInterval(function(){F+=0.1;if(1<F){clearInterval(M);F=1;for(var e=0,a=u.rendering.length;e<a;e++)u.rendering[e].isNew=0}Y.render();
g()},33)}},scale:function(e,a){for(var c,d,b=this.raw,g=[],f,k,l,h,D,t,n=ga-e,j=0,v=b.length;j<v;j++)if(l=b[j],D=l.minHeight>>n,!(D>ha)){h=l.footprint;t=new ia(h.length);f=0;for(k=h.length-1;f<k;f+=2)c=h[f+1],d=O(1,R(0,0.5-ua(fa(Ia+pa*h[f]/180))/T/2)),c=(c/360+0.5)*H<<0,d=d*H<<0,t[f]=c,t[f+1]=d;f=t;k=f.length/2;h=new ja(k);t=0;c=k-1;var q=d=void 0,r=void 0,s=void 0,u=[],x=[],z=[];for(h[t]=h[c]=1;c;){q=0;for(d=t+1;d<c;d++){var r=f[2*d],B=f[2*d+1],y=f[2*t],m=f[2*t+1],w=f[2*c],C=f[2*c+1],F=w-y,A=C-m,
G=void 0;if(0!==F||0!==A)G=((r-y)*F+(B-m)*A)/(F*F+A*A),1<G?(y=w,m=C):0<G&&(y+=F*G,m+=A*G);F=r-y;A=B-m;r=F*F+A*A;r>q&&(s=d,q=r)}2<q&&(h[s]=1,u.push(t),x.push(s),u.push(s),x.push(c));t=u.pop();c=x.pop()}for(d=0;d<k;d++)h[d]&&z.push(f[2*d],f[2*d+1]);t=z;8>t.length||g.push({footprint:t,height:O(l.height>>n,ha),minHeight:D,wallColor:l.wallColor&&l.wallColor.adjustAlpha(J)+"",altColor:l.wallColor&&l.altColor.adjustAlpha(J)+"",roofColor:l.roofColor&&l.roofColor.adjustAlpha(J)+"",center:ra(t),isNew:a})}this.rendering=
g}};this.geoJSON=function(e){var a=typeof e,c=this.Data;c.setLatLon(!1);"string"===a&&(c.setUrl(e),c.load());"object"===a&&c.set(e);return this};var Y={enabled:!0,context:null,color:new G(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(e){this.context=e;this.setDate((new Date).setHours(10))},setEnabled:function(e){this.enabled=!!e},render:function(){var e=this.context,a,d,b,f;e.clearRect(0,0,k,s);if(this.enabled&&u.rendering&&!(z<ca||Z))if(a=c(B+h,
y+x),a=ka(this.date,a.latitude,a.longitude),!(0>=a.altitude)){d=1/fa(a.altitude);b=0.4/d;this.directionX=wa(a.azimuth)*d;this.directionY=va(a.azimuth)*d;this.color.a=b;f=this.color+"";var g,j,n,l,m,D,t=B,A=y,E,v,q,r,w,C,G=[];e.beginPath();a=0;for(d=u.rendering.length;a<d;a++){j=u.rendering[a];v=!1;n=j.footprint;E=[];b=0;for(g=n.length-1;b<g;b+=2)E[b]=m=n[b]-t,E[b+1]=D=n[b+1]-A,v||(v=0<m&&m<k&&0<D&&D<s);if(v){n=j.isNew?j.height*F:j.height;j.minHeight&&(l=j.isNew?j.minHeight*F:j.minHeight);m=null;b=
0;for(g=E.length-3;b<g;b+=2)D=E[b],q=E[b+1],v=E[b+2],r=E[b+3],w=this.project(D,q,n),C=this.project(v,r,n),j.minHeight&&(q=this.project(D,q,l),r=this.project(v,r,l),D=q.x,q=q.y,v=r.x,r=r.y),(v-D)*(w.y-q)>(w.x-D)*(r-q)?(1===m&&e.lineTo(D,q),m=0,b||e.moveTo(D,q),e.lineTo(v,r)):(0===m&&e.lineTo(w.x,w.y),m=1,b||e.moveTo(w.x,w.y),e.lineTo(C.x,C.y));e.closePath();G.push(E)}}e.fillStyle=f;e.fill();e.globalCompositeOperation="destination-out";e.beginPath();a=0;for(d=G.length;a<d;a++){l=G[a];e.moveTo(l[0],
l[1]);b=2;for(g=l.length;b<g;b+=2)e.lineTo(l[b],l[b+1]);e.lineTo(l[0],l[1]);e.closePath()}e.fillStyle="#00ff00";e.fill();e.globalCompositeOperation="source-over"}},project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},ea={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,k,s);if(u.rendering&&!(z<ca||Z)){var c,d,b,f,g,h,j,l=B,n=y,m,t;a.beginPath();c=0;for(d=u.rendering.length;c<
d;c++){b=u.rendering[c];t=!1;g=b.footprint;m=[];b=0;for(f=g.length-1;b<f;b+=2)m[b]=h=g[b]-l,m[b+1]=j=g[b+1]-n,t||(t=0<h&&h<k&&0<j&&j<s);if(t){b=0;for(f=m.length-3;b<f;b+=2)t=m[b],g=m[b+1],b?a.lineTo(t,g):a.moveTo(t,g);a.closePath()}}a.fillStyle=X;a.strokeStyle=W;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)A=G.parse(a.color||a.wallColor),K=A.adjustAlpha(J)+"",da=A.adjustLightness(0.8),W=da.adjustAlpha(J)+"",P=A.adjustLightness(1.2),
X=P.adjustAlpha(J)+"";a.roofColor&&(P=G.parse(a.roofColor),X=P.adjustAlpha(J)+"");void 0!==a.shadows&&Y.setEnabled(a.shadows);d();return this};this.setCamOffset=function(a,b){$=h+a;aa=s+b};this.setMaxZoom=function(a){ga=a};this.setDate=function(a){Y.setDate(a);return this};this.appendTo=function(a){return S.init(a)};this.loadData=u.load;this.onMoveEnd=function(){var a=c(B,y),b=c(B+k,y+s);d();(a[U]>u.n||a[V]<u.w||b[U]<u.s||b[V]>u.e)&&u.load()};this.onZoomEnd=function(a){Z=!1;b(a.zoom);u.load();d()};
this.onZoomStart=function(){Z=!0;d()};this.setOrigin=function(a,b){B=a;y=b};this.setSize=function(a,b){k=a;s=b;h=k/2<<0;x=s/2<<0;$=h;aa=s;Q=k/(1.5/(window.devicePixelRatio||1))/fa(45)<<0;S.setSize(k,s);ha=Q-50};this.setZoom=b;this.render=g;u.setUrl(url)};a.OSMBuildings.VERSION="0.1.8a";a.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var m=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(a){return this.osmb.geoJSON(a)},setStyle:function(a){return this.osmb.setStyle(a)},
setDate:function(a){return this.osmb.setDate(a)}});
