(function(a){function m(d,c){var k=d[0]-c[0],f=d[1]-c[1];return k*k+f*f}function Ba(d){for(var c=0,k=0,f=0,a=d.length-3;f<a;f+=2)c+=d[f],k+=d[f+1];d=2*(d.length-2);return[c/d<<0,k/d<<0]}function Ca(d){var c=d.length/2,k=new Z(c),f=0,a=c-1,n,g,j,A,m=[],F=[],G=[];for(k[f]=k[a]=1;a;){g=0;for(n=f+1;n<a;n++){j=d[2*n];var p=d[2*n+1],w=d[2*f],x=d[2*f+1],E=d[2*a],u=d[2*a+1],B=E-w,D=u-x,r=void 0;if(0!==B||0!==D)r=((j-w)*B+(p-x)*D)/(B*B+D*D),1<r?(w=E,x=u):0<r&&(w+=B*r,x+=D*r);B=j-w;D=p-x;j=B*B+D*D;j>g&&(A=
n,g=j)}2<g&&(k[A]=1,m.push(f),F.push(A),m.push(A),F.push(a));f=m.pop();a=F.pop()}for(n=0;n<c;n++)k[n]&&G.push(d[2*n],d[2*n+1]);return G}var Da=Da||Array,Z=Z||Array,g=Math,Ma=g.exp,Na=g.log,Oa=g.sin,Pa=g.cos,va=g.tan,Qa=g.atan,aa=g.min,wa=g.max,pa=document,j,Ea=function(d){var c,a,f;if(0===d.s)c=a=f=d.l;else{f=0.5>d.l?d.l*(1+d.s):d.l+d.s-d.l*d.s;var g=2*d.l-f;d.h/=360;c=V(g,f,d.h+1/3);a=V(g,f,d.h);f=V(g,f,d.h-1/3)}return new j(255*c<<0,255*a<<0,255*f<<0,d.a)},V=function(d,c,a){0>a&&(a+=1);1<a&&(a-=
1);return a<1/6?d+6*(c-d)*a:0.5>a?c:a<2/3?d+6*(c-d)*(2/3-a):d},g=function(d,a,k,f){this.r=d;this.g=a;this.b=k;this.a=4>arguments.length?1:f},W=g.prototype;W.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};W.adjustLightness=function(a){var c=j.toHSLA(this);c.l*=a;c.l=Math.min(1,Math.max(0,c.l));return Ea(c)};W.adjustAlpha=function(a){return new j(this.r,this.g,this.b,this.a*a)};g.parse=function(a){var c;a+="";if(~a.indexOf("#"))return c=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new j(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1);if(c=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new j(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5]):1);if(c=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ea({h:parseInt(c[1],10),s:parseFloat(c[2]),l:parseFloat(c[3]),a:c[4]?parseFloat(c[5]):1})};g.toHSLA=function(a){var c=a.r/255,k=a.g/255,f=a.b/255,g=Math.max(c,k,f),n=Math.min(c,k,f),
j,A=(g+n)/2,m;if(g===n)j=n=0;else{m=g-n;n=0.5<A?m/(2-g-n):m/(g+n);switch(g){case c:j=(k-f)/m+(k<f?6:0);break;case k:j=(f-c)/m+2;break;case f:j=(c-k)/m+4}j/=6}return{h:360*j,s:n,l:A,a:a.a}};j=g;var Fa,g=Math,u=g.sin,I=g.cos,Ra=g.tan,Ga=g.asin,Ha=g.atan2,S=g.PI,p=180/S,Sa=357.5291/p,Ta=0.98560028/p,Ua=1.9148/p,Va=0.02/p,Wa=3E-4/p,Xa=102.9372/p,Ia=23.45/p,Ya=280.16/p,Za=360.9856235/p;Fa=function(a,c,g){g=-g/p;c/=p;a=a.valueOf()/864E5-0.5+2440588;var f=Sa+Ta*(a-2451545),j=Ua*u(f)+Va*u(2*f)+Wa*u(3*f),
j=f+Xa+j+S,f=Ga(u(j)*u(Ia)),j=Ha(u(j)*I(Ia),I(j));g=Ya+Za*(a-2451545)-g-j;return{altitude:Ga(u(c)*u(f)+I(c)*I(f)*I(g)),azimuth:Ha(u(g),I(g)*u(c)-Ra(f)*I(c))-S/2}};var ba=Math.PI,Ja=ba/2,$a=ba/4,ab=180/ba,bb=256,xa=14,ca="latitude",da="longitude",Ka=3,La=4,F=0,A=1,G=2,E=3,qa=4,T=5,N=6;a.OSMBuildings=function(d){function c(b,P){var e={};b/=ea;P/=ea;e[ca]=0>=P?90:1<=P?-90:ab*(2*Qa(Ma(ba*(1-2*P)))-Ja);e[da]=360*(1===b?1:(b%1+1)%1)-180;return e}function g(){if(S&&!(r<xa)){var b=c(B-U,D-oa),P=c(B+w+U,D+
x+oa);ra&&ra.abort();var e={w:b[da],n:b[ca],e:P[da],s:P[ca],z:r},b=S.replace(/\{ *([\w_]+) *\}/g,function(b,a){return e[a]}),h=f,a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&a.status&&!(200>a.status||299<a.status)&&a.responseText&&h(JSON.parse(a.responseText))};a.open("GET",b);a.send(null);ra=a}}function f(b){var a,e,h,y,c=[],g=e=0;X=xa;I(r);ra=null;if(b&&b.meta.z===r){y=b.meta;h=b.data;if(z&&q&&z.z===y.z){e=z.x-y.x;g=z.y-y.y;b=0;for(a=q.length;b<a;b++)c[b]=q[b][G][0]+e+
","+(q[b][G][1]+g)}z=y;q=[];b=0;for(a=h.length;b<a;b++)if(y=[],!(h[b][A]>fa)&&(e=Ca(h[b][G]),!(8>e.length))){y[G]=e;y[qa]=Ba(e);y[F]=aa(h[b][F],fa);y[A]=h[b][A];e=y[G][0]+","+y[G][1];y[T]=!(c&&~c.indexOf(e));y[E]=[];y[N]=[];e=h[b][Ka]?j.parse(h[b][Ka]):null;g=h[b][La]?j.parse(h[b][La]):null;y[E]=[e||null,e?e.adjustLightness(0.8):null,g?g:e?e.adjustLightness(1.2):Q];for(e=0;3>e;e++)y[E][e]&&(y[N][e]=y[E][e].adjustAlpha(K)+"");q.push(y)}V()}}function p(b,a){var e,h,y=[],c,g,d,l,f,j,m,H,n=ya-r;c=0;for(g=
b.length;c<g;c++)if(f=b[c],m=f[A]>>n,!(m>fa)){j=f[G];H=new Da(j.length);d=0;for(l=j.length-1;d<l;d+=2)e=j[d+1],h=aa(1,wa(0,0.5-Na(va($a+Ja*j[d]/180))/ba/2)),e=(e/360+0.5)*ea<<0,h=h*ea<<0,H[d]=e,H[d+1]=h;H=Ca(H);if(!(8>H.length)){l=[];l[G]=H;l[qa]=Ba(H);l[F]=aa(f[F]>>n,fa);l[A]=m;l[T]=a;l[E]=f[E];l[N]=[];for(d=0;3>d;d++)l[E][d]&&(l[N][d]=l[E][d].adjustAlpha(K)+"");y.push(l)}}return y}function n(b,a,e){void 0===e&&(e=[]);var h,c,d,g=b[0]?b:b.features,f,l,J,m,q,H,C=a?1:0,s=a?0:1;if(g){b=0;for(h=g.length;b<
h;b++)n(g[b],a,e);return e}"Feature"===b.type&&(h=b.geometry,l=b.properties);"Polygon"===h.type&&(f=[h.coordinates]);"MultiPolygon"===h.type&&(f=h.coordinates);if(f){m=l.height;if(l.color||l.wallColor)q=j.parse(l.color||l.wallColor);l.roofColor&&(H=j.parse(l.roofColor));b=0;for(h=f.length;b<h;b++){a=f[b][0];J=[];c=g=0;for(d=a.length;c<d;c++)J.push(a[c][C],a[c][s]),g+=m||a[c][2]||0;if(g){d=c=[];var v=G;for(var t=void 0,k=void 0,x=void 0,z=void 0,w=0,r=void 0,B=void 0,r=0,B=J.length-3;r<B;r+=2)t=J[r],
k=J[r+1],x=J[r+2],z=J[r+3],w+=t*z-x*k;if("CW"!==(0<w/2?"CW":"CCW")){t=[];for(k=J.length-2;0<=k;k-=2)t.push(J[k],J[k+1]);J=t}d[v]=J;c[F]=g/a.length<<0;c[A]=l.minHeight;c[E]=[q||null,q?q.adjustLightness(0.8):null,H?H:q?q.adjustLightness(1.2):Q];e.push(c)}}}return e}function u(b,a){b?(ga=n(b,a),X=0,I(r),z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:r},q=p(ga,!0),V()):(ga=null,$())}function I(b){var a,e,h;r=b;ea=bb<<r;b=r;a=X;e=ya;b=aa(wa(b,a),e);K=1-aa(wa(0+0.4*((b-a)/(e-a)),0),0.4);za=R.adjustAlpha(K)+"";ha=
sa.adjustAlpha(K)+"";ia=Q.adjustAlpha(K)+"";if(q){b=0;for(a=q.length;b<a;b++){h=q[b];h[N]=[];for(e=0;3>e;e++)h[E][e]&&(h[N][e]=h[E][e].adjustAlpha(K)+"")}}}function V(){clearInterval(Aa);O=0;ta.render();Aa=setInterval(function(){O+=0.1;if(1<O){clearInterval(Aa);O=1;for(var b=0,a=q.length;b<a;b++)q[b][T]=0}ua.render();$()},33)}function ma(){ua.render();ta.render();$()}function $(){M.clearRect(0,0,w,x);if(z&&q&&!(r<X||ja)){var b,a,e,h,c,d,g,f,l,j=B-z.x,k=D-z.y,n=ta.getMaxHeight(),H=[ka+j,la+k],C,s,
v,t,p,u;q.sort(function(b,a){return m(a[qa],H)/a[F]-m(b[qa],H)/b[F]});b=0;for(a=q.length;b<a;b++)if(c=q[b],!(c[F]<=n)){s=!1;d=c[G];C=[];e=0;for(h=d.length-1;e<h;e+=2)C[e]=f=d[e]-j,C[e+1]=l=d[e+1]-k,s||(s=0<f&&f<w&&0<l&&l<x);if(s){e=c[T]?c[F]*O:c[F];d=Y/(Y-e);c[A]&&(e=c[T]?c[A]*O:c[A],g=Y/(Y-e));f=[];e=0;for(h=C.length-3;e<h;e+=2)l=C[e],v=C[e+1],s=C[e+2],t=C[e+3],p=na(l,v,d),u=na(s,t,d),c[A]&&(v=na(l,v,g),t=na(s,t,g),l=v.x,v=v.y,s=t.x,t=t.y),(s-l)*(p.y-v)>(p.x-l)*(t-v)&&(M.fillStyle=l<s&&v<t||l>s&&
v>t?c[N][1]||ha:c[N][0]||za,W([s,t,l,v,p.x,p.y,u.x,u.y])),f[e]=p.x,f[e+1]=p.y;M.fillStyle=c[N][2]||ia;M.strokeStyle=c[N][1]||ha;W(f,!0)}}}}function W(b,a){if(b.length){M.beginPath();M.moveTo(b[0],b[1]);for(var e=2,c=b.length;e<c;e+=2)M.lineTo(b[e],b[e+1]);M.closePath();a&&M.stroke();M.fill()}}function na(b,a,e){return{x:(b-ka)*e+ka<<0,y:(a-la)*e+la<<0}}var w=0,x=0,U=0,oa=0,B=0,D=0,r,ea,ra,M,S,R=new j(200,190,180),sa=R.adjustLightness(0.8),Q=R.adjustLightness(1.2),za=R+"",ha=sa+"",ia=Q+"",ga,z,q,O=
1,Aa,K=1,X=xa,ya=20,fa,ka,la,Y,ja,Z={container:null,items:[],init:function(b){var a=this.container=pa.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=0;ua.init(this.create());ta.init(this.create());M=this.create();b.appendChild(a);return a},create:function(){var b=pa.createElement("CANVAS");b.style.webkitTransform="translate3d(0,0,0)";b.style.imageRendering="optimizeSpeed";b.style.position="absolute";b.style.left=0;b.style.top=0;var a=b.getContext("2d");
a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=!1}catch(e){}this.items.push(b);this.container.appendChild(b);return a},setSize:function(b,a){for(var e=this.items,c=0,d=e.length;c<d;c++)e[c].width=b,e[c].height=a}},ua={context:null,color:new j(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(b){this.context=b;this.setDate((new Date).setHours(10))},render:function(){var b=this.context,a,e,h,d;b.clearRect(0,0,w,x);if(z&&
q&&!(r<X||ja))if(a=c(B+U,D+oa),a=Fa(this.date,a.latitude,a.longitude),!(0>=a.altitude)){e=1/va(a.altitude);h=0.4/e;this.directionX=Pa(a.azimuth)*e;this.directionY=Oa(a.azimuth)*e;this.color.a=h;d=this.color+"";var g,f,j,l,k,m=B-z.x,n=D-z.y,p,C,s,v,t,u,E=[];b.beginPath();a=0;for(e=q.length;a<e;a++){f=q[a];C=!1;j=f[G];p=[];h=0;for(g=j.length-1;h<g;h+=2)p[h]=l=j[h]-m,p[h+1]=k=j[h+1]-n,C||(C=0<l&&l<w&&0<k&&k<x);if(C){j=f[T]?f[F]*O:f[F];f[A]&&(j=f[T]?f[A]*O:f[A]);l=null;h=0;for(g=p.length-3;h<g;h+=2)k=
p[h],s=p[h+1],C=p[h+2],v=p[h+3],t=this.project(k,s,j),u=this.project(C,v,j),f[A]&&(s=this.project(k,s,j),v=this.project(C,v,j),k=s.x,s=s.y,C=v.x,v=v.y),(C-k)*(t.y-s)>(t.x-k)*(v-s)?(1===l&&b.lineTo(k,s),l=0,h||b.moveTo(k,s),b.lineTo(C,v)):(0===l&&b.lineTo(t.x,t.y),l=1,h||b.moveTo(t.x,t.y),b.lineTo(u.x,u.y));b.closePath();E.push(p)}}b.fillStyle=d;b.fill();b.globalCompositeOperation="destination-out";b.beginPath();a=0;for(e=E.length;a<e;a++){d=E[a];b.moveTo(d[0],d[1]);h=2;for(g=d.length;h<g;h+=2)b.lineTo(d[h],
d[h+1]);b.lineTo(d[0],d[1]);b.closePath()}b.fillStyle="#00ff00";b.fill();b.globalCompositeOperation="source-over"}},project:function(a,c,e){return{x:a+this.directionX*e,y:c+this.directionY*e}},setDate:function(a){this.date=a;this.render()}},ta={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,w,x);if(z&&q&&!(r<X||ja)){var c,e,d,g,f,j,k,l=B-z.x,p=D-z.y,m,n;a.beginPath();c=0;for(e=q.length;c<e;c++){d=q[c];n=!1;f=d[G];m=[];d=0;for(g=f.length-
1;d<g;d+=2)m[d]=j=f[d]-l,m[d+1]=k=f[d+1]-p,n||(n=0<j&&j<w&&0<k&&k<x);if(n){d=0;for(g=m.length-3;d<g;d+=2)n=m[d],f=m[d+1],d?a.lineTo(n,f):a.moveTo(n,f);a.closePath()}}a.fillStyle=ia;a.strokeStyle=ha;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)R=j.parse(a.color||a.wallColor),za=R.adjustAlpha(K)+"",sa=R.adjustLightness(0.8),ha=sa.adjustAlpha(K)+"",Q=R.adjustLightness(1.2),ia=Q.adjustAlpha(K)+"";a.roofColor&&(Q=j.parse(a.roofColor),
ia=Q.adjustAlpha(K)+"");ma();return this};this.geoJSON=function(b,c){if("object"===typeof b)u(b,!c);else{var d=pa.documentElement,f=pa.createElement("script");a.jsonpCallback=function(b){delete a.jsonpCallback;d.removeChild(f);u(b,!c)};d.insertBefore(f,d.lastChild).src=b.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,c){ka=U+a;la=x+c};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return Z.init(a)};
this.loadData=g;this.onMoveEnd=function(){var a=c(B,D),d=c(B+w,D+x);ma();z&&(a[ca]>z.n||a[da]<z.w||d[ca]<z.s||d[da]>z.e)&&g()};this.onZoomEnd=function(a){ja=!1;I(a.zoom);ga?(q=p(ga),ma()):($(),g())};this.onZoomStart=function(){ja=!0;ma()};this.setOrigin=function(a,c){B=a;D=c};this.setSize=function(a,c){w=a;x=c;U=w/2<<0;oa=x/2<<0;ka=U;la=x;Y=w/(1.5/(window.devicePixelRatio||1))/va(45)<<0;Z.setSize(w,x);fa=Y-50};this.setZoom=I;this.render=$;S=d};a.OSMBuildings.VERSION="0.1.8a";a.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),m=this.map.getPixelOrigin();this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var m=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(m.x-a.x,m.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(a,m){return this.osmb.geoJSON(a,m)},setStyle:function(a){return this.osmb.setStyle(a)},
setDate:function(a){return this.osmb.setDate(a)}});
