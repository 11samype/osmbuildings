(function(k){function P(m,o){var y=m[0]-o[0],e=m[1]-o[1];return y*y+e*e}function Ja(m){for(var o=0,y=0,e=0,h=m.length-3;e<h;e+=2){o+=m[e];y+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,y/m<<0]}function Ka(m){var o=m.length/2,y=new La(o),e=0,h=o-1,i,q,n,G,K=[],S=[],J=[];for(y[e]=y[h]=1;h;){q=0;for(i=e+1;i<h;i++){n=m[i*2];var ea=m[i*2+1],H=m[e*2],Q=m[e*2+1],Z=m[h*2],M=m[h*2+1],v=Z-H,B=M-Q,E=void 0;if(v!==0||B!==0){E=((n-H)*v+(ea-Q)*B)/(v*v+B*B);if(E>1){H=Z;Q=M}else if(E>0){H+=v*E;Q+=B*E}}v=n-H;B=ea-Q;n=v*
v+B*B;if(n>q){G=i;q=n}}if(q>2){y[G]=1;K.push(e);S.push(G);K.push(G);S.push(h)}e=K.pop();h=S.pop()}for(i=0;i<o;i++)y[i]&&J.push(m[i*2],m[i*2+1]);return J}var Ma=Ma||Array,La=La||Array,ba=Math,Pa=ba.exp,Qa=ba.log,Ra=ba.sin,Sa=ba.cos,Ba=ba.tan,Ta=ba.atan,ja=ba.min,Ca=ba.max,Da=k.document,T=function(){function m(e,h,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(h-e)*6*i;if(i<0.5)return h;if(i<2/3)return e+(h-e)*(2/3-i)*6;return e}function o(e,h,i,q){this.r=e;this.g=h;this.b=i;this.a=arguments.length<
4?1:q}var y=o.prototype;y.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};y.adjustLightness=function(e){var h=T.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var i,q;if(h.s===0)e=i=q=h.l;else{q=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var n=2*h.l-q;e=m(n,q,h.h+1/3);i=m(n,q,h.h);q=m(n,q,h.h-1/3)}return new T(e*255<<0,i*255<<0,q*255<<0,h.a)};y.adjustAlpha=function(e){return new T(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new T(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new T(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var h=e.r/255,i=e.g/255,q=e.b/255,n=Math.max(h,i,q),G=Math.min(h,i,q),K,S=(n+G)/2,J;if(n===G)K=G=0;else{J=n-G;G=S>0.5?J/(2-n-G):J/(n+G);switch(n){case h:K=(i-q)/J+(i<q?6:0);break;case i:K=
(q-h)/J+2;break;case q:K=(h-i)/J+4;break}K/=6}return{h:K,s:G,l:S,a:e.a}};return o}(),Ua=function(){var m=Math,o=m.sin,y=m.cos,e=m.tan,h=m.asin,i=m.atan2,q=m.PI,n=180/q,G=357.5291/n,K=0.98560028/n,S=1.9148/n,J=0.02/n,ea=3.0E-4/n,H=102.9372/n,Q=23.45/n,Z=280.16/n,M=360.9856235/n;return function(v,B,E){E=-E/n;B=B/n;v=v.valueOf()/864E5-0.5+2440588;var D=G+K*(v-2451545),F=S*o(D)+J*o(2*D)+ea*o(3*D);F=D+H+F+q;D=h(o(F)*o(Q));F=i(o(F)*y(Q),y(F));E=Z+M*(v-2451545)-E-F;return{altitude:h(o(B)*o(D)+y(B)*y(D)*
y(E)),azimuth:i(o(E),y(E)*o(B)-e(D)*y(B))-q/2}}}(),ka=Math.PI,Na=ka/2,Va=ka/4,Wa=180/ka,Xa=256,Ea=14,la="latitude",ma="longitude",X=0,R=1,U=2,ca=3,ua=4,na=5,$=6;k.OSMBuildings=function(m){function o(a,c){var b={};a/=oa;c/=oa;b[la]=c<=0?90:c>=1?-90:Wa*(2*Ta(Pa(ka*(1-2*c)))-Na);b[ma]=(a===1?1:(a%1+1)%1)*360-180;return b}function y(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c,b,d,g){a=ja(Ca(a,c),b);return ja(Ca(d+(a-c)/(b-c)*(g-d),d),g)}function h(a,c){var b=new XMLHttpRequest;
b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!Fa||V<Ea)){var a=o(D-B,F-E),c=o(D+M+B,F+v+E);va&&va.abort();va=h(y(Fa,{w:a[ma],n:a[la],e:c[ma],s:c[la],z:V}),q)}}function q(a){var c,b,d,g=[],f,j=f=0;wa=Ea;J(V);va=null;if(!(!a||a.meta.z!==V)){d=a.meta;b=a.data;if(I&&C&&I.z===d.z){f=I.x-d.x;j=I.y-d.y;a=0;for(c=C.length;a<c;a++)g[a]=C[a][U][0]+f+","+(C[a][U][1]+
j)}I=d;C=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][R]>pa)){f=Ka(b[a][U]);if(!(f.length<8)){d[U]=f;d[ua]=Ja(f);d[X]=ja(b[a][X],pa);d[R]=b[a][R];f=d[U][0]+","+d[U][1];d[na]=!(g&&~g.indexOf(f));d[ca]=[];d[$]=[];C.push(d)}}}ea()}}function n(a,c){var b=[],d,g,f,j,l,r,w,z,s,x=Ga-V;d=0;for(g=a.length;d<g;d++){l=a[d];z=l[R]>>x;if(!(z>pa)){r=l[U];s=new Ma(r.length);f=0;for(j=r.length-1;f<j;f+=2){w=r[f+1];var t=ja(1,Ca(0,0.5-Qa(Ba(Va+Na*r[f]/180))/ka/2));w={x:(w/360+0.5)*oa<<0,y:t*oa<<0};s[f]=w.x;s[f+1]=
w.y}s=Ka(s);if(!(s.length<8)){j=[];j[U]=s;j[ua]=Ja(s);j[X]=ja(l[X]>>x,pa);j[R]=z;j[na]=c;j[ca]=l[ca];j[$]=[];for(f=0;f<3;f++)if(j[ca][f])j[$][f]=j[ca][f].adjustAlpha(W)+"";b.push(j)}}}return b}function G(a,c){if(typeof a==="object")S(a,!c);else{var b=Da.documentElement,d=Da.createElement("script");k.jsonpCallback=function(g){delete k.jsonpCallback;b.removeChild(d);S(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function K(a,c,b){if(b===undefined)b=[];var d,g,
f,j=a[0]?a:a.features,l,r,w,z,s,x=c?1:0,t=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)K(j[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")r=[l.coordinates];if(l.type==="MultiPolygon")r=l.coordinates;if(r){c=d.height;if(d.color||d.wallColor)z=T.parse(d.color||d.wallColor);if(d.roofColor)s=T.parse(d.roofColor);d=0;for(a=r.length;d<a;d++){j=r[d][0];w=[];g=l=0;for(f=j.length;g<f;g++){w.push(j[g][x],j[g][t]);l+=c||j[g][2]||0}if(l){g=[];f=U;var u=void 0,A=void 0,O=void 0,
ga=void 0,qa=0,Y=void 0,Oa=void 0;Y=0;for(Oa=w.length-3;Y<Oa;Y+=2){u=w[Y];A=w[Y+1];O=w[Y+2];ga=w[Y+3];qa+=u*ga-O*A}if((qa/2>0?"CW":"CCW")==="CW")w=w;else{u=[];for(A=w.length-2;A>=0;A-=2)u.push(w[A],w[A+1]);w=u}g[f]=w;g[X]=l/j.length<<0;g[ca]=[z||null,z?z.adjustLightness(0.8):null,s?s:z?z.adjustLightness(1.2):fa];b.push(g)}}}return b}function S(a,c){if(a){ra=K(a,c);wa=0;J(V);I={n:90,w:-180,s:-90,e:180,x:0,y:0,z:V};C=n(ra,true);ea()}else{ra=null;H()}}function J(a){var c,b,d;V=a;oa=Xa<<V;W=1-e(V,wa,
Ga,0,0.3);xa=da.adjustAlpha(W)+"";ya=za.adjustAlpha(W)+"";Aa=fa.adjustAlpha(W)+"";aa.colorStr=aa.color.adjustAlpha(W)+"";if(C){a=0;for(c=C.length;a<c;a++){d=C[a];d[$]=[];for(b=0;b<3;b++)if(d[ca][b])d[$][b]=d[ca][b].adjustAlpha(W)+""}}}function ea(){ha=0;aa.create();clearInterval(Ha);Ha=setInterval(function(){ha+=0.1;if(ha>1){clearInterval(Ha);ha=1;for(var a=0,c=C.length;a<c;a++)C[a][na]=0}H()},33)}function H(){p.clearRect(0,0,M,v);if(I&&C)if(!(V<wa||Ia)){aa.enabled&&aa.render();var a,c,b,d,g,f,j,
l,r,w=D-I.x,z=F-I.y,s=[sa+w,ta+z],x,t,u,A,O,ga;C.sort(function(qa,Y){return P(Y[ua],s)/Y[X]-P(qa[ua],s)/qa[X]});a=0;for(c=C.length;a<c;a++){g=C[a];t=false;f=g[U];x=[];b=0;for(d=f.length-1;b<d;b+=2){x[b]=l=f[b]-w;x[b+1]=r=f[b+1]-z;t||(t=l>0&&l<M&&r>0&&r<v)}if(t){b=g[na]?g[X]*ha:g[X];f=ia/(ia-b);if(g[R]){b=g[na]?g[R]*ha:g[R];j=ia/(ia-b)}l=[];b=0;for(d=x.length-3;b<d;b+=2){r=x[b];u=x[b+1];t=x[b+2];A=x[b+3];O=Z(r,u,f);ga=Z(t,A,f);if(g[R]){u=Z(r,u,j);A=Z(t,A,j);r=u.x;u=u.y;t=A.x;A=A.y}if((t-r)*(O.y-u)>
(O.x-r)*(A-u)){p.fillStyle=r<t&&u<A||r>t&&u>A?g[$][1]||ya:g[$][0]||xa;Q([t,A,r,u,O.x,O.y,ga.x,ga.y])}l[b]=O.x;l[b+1]=O.y}p.fillStyle=g[$][2]||Aa;p.strokeStyle=g[$][1]||ya;Q(l,true)}}}}function Q(a,c){if(a.length){p.beginPath();p.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)p.lineTo(a[b],a[b+1]);p.closePath();c&&p.stroke();p.fill()}}function Z(a,c,b){return{x:(a-sa)*b+sa<<0,y:(c-ta)*b+ta<<0}}var M=0,v=0,B=0,E=0,D=0,F=0,V,oa,va,N,p,Fa,da=new T(200,190,180),za=da.adjustLightness(0.8),fa=da.adjustLightness(1.2),
xa=da+"",ya=za+"",Aa=fa+"",ra,I,C,ha=1,Ha,W=1,wa=Ea,Ga=20,pa,sa,ta,ia,Ia,aa={enabled:true,originX:0,originY:0,buffer:new Image,color:new T(0,0,0),colorStr:this.color+"",sunAlpha:1,length:0,directionX:0,directionY:0,create:function(){if(I&&C)if(this.length){console.log("creates buffer");this.originX=D;this.originY=F;var a,c,b,d,g,f,j,l,r=D-I.x,w=F-I.y,z,s,x,t,u,A,O=[];p.fillStyle=this.colorStr;a=0;for(c=C.length;a<c;a++){g=C[a];s=false;f=g[U];z=[];b=0;for(d=f.length-1;b<d;b+=2){z[b]=j=f[b]-r;z[b+1]=
l=f[b+1]-w;s||(s=j>0&&j<M&&l>0&&l<v)}if(s){f=g[X];if(g[R])f=g[R];j=null;p.beginPath();b=0;for(d=z.length-3;b<d;b+=2){l=z[b];x=z[b+1];s=z[b+2];t=z[b+3];u=this.project(l,x,f);A=this.project(s,t,f);if(g[R]){x=this.project(l,x,f);t=this.project(s,t,f);l=x.x;x=x.y;s=t.x;t=t.y}if((s-l)*(u.y-x)>(u.x-l)*(t-x)){j===1&&p.lineTo(l,x);j=0;b||p.moveTo(l,x);p.lineTo(s,t)}else{j===0&&p.lineTo(u.x,u.y);j=1;b||p.moveTo(u.x,u.y);p.lineTo(A.x,A.y)}}p.closePath();p.fill();O.push(z)}}p.fillStyle=xa;a=0;for(c=O.length;a<
c;a++)Q(O[a]);this.filter();this.buffer.src=N.toDataURL()}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},filter:function(){for(var a=p.getImageData(0,0,M,v),c=a.data,b=this.sunAlpha*255<<0,d,g,f=0,j=c.length;f<j;f+=4){d=c[f+0];g=c[f+3];if(d&&g>=255)c[f+3]=0;else if(g>b)c[f+3]=b}p.putImageData(a,0,0)},render:function(){if(this.length){console.log("should draw buffer");p.drawImage(this.buffer,this.originX-D,this.originY-F)}},setSun:function(a){if(a.altitude<=0){this.length=
0;this.sunAlpha=e(-a.altitude,0,1,0.1,0.8)}else{this.length=1/Ba(a.altitude);this.sunAlpha=0.4/this.length;this.directionX=Sa(a.azimuth)*this.length;this.directionY=Ra(a.azimuth)*this.length}this.color.a=this.sunAlpha;this.colorStr=this.color+"";this.create()}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=T.parse(a.color||a.wallColor);xa=da.adjustAlpha(W)+"";za=da.adjustLightness(0.8);ya=za.adjustAlpha(W)+"";fa=da.adjustLightness(1.2);Aa=fa.adjustAlpha(W)+""}if(a.roofColor){fa=
T.parse(a.roofColor);Aa=fa.adjustAlpha(W)+""}if(a.shadows!==undefined)aa.enabled=!!a.shadows;H();return this};this.geoJSON=function(a,c){G(a,c);return this};this.setCamOffset=function(a,c){sa=B+a;ta=v+c};this.setMaxZoom=function(a){Ga=a};this.setDate=function(a){var c=o(D+B,F+E);aa.setSun(Ua(a,c.latitude,c.longitude));H();return this};this.createCanvas=function(a){N=Da.createElement("CANVAS");N.style.webkitTransform="translate3d(0,0,0)";N.style.imageRendering="optimizeSpeed";N.style.position="absolute";
N.style.pointerEvents="none";N.style.left=0;N.style.top=0;a.appendChild(N);p=N.getContext("2d");p.lineCap="round";p.lineJoin="round";p.lineWidth=1;try{p.mozImageSmoothingEnabled=false}catch(c){}return N};this.destroyCanvas=function(){N.parentNode.removeChild(N)};this.loadData=i;this.onMoveEnd=function(){var a=o(D,F),c=o(D+M,F+v);aa.create();H();if(I&&(a[la]>I.n||a[ma]<I.w||c[la]<I.s||c[ma]>I.e))i()};this.onZoomEnd=function(a){Ia=false;J(a.zoom);if(ra){C=n(ra);aa.create();H()}else{H();i()}};this.onZoomStart=
function(){Ia=true;H()};this.render=H;this.setOrigin=function(a,c){D=a;F=c};this.setSize=function(a,c){M=a;v=c;B=M/2<<0;E=v/2<<0;sa=B;ta=v;ia=M/1.5/Ba(45)<<0;N.width=M;N.height=v;pa=ia-50};this.setZoom=J;Fa=m};k.OSMBuildings.VERSION="0.1.8a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(k){L.Util.setOptions(this,k)},onMove:function(){var k=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-k.x,this.lastY-k.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var k=L.DomUtil.getPosition(this.map._mapPane),P=this.map.getPixelOrigin();this.lastX=k.x;this.lastY=k.y;this.canvas.style.left=-k.x+"px";
this.canvas.style.top=-k.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(P.x-k.x,P.y-k.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var k=L.DomUtil.getPosition(this.map._mapPane),P=this.map.getPixelOrigin();this.osmb.setOrigin(P.x-k.x,P.y-k.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(k){k.addLayer(this);return this},onAdd:function(k){this.map=k;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;k=L.DomUtil.getPosition(this.map._mapPane);var P=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(P.x-k.x,P.y-k.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-k.x+"px";this.canvas.style.top=-k.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(k){k.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);k.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(k,P){return this.osmb.geoJSON(k,P)},
setStyle:function(k){return this.osmb.setStyle(k)},setDate:function(k){return this.osmb.setDate(k)}});
