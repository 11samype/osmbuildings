(function(i){function K(m,q){var r=m[0]-q[0],e=m[1]-q[1];return r*r+e*e}function La(m){for(var q=0,r=0,e=0,g=m.length-3;e<g;e+=2){q+=m[e];r+=m[e+1]}m=(m.length-2)*2;return[q/m<<0,r/m<<0]}function Ma(m){var q=m.length/2,r=new Na(q),e=0,g=q-1,k,p,o,C,H=[],P=[],I=[];for(r[e]=r[g]=1;g;){p=0;for(k=e+1;k<g;k++){o=m[k*2];var Z=m[k*2+1],W=m[e*2],D=m[e*2+1],ha=m[g*2],$=m[g*2+1],w=ha-W,s=$-D,A=void 0;if(w!==0||s!==0){A=((o-W)*w+(Z-D)*s)/(w*w+s*s);if(A>1){W=ha;D=$}else if(A>0){W+=w*A;D+=s*A}}w=o-W;s=Z-D;o=w*
w+s*s;if(o>p){C=k;p=o}}if(p>2){r[C]=1;H.push(e);P.push(C);H.push(C);P.push(g)}e=H.pop();g=P.pop()}for(k=0;k<q;k++)r[k]&&I.push(m[k*2],m[k*2+1]);return I}var Oa=Oa||Array,Na=Na||Array,ba=Math,Ra=ba.exp,Sa=ba.log,Ta=ba.sin,Ua=ba.cos,Ea=ba.tan,Va=ba.atan,la=ba.min,Fa=ba.max,wa=i.document,Q=function(){function m(e,g,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return e+(g-e)*6*k;if(k<0.5)return g;if(k<2/3)return e+(g-e)*(2/3-k)*6;return e}function q(e,g,k,p){this.r=e;this.g=g;this.b=k;this.a=arguments.length<
4?1:p}var r=q.prototype;r.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};r.adjustLightness=function(e){var g=Q.toHSLA(this);g.l*=e;g.l=Math.min(1,Math.max(0,g.l));var k,p;if(g.s===0)e=k=p=g.l;else{p=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var o=2*g.l-p;e=m(o,p,g.h+1/3);k=m(o,p,g.h);p=m(o,p,g.h-1/3)}return new Q(e*255<<0,k*255<<0,p*255<<0,g.a)};r.adjustAlpha=function(e){return new Q(this.r,this.g,this.b,this.a*e)};q.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};q.toHSLA=function(e){var g=e.r/255,k=e.g/255,p=e.b/255,o=Math.max(g,k,p),C=Math.min(g,k,p),H,P=(o+C)/2,I;if(o===C)H=C=0;else{I=o-C;C=P>0.5?I/(2-o-C):I/(o+C);switch(o){case g:H=(k-p)/I+(k<p?6:0);break;case k:H=
(p-g)/I+2;break;case p:H=(g-k)/I+4;break}H/=6}return{h:H,s:C,l:P,a:e.a}};return q}(),Wa=function(){var m=Math,q=m.sin,r=m.cos,e=m.tan,g=m.asin,k=m.atan2,p=m.PI,o=180/p,C=357.5291/o,H=0.98560028/o,P=1.9148/o,I=0.02/o,Z=3.0E-4/o,W=102.9372/o,D=23.45/o,ha=280.16/o,$=360.9856235/o;return function(w,s,A){A=-A/o;s=s/o;w=w.valueOf()/864E5-0.5+2440588;var M=C+H*(w-2451545),F=P*q(M)+I*q(2*M)+Z*q(3*M);F=M+W+F+p;M=g(q(F)*q(D));F=k(q(F)*r(D),r(F));A=ha+$*(w-2451545)-A-F;return{altitude:g(q(s)*q(M)+r(s)*r(M)*
r(A)),azimuth:k(q(A),r(A)*q(s)-e(M)*r(s))-p/2}}}(),ma=Math.PI,Pa=ma/2,Xa=ma/4,Ya=180/ma,Za=256,Ga=14,na="latitude",oa="longitude",R=0,N=1,S=2,ca=3,xa=4,ia=5,aa=6;i.OSMBuildings=function(m){function q(a){var d=wa.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering="optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;a.appendChild(d);a=d.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=false}catch(b){}return d}
function r(a,d){var b={};a/=pa;d/=pa;b[na]=d<=0?90:d>=1?-90:Ya*(2*Va(Ra(ma*(1-2*d)))-Pa);b[oa]=(a===1?1:(a%1+1)%1)*360-180;return b}function e(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function g(a,d,b,c,h){a=la(Fa(a,d),b);return la(Fa(c+(a-d)/(b-d)*(h-c),c),h)}function k(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}
function p(){if(!(!Ha||O<Ga)){var a=r(F-A,da-M),d=r(F+w+A,da+s+M);ya&&ya.abort();ya=k(e(Ha,{w:a[oa],n:a[na],e:d[oa],s:d[na],z:O}),o)}}function o(a){var d,b,c,h=[],f,j=f=0;qa=Ga;Z(O);ya=null;if(!(!a||a.meta.z!==O)){c=a.meta;b=a.data;if(E&&B&&E.z===c.z){f=E.x-c.x;j=E.y-c.y;a=0;for(d=B.length;a<d;a++)h[a]=B[a][S][0]+f+","+(B[a][S][1]+j)}E=c;B=[];a=0;for(d=b.length;a<d;a++){c=[];if(!(b[a][N]>ra)){f=Ma(b[a][S]);if(!(f.length<8)){c[S]=f;c[xa]=La(f);c[R]=la(b[a][R],ra);c[N]=b[a][N];f=c[S][0]+","+c[S][1];
c[ia]=!(h&&~h.indexOf(f));c[ca]=[];c[aa]=[];B.push(c)}}}W()}}function C(a,d){var b=[],c,h,f,j,n,l,x,G,y,z=Ia-O;c=0;for(h=a.length;c<h;c++){n=a[c];G=n[N]>>z;if(!(G>ra)){l=n[S];y=new Oa(l.length);f=0;for(j=l.length-1;f<j;f+=2){x=l[f+1];var t=la(1,Fa(0,0.5-Sa(Ea(Xa+Pa*l[f]/180))/ma/2));x={x:(x/360+0.5)*pa<<0,y:t*pa<<0};y[f]=x.x;y[f+1]=x.y}y=Ma(y);if(!(y.length<8)){j=[];j[S]=y;j[xa]=La(y);j[R]=la(n[R]>>z,ra);j[N]=G;j[ia]=d;j[ca]=n[ca];j[aa]=[];for(f=0;f<3;f++)if(j[ca][f])j[aa][f]=j[ca][f].adjustAlpha(T)+
"";b.push(j)}}}return b}function H(a,d){if(typeof a==="object")I(a,!d);else{var b=wa.documentElement,c=wa.createElement("script");i.jsonpCallback=function(h){delete i.jsonpCallback;b.removeChild(c);I(h,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function P(a,d,b){if(b===undefined)b=[];var c,h,f,j=a[0]?a:a.features,n,l,x,G,y,z=d?1:0,t=d?0:1;if(j){c=0;for(a=j.length;c<a;c++)P(j[c],d,b);return b}if(a.type==="Feature"){n=a.geometry;c=a.properties}if(n.type==="Polygon")l=
[n.coordinates];if(n.type==="MultiPolygon")l=n.coordinates;if(l){d=c.height;if(c.color||c.wallColor)G=Q.parse(c.color||c.wallColor);if(c.roofColor)y=Q.parse(c.roofColor);c=0;for(a=l.length;c<a;c++){j=l[c][0];x=[];h=n=0;for(f=j.length;h<f;h++){x.push(j[h][z],j[h][t]);n+=d||j[h][2]||0}if(n){h=[];f=S;var u=void 0,v=void 0,J=void 0,X=void 0,sa=0,Y=void 0,Qa=void 0;Y=0;for(Qa=x.length-3;Y<Qa;Y+=2){u=x[Y];v=x[Y+1];J=x[Y+2];X=x[Y+3];sa+=u*X-J*v}if((sa/2>0?"CW":"CCW")==="CW")x=x;else{u=[];for(v=x.length-
2;v>=0;v-=2)u.push(x[v],x[v+1]);x=u}h[f]=x;h[R]=n/j.length<<0;h[ca]=[G||null,G?G.adjustLightness(0.8):null,y?y:G?G.adjustLightness(1.2):ja];b.push(h)}}}return b}function I(a,d){if(a){ta=P(a,d);qa=0;Z(O);E={n:90,w:-180,s:-90,e:180,x:0,y:0,z:O};B=C(ta,true);W()}else{ta=null;D()}}function Z(a){var d,b,c;O=a;pa=Za<<O;T=1-g(O,qa,Ia,0,0.3);Ja=ea.adjustAlpha(T)+"";za=Aa.adjustAlpha(T)+"";Ba=ja.adjustAlpha(T)+"";fa.setAlpha(T);if(B){a=0;for(d=B.length;a<d;a++){c=B[a];c[aa]=[];for(b=0;b<3;b++)if(c[ca][b])c[aa][b]=
c[ca][b].adjustAlpha(T)+""}}}function W(){clearInterval(Ka);ga=0;Ka=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(Ka);ga=1;for(var a=0,d=B.length;a<d;a++)B[a][ia]=0}fa.render();D()},33)}function D(){U.clearRect(0,0,w,s);if(E&&B)if(!(O<qa||Ca)){var a,d,b,c,h,f,j,n,l,x=F-E.x,G=da-E.y,y=[ua+x,va+G],z,t,u,v,J,X;B.sort(function(sa,Y){return K(Y[xa],y)/Y[R]-K(sa[xa],y)/sa[R]});a=0;for(d=B.length;a<d;a++){h=B[a];t=false;f=h[S];z=[];b=0;for(c=f.length-1;b<c;b+=2){z[b]=n=f[b]-x;z[b+1]=l=f[b+1]-G;t||
(t=n>0&&n<w&&l>0&&l<s)}if(t){b=h[ia]?h[R]*ga:h[R];f=ka/(ka-b);if(h[N]){b=h[ia]?h[N]*ga:h[N];j=ka/(ka-b)}n=[];b=0;for(c=z.length-3;b<c;b+=2){l=z[b];u=z[b+1];t=z[b+2];v=z[b+3];J=$(l,u,f);X=$(t,v,f);if(h[N]){u=$(l,u,j);v=$(t,v,j);l=u.x;u=u.y;t=v.x;v=v.y}if((t-l)*(J.y-u)>(J.x-l)*(v-u)){U.fillStyle=l<t&&u<v||l>t&&u>v?h[aa][1]||za:h[aa][0]||Ja;ha([t,v,l,u,J.x,J.y,X.x,X.y])}n[b]=J.x;n[b+1]=J.y}U.fillStyle=h[aa][2]||Ba;U.strokeStyle=h[aa][1]||za;ha(n,true)}}}}function ha(a,d){if(a.length){U.beginPath();U.moveTo(a[0],
a[1]);for(var b=2,c=a.length;b<c;b+=2)U.lineTo(a[b],a[b+1]);U.closePath();d&&U.stroke();U.fill()}}function $(a,d,b){return{x:(a-ua)*b+ua<<0,y:(d-va)*b+va<<0}}var w=0,s=0,A=0,M=0,F=0,da=0,O,pa,ya,V,Da,U,Ha,ea=new Q(200,190,180),Aa=ea.adjustLightness(0.8),ja=ea.adjustLightness(1.2),Ja=ea+"",za=Aa+"",Ba=ja+"",ta,E,B,ga=1,Ka,T=1,qa=Ga,Ia=20,ra,ua,va,ka,Ca,fa={enabled:true,canvas:null,context:null,color:new Q(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.canvas=
q(a);this.context=this.canvas.getContext("2d")},render:function(){var a=this.context;a.clearRect(0,0,w,s);if(this.enabled)if(E&&B)if(!(O<qa||Ca))if(this.length){var d,b,c,h,f,j,n,l,x=F-E.x,G=da-E.y,y,z,t,u,v,J,X=[];a.beginPath();d=0;for(b=B.length;d<b;d++){f=B[d];z=false;j=f[S];y=[];c=0;for(h=j.length-1;c<h;c+=2){y[c]=n=j[c]-x;y[c+1]=l=j[c+1]-G;z||(z=n>0&&n<w&&l>0&&l<s)}if(z){j=f[ia]?f[R]*ga:f[R];if(f[N])j=f[ia]?f[N]*ga:f[N];n=null;c=0;for(h=y.length-3;c<h;c+=2){l=y[c];t=y[c+1];z=y[c+2];u=y[c+3];
v=this.project(l,t,j);J=this.project(z,u,j);if(f[N]){t=this.project(l,t,j);u=this.project(z,u,j);l=t.x;t=t.y;z=u.x;u=u.y}if((z-l)*(v.y-t)>(v.x-l)*(u-t)){n===1&&a.lineTo(l,t);n=0;c||a.moveTo(l,t);a.lineTo(z,u)}else{n===0&&a.lineTo(v.x,v.y);n=1;c||a.moveTo(v.x,v.y);a.lineTo(J.x,J.y)}}a.closePath();X.push(y)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(b=X.length;d<b;d++){f=X[d];a.moveTo(f[0],f[1]);c=2;for(h=f.length;c<h;c+=2)a.lineTo(f[c],f[c+
1]);a.lineTo(f[0],f[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,d,b){return{x:a+this.directionX*b,y:d+this.directionY*b}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=r(F+A,da+M);a=Wa(a,d.latitude,d.longitude);if(a.altitude<=0){this.length=0;this.alpha=g(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Ea(a.altitude);this.alpha=
0.4/this.length;this.directionX=Ua(a.azimuth)*this.length;this.directionY=Ta(a.azimuth)*this.length}this.color.a=this.alpha;this.colorStr=this.color+"";this.render()},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d},destroy:function(){this.canvas.parentNode.removeChild(this.canvas)}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ea=Q.parse(a.color||a.wallColor);Ja=ea.adjustAlpha(T)+"";Aa=ea.adjustLightness(0.8);za=Aa.adjustAlpha(T)+"";ja=ea.adjustLightness(1.2);Ba=
ja.adjustAlpha(T)+""}if(a.roofColor){ja=Q.parse(a.roofColor);Ba=ja.adjustAlpha(T)+""}a.shadows!==undefined&&fa.setEnabled(a.shadows);D();return this};this.geoJSON=function(a,d){H(a,d);return this};this.setCamOffset=function(a,d){ua=A+a;va=s+d};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){fa.setDate(a);return this};this.createContainer=function(a){V=wa.createElement("DIV");V.style.pointerEvents="none";V.style.position="absolute";V.style.left=0;V.style.top=0;fa.init(V);Da=q(V);U=Da.getContext("2d");
a.appendChild(V);return V};this.destroyContainer=function(){V.parentNode.removeChild(V)};this.loadData=p;this.onMoveEnd=function(){var a=r(F,da),d=r(F+w,da+s);fa.render();D();if(E&&(a[na]>E.n||a[oa]<E.w||d[na]<E.s||d[oa]>E.e))p()};this.onZoomEnd=function(a){Ca=false;Z(a.zoom);if(ta){B=C(ta);D()}else{D();p()}};this.onZoomStart=function(){Ca=true;fa.render();D()};this.setOrigin=function(a,d){F=a;da=d};this.setSize=function(a,d){w=a;s=d;A=w/2<<0;M=s/2<<0;ua=A;va=s;ka=w/1.5/Ea(45)<<0;fa.setSize(w,s);
Da.width=w;Da.height=s;ra=ka-50};this.setZoom=Z;this.render=D;Ha=m};i.OSMBuildings.VERSION="0.1.8a";i.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(i){L.Util.setOptions(this,i)},onMove:function(){var i=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-i.x,this.lastY-i.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var i=L.DomUtil.getPosition(this.map._mapPane),K=this.map.getPixelOrigin();this.lastX=i.x;this.lastY=i.y;this.container.style.left=-i.x+
"px";this.container.style.top=-i.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(K.x-i.x,K.y-i.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var i=L.DomUtil.getPosition(this.map._mapPane),K=this.map.getPixelOrigin();this.osmb.setOrigin(K.x-i.x,K.y-i.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(i){i.addLayer(this);return this},onAdd:function(i){this.map=
i;i=this.map._panes.overlayPane;if(this.osmb)i.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.createContainer(i);this.osmb.maxZoom=this.map._layersMaxZoom}i=L.DomUtil.getPosition(this.map._mapPane);var K=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(K.x-i.x,K.y-i.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-i.x+"px";this.container.style.top=-i.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(i){i.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);i.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(i,K){return this.osmb.geoJSON(i,K)},setStyle:function(i){return this.osmb.setStyle(i)},
setDate:function(i){return this.osmb.setDate(i)}});
