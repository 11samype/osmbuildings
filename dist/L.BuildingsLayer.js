(function(g){function D(l,r){var w=l[0]-r[0],d=l[1]-r[1];return w*w+d*d}function Da(l){for(var r=0,w=0,d=0,f=l.length-3;d<f;d+=2){r+=l[d];w+=l[d+1]}l=(l.length-2)*2;return[r/l<<0,w/l<<0]}function Ea(l){var r=l.length/2,w=new Fa(r),d=0,f=r-1,h,m,s,x,E=[],K=[],F=[];for(w[d]=w[f]=1;f;){m=0;for(h=d+1;h<f;h++){s=l[h*2];var M=l[h*2+1],X=l[d*2],P=l[d*2+1],Q=l[f*2],G=l[f*2+1],z=Q-X,H=G-P,I=void 0;if(z!==0||H!==0){I=((s-X)*z+(M-P)*H)/(z*z+H*H);if(I>1){X=Q;P=G}else if(I>0){X+=z*I;P+=H*I}}z=s-X;H=M-P;s=z*z+
H*H;if(s>m){x=h;m=s}}if(m>7){w[x]=1;E.push(d);K.push(x);E.push(x);K.push(f)}d=E.pop();f=K.pop()}for(h=0;h<r;h++)w[h]&&F.push(l[h*2],l[h*2+1]);return F}var Ga=Ga||Array,Fa=Fa||Array,Ka=Math.exp,La=Math.log,Ma=Math.tan,Na=Math.atan,va=Math.min,Oa=Math.max,wa=g.document,R=function(){function l(d,f,h){if(h<0)h+=1;if(h>1)h-=1;if(h<1/6)return d+(f-d)*6*h;if(h<0.5)return f;if(h<2/3)return d+(f-d)*(2/3-h)*6;return d}function r(d,f,h,m){this.r=d;this.g=f;this.b=h;this.a=arguments.length<4?1:m}var w=r.prototype;
w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(d){var f=R.toHSLA(this);f.l*=d;f.l=Math.min(1,Math.max(0,f.l));var h,m;if(f.s===0)d=h=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var s=2*f.l-m;d=l(s,m,f.h+1/3);h=l(s,m,f.h);m=l(s,m,f.h-1/3)}return new R(d*255<<0,h*255<<0,m*255<<0,f.a)};w.adjustAlpha=function(d){return new R(this.r,this.g,this.b,this.a*d)};r.parse=function(d){d+="";if(~d.indexOf("#")){d=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);
return new R(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16),d[4]?parseInt(d[4],16)/255:1)}if(d=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new R(parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5],10):1)};r.toHSLA=function(d){var f=d.r/255,h=d.g/255,m=d.b/255,s=Math.max(f,h,m),x=Math.min(f,h,m),E,K=(s+x)/2,F;if(s===x)E=x=0;else{F=s-x;x=K>0.5?F/(2-s-x):F/(s+x);switch(s){case f:E=(h-m)/F+(h<m?6:0);break;case h:E=(m-f)/F+2;break;case m:E=(f-h)/F+4;break}E/=
6}return{h:E,s:x,l:K,a:d.a}};return r}(),fa=Math.PI,Ha=fa/2,Pa=fa/4,Qa=180/fa,Ra=256,xa=14,ga=400,Ia=ga-50,ha="latitude",ia="longitude",N=0,Y=1,S=2,Z=3,qa=4,ja=5,W=6;g.OSMBuildings=function(l){function r(a,e){var b={};a/=ka;e/=ka;b[ha]=e<=0?90:e>=1?-90:Qa*(2*Na(Ka(fa*(1-2*e)))-Ha);b[ia]=(a===1?1:(a%1+1)%1)*360-180;return b}function w(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return e[c]})}function d(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||
b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!ya||O<xa)){var a=r(I-z,da-H),e=r(I+Q+z,da+G+H);ra&&ra.abort();ra=d(w(ya,{w:a[ia],n:a[ha],e:e[ia],s:e[ha],z:O}),h)}}function h(a){var e,b,c,j=[],i,k=i=0;la=xa;K(O);ra=null;if(!(!a||a.meta.z!==O)){c=a.meta;b=a.data;if(A&&v&&A.z===c.z){i=A.x-c.x;k=A.y-c.y;a=0;for(e=v.length;a<e;a++)j[a]=v[a][S][0]+i+","+(v[a][S][1]+k)}A=c;v=[];a=0;for(e=b.length;a<e;a++){c=[];i=Ea(b[a][S],
b[a][N]);if(!(i.length<8)){c[S]=i;c[qa]=Da(i);c[N]=va(b[a][N],Ia);c[Y]=b[a][Y];i=c[S][0]+","+c[S][1];c[ja]=!(j&&~j.indexOf(i));c[Z]=[];c[W]=[];v.push(c)}}F()}}function m(a,e){var b=[],c,j,i,k,n,o,p,t,$=za-O;c=0;for(j=a.length;c<j;c++){n=a[c];o=n[S];t=new Ga(o.length);i=0;for(k=o.length-1;i<k;i+=2){p=o[i+1];var J=va(1,Oa(0,0.5-La(Ma(Pa+Ha*o[i]/180))/fa/2));p={x:(p/360+0.5)*ka<<0,y:J*ka<<0};t[i]=p.x;t[i+1]=p.y}t=Ea(t,n[N]);if(!(t.length<8)){k=[];k[S]=t;k[qa]=Da(t);k[N]=va(n[N]>>$,Ia);k[Y]=n[Y];k[ja]=
e;k[Z]=n[Z];k[W]=[];for(i=0;i<3;i++)if(k[Z][i])k[W][i]=k[Z][i].adjustAlpha(T)+"";b.push(k)}}return b}function s(a,e){if(typeof a==="object")E(a,!e);else{var b=wa.documentElement,c=wa.createElement("script");g.jsonpCallback=function(j){delete g.jsonpCallback;b.removeChild(c);E(j,!e)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function x(a,e,b){if(b===undefined)b=[];var c,j,i,k=a[0]?a:a.features,n,o,p,t,$,J=e?1:0,aa=e?0:1;if(k){c=0;for(a=k.length;c<a;c++)x(k[c],e,b);
return b}if(a.type==="Feature"){n=a.geometry;c=a.properties}if(n.type==="Polygon")o=[n.coordinates];if(n.type==="MultiPolygon")o=n.coordinates;if(o){e=c.height;if(c.color||c.wallColor)t=R.parse(c.color||c.wallColor);if(c.roofColor)$=R.parse(c.roofColor);c=0;for(a=o.length;c<a;c++){k=o[c][0];p=[];j=n=0;for(i=k.length;j<i;j++){p.push(k[j][J],k[j][aa]);n+=e||k[j][2]||0}if(n){j=[];i=S;var u=void 0,q=void 0,B=void 0,U=void 0,ma=0,V=void 0,Ja=void 0;V=0;for(Ja=p.length-3;V<Ja;V+=2){u=p[V];q=p[V+1];B=p[V+
2];U=p[V+3];ma+=u*U-B*q}if((ma/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}j[i]=p;j[N]=n/k.length<<0;j[Z]=[t||null,t?t.adjustLightness(0.8):null,$?$:t?t.adjustLightness(1.2):ca];b.push(j)}}}return b}function E(a,e){if(a){na=x(a,e);la=0;K(O);A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:O};v=m(na,true);F()}else{na=null;M()}}function K(a){var e,b,c;O=a;ka=Ra<<O;T=1-(O-la)*0.3/(za-la);Aa=ba.adjustAlpha(T)+"";sa=ta.adjustAlpha(T)+"";ua=ca.adjustAlpha(T)+"";if(v){a=0;
for(e=v.length;a<e;a++){c=v[a];c[W]=[];for(b=0;b<3;b++)if(c[Z][b])c[W][b]=c[Z][b].adjustAlpha(T)+""}}}function F(){ea=0;clearInterval(Ba);Ba=setInterval(function(){ea+=0.1;if(ea>1){clearInterval(Ba);ea=1;for(var a=0,e=v.length;a<e;a++)v[a][ja]=0}M()},33)}function M(){y.clearRect(0,0,Q,G);if(A&&v)if(!(O<la||Ca)){var a,e,b,c,j,i,k,n,o,p=I-A.x,t=da-A.y,$=[oa+p,pa+t],J,aa,u,q,B,U;v.sort(function(ma,V){return D(V[qa],$)/V[N]-D(ma[qa],$)/ma[N]});a=0;for(e=v.length;a<e;a++){j=v[a];u=false;i=j[S];J=[];b=
0;for(c=i.length-1;b<c;b+=2){J[b]=n=i[b]-p;J[b+1]=o=i[b+1]-t;u||(u=n>0&&n<Q&&o>0&&o<G)}if(u){b=j[ja]?j[N]*ea:j[N];i=ga/(ga-b);if(j[Y]){b=j[ja]?j[Y]*ea:j[Y];k=ga/(ga-b)}n=[];aa=[];b=0;for(c=J.length-3;b<c;b+=2){o=J[b];q=J[b+1];u=J[b+2];B=J[b+3];U=P(o,q,i);aa=P(u,B,i);if(j[Y]){q=P(o,q,k);B=P(u,B,k);o=q.x;q=q.y;u=B.x;B=B.y}if((u-o)*(U.y-q)>(U.x-o)*(B-q)){aa=[u+0.5,B+0.5,o+0.5,q+0.5,U.x,U.y,aa.x,aa.y];y.fillStyle=o<u&&q<B||o>u&&q>B?j[W][1]||sa:j[W][0]||Aa;X(aa)}n[b]=U.x;n[b+1]=U.y}y.fillStyle=j[W][2]||
ua;y.strokeStyle=j[W][1]||sa;X(n,true)}}}}function X(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function P(a,e,b){return{x:((a-oa)*b+oa<<0)+0.5,y:((e-pa)*b+pa<<0)+0.5}}var Q=0,G=0,z=0,H=0,I=0,da=0,O,ka,ra,C,y,ya,ba=new R(200,190,180),ta=ba.adjustLightness(0.8),ca=ba.adjustLightness(1.2),Aa=ba+"",sa=ta+"",ua=ca+"",na,A,v,ea=1,Ba,T=1,la=xa,za=20,oa,pa,Ca;this.setStyle=function(a){a=(a=a)||{};if(a.color||
a.wallColor){ba=R.parse(a.color||a.wallColor);Aa=ba.adjustAlpha(T)+"";ta=ba.adjustLightness(0.8);sa=ta.adjustAlpha(T)+"";ca=ba.adjustLightness(1.2);ua=ca.adjustAlpha(T)+""}if(a.roofColor){ca=R.parse(a.roofColor);ua=ca.adjustAlpha(T)+""}M();return this};this.geoJSON=function(a,e){s(a,e);return this};this.setCamOffset=function(a,e){oa=z+a;pa=G+e};this.setMaxZoom=function(a){za=a};this.createCanvas=function(a){C=wa.createElement("canvas");C.style.webkitTransform="translate3d(0,0,0)";C.style.imageRendering=
"optimizeSpeed";C.style.position="absolute";C.style.pointerEvents="none";C.style.left=0;C.style.top=0;a.appendChild(C);y=C.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return C};this.destroyCanvas=function(){C.parentNode.removeChild(C)};this.loadData=f;this.onMoveEnd=function(){var a=r(I,da),e=r(I+Q,da+G);M();if(A&&(a[ha]>A.n||a[ia]<A.w||e[ha]<A.s||e[ia]>A.e))f()};this.onZoomEnd=function(a){Ca=false;K(a.zoom);if(na){v=m(na);M()}else{M();
f()}};this.onZoomStart=function(){Ca=true;M()};this.render=M;this.setOrigin=function(a,e){I=a;da=e};this.setSize=function(a,e){Q=a;G=e;z=Q/2<<0;H=G/2<<0;oa=z;pa=G;C.width=Q;C.height=G};this.setZoom=K;ya=l};g.OSMBuildings.VERSION="0.1.7a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.canvas.style.left=-g.x+"px";
this.canvas.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),D=this.map.getPixelOrigin();this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=g;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;g=L.DomUtil.getPosition(this.map._mapPane);var D=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(D.x-g.x,D.y-g.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-g.x+"px";this.canvas.style.top=-g.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(g,D){return this.osmb.geoJSON(g,D)},
setStyle:function(g){return this.osmb.setStyle(g)}});
