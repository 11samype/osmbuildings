(function(j){function I(p,x){var C=p[0]-x[0],f=p[1]-x[1];return C*C+f*f}function Wa(p){for(var x=0,C=0,f=0,h=p.length-3;f<h;f+=2){x+=p[f];C+=p[f+1]}p=(p.length-2)*2;return[x/p<<0,C/p<<0]}function Xa(p){var x=p.length/2,C=new Ya(x),f=0,h=x-1,k,u,y,E,J=[],Z=[],G=[];for(C[f]=C[h]=1;h;){u=0;for(k=f+1;k<h;k++){y=p[k*2];var oa=p[k*2+1],fa=p[f*2],aa=p[f*2+1],M=p[h*2],ja=p[h*2+1],K=M-fa,z=ja-aa,B=void 0;if(K!==0||z!==0){B=((y-fa)*K+(oa-aa)*z)/(K*K+z*z);if(B>1){fa=M;aa=ja}else if(B>0){fa+=K*B;aa+=z*B}}K=y-
fa;z=oa-aa;y=K*K+z*z;if(y>u){E=k;u=y}}if(u>2){C[E]=1;J.push(f);Z.push(E);J.push(E);Z.push(h)}f=J.pop();h=Z.pop()}for(k=0;k<x;k++)C[k]&&G.push(p[k*2],p[k*2+1]);return G}var Za=Za||Array,Ya=Ya||Array,U=Math,hb=U.exp,ib=U.log,P=U.sin,ba=U.cos,Ba=U.tan,$a=U.asin,jb=U.atan,ab=U.atan2,pa=U.min,Oa=U.max,Pa=j.document,Q=function(){function p(f,h,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return f+(h-f)*6*k;if(k<0.5)return h;if(k<2/3)return f+(h-f)*(2/3-k)*6;return f}function x(f,h,k,u){this.r=f;this.g=h;this.b=
k;this.a=arguments.length<4?1:u}var C=x.prototype;C.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};C.adjustLightness=function(f){var h=Q.toHSLA(this);h.l*=f;h.l=Math.min(1,Math.max(0,h.l));var k,u;if(h.s===0)f=k=u=h.l;else{u=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var y=2*h.l-u;f=p(y,u,h.h+1/3);k=p(y,u,h.h);u=p(y,u,h.h-1/3)}return new Q(f*255<<0,k*255<<0,u*255<<0,h.a)};C.adjustAlpha=function(f){return new Q(this.r,this.g,this.b,this.a*f)};x.parse=function(f){f+=
"";if(~f.indexOf("#")){f=f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};x.toHSLA=function(f){var h=f.r/255,k=f.g/255,u=f.b/255,y=Math.max(h,k,u),E=Math.min(h,k,u),J,Z=(y+E)/2,G;if(y===E)J=E=0;else{G=y-E;E=Z>0.5?G/(2-y-E):G/(y+E);switch(y){case h:J=(k-
u)/G+(k<u?6:0);break;case k:J=(u-h)/G+2;break;case u:J=(h-k)/G+4;break}J/=6}return{h:J,s:E,l:Z,a:f.a}};return x}(),ga=Math.PI,bb=ga/2,kb=ga/4,N=180/ga,lb=256,Qa=14,qa="latitude",ra="longitude",V=0,O=1,R=2,ca=3,Ca=4,sa=5,$=6;j.OSMBuildings=function(p){function x(a,c){var b={};a/=ta;c/=ta;b[qa]=c<=0?90:c>=1?-90:N*(2*jb(hb(ga*(1-2*c)))-bb);b[ra]=(a===1?1:(a%1+1)%1)*360-180;return b}function C(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function f(a,c,b,d,e){a=pa(Oa(a,c),b);
return pa(Oa(d+(a-c)/(b-c)*(e-d),d),e)}function h(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function k(){if(!(!Ra||S<Qa)){var a=x(W-ka,X-Da),c=x(W+z+ka,X+B+Da);Ea&&Ea.abort();Ea=h(C(Ra,{w:a[ra],n:a[qa],e:c[ra],s:c[qa],z:S}),u)}}function u(a){var c,b,d,e=[],g,i=g=0;Fa=Qa;G(S);Ea=null;if(!(!a||a.meta.z!==S)){d=a.meta;b=a.data;if(D&&A&&D.z===
d.z){g=D.x-d.x;i=D.y-d.y;a=0;for(c=A.length;a<c;a++)e[a]=A[a][R][0]+g+","+(A[a][R][1]+i)}D=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][O]>ua)){g=Xa(b[a][R]);if(!(g.length<8)){d[R]=g;d[Ca]=Wa(g);d[V]=pa(b[a][V],ua);d[O]=b[a][O];g=d[R][0]+","+d[R][1];d[sa]=!(e&&~e.indexOf(g));d[ca]=[];d[$]=[];A.push(d)}}}aa()}}function y(a,c){var b=[],d,e,g,i,l,m,o,v,q,t=Sa-S;d=0;for(e=a.length;d<e;d++){l=a[d];v=l[O]>>t;if(!(v>ua)){m=l[R];q=new Za(m.length);g=0;for(i=m.length-1;g<i;g+=2){o=m[g+1];var r=pa(1,Oa(0,
0.5-ib(Ba(kb+bb*m[g]/180))/ga/2));o={x:(o/360+0.5)*ta<<0,y:r*ta<<0};q[g]=o.x;q[g+1]=o.y}q=Xa(q);if(!(q.length<8)){i=[];i[R]=q;i[Ca]=Wa(q);i[V]=pa(l[V]>>t,ua);i[O]=v;i[sa]=c;i[ca]=l[ca];i[$]=[];for(g=0;g<3;g++)if(i[ca][g])i[$][g]=i[ca][g].adjustAlpha(T)+"";b.push(i)}}}return b}function E(a,c){if(typeof a==="object")Z(a,!c);else{var b=Pa.documentElement,d=Pa.createElement("script");j.jsonpCallback=function(e){delete j.jsonpCallback;b.removeChild(d);Z(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,
"jsonpCallback")}}function J(a,c,b){if(b===undefined)b=[];var d,e,g,i=a[0]?a:a.features,l,m,o,v,q,t=c?1:0,r=c?0:1;if(i){d=0;for(a=i.length;d<a;d++)J(i[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")m=[l.coordinates];if(l.type==="MultiPolygon")m=l.coordinates;if(m){c=d.height;if(d.color||d.wallColor)v=Q.parse(d.color||d.wallColor);if(d.roofColor)q=Q.parse(d.roofColor);d=0;for(a=m.length;d<a;d++){i=m[d][0];o=[];e=l=0;for(g=i.length;e<g;e++){o.push(i[e][t],
i[e][r]);l+=c||i[e][2]||0}if(l){e=[];g=R;var s=void 0,w=void 0,H=void 0,la=void 0,va=0,Y=void 0,cb=void 0;Y=0;for(cb=o.length-3;Y<cb;Y+=2){s=o[Y];w=o[Y+1];H=o[Y+2];la=o[Y+3];va+=s*la-H*w}if((va/2>0?"CW":"CCW")==="CW")o=o;else{s=[];for(w=o.length-2;w>=0;w-=2)s.push(o[w],o[w+1]);o=s}e[g]=o;e[V]=l/i.length<<0;e[ca]=[v||null,v?v.adjustLightness(0.8):null,q?q:v?v.adjustLightness(1.2):ha];b.push(e)}}}return b}function Z(a,c){if(a){wa=J(a,c);Fa=0;G(S);D={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};A=y(wa,true);
aa()}else{wa=null;M()}}function G(a){var c,b,d;S=a;ta=lb<<S;T=1-f(S,Fa,Sa,0,0.3);Ga=da.adjustAlpha(T)+"";Ha=Ia.adjustAlpha(T)+"";Ja=ha.adjustAlpha(T)+"";Ka=La.adjustAlpha(T)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[$]=[];for(b=0;b<3;b++)if(d[ca][b])d[$][b]=d[ca][b].adjustAlpha(T)+""}}}function oa(a){var c;Ma=a;ea=null;if(Ma){c=x(W+ka,X+Da);a=-c.longitude/N;c=c.latitude/N;var b=Ma.valueOf()/mb-0.5+nb,d=ob+pb*(b-db),e=qb*P(d)+rb*P(2*d)+sb*P(3*d);e=d+tb+e+ga;d=$a(P(e)*P(eb));e=ab(P(e)*ba(eb),ba(e));
a=ub+vb*(b-db)-a-e;a={altitude:$a(P(c)*P(d)+ba(c)*ba(d)*ba(a)),azimuth:ab(P(a),ba(a)*P(c)-Ba(d)*ba(c))-ga/2};if(a.altitude<=0){ia=-1;Na=f(-a.altitude,0,1,0.1,0.8)}else{ia=1/Ba(a.altitude);Na=0.4/ia;xa=ba(a.azimuth)*ia;ya=P(a.azimuth)*ia}La.a=Na;Ka=La+"";M()}}function fa(){var a,c,b,d,e,g,i,l,m=W-D.x,o=X-D.y,v,q,t,r,s,w,H=[];n.fillStyle=Ka;a=0;for(c=A.length;a<c;a++){e=A[a];q=false;g=e[R];v=[];b=0;for(d=g.length-1;b<d;b+=2){v[b]=i=g[b]-m;v[b+1]=l=g[b+1]-o;q||(q=i>0&&i<z&&l>0&&l<B)}if(q){g=e[V];if(e[O])g=
e[O];i=null;n.beginPath();b=0;for(d=v.length-3;b<d;b+=2){l=v[b];t=v[b+1];q=v[b+2];r=v[b+3];s={x:l+xa*g,y:t+ya*g};w={x:q+xa*g,y:r+ya*g};if(e[O]){t={x:l+xa*g,y:t+ya*g};r={x:q+xa*g,y:r+ya*g};l=t.x;t=t.y;q=r.x;r=r.y}if((q-l)*(s.y-t)>(s.x-l)*(r-t)){i===1&&n.lineTo(l,t);i=0;b||n.moveTo(l,t);n.lineTo(q,r)}else{i===0&&n.lineTo(s.x,s.y);i=1;b||n.moveTo(s.x,s.y);n.lineTo(w.x,w.y)}}n.closePath();n.fill();H.push(v)}}n.fillStyle=Ga;a=0;for(c=H.length;a<c;a++)ja(H[a]);a=n.getImageData(0,0,z,B);c=a.data;b=Na*255<<
0;m=0;for(o=c.length;m<o;m+=4){d=c[m+0];e=c[m+3];if(d&&e>=255)c[m+3]=0;else if(e>b)c[m+3]=b}n.putImageData(a,0,0);ea=new Image;ea.src=F.toDataURL()}function aa(){ma=0;ea=null;clearInterval(Ta);Ta=setInterval(function(){ma+=0.1;if(ma>1){clearInterval(Ta);ma=1;for(var a=0,c=A.length;a<c;a++)A[a][sa]=0}M()},33)}function M(){n.clearRect(0,0,z,B);if(D&&A)if(!(S<Fa||Ua)){if(Va&&ia>-1){Ma||oa(new Date);if(ea)n.drawImage(ea,fb-W,gb-X);else{fa();fb=W;gb=X}}var a,c,b,d,e,g,i,l,m,o=W-D.x,v=X-D.y,q=[za+o,Aa+
v],t,r,s,w,H,la;A.sort(function(va,Y){return I(Y[Ca],q)/Y[V]-I(va[Ca],q)/va[V]});a=0;for(c=A.length;a<c;a++){e=A[a];r=false;g=e[R];t=[];b=0;for(d=g.length-1;b<d;b+=2){t[b]=l=g[b]-o;t[b+1]=m=g[b+1]-v;r||(r=l>0&&l<z&&m>0&&m<B)}if(r){b=e[sa]?e[V]*ma:e[V];g=na/(na-b);if(e[O]){b=e[sa]?e[O]*ma:e[O];i=na/(na-b)}l=[];b=0;for(d=t.length-3;b<d;b+=2){m=t[b];s=t[b+1];r=t[b+2];w=t[b+3];H=K(m,s,g);la=K(r,w,g);if(e[O]){s=K(m,s,i);w=K(r,w,i);m=s.x;s=s.y;r=w.x;w=w.y}if((r-m)*(H.y-s)>(H.x-m)*(w-s)){n.fillStyle=m<r&&
s<w||m>r&&s>w?e[$][1]||Ha:e[$][0]||Ga;ja([r,w,m,s,H.x,H.y,la.x,la.y])}l[b]=H.x;l[b+1]=H.y}n.fillStyle=e[$][2]||Ja;n.strokeStyle=e[$][1]||Ha;ja(l,true)}}if(Va&&ia===-1){n.fillStyle=Ka;n.fillRect(0,0,z,B)}}}function ja(a,c){if(a.length){n.beginPath();n.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)n.lineTo(a[b],a[b+1]);n.closePath();c&&n.stroke();n.fill()}}function K(a,c,b){return{x:(a-za)*b+za<<0,y:(c-Aa)*b+Aa<<0}}var z=0,B=0,ka=0,Da=0,W=0,X=0,S,ta,Ea,F,n,Ra,da=new Q(200,190,180),Ia=da.adjustLightness(0.8),
ha=da.adjustLightness(1.2),La=new Q(0,0,0),Ga=da+"",Ha=Ia+"",Ja=ha+"",Ka=La+"",Va=true,wa,D,A,ma=1,Ta,T=1,Fa=Qa,Sa=20,ua,za,Aa,na,Ua,fb,gb,ea,Na=1,ia=-1,xa=0,ya=0,Ma,mb=864E5,nb=2440588,db=2451545,ob=357.5291/N,pb=0.98560028/N,qb=1.9148/N,rb=0.02/N,sb=3.0E-4/N,tb=102.9372/N,eb=23.45/N,ub=280.16/N,vb=360.9856235/N;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=Q.parse(a.color||a.wallColor);Ga=da.adjustAlpha(T)+"";Ia=da.adjustLightness(0.8);Ha=Ia.adjustAlpha(T)+"";ha=da.adjustLightness(1.2);
Ja=ha.adjustAlpha(T)+""}if(a.roofColor){ha=Q.parse(a.roofColor);Ja=ha.adjustAlpha(T)+""}if(a.shadows!==undefined)Va=!!a.shadows;M();return this};this.geoJSON=function(a,c){E(a,c);return this};this.setCamOffset=function(a,c){za=ka+a;Aa=B+c};this.setMaxZoom=function(a){Sa=a};this.createCanvas=function(a){F=Pa.createElement("CANVAS");F.style.webkitTransform="translate3d(0,0,0)";F.style.imageRendering="optimizeSpeed";F.style.position="absolute";F.style.pointerEvents="none";F.style.left=0;F.style.top=
0;a.appendChild(F);n=F.getContext("2d");n.lineCap="round";n.lineJoin="round";n.lineWidth=1;try{n.mozImageSmoothingEnabled=false}catch(c){}return F};this.destroyCanvas=function(){F.parentNode.removeChild(F)};this.loadData=k;this.onMoveEnd=function(){var a=x(W,X),c=x(W+z,X+B);ea=null;M();if(D&&(a[qa]>D.n||a[ra]<D.w||c[qa]<D.s||c[ra]>D.e))k()};this.onZoomEnd=function(a){Ua=false;G(a.zoom);if(wa){A=y(wa);ea=null;M()}else{M();k()}};this.onZoomStart=function(){Ua=true;M()};this.render=M;this.setOrigin=
function(a,c){W=a;X=c};this.setSize=function(a,c){z=a;B=c;ka=z/2<<0;Da=B/2<<0;za=ka;Aa=B;na=z/1.5/Ba(45)<<0;F.width=z;F.height=B;ua=na-50};this.setZoom=G;this.setDate=oa;Ra=p};j.OSMBuildings.VERSION="0.1.8a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.canvas.style.left=-j.x+"px";
this.canvas.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),I=this.map.getPixelOrigin();this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=j;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;j=L.DomUtil.getPosition(this.map._mapPane);var I=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(I.x-j.x,I.y-j.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-j.x+"px";this.canvas.style.top=-j.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(j,I){return this.osmb.geoJSON(j,I)},
setStyle:function(j){return this.osmb.setStyle(j)},setDate:function(j){return this.osmb.setDate(j)}});
