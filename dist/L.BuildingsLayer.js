(function(j){function O(n,q){var w=n[0]-q[0],f=n[1]-q[1];return w*w+f*f}function Ka(n){for(var q=0,w=0,f=0,i=n.length-3;f<i;f+=2){q+=n[f];w+=n[f+1]}n=(n.length-2)*2;return[q/n<<0,w/n<<0]}function La(n){var q=n.length/2,w=new Ma(q),f=0,i=q-1,k,r,o,G,M=[],T=[],J=[];for(w[f]=w[i]=1;i;){r=0;for(k=f+1;k<i;k++){o=n[k*2];var ea=n[k*2+1],K=n[f*2],U=n[f*2+1],Z=n[i*2],H=n[i*2+1],u=Z-K,z=H-U,C=void 0;if(u!==0||z!==0){C=((o-K)*u+(ea-U)*z)/(u*u+z*z);if(C>1){K=Z;U=H}else if(C>0){K+=u*C;U+=z*C}}u=o-K;z=ea-U;o=u*
u+z*z;if(o>r){G=k;r=o}}if(r>2){w[G]=1;M.push(f);T.push(G);M.push(G);T.push(i)}f=M.pop();i=T.pop()}for(k=0;k<q;k++)w[k]&&J.push(n[k*2],n[k*2+1]);return J}var Na=Na||Array,Ma=Ma||Array,aa=Math,Qa=aa.exp,Ra=aa.log,Sa=aa.sin,Ta=aa.cos,Da=aa.tan,Ua=aa.atan,la=aa.min,Ea=aa.max,za=j.document,V=function(){function n(f,i,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return f+(i-f)*6*k;if(k<0.5)return i;if(k<2/3)return f+(i-f)*(2/3-k)*6;return f}function q(f,i,k,r){this.r=f;this.g=i;this.b=k;this.a=arguments.length<
4?1:r}var w=q.prototype;w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(f){var i=V.toHSLA(this);i.l*=f;i.l=Math.min(1,Math.max(0,i.l));var k,r;if(i.s===0)f=k=r=i.l;else{r=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var o=2*i.l-r;f=n(o,r,i.h+1/3);k=n(o,r,i.h);r=n(o,r,i.h-1/3)}return new V(f*255<<0,k*255<<0,r*255<<0,i.a)};w.adjustAlpha=function(f){return new V(this.r,this.g,this.b,this.a*f)};q.parse=function(f){f+="";if(~f.indexOf("#")){f=
f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new V(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new V(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};q.toHSLA=function(f){var i=f.r/255,k=f.g/255,r=f.b/255,o=Math.max(i,k,r),G=Math.min(i,k,r),M,T=(o+G)/2,J;if(o===G)M=G=0;else{J=o-G;G=T>0.5?J/(2-o-G):J/(o+G);switch(o){case i:M=(k-r)/J+(k<r?6:0);break;case k:M=
(r-i)/J+2;break;case r:M=(i-k)/J+4;break}M/=6}return{h:M,s:G,l:T,a:f.a}};return q}(),Va=function(){var n=Math,q=n.sin,w=n.cos,f=n.tan,i=n.asin,k=n.atan2,r=n.PI,o=180/r,G=357.5291/o,M=0.98560028/o,T=1.9148/o,J=0.02/o,ea=3.0E-4/o,K=102.9372/o,U=23.45/o,Z=280.16/o,H=360.9856235/o;return function(u,z,C){C=-C/o;z=z/o;u=u.valueOf()/864E5-0.5+2440588;var D=G+M*(u-2451545),I=T*q(D)+J*q(2*D)+ea*q(3*D);I=D+K+I+r;D=i(q(I)*q(U));I=k(q(I)*w(U),w(I));C=Z+H*(u-2451545)-C-I;return{altitude:i(q(z)*q(D)+w(z)*w(D)*
w(C)),azimuth:k(q(C),w(C)*q(z)-f(D)*w(z))-r/2}}}(),ma=Math.PI,Oa=ma/2,Wa=ma/4,Xa=180/ma,Ya=256,Fa=14,na="latitude",oa="longitude",R=0,P=1,S=2,ba=3,Aa=4,fa=5,$=6;j.OSMBuildings=function(n){function q(a,d){var c={};a/=pa;d/=pa;c[na]=d<=0?90:d>=1?-90:Xa*(2*Ua(Qa(ma*(1-2*d)))-Oa);c[oa]=(a===1?1:(a%1+1)%1)*360-180;return c}function w(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(c,b){return d[b]})}function f(a,d,c,b,g){a=la(Ea(a,d),c);return la(Ea(b+(a-d)/(c-d)*(g-b),b),g)}function i(a,d){var c=new XMLHttpRequest;
c.onreadystatechange=function(){if(c.readyState===4)!c.status||c.status<200||c.status>299||c.responseText&&d(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}function k(){if(!(!Ga||Q<Fa)){var a=q(D-z,I-C),d=q(D+H+z,I+u+C);Ba&&Ba.abort();Ba=i(w(Ga,{w:a[oa],n:a[na],e:d[oa],s:d[na],z:Q}),r)}}function r(a){var d,c,b,g=[],e,h=e=0;ia=Fa;J(Q);Ba=null;if(!(!a||a.meta.z!==Q)){b=a.meta;c=a.data;if(B&&y&&B.z===b.z){e=B.x-b.x;h=B.y-b.y;a=0;for(d=y.length;a<d;a++)g[a]=y[a][S][0]+e+","+(y[a][S][1]+
h)}B=b;y=[];a=0;for(d=c.length;a<d;a++){b=[];if(!(c[a][P]>qa)){e=La(c[a][S]);if(!(e.length<8)){b[S]=e;b[Aa]=Ka(e);b[R]=la(c[a][R],qa);b[P]=c[a][P];e=b[S][0]+","+b[S][1];b[fa]=!(g&&~g.indexOf(e));b[ba]=[];b[$]=[];y.push(b)}}}ea()}}function o(a,d){var c=[],b,g,e,h,m,l,v,A,p,E=Ha-Q;b=0;for(g=a.length;b<g;b++){m=a[b];A=m[P]>>E;if(!(A>qa)){l=m[S];p=new Na(l.length);e=0;for(h=l.length-1;e<h;e+=2){v=l[e+1];var x=la(1,Ea(0,0.5-Ra(Da(Wa+Oa*l[e]/180))/ma/2));v={x:(v/360+0.5)*pa<<0,y:x*pa<<0};p[e]=v.x;p[e+1]=
v.y}p=La(p);if(!(p.length<8)){h=[];h[S]=p;h[Aa]=Ka(p);h[R]=la(m[R]>>E,qa);h[P]=A;h[fa]=d;h[ba]=m[ba];h[$]=[];for(e=0;e<3;e++)if(h[ba][e])h[$][e]=h[ba][e].adjustAlpha(W)+"";c.push(h)}}}return c}function G(a,d){if(typeof a==="object")T(a,!d);else{var c=za.documentElement,b=za.createElement("script");j.jsonpCallback=function(g){delete j.jsonpCallback;c.removeChild(b);T(g,!d)};c.insertBefore(b,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function M(a,d,c){if(c===undefined)c=[];var b,g,
e,h=a[0]?a:a.features,m,l,v,A,p,E=d?1:0,x=d?0:1;if(h){b=0;for(a=h.length;b<a;b++)M(h[b],d,c);return c}if(a.type==="Feature"){m=a.geometry;b=a.properties}if(m.type==="Polygon")l=[m.coordinates];if(m.type==="MultiPolygon")l=m.coordinates;if(l){d=b.height;if(b.color||b.wallColor)A=V.parse(b.color||b.wallColor);if(b.roofColor)p=V.parse(b.roofColor);b=0;for(a=l.length;b<a;b++){h=l[b][0];v=[];g=m=0;for(e=h.length;g<e;g++){v.push(h[g][E],h[g][x]);m+=d||h[g][2]||0}if(m){g=[];e=S;var s=void 0,t=void 0,F=void 0,
N=void 0,ja=0,Y=void 0,ra=void 0;Y=0;for(ra=v.length-3;Y<ra;Y+=2){s=v[Y];t=v[Y+1];F=v[Y+2];N=v[Y+3];ja+=s*N-F*t}if((ja/2>0?"CW":"CCW")==="CW")v=v;else{s=[];for(t=v.length-2;t>=0;t-=2)s.push(v[t],v[t+1]);v=s}g[e]=v;g[R]=m/h.length<<0;g[ba]=[A||null,A?A.adjustLightness(0.8):null,p?p:A?A.adjustLightness(1.2):ga];c.push(g)}}}return c}function T(a,d){if(a){sa=M(a,d);ia=0;J(Q);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:Q};y=o(sa,true);ea()}else{sa=null;K()}}function J(a){var d,c,b;Q=a;pa=Ya<<Q;W=1-f(Q,ia,Ha,
0,0.4);Ia=ca.adjustAlpha(W)+"";ta=Ca.adjustAlpha(W)+"";ua=ga.adjustAlpha(W)+"";ha.setAlpha(W);if(y){a=0;for(d=y.length;a<d;a++){b=y[a];b[$]=[];for(c=0;c<3;c++)if(b[ba][c])b[$][c]=b[ba][c].adjustAlpha(W)+""}}}function ea(){clearInterval(Ja);da=0;va.render();Ja=setInterval(function(){da+=0.1;if(da>1){clearInterval(Ja);da=1;for(var a=0,d=y.length;a<d;a++)y[a][fa]=0}ha.render();K()},33)}function K(){X.clearRect(0,0,H,u);if(!(!B||!y||Q<ia||wa)){var a,d,c,b,g,e,h,m,l,v=D-B.x,A=I-B.y,p=va.getMaxHeight(),
E=[xa+v,ya+A],x,s,t,F,N,ja;y.sort(function(Y,ra){return O(ra[Aa],E)/ra[R]-O(Y[Aa],E)/Y[R]});a=0;for(d=y.length;a<d;a++){g=y[a];if(!(g[R]<=p)){s=false;e=g[S];x=[];c=0;for(b=e.length-1;c<b;c+=2){x[c]=m=e[c]-v;x[c+1]=l=e[c+1]-A;s||(s=m>0&&m<H&&l>0&&l<u)}if(s){c=g[fa]?g[R]*da:g[R];e=ka/(ka-c);if(g[P]){c=g[fa]?g[P]*da:g[P];h=ka/(ka-c)}m=[];c=0;for(b=x.length-3;c<b;c+=2){l=x[c];t=x[c+1];s=x[c+2];F=x[c+3];N=Z(l,t,e);ja=Z(s,F,e);if(g[P]){t=Z(l,t,h);F=Z(s,F,h);l=t.x;t=t.y;s=F.x;F=F.y}if((s-l)*(N.y-t)>(N.x-
l)*(F-t)){X.fillStyle=l<s&&t<F||l>s&&t>F?g[$][1]||ta:g[$][0]||Ia;U([s,F,l,t,N.x,N.y,ja.x,ja.y])}m[c]=N.x;m[c+1]=N.y}X.fillStyle=g[$][2]||ua;X.strokeStyle=g[$][1]||ta;U(m,true)}}}}}function U(a,d){if(a.length){X.beginPath();X.moveTo(a[0],a[1]);for(var c=2,b=a.length;c<b;c+=2)X.lineTo(a[c],a[c+1]);X.closePath();d&&X.stroke();X.fill()}}function Z(a,d,c){return{x:(a-xa)*c+xa<<0,y:(d-ya)*c+ya<<0}}var H=0,u=0,z=0,C=0,D=0,I=0,Q,pa,Ba,X,Ga,ca=new V(200,190,180),Ca=ca.adjustLightness(0.8),ga=ca.adjustLightness(1.2),
Ia=ca+"",ta=Ca+"",ua=ga+"",sa,B,y,da=1,Ja,W=1,ia=Fa,Ha=20,qa,xa,ya,ka,wa,Pa={container:null,items:[],create:function(a){var d=this.container=za.createElement("DIV");d.style.pointerEvents="none";d.style.position="absolute";d.style.left=0;d.style.top=0;ha.setContext(this.add());va.setContext(this.add());X=this.add();a.appendChild(d);return d},add:function(){var a=za.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";
a.style.left=0;a.style.top=0;var d=a.getContext("2d");d.lineCap="round";d.lineJoin="round";d.lineWidth=1;try{d.mozImageSmoothingEnabled=false}catch(c){}this.items.push(a);this.container.appendChild(a);return d},setSize:function(a,d){for(var c=this.items,b=0,g=c.length;b<g;b++){c[b].width=a;c[b].height=d}}},ha={enabled:true,context:null,color:new V(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,directionY:0,setContext:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,
0,H,u);if(!(!this.enabled||!B||!y||Q<ia||wa||!this.length)){var d,c,b,g,e,h,m,l,v=D-B.x,A=I-B.y,p,E,x,s,t,F,N=[];a.beginPath();d=0;for(c=y.length;d<c;d++){e=y[d];E=false;h=e[S];p=[];b=0;for(g=h.length-1;b<g;b+=2){p[b]=m=h[b]-v;p[b+1]=l=h[b+1]-A;E||(E=m>0&&m<H&&l>0&&l<u)}if(E){h=e[fa]?e[R]*da:e[R];if(e[P])h=e[fa]?e[P]*da:e[P];m=null;b=0;for(g=p.length-3;b<g;b+=2){l=p[b];x=p[b+1];E=p[b+2];s=p[b+3];t=this.project(l,x,h);F=this.project(E,s,h);if(e[P]){x=this.project(l,x,h);s=this.project(E,s,h);l=x.x;
x=x.y;E=s.x;s=s.y}if((E-l)*(t.y-x)>(t.x-l)*(s-x)){m===1&&a.lineTo(l,x);m=0;b||a.moveTo(l,x);a.lineTo(E,s)}else{m===0&&a.lineTo(t.x,t.y);m=1;b||a.moveTo(t.x,t.y);a.lineTo(F.x,F.y)}}a.closePath();N.push(p)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=N.length;d<c;d++){e=N[d];a.moveTo(e[0],e[1]);b=2;for(g=e.length;b<g;b+=2)a.lineTo(e[b],e[b+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},
project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=q(D+z,I+C);a=Va(a,d.latitude,d.longitude);if(a.altitude<=0){this.length=0;this.alpha=f(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Da(a.altitude);this.alpha=0.4/this.length;this.directionX=Ta(a.azimuth)*this.length;this.directionY=Sa(a.azimuth)*this.length}this.color.a=
this.alpha;this.colorStr=this.color+"";this.render()}},va={context:null,maxHeight:8,setContext:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,H,u);if(!(!B||!y||Q<ia||wa)){var d,c,b,g,e,h,m,l=D-B.x,v=I-B.y,A,p;a.beginPath();d=0;for(c=y.length;d<c;d++){b=y[d];p=false;e=b[S];A=[];b=0;for(g=e.length-1;b<g;b+=2){A[b]=h=e[b]-l;A[b+1]=m=e[b+1]-v;p||(p=h>0&&h<H&&m>0&&m<u)}if(p){b=0;for(g=A.length-3;b<g;b+=2){p=A[b];e=A[b+1];b?a.lineTo(p,e):a.moveTo(p,e)}a.closePath()}}a.fillStyle=
ua;a.strokeStyle=ta;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ca=V.parse(a.color||a.wallColor);Ia=ca.adjustAlpha(W)+"";Ca=ca.adjustLightness(0.8);ta=Ca.adjustAlpha(W)+"";ga=ca.adjustLightness(1.2);ua=ga.adjustAlpha(W)+""}if(a.roofColor){ga=V.parse(a.roofColor);ua=ga.adjustAlpha(W)+""}a.shadows!==undefined&&ha.setEnabled(a.shadows);K();return this};this.geoJSON=function(a,d){G(a,d);return this};this.setCamOffset=
function(a,d){xa=z+a;ya=u+d};this.setMaxZoom=function(a){Ha=a};this.setDate=function(a){ha.setDate(a);return this};this.appendTo=function(a){return Pa.create(a)};this.loadData=k;this.onMoveEnd=function(){var a=q(D,I),d=q(D+H,I+u);ha.render();va.render();K();if(B&&(a[na]>B.n||a[oa]<B.w||d[na]<B.s||d[oa]>B.e))k()};this.onZoomEnd=function(a){wa=false;J(a.zoom);if(sa){y=o(sa);K()}else{K();k()}};this.onZoomStart=function(){wa=true;ha.render();va.render();K()};this.setOrigin=function(a,d){D=a;I=d};this.setSize=
function(a,d){H=a;u=d;z=H/2<<0;C=u/2<<0;xa=z;ya=u;ka=H/1.5/Da(45)<<0;Pa.setSize(H,u);qa=ka-50};this.setZoom=J;this.render=K;Ga=n};j.OSMBuildings.VERSION="0.1.8a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),O=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.container.style.left=-j.x+
"px";this.container.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(O.x-j.x,O.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),O=this.map.getPixelOrigin();this.osmb.setOrigin(O.x-j.x,O.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=
j;j=this.map._panes.overlayPane;if(this.osmb)j.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(j);this.osmb.maxZoom=this.map._layersMaxZoom}j=L.DomUtil.getPosition(this.map._mapPane);var O=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(O.x-j.x,O.y-j.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-j.x+"px";this.container.style.top=-j.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(j,O){return this.osmb.geoJSON(j,O)},setStyle:function(j){return this.osmb.setStyle(j)},
setDate:function(j){return this.osmb.setDate(j)}});
