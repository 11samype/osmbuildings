(function(i){function u(P,z){var Q=P[0]-z[0],f=P[1]-z[1];return Q*Q+f*f}var va=va||Array,Ca=Math.exp,Da=Math.log,Ea=Math.tan,Fa=Math.atan,ka=Math.min,wa=Math.max,la=i.document,D=function(){function P(f,j,m){if(m<0)m+=1;if(m>1)m-=1;if(m<1/6)return f+(j-f)*6*m;if(m<0.5)return j;if(m<2/3)return f+(j-f)*(2/3-m)*6;return f}function z(f,j,m,p){this.r=f;this.g=j;this.b=m;this.a=arguments.length<4?1:p}var Q=z.prototype;Q.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};Q.adjustLightness=function(f){var j=D.toHSLA(this);j.l*=f;j.l=Math.min(1,Math.max(0,j.l));var m,p;if(j.s===0)f=m=p=j.l;else{p=j.l<0.5?j.l*(1+j.s):j.l+j.s-j.l*j.s;var A=2*j.l-p;f=P(A,p,j.h+1/3);m=P(A,p,j.h);p=P(A,p,j.h-1/3)}return new D(f*255<<0,m*255<<0,p*255<<0,j.a)};Q.adjustAlpha=function(f){return new D(this.r,this.g,this.b,this.a*f)};z.parse=function(f){f+="";if(~f.indexOf("#")){f=f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new D(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],
16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new D(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};z.toHSLA=function(f){var j=f.r/255,m=f.g/255,p=f.b/255,A=Math.max(j,m,p),E=Math.min(j,m,p),H,S=(A+E)/2,I;if(A===E)H=E=0;else{I=A-E;E=S>0.5?I/(2-A-E):I/(A+E);switch(A){case j:H=(m-p)/I+(m<p?6:0);break;case m:H=(p-j)/I+2;break;case p:H=(j-m)/I+4;break}H/=6}return{h:H,s:E,l:S,a:f.a}};return z}(),Z=Math.PI,xa=Z/2,
Ga=Z/4,Ha=180/Z,Ia=256,ma=14,na=400,ya=na-50,$="latitude",aa="longitude",J=0,B=1,y=2,oa=3,ga=4;i.OSMBuildings=function(P){function z(a,d){var b={};a/=ba;d/=ba;b[$]=d<=0?90:d>=1?-90:Ha*(2*Fa(Ca(Z*(1-2*d)))-xa);b[aa]=(a===1?1:(a%1+1)%1)*360-180;return b}function Q(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function f(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function j(){if(!(!pa||C<ma)){var a=z(W-ca,X-qa),d=z(W+T+ca,X+K+qa);ha&&ha.abort();ha=f(Q(pa,{w:a[aa],n:a[$],e:d[aa],s:d[$],z:C}),m)}}function m(a){var d,b,c,g=[],h,e=h=0,n=wa(1,(C-Y)*2)+1;Y=ma;S(C);ha=null;if(!(!a||a.meta.z!==C)){c=a.meta;b=a.data;if(v&&w&&v.z===c.z){h=v.x-c.x;e=v.y-c.y;a=0;for(d=w.length;a<d;a++)g[a]=w[a][B][0]+h+","+(w[a][B][1]+e)}v=c;w=[];a=0;for(d=b.length;a<d;a++){c={};h=B;e=b[a][B];for(var l=n*n,k=void 0,q=[e[0],e[1]],o=[e[0],e[1]],s=2,
t=e.length-3;s<t;s+=2){k=[e[s],e[s+1]];if(u(k,q)>l){o.push(k[0],k[1]);q=k}}if(k[0]!==e[0]||k[1]!==e[1])o.push(e[0],e[1]);c[h]=o;if(!(c[B].length<8)){c[J]=ka(b[a][J],ya);h=oa;e=c[B];l=void 0;k=e.length-2;for(l=o=q=0;l<k-1;l+=2){q+=e[l];o+=e[l+1]}c[h]=[q/k*2<<0,o/k*2<<0];h=c[B][0]+","+c[B][1];c[ga]=!(g&&~g.indexOf(h));w.push(c)}}I()}}function p(a,d){var b=[],c,g,h,e,n,l,k,q,o=ra-C;c=0;for(g=a.length;c<g;c++){n=a[c];l=n[B];k=new va(l.length);h=0;for(e=l.length-1;h<e;h+=2){q=l[h+1];var s=ka(1,wa(0,0.5-
Da(Ea(Ga+xa*l[h]/180))/Z/2));q={x:(q/360+0.5)*ba<<0,y:s*ba<<0};k[h]=q.x;k[h+1]=q.y}b[c]=[];b[c][J]=ka(n[J]>>o,ya);b[c][B]=k;b[c][y]=n[y];b[c][ga]=d}return b}function A(a,d){if(typeof a==="object")H(a,!d);else{var b=la.documentElement,c=la.createElement("script");i.jsonpCallback=function(g){delete i.jsonpCallback;b.removeChild(c);H(g,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function E(a,d,b){if(b===undefined)b=[];var c,g,h,e=a[0]?a:a.features,n,l,k,q,o,s=d?
1:0,t=d?0:1;if(e){c=0;for(a=e.length;c<a;c++)E(e[c],d,b);return b}if(a.type==="Feature"){g=a.geometry;c=a.properties}if(g.type==="Polygon")n=[g.coordinates];if(g.type==="MultiPolygon")n=g.coordinates;if(n){d=c.height;if(c.color||c.wallColor)q=D.parse(c.color||c.wallColor);if(c.roofColor)o=D.parse(c.roofColor);c=0;for(a=n.length;c<a;c++){l=n[c][0];e=[];g=k=0;for(h=l.length;g<h;g++){e.push(l[g][s],l[g][t]);k+=d||l[g][2]||0}if(k){g=[];g[J]=k/l.length<<0;l=B;k=void 0;h=void 0;var M=void 0,N=void 0,F=
0,G=void 0,da=void 0;G=0;for(da=e.length-3;G<da;G+=2){k=e[G];h=e[G+1];M=e[G+2];N=e[G+3];F+=k*N-M*h}if((F/2>0?"CW":"CCW")==="CW")e=e;else{k=[];for(h=e.length-2;h>=0;h-=2)k.push(e[h],e[h+1]);e=k}g[l]=e;if(q||o)g[y]=[q,o];b.push(g)}}}return b}function H(a,d){if(a){ea=E(a,d);Y=0;S(C);v={n:90,w:-180,s:-90,e:180,x:0,y:0,z:C};w=p(ea,true);I()}else{ea=null;R()}}function S(a){C=a;ba=Ia<<C;O=1-(C-Y)*0.3/(ra-Y)}function I(){fa=0;clearInterval(sa);sa=setInterval(function(){fa+=0.1;if(fa>1){clearInterval(sa);
fa=1;for(var a=0,d=w.length;a<d;a++)w[a][ga]=0}R()},33)}function R(){r.clearRect(0,0,T,K);if(v&&w)if(!(C<Y||ta)){var a,d,b,c,g,h,e,n,l=W-v.x,k=X-v.y,q=[U+l,V+k],o,s,t,M,N,F,G=ia.adjustAlpha(O)+"",da=(ua||ia.adjustLightness(1.2)).adjustAlpha(O)+"";if(ja)r.strokeStyle=Ja.adjustAlpha(O)+"";w.sort(function(za,Aa){return u(Aa[oa],q)/Aa[J]-u(za[oa],q)/za[J]});a=0;for(d=w.length;a<d;a++){g=w[a];t=false;h=g[B];o=[];b=0;for(c=h.length-1;b<c;b+=2){o[b]=e=h[b]-l;o[b+1]=n=h[b+1]-k;t||(t=e>0&&e<T&&n>0&&n<K)}if(t){r.fillStyle=
g[y]&&g[y][0]?g[y][0].adjustAlpha(O)+"":G;b=g[ga]?g[J]*fa:g[J];h=na/(na-b);e=[];s=[];b=0;for(c=o.length-3;b<c;b+=2){n=o[b];t=o[b+1];M=o[b+2];N=o[b+3];F={x:((n-U)*h+U<<0)+0.5,y:((t-V)*h+V<<0)+0.5};s={x:((M-U)*h+U<<0)+0.5,y:((N-V)*h+V<<0)+0.5};if((M-n)*(F.y-t)>(F.x-n)*(N-t)){s=[M+0.5,N+0.5,n+0.5,t+0.5,F.x,F.y,s.x,s.y];r.fillStyle=n<M&&t<N||n>M&&t>N?ia.adjustAlpha(O).adjustLightness(0.8)+"":g[y]&&g[y][0]?g[y][0].adjustAlpha(O)+"":G;Ba(s)}e[b]=F.x;e[b+1]=F.y}r.fillStyle=!g[y]?da:g[y][1]?g[y][1].adjustAlpha(O)+
"":ua?da:g[y][0].adjustLightness(1.2).adjustAlpha(O)+"";Ba(e,ja)}}}}function Ba(a,d){if(a.length){r.beginPath();r.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)r.lineTo(a[b],a[b+1]);r.closePath();d&&r.stroke();r.fill()}}var T=0,K=0,ca=0,qa=0,W=0,X=0,C,ba,ha,x,r,pa,ja,ia=new D(200,190,180),ua,Ja=new D(145,140,135),ea,v,w,O=1,fa=1,sa,Y=ma,ra=20,U,V,ta;this.setStyle=function(a){a=(a=a)||{};ja=a.strokeRoofs!==undefined?a.strokeRoofs:ja;if(a.color||a.wallColor)ia=D.parse(a.color||a.wallColor);if(a.roofColor!==
undefined)ua=D.parse(a.roofColor);R();return this};this.geoJSON=function(a,d){A(a,d);return this};this.setCamOffset=function(a,d){U=ca+a;V=K+d};this.setMaxZoom=function(a){ra=a};this.createCanvas=function(a){x=la.createElement("canvas");x.style.webkitTransform="translate3d(0,0,0)";x.style.imageRendering="optimizeSpeed";x.style.position="absolute";x.style.pointerEvents="none";x.style.left=0;x.style.top=0;a.appendChild(x);r=x.getContext("2d");r.lineCap="round";r.lineJoin="round";r.lineWidth=1;try{r.mozImageSmoothingEnabled=
false}catch(d){}return x};this.destroyCanvas=function(){x.parentNode.removeChild(x)};this.loadData=j;this.onMoveEnd=function(){var a=z(W,X),d=z(W+T,X+K);R();if(v&&(a[$]>v.n||a[aa]<v.w||d[$]<v.s||d[aa]>v.e))j()};this.onZoomEnd=function(a){ta=false;S(a.zoom);if(ea){w=p(ea);R()}else{R();j()}};this.onZoomStart=function(){ta=true;R()};this.render=R;this.setOrigin=function(a,d){W=a;X=d};this.setSize=function(a,d){T=a;K=d;ca=T/2<<0;qa=K/2<<0;U=ca;V=K;x.width=T;x.height=K};this.setZoom=S;pa=P};i.OSMBuildings.VERSION=
"0.1.7a";i.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(i){L.Util.setOptions(this,i)},onMove:function(){var i=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-i.x,this.lastY-i.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var i=L.DomUtil.getPosition(this.map._mapPane),u=this.map.getPixelOrigin();this.lastX=i.x;this.lastY=i.y;this.canvas.style.left=-i.x+"px";
this.canvas.style.top=-i.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(u.x-i.x,u.y-i.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var i=L.DomUtil.getPosition(this.map._mapPane),u=this.map.getPixelOrigin();this.osmb.setOrigin(u.x-i.x,u.y-i.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(i){i.addLayer(this);return this},onAdd:function(i){this.map=i;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;i=L.DomUtil.getPosition(this.map._mapPane);var u=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(u.x-i.x,u.y-i.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-i.x+"px";this.canvas.style.top=-i.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(i){i.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);i.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(i,u){return this.osmb.geoJSON(i,u)},
setStyle:function(i){return this.osmb.setStyle(i)}});
