(function(h){var H=H||Array,xa=Math.exp,ya=Math.log,za=Math.tan,Aa=Math.atan,ja=Math.min,Ba=Math.max,ka=h.document,w=function(){function W(e,g,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return e+(g-e)*6*l;if(l<0.5)return g;if(l<2/3)return e+(g-e)*(2/3-l)*6;return e}function B(e,g,l,m){this.r=e;this.g=g;this.b=l;this.a=arguments.length<4?1:m}var X=B.prototype;X.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};X.adjustLightness=function(e){var g=w.toHSLA(this);g.l*=
e;g.l=Math.min(1,Math.max(0,g.l));var l,m;if(g.s===0)e=l=m=g.l;else{m=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var v=2*g.l-m;e=W(v,m,g.h+1/3);l=W(v,m,g.h);m=W(v,m,g.h-1/3)}return new w(~~(e*255),~~(l*255),~~(m*255),g.a)};X.adjustAlpha=function(e){return new w(this.r,this.g,this.b,this.a*e)};B.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new w(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new w(parseInt(e[1],
10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};B.toHSLA=function(e){var g=e.r/255,l=e.g/255,m=e.b/255,v=Math.max(g,l,m),x=Math.min(g,l,m),C,J=(v+x)/2,D;if(v===x)C=x=0;else{D=v-x;x=J>0.5?D/(2-v-x):D/(v+x);switch(v){case g:C=(l-m)/D+(l<m?6:0);break;case l:C=(m-g)/D+2;break;case m:C=(g-l)/D+4;break}C/=6}return{h:C,s:x,l:J,a:e.a}};return B}(),Y=Math.PI,va=Y/2,Ca=Y/4,Da=180/Y,Ea=256,la=14,ma=400,wa=ma-50,Z="latitude",$="longitude",K=0,I=1,z=2,ga=3;h.OSMBuildings=function(W){function B(a,
c){var b={};a/=aa;c/=aa;b[Z]=c<=0?90:c>=1?-90:Da*(2*Aa(xa(Y*(1-2*c)))-va);b[$]=(a===1?1:(a%1+1)%1)*360-180;return b}function X(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function g(){if(!(!na||y<la)){var a=B(P-ba,Q-oa),c=B(P+M+ba,Q+E+oa);ha&&ha.abort();ha=e(X(na,
{w:a[$],n:a[Z],e:c[$],s:c[Z],z:y}),l)}}function l(a){var c,b,d,f=[],i=0,j=0;ca=la;J(y);ha=null;if(!(!a||a.meta.z!==y)){d=a.meta;b=a.data;if(t&&n&&t.z===d.z){i=t.x-d.x;j=t.y-d.y;a=0;for(c=n.length;a<c;a++)f[a]=n[a][I][0]+i+","+(n[a][I][1]+j)}t=d;n=[];a=0;for(c=b.length;a<c;a++){n[a]=b[a];n[a][K]=ja(n[a][K],wa);d=n[a][I][0]+","+n[a][I][1];n[a][ga]=!(f&&~f.indexOf(d))}D()}}function m(a,c){var b=[],d,f,i,j,k,q,p,o,r=pa-y;d=0;for(f=a.length;d<f;d++){k=a[d];q=k[I];p=new H(q.length);i=0;for(j=q.length-1;i<
j;i+=2){o=q[i+1];var F=ja(1,Ba(0,0.5-ya(za(Ca+va*q[i]/180))/Y/2));o={x:~~((o/360+0.5)*aa),y:~~(F*aa)};p[i]=o.x;p[i+1]=o.y}b[d]=[];b[d][K]=ja(k[K]>>r,wa);b[d][I]=p;b[d][z]=k[z];b[d][ga]=c}return b}function v(a,c){if(typeof a==="object")C(a,!c);else{var b=ka.documentElement,d=ka.createElement("script");h.jsonpCallback=function(f){delete h.jsonpCallback;b.removeChild(d);C(f,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function x(a,c,b){if(b===undefined)b=[];var d,
f,i,j=a[0]?a:a.features,k,q,p,o,r,F=c?1:0,R=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)x(j[d],c,b);return b}if(a.type==="Feature"){f=a.geometry;d=a.properties}if(f.type==="Polygon")k=[f.coordinates];if(f.type==="MultiPolygon")k=f.coordinates;if(k){c=d.height;if(d.color||d.wallColor)o=w.parse(d.color||d.wallColor);if(d.roofColor)r=w.parse(d.roofColor);d=0;for(a=k.length;d<a;d++){q=k[d][0];j=[];f=p=0;for(i=q.length;f<i;f++){j.push(q[f][F],q[f][R]);p+=c||q[f][2]||0}if(p){f=[];f[K]=~~(p/q.length);q=I;p=void 0;
i=void 0;var N=void 0,A=void 0,S=0,G=void 0,da=void 0;G=0;for(da=j.length-3;G<da;G+=2){p=j[G];i=j[G+1];N=j[G+2];A=j[G+3];S+=p*A-N*i}if((S/2>0?"CW":"CCW")==="CW")j=j;else{p=[];for(i=j.length-2;i>=0;i-=2)p.push(j[i],j[i+1]);j=p}f[q]=j;if(o||r)f[z]=[o,r];b.push(f)}}}return b}function C(a,c){if(a){ea=x(a,c);ca=0;J(y);t={n:90,w:-180,s:-90,e:180,x:0,y:0,z:y};n=m(ea,true);D()}else{ea=null;T()}}function J(a){y=a;aa=Ea<<y;O=1-(y-ca)*0.3/(pa-ca)}function D(){fa=0;clearInterval(qa);qa=setInterval(function(){fa+=
0.1;if(fa>1){clearInterval(qa);fa=1;for(var a=0,c=n.length;a<c;a++)n[a][ga]=0}T()},33)}function T(){s.clearRect(0,0,M,E);if(t&&n)if(!(y<ca||ra)){var a,c,b,d,f,i,j,k,q=P-t.x,p=Q-t.y,o,r,F,R,N,A,S,G=sa.adjustAlpha(O)+"",da=(ta||sa.adjustLightness(1.2)).adjustAlpha(O)+"";if(ia)s.strokeStyle=Fa.adjustAlpha(O)+"";a=0;for(c=n.length;a<c;a++){f=n[a];r=false;i=f[I];o=[];b=0;for(d=i.length-1;b<d;b+=2){o[b]=j=i[b]-q;o[b+1]=k=i[b+1]-p;r||(r=j>0&&j<M&&k>0&&k<E)}if(r){s.fillStyle=f[z]&&f[z][0]?f[z][0].adjustAlpha(O)+
"":G;b=f[ga]?f[K]*fa:f[K];i=ma/(ma-b);j=[];k=[];b=0;for(d=o.length-3;b<d;b+=2){r=o[b];F=o[b+1];R=o[b+2];N=o[b+3];A={x:~~((r-U)*i+U)+0.5,y:~~((F-V)*i+V)+0.5};S={x:~~((R-U)*i+U)+0.5,y:~~((N-V)*i+V)+0.5};if((R-r)*(A.y-F)>(A.x-r)*(N-F)){if(!k.length){k.unshift(F+0.5);k.unshift(r+0.5);k.push(A.x,A.y)}k.unshift(N+0.5);k.unshift(R+0.5);k.push(S.x,S.y)}else{ua(k);k=[]}j[b]=A.x;j[b+1]=A.y}ua(k);s.fillStyle=!f[z]?da:f[z][1]?f[z][1].adjustAlpha(O)+"":ta?da:f[z][0].adjustLightness(1.2).adjustAlpha(O)+"";ua(j,
ia)}}}}function ua(a,c){if(a.length){s.beginPath();s.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)s.lineTo(a[b],a[b+1]);s.closePath();c&&s.stroke();s.fill()}}na=W;var M=0,E=0,ba=0,oa=0,P=0,Q=0,y,aa,ha,u,s,na,ia,sa=new w(200,190,180),ta,Fa=new w(145,140,135),ea,t,n,O=1,fa=1,qa,ca=la,pa=20,U,V,ra;this.setStyle=function(a){a=(a=a)||{};ia=a.strokeRoofs!==undefined?a.strokeRoofs:ia;if(a.color||a.wallColor)sa=w.parse(a.color||a.wallColor);if(a.roofColor!==undefined)ta=w.parse(a.roofColor);T();return this};
this.geoJSON=function(a,c){v(a,c);return this};this.setCamOffset=function(a,c){U=ba+a;V=E+c};this.setMaxZoom=function(a){pa=a};this.createCanvas=function(a){u=ka.createElement("canvas");u.style.webkitTransform="translate3d(0,0,0)";u.style.imageRendering="optimizeSpeed";u.style.position="absolute";u.style.pointerEvents="none";u.style.left=0;u.style.top=0;a.appendChild(u);s=u.getContext("2d");s.lineCap="round";s.lineJoin="round";s.lineWidth=1;try{s.mozImageSmoothingEnabled=false}catch(c){}return u};
this.destroyCanvas=function(){u.parentNode.removeChild(u)};this.loadData=g;this.onMoveEnd=function(){var a=B(P,Q),c=B(P+M,Q+E);if(t&&(a[Z]>t.n||a[$]<t.w||c[Z]<t.s||c[$]>t.e))g()};this.onZoomEnd=function(a){ra=false;J(a.zoom);if(ea){n=m(ea);T()}else g()};this.onZoomStart=function(){ra=true;T()};this.render=T;this.setOrigin=function(a,c){P=a;Q=c};this.setSize=function(a,c){M=a;E=c;ba=~~(M/2);oa=~~(E/2);U=ba;V=E;u.width=M;u.height=E};this.setZoom=J};h.OSMBuildings.VERSION="0.1.6a";h.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({_lastX:0,_lastY:0,_onMove:function(){var h=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this._lastX-h.x,this._lastY-h.y);this.osmb.render()},_onMoveEnd:function(){if(this._blockMoveEvent)this._blockMoveEvent=false;else{var h=L.DomUtil.getPosition(this.map._mapPane),H=this.map.getPixelOrigin();this._lastX=h.x;this._lastY=h.y;this.canvas.style.left=-h.x+"px";this.canvas.style.top=-h.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,
this.map._size.y);this.osmb.setOrigin(H.x-h.x,H.y-h.y);this.osmb.onMoveEnd();this.osmb.render()}},_onZoomStart:function(){this.osmb.onZoomStart()},_onZoomEnd:function(){var h=L.DomUtil.getPosition(this.map._mapPane),H=this.map.getPixelOrigin();this.osmb.setOrigin(H.x-h.x,H.y-h.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this._blockMoveEvent=true},_blockMoveEvent:null,map:null,osmb:null,canvas:null,initialize:function(h){this.osmb=new OSMBuildings(h)},addTo:function(h){h.addLayer(this);return this},
onAdd:function(h){this.map=h;this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;this.osmb.setSize(this.map._size.x,this.map._size.y);h=this.map.getPixelOrigin();this.osmb.setOrigin(h.x,h.y);this.osmb.setZoom(this.map._zoom);this.map.on({move:this._onMove,moveend:this._onMoveEnd,zoomstart:this._onZoomStart,zoomend:this._onZoomEnd},this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);
this.osmb.loadData();this.osmb.render()},onRemove:function(h){h.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);h.off({move:this._onMove,moveend:this._onMoveEnd,zoomstart:this._onZoomStart,zoomend:this._onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.map=null}});
