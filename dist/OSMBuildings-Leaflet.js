var OSMBuildings=function(){function ua(a,c){var b=a.x-c.x,e=a.y-c.y;return b*b+e*e}function Qa(a){for(var c=Infinity,b=-Infinity,e=Infinity,d=-Infinity,f=0,g=a.length-3;f<g;f+=2)c=R(c,a[f]),b=M(b,a[f]),e=R(e,a[f+1]),d=M(d,a[f+1]);return{x:c+(b-c)/2<<0,y:e+(d-e)/2<<0}}function aa(a,c){var b={};a/=S;c/=S;b[Ra]=0>=c?90:1<=c?-90:va*(2*Sa(Ta(E*(1-2*c)))-N);b[Ua]=360*(1===a?1:(a%1+1)%1)-180;return b}function wa(a,c,b){function e(a){if("XDomainRequest"in T&&a!==d.readyState&&(d.readyState=a,d.onreadystatechange))d.onreadystatechange()}
a=a.replace(/\{ *([\w_]+) *\}/g,function(a,b){return c[b]||a});var d="XDomainRequest"in T?new XDomainRequest:new XMLHttpRequest;d.onerror=function(){d.status=500;d.statusText="Error";e(4)};d.ontimeout=function(){d.status=408;d.statusText="Timeout";e(4)};d.onprogress=function(){e(3)};d.onload=function(){d.status=200;d.statusText="Ok";e(4)};d.onreadystatechange=function(){4===d.readyState&&d.status&&!(200>d.status||299<d.status)&&b&&d.responseText&&b(JSON.parse(d.responseText))};e(0);d.open("GET",a);
e(1);d.send(null);e(2);return d}function ha(a){U=V+a.x;W=v+a.y}function xa(a){A=a.w;v=a.h;V=A/2<<0;ia=v/2<<0;U=V;W=v;r.setSize(A,v);ja=z-50}function ya(a){B=a;S=Va<<B;a=aa(q+V,s+ia);za=Math.abs(40075040*Aa(a.latitude)/ka(2,B+8));w=ka(0.95,B-I);la=F.alpha(w)+"";ba=ca.alpha(w)+"";X=O.alpha(w)+""}var Ba=Ba||Array,Ca=Ca||Array,k=Math,Ta=k.exp,Wa=k.log,Xa=k.sin,Aa=k.cos,Da=k.tan,Sa=k.atan,da=k.atan2,R=k.min,M=k.max,Ea=k.sqrt,Fa=k.ceil,Ga=k.floor,ka=k.pow,T=window,ma=document;T.console||(T.console={});
var G,na=function(a,c,b){0>b&&(b+=1);1<b&&(b-=1);return b<1/6?a+6*(c-a)*b:0.5>b?c:b<2/3?a+6*(c-a)*(2/3-b):a},Ya={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",
darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",
fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",
lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",
navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",
sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},P=function(a,c,b,e){this.H=a;this.S=c;this.L=b;this.A=e},k=P.prototype;k.toString=function(){var a=Math.min(360,Math.max(0,this.H)),c=Math.min(1,Math.max(0,this.S)),
b=Math.min(1,Math.max(0,this.L)),e=Math.min(1,Math.max(0,this.A)),d;if(0===c)a=d=c=b;else{var f=0.5>b?b*(1+c):b+c-b*c,b=2*b-f,a=a/360,c=na(b,f,a+1/3);d=na(b,f,a);a=na(b,f,a-1/3)}c*=255;d*=255;a*=255;return 1===e?"#"+(16777216+(c<<16)+(d<<8)+a).toString(16).slice(1,7):"rgba("+[Math.round(c),Math.round(d),Math.round(a),e.toFixed(2)].join()+")"};k.hue=function(a){return new P(this.H*a,this.S,this.L,this.A)};k.saturation=function(a){return new P(this.H,this.S*a,this.L,this.A)};k.lightness=function(a){return new P(this.H,
this.S,this.L*a,this.A)};k.alpha=function(a){return new P(this.H,this.S,this.L,this.A*a)};G=function(a){var c=0,b=0,e=0,d=1,f;a=(""+a).toLowerCase().replace("grey","gray");a=Ya[a]||a;if(f=a.match(/^#(\w{2})(\w{2})(\w{2})$/))c=parseInt(f[1],16),b=parseInt(f[2],16),e=parseInt(f[3],16);if(f=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))c=parseInt(f[1],10),b=parseInt(f[2],10),e=parseInt(f[3],10),d=f[4]?parseFloat(f[5]):1;c/=255;b/=255;e/=255;a=Math.max(c,b,e);var g=Math.min(c,b,e),j;f=(a+g)/
2;var h=a-g;if(h){g=0.5<f?h/(2-a-g):h/(a+g);switch(a){case c:j=(b-e)/h+(b<e?6:0);break;case b:j=(e-c)/h+2;break;case e:j=(c-b)/h+4}j*=60}else j=g=0;return new P(j,g,f,d)};var Ha,k=Math,oa=k.PI,u=k.sin,D=k.cos,Ia=k.tan,Ja=k.asin,Ka=k.atan2,J=oa/180,ea=23.4397*J;Ha=function(a,c,b){b=J*-b;c*=J;a=a.valueOf()/864E5-0.5+2440588-2451545;var e=J*(357.5291+0.98560028*a),d=J*(1.9148*u(e)+0.02*u(2*e)+3E-4*u(3*e)),d=e+d+102.9372*J+oa,e=Ja(u(0)*D(ea)+D(0)*u(ea)*u(d)),d=Ka(u(d)*D(ea)-Ia(0)*u(ea),D(d));b=J*(280.16+
360.9856235*a)-b-d;return{altitude:Ja(u(c)*u(e)+D(c)*D(e)*D(b)),azimuth:Ka(u(b),D(b)*u(c)-Ia(e)*D(c))-oa/2}};var x={YARD_TO_METER:0.9144,FOOT_TO_METER:0.3048,INCH_TO_METER:0.0254,METERS_PER_LEVEL:3,clockwise:"CW",counterClockwise:"CCW",getWinding:function(a){var c,b,e,d,f=0,g,j;g=0;for(j=a.length-3;g<j;g+=2)c=a[g],b=a[g+1],e=a[g+2],d=a[g+3],f+=c*d-e*b;return 0<f/2?this.clockwise:this.counterClockwise},makeWinding:function(a,c){if(this.getWinding(a)===c)return a;for(var b=[],e=a.length-2;0<=e;e-=2)b.push(a[e],
a[e+1]);return b},toMeters:function(a){a=""+a;var c=parseFloat(a);return c===a||~a.indexOf("m")?c<<0:~a.indexOf("yd")?c*this.YARD_TO_METER<<0:~a.indexOf("ft")?c*this.FOOT_TO_METER<<0:~a.indexOf("'")?(a=a.split("'"),a[0]*this.FOOT_TO_METER+a[1]*this.INCH_TO_METER<<0):c<<0},getRadius:function(a){for(var c=90,b=-90,e=0,d=a.length;e<d;e+=2)c=R(c,a[e]),b=M(b,a[e]);return 6378137*((b-c)/va)/2<<0},materialColors:{brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",
gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},baseMaterials:{asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",
shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},getMaterialColor:function(a){a=a.toLowerCase();return"#"===a[0]?a:this.materialColors[this.baseMaterials[a]||a]||null},alignProperties:function(a,c){c.height?a.height=this.toMeters(c.height):(c["building:height"]&&(a.height=this.toMeters(c["building:height"])),c.levels&&(a.height=c.levels*this.METERS_PER_LEVEL<<0),c["building:levels"]&&(a.height=
c["building:levels"]*this.METERS_PER_LEVEL<<0));c.min_height?a.minHeight=this.toMeters(c.min_height):(c["building:min_height"]&&(a.minHeight=this.toMeters(c["building:min_height"])),c.min_level&&(a.minHeight=c.min_level*this.METERS_PER_LEVEL<<0),c["building:min_level"]&&(a.minHeight=c["building:min_level"]*this.METERS_PER_LEVEL<<0));a.wallColor||(c["building:material"]&&(a.wallColor=this.getMaterialColor(c["building:material"])),c["building:facade:material"]&&(a.wallColor=this.getMaterialColor(c["building:facade:material"])),
c["building:cladding"]&&(a.wallColor=this.getMaterialColor(c["building:cladding"])),c["building:color"]&&(a.wallColor=c["building:color"]),c["building:colour"]&&(a.wallColor=c["building:colour"]));104991250===a.id&&(console.log("DST:",a),console.log("SRC:",c));a.roofColor||(c["roof:material"]&&(a.roofColor=this.getMaterialColor(c["roof:material"])),c["building:roof:material"]&&(a.roofColor=this.getMaterialColor(c["building:roof:material"])),c["roof:color"]&&(a.roofColor=c["roof:color"]),c["roof:colour"]&&
(a.roofColor=c["roof:colour"]),c["building:roof:color"]&&(a.roofColor=c["building:roof:color"]),c["building:roof:colour"]&&(a.roofColor=c["building:roof:colour"]));if(!a.shape)switch(c["building:shape"]){case "cone":case "cylinder":a.shape=c["building:shape"];break;case "dome":case "sphere":a.shape="dome"}if(!a.roofShape&&("cone"===c["roof:shape"]||"dome"===c["roof:shape"])&&c["roof:height"])a.shape="cylinder",a.roofShape=c["roof:shape"],a.roofHeight=this.toMeters(c["roof:height"]);return a}},La,
Ma=function(a){var c,b,e,d,f,g=[],j=[],h=0;e=[];switch(a.type){case "GeometryCollection":c=0;for(b=a.geometries.length;c<b;c++)if(g=Ma(a.geometries[c]))e=e.concat(g);return e;case "Polygon":d=a.coordinates;break;case "MultiPolygon":d=a.coordinates[0];break;default:return e}f=d[0];c=0;for(b=f.length;c<b;c++)g.push(f[c][1],f[c][0]),void 0!==f[c][2]&&(h+=f[c][2]);c=0;for(b=d.length-1;c<b;c++){f=d[c+1];j[c]=[];a=0;for(e=f.length;a<e;a++)j[c].push(f[a][1],f[a][0]);j[c]=x.makeWinding(j[c],x.counterClockwise)}return[{outer:x.makeWinding(g,
x.clockwise),inner:j.length?j:null,height:h/d[0].length}]};La=function(a,c){var b,e,d,f,g=[],j,h,m,l,p,H,k,t;b=0;for(e=a.length;b<e;b++)if(j=a[b],!("Feature"!==j.type||!1===c(j))){h=x.alignProperties(j.properties);p=h.height||Na;H=h.minHeight;k=h.color||h.wallColor;t=h.roofColor;m=Ma(j.geometry);d=0;for(f=m.length;d<f;d++)l=m[d].outer,g.push({footprint:l,holes:m[d].inner,height:p||m[d].height,id:j.id||h.id||[l[0],l[1],p,H].join(),minHeight:H,wallColor:k,roofColor:t})}return g};var Oa,Pa=function(a){return(a=
a.tags)&&!a.landuse&&(a.building||a["building:part"])&&(!a.layer||0<=a.layer)},qa=function(a){if(a){for(var c=[],b,e=0,d=a.length;e<d;e++)b=pa[a[e]],c.push(b[0],b[1]);c[c.length-2]!==c[0]&&c[c.length-1]!==c[1]&&c.push(c[0],c[1]);if(!(8>c.length))return c}},Za=function(a,c){for(var b in c)c.hasOwnProperty(b)&&(a[b]=c[b]);return a},ra=function(a,c){var b={},e=a.tags||{};a.id&&(b.id=a.id);c&&(b.footprint=x.makeWinding(c,x.clockwise));x.alignProperties(b,e);b.height=b.height||Na;if("cone"===b.shape||
"cylinder"===b.shape)b.radius=x.getRadius(b.footprint);b.roofHeight&&(b.height=M(0,b.height-b.roofHeight));return b},pa,Y,fa,ga;Oa=function(a,c){pa={};Y={};fa=[];ga=c;for(var b,e=0,d=a.length;e<d;e++)switch(b=a[e],b.type){case "node":pa[b.id]=[b.lat,b.lon];break;case "way":if(Pa(b)){var f=void 0,f=void 0;if((f=qa(b.nodes))&&!1!==ga(b))f=ra(b,f),fa.push(f)}else if(f=b.tags,!f||!f.highway&&!f.railway&&!f.landuse)Y[b.id]=b;break;case "relation":var g=b,j=void 0,h=void 0;b=[];var m=h=void 0,l=void 0,
f=void 0;if(Pa(g)&&!("multipolygon"!==g.tags.type&&"building"!==g.tags.type||!1===ga(g))){for(var j=g.members,h=m=void 0,l=[],p=0,H=j.length;p<H;p++)m=j[p],"way"===m.type&&Y[m.ref]&&(!m.role||"outer"===m.role?h=Y[m.ref]:("inner"===m.role||"enclave"===m.role)&&l.push(Y[m.ref]));j=h?{outer:h,inner:l}:void 0;if(j&&(m=ra(g),h=j.outer))if((l=qa(h.nodes))&&!1!==ga(h)){h=ra(h,l);g=0;for(l=j.inner.length;g<l;g++)(f=qa(j.inner[g].nodes))&&b.push(x.makeWinding(f,x.counterClockwise));b.length&&(h.holes=b);fa.push(Za(h,
m))}}}return fa};var E=Math.PI,N=E/2,$a=E/4,va=180/E,Va=256,I=15,Ra="latitude",Ua="longitude",A=0,v=0,V=0,ia=0,q=0,s=0,B,S,F=G("rgba(200, 190, 180)"),ca=F.lightness(0.8),O=F.lightness(1.2),la=""+F,ba=""+ca,X=""+O,Q,za=1,w=1,ja,Na=5,U,W,z=450,Z,sa={time:new Date,data:{},add:function(a,c){this.data[c]={data:a,time:Date.now()}},get:function(a){return this.data[a]&&this.data[a].data},purge:function(){this.time.setMinutes(this.time.getMinutes()-5);for(var a in this.data)this.data[a].time<this.time&&delete this.data[a]}},
C={currentItemsIndex:{},items:[],cropDecimals:function(a){return parseFloat(a.toFixed(5))},getPixelFootprint:function(a){for(var c,b,e=new Ba(a.length),d=0,f=a.length-1;d<f;d+=2)c=a[d+1],b=R(1,M(0,0.5-Wa(Da($a+N*a[d]/180))/E/2)),c=(c/360+0.5)*S<<0,b=b*S<<0,e[d]=c,e[d+1]=b;a=e;e=a.length/2;d=new Ca(e);f=0;c=e-1;var g,j,h,m=[],l=[],p=[];for(d[f]=d[c]=1;c;){g=0;for(b=f+1;b<c;b++){j=a[2*b];var H=a[2*b+1],k=a[2*f],t=a[2*f+1],q=a[2*c],s=a[2*c+1],n=q-k,v=s-t,r=void 0;if(0!==n||0!==v)r=((j-k)*n+(H-t)*v)/
(n*n+v*v),1<r?(k=q,t=s):0<r&&(k+=n*r,t+=v*r);n=j-k;v=H-t;j=n*n+v*v;j>g&&(h=b,g=j)}2<g&&(d[h]=1,m.push(f),l.push(h),m.push(h),l.push(c));f=m.pop();c=l.pop()}for(b=0;b<e;b++)d[b]&&p.push(a[2*b],a[2*b+1]);e=p;if(!(8>e.length))return e},createClosure:function(a){var c=this;return function(b){b=c.parse(b);sa.add(b,a);c.addRenderItems(b,!0)}},parse:function(a){return!a?[]:"FeatureCollection"===a.type?La(a.features,this.each):a.osm3s?Oa(a.elements,this.each):[]},resetItems:function(){this.items=[];this.currentItemsIndex=
{}},addRenderItems:function(a,c){for(var b=this.scale(a),e=0,d=b.length;e<d;e++)this.currentItemsIndex[b[e].id]||(b[e].scale=c?0:1,this.items.push(b[e]),this.currentItemsIndex[b[e].id]=1);Q||(Q=setInterval(function(){for(var a=C.items,b=!1,c=0,d=a.length;c<d;c++)1>a[c].scale&&(a[c].scale+=0.1,1<a[c].scale&&(a[c].scale=1),b=!0);r.render();b||(clearInterval(Q),Q=null)},33))},scale:function(a){var c,b,e,d,f=[],g,j,h,m,l,p,k,q,s,n=4/ka(2,B-I);c=0;for(b=a.length;c<b;c++)if(g=a[c],j=g.height/n,h=isNaN(g.minHeight)?
0:g.minHeight/n,!(h>ja)&&(m=this.getPixelFootprint(g.footprint))){q=[];if(g.holes){e=0;for(d=g.holes.length;e<d;e++)(s=this.getPixelFootprint(g.holes[e]))&&q.push(s)}d=e=null;if(g.wallColor&&(l=G(g.wallColor)))e=l.alpha(w),d=""+e.lightness(0.8),e=""+e;p=null;if(g.roofColor&&(l=G(g.roofColor)))p=""+l.alpha(w);k=g.roofHeight/n;j<=h&&0>=k||f.push({id:g.id,footprint:m,height:R(j,ja),minHeight:h,wallColor:e,altColor:d,roofColor:p,roofShape:g.roofShape,roofHeight:k,center:Qa(m),holes:q.length?q:null,shape:g.shape,
radius:g.radius/za})}return f},set:function(a){this.isStatic=!0;this.resetItems();this.addRenderItems(this.staticData=this.parse(a),!0)},load:function(a){this.url=a||"http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";(this.isStatic=!/(.+\{[nesw]\}){4,}/.test(this.url))?(this.resetItems(),wa(this.url,{},function(a){this.addRenderItems(this.staticData=
this.parse(a),!0)})):this.update()},update:function(){this.resetItems();if(!(B<I))if(this.isStatic)this.addRenderItems(this.staticData);else if(this.url){var a,c,b,e,d=aa(q,s);a=aa(q+A,s+v);var f=0.0075*Fa(d.latitude/0.0075),g=0.015*Fa(a.longitude/0.015);a=0.0075*Ga(a.latitude/0.0075);for(d=0.015*Ga(d.longitude/0.015);a<=f;a+=0.0075)for(c=d;c<=g;c+=0.015)a=this.cropDecimals(a),c=this.cropDecimals(c),e=a+","+c,(b=sa.get(e))?this.addRenderItems(b):wa(this.url,{n:this.cropDecimals(a+0.0075),e:this.cropDecimals(c+
0.015),s:a,w:c},this.createClosure(e));sa.purge()}},each:function(){}},y={circle:function(a,c,b,e,d){a.fillStyle=d;a.beginPath();a.arc(c,b,e,0,2*E);a.stroke();a.fill()},draw:function(a,c,b,e,d,f,g,j,h,m){var l=z/(z-f);f=$.project(c,b,l);d*=l;g&&(l=z/(z-g),b=$.project(c,b,l),c=b.x,b=b.y,e*=l);if(l=y.getTangents(c,b,e,f.x,f.y,d))g=da(l[0].y1-b,l[0].x1-c),l=da(l[1].y1-b,l[1].x1-c),a.fillStyle=j,a.beginPath(),a.arc(f.x,f.y,d,N,g,!0),a.arc(c,b,e,g,N),a.closePath(),a.fill(),a.fillStyle=h,a.beginPath(),
a.arc(f.x,f.y,d,l,N,!0),a.arc(c,b,e,N,l),a.closePath(),a.fill();y.circle(a,f.x,f.y,d,m)},shadow:function(a,c,b,e,d,f,g){f=K.project(c,b,f);var j;g&&(b=K.project(c,b,g),c=b.x,b=b.y);var h=y.getTangents(c,b,e,f.x,f.y,d);h?(g=da(h[0].y1-b,h[0].x1-c),j=da(h[1].y1-b,h[1].x1-c),a.moveTo(h[1].x2,h[1].y2),a.arc(f.x,f.y,d,j,g),a.arc(c,b,e,g,j)):(a.moveTo(c+e,b),a.arc(c,b,e,0,2*E))},footprintMask:function(a,c,b,e){a.moveTo(c+e,b);a.arc(c,b,e,0,2*E)},getTangents:function(a,c,b,e,d,f){var g=a-e,j=c-d,h=b-f,m=
g*g+j*j;if(!(m<=h*h)){var m=Ea(m),g=-g/m,j=-j/m,h=h/m,m=[],l,p,k;l=Ea(M(0,1-h*h));for(var q=1;-1<=q;q-=2)p=g*h-q*l*j,k=j*h+q*l*g,m.push({x1:a+b*p<<0,y1:c+b*k<<0,x2:e+f*p<<0,y2:d+f*k<<0});return m}}},$={project:function(a,c,b){return{x:(a-U)*b+U<<0,y:(c-W)*b+W<<0}},drawSolid:function(a,c,b,e,d){for(var f={x:0,y:0},g={x:0,y:0},j,h,m=[],l=0,p=a.length-3;l<p;l+=2)f.x=a[l]-q,f.y=a[l+1]-s,g.x=a[l+2]-q,g.y=a[l+3]-s,j=this.project(f.x,f.y,c),h=this.project(g.x,g.y,c),b&&(f=this.project(f.x,f.y,b),g=this.project(g.x,
g.y,b)),(g.x-f.x)*(j.y-f.y)>(j.x-f.x)*(g.y-f.y)&&(this.context.fillStyle=f.x<g.x&&f.y<g.y||f.x>g.x&&f.y>g.y?d:e,this.drawFace([g.x,g.y,f.x,f.y,j.x,j.y,h.x,h.y])),m[l]=j.x,m[l+1]=j.y;return m},drawFace:function(a,c,b){var e=this.context,d,f,g,j;if(a.length){e.beginPath();e.moveTo(a[0],a[1]);d=2;for(f=a.length;d<f;d+=2)e.lineTo(a[d],a[d+1]);if(b){d=0;for(f=b.length;d<f;d++){a=b[d];e.moveTo(a[0],a[1]);g=2;for(j=a.length;g<j;g+=2)e.lineTo(a[g],a[g+1])}}e.closePath();c&&e.stroke();e.fill()}},render:function(){this.context.clearRect(0,
0,A,v);if(!(B<I||Z)){var a,c,b,e,d,f,g,j={x:U+q,y:W+s},h=q,m=q+A,l=s,p=s+v,k,n,t,r,w,u=C.items;u.sort(function(a,b){return a.minHeight-b.minHeight||ua(b.center,j)-ua(a.center,j)||b.height-a.height});a=0;for(c=u.length;a<c;a++)if(d=u[a],!ta.isSimple(d)){f=!1;k=d.footprint;b=0;for(e=k.length-1;b<e;b+=2)f||(f=k[b]>h&&k[b]<m&&k[b+1]>l&&k[b+1]<p);if(f)switch(b=1>d.scale?d.height*d.scale:d.height,f=z/(z-b),g=e=0,d.minHeight&&(e=1>d.scale?d.minHeight*d.scale:d.minHeight,g=z/(z-e)),t=d.wallColor||la,r=d.altColor||
ba,w=d.roofColor||X,this.context.strokeStyle=r,d.shape){case "cylinder":y.draw(this.context,d.center.x-q,d.center.y-s,d.radius,d.radius,b,e,t,r,w);"cone"===d.roofShape&&y.draw(this.context,d.center.x-q,d.center.y-s,d.radius,0,b+d.roofHeight,b,w,""+G(w).lightness(0.9));"dome"===d.roofShape&&y.draw(this.context,d.center.x-q,d.center.y-s,d.radius,d.radius/2,b+d.roofHeight,b,w,""+G(w).lightness(0.9));break;case "cone":y.draw(this.context,d.center.x-q,d.center.y-s,d.radius,0,b,e,t,r);break;case "dome":y.draw(this.context,
d.center.x-q,d.center.y-s,d.radius,d.radius/2,b,e,t,r);break;default:k=this.drawSolid(k,f,g,t,r);n=[];if(d.holes){b=0;for(e=d.holes.length;b<e;b++)n[b]=this.drawSolid(d.holes[b],f,g,t,r)}this.context.fillStyle=w;this.drawFace(k,!0,n)}}}}},ta={maxZoom:I+2,maxHeight:2,isSimple:function(a){return B<=this.maxZoom&&a.height<this.maxHeight},getFace:function(a){for(var c=[],b=0,e=a.length-3;b<e;b+=2)c[b]=a[b]-q,c[b+1]=a[b+1]-s;return c},drawFace:function(a,c){if(a.length){var b,e,d,f;this.context.beginPath();
this.context.moveTo(a[0],a[1]);b=2;for(e=a.length;b<e;b+=2)this.context.lineTo(a[b],a[b+1]);if(c){b=0;for(e=c.length;b<e;b++){a=c[b];this.context.moveTo(a[0],a[1]);d=2;for(f=a.length;d<f;d+=2)this.context.lineTo(a[d],a[d+1])}}this.context.closePath();this.context.stroke();this.context.fill()}},render:function(){this.context.clearRect(0,0,A,v);if(!(B<I||Z||B>this.maxZoom)){var a,c,b,e,d,f=q,g=q+A,j=s,h=s+v,m,l,k,n=C.items;a=0;for(c=n.length;a<c;a++)if(d=n[a],!(d.height>=this.maxHeight)){k=!1;m=d.footprint;
b=0;for(e=m.length-1;b<e;b+=2)k||(k=m[b]>f&&m[b]<g&&m[b+1]>j&&m[b+1]<h);if(k)if(b=d.altColor||ba,k=d.roofColor||X,this.context.strokeStyle=b,"cylinder"===d.shape||"cone"===d.shape)y.circle(this.context,d.center.x-q,d.center.y-s,d.radius,k);else{m=this.getFace(m);l=[];if(d.holes){b=0;for(e=d.holes.length;b<e;b++)l[b]=this.getFace(d.holes[b])}this.context.fillStyle=k;this.drawFace(m,l)}}}}},K={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(a,
c,b){return{x:a+this.direction.x*b,y:c+this.direction.y*b}},render:function(){var a,c,b;this.context.clearRect(0,0,A,v);if(this.enabled&&!(B<I||Z))if(a=aa(q+V,s+ia),a=Ha(this.date,a.latitude,a.longitude),!(0>=a.altitude)){c=1/Da(a.altitude);b=5>c?0.75:5*(1/c);this.direction.x=Aa(a.azimuth)*c;this.direction.y=Xa(a.azimuth)*c;var e,d,f,g,j,h,k,l,p,n,r,t,u,x;a=[];c=[];var z=C.items;this.context.canvas.style.opacity=b/(2*w);this.context.shadowColor=this.blurColor;this.context.shadowBlur=this.blurSize*
(w/2);this.context.fillStyle=this.color;this.context.beginPath();b=0;for(e=z.length;b<e;b++){h=z[b];p=!1;k=h.footprint;g=[];d=0;for(f=k.length-1;d<f;d+=2)g[d]=j=k[d]-q,g[d+1]=l=k[d+1]-s,p||(p=0<j&&j<A&&0<l&&l<v);if(p)if(j=1>h.scale?h.height*h.scale:h.height,k=0,h.minHeight&&(k=1>h.scale?h.minHeight*h.scale:h.minHeight),"cylinder"===h.shape||"cone"===h.shape)a.push({shape:h.shape,center:{x:h.center.x-q,y:h.center.y-s},radius:h.radius,h:j,mh:k}),"cone"===h.roofShape&&a.push({shape:"cone",center:{x:h.center.x-
q,y:h.center.y-s},radius:h.radius,h:j+h.roofHeight,mh:j});else{l=null;d=0;for(f=g.length-3;d<f;d+=2)p=g[d],n=g[d+1],r=g[d+2],t=g[d+3],u=this.project(p,n,j),x=this.project(r,t,j),k&&(n=this.project(p,n,k),t=this.project(r,t,k),p=n.x,n=n.y,r=t.x,t=t.y),(r-p)*(u.y-n)>(u.x-p)*(t-n)?(1===l&&this.context.lineTo(p,n),l=0,d||this.context.moveTo(p,n),this.context.lineTo(r,t)):(0===l&&this.context.lineTo(u.x,u.y),l=1,d||this.context.moveTo(u.x,u.y),this.context.lineTo(x.x,x.y));k||c.push(g);if(h.holes){d=0;
for(f=h.holes.length;d<f;d++){l=h.holes[d];p=[l[0]-q,l[1]-s];this.context.moveTo(p[0],p[1]);g=2;for(j=l.length;g<j;g+=2)p[g]=l[g]-q,p[g+1]=l[g+1]-s,this.context.lineTo(p[g],p[g+1]);k||c.push(p)}}}}b=0;for(e=a.length;b<e;b++)switch(h=a[b],h.shape){case "cylinder":y.shadow(this.context,h.center.x,h.center.y,h.radius,h.radius,h.h,h.mh);break;case "cone":y.shadow(this.context,h.center.x,h.center.y,h.radius,0,h.h,h.mh);break;case "dome":y.shadow(this.context,h.center.x,h.center.y,h.radius,h.radius/2,h.h,
h.mh)}this.context.closePath();this.context.fill();this.context.shadowBlur=null;this.context.globalCompositeOperation="destination-out";this.context.beginPath();b=0;for(e=c.length;b<e;b++){l=c[b];this.context.moveTo(l[0],l[1]);d=2;for(f=l.length;d<f;d+=2)this.context.lineTo(l[d],l[d+1]);this.context.lineTo(l[0],l[1])}b=0;for(e=a.length;b<e;b++)h=a[b],("cylinder"===h.shape||"cone"===h.shape)&&!h.mh&&y.footprintMask(this.context,h.center.x,h.center.y,h.radius);this.context.fillStyle="#00ff00";this.context.fill();
this.context.globalCompositeOperation="source-over"}}},r={container:ma.createElement("DIV"),items:[],init:function(){this.container.style.pointerEvents="none";this.container.style.position="absolute";this.container.style.left=0;this.container.style.top=0;K.context=this.createContext();ta.context=this.createContext();$.context=this.createContext()},render:function(){K.render();ta.render();$.render()},createContext:function(){var a=ma.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";
a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;c.mozImageSmoothingEnabled=!1;c.webkitImageSmoothingEnabled=!1;this.items.push(a);this.container.appendChild(a);return c},appendTo:function(a){a.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(a,c){for(var b=0,e=this.items.length;b<e;b++)this.items[b].width=
a,this.items[b].height=c},screenshot:function(){var a=ma.createElement("CANVAS"),c=a.getContext("2d"),b,e,d;a.width=A;a.height=v;clearInterval(Q);Q=null;d=C.items;b=0;for(e=d.length;b<e;b++)d[b].scale=1;this.render();b=0;for(e=this.items.length;b<e;b++)d=this.items[b],""!==d.style.opacity&&(c.globalAlpha=parseFloat(d.style.opacity)),c.drawImage(d,0,0),c.globalAlpha=1;return a.toDataURL("image/png")},setPosition:function(a,c){this.container.style.left=a+"px";this.container.style.top=c+"px"}};r.init();
var k=function(a){this.offset={x:0,y:0};a.addLayer(this)},n=k.prototype;n.onAdd=function(a){this.map=a;r.appendTo(a._panes.overlayPane);var c=this.getOffset(),b=a.getPixelOrigin();xa({w:a._size.x,h:a._size.y});var e=b.y-c.y;q=b.x-c.x;s=e;ya(a._zoom);r.setPosition(-c.x,-c.y);a.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset},this);if(a.options.zoomAnimation)a.on("zoomanim",this.onZoom,this);a.attributionControl&&
a.attributionControl.addAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>');C.update()};n.onRemove=function(){var a=this.map;a.attributionControl&&a.attributionControl.removeAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>');a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset},this);a.options.zoomAnimation&&a.off("zoomanim",this.onZoom,this);r.remove()};n.onMove=
function(){var a=this.getOffset();ha({x:this.offset.x-a.x,y:this.offset.y-a.y});$.render()};n.onMoveEnd=function(){if(this.skipMoveEnd)this.skipMoveEnd=!1;else{var a=this.map,c=this.getOffset(),b=a.getPixelOrigin();this.offset=c;r.setPosition(-c.x,-c.y);ha({x:0,y:0});xa({w:a._size.x,h:a._size.y});a=b.y-c.y;q=b.x-c.x;s=a;r.render();C.update()}};n.onZoomStart=function(){Z=!0;r.render()};n.onZoom=function(){};n.onZoomEnd=function(){var a=this.map,c=this.getOffset(),b=a.getPixelOrigin(),e=b.y-c.y;q=b.x-
c.x;s=e;a=a._zoom;Z=!1;ya(a);C.update();r.render();this.skipMoveEnd=!0};n.onResize=function(){};n.onViewReset=function(){var a=this.getOffset();this.offset=a;r.setPosition(-a.x,-a.y);ha({x:0,y:0})};n.getOffset=function(){return L.DomUtil.getPosition(this.map._mapPane)};n.setStyle=function(a){a=a||{};var c;if(c=a.color||a.wallColor)F=G(c),la=""+F.alpha(w),ca=F.lightness(0.8),ba=""+ca.alpha(w),O=F.lightness(1.2),X=""+O.alpha(w);a.roofColor&&(O=G(a.roofColor),X=""+O.alpha(w));void 0!==a.shadows&&(K.enabled=
!!a.shadows);r.render();return this};n.setDate=function(a){K.date=a;K.render();return this};n.loadData=function(a){C.load(a);return this};n.setData=function(a){C.set(a);return this};n.each=function(a,c){C.each=function(b){return a.call(c,b)};return this};n.screenshot=function(a){var c=r.screenshot();a&&(T.location.href=c.replace("image/png","image/octet-stream"));return c};k.VERSION="0.1.9a";k.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';return k}();
