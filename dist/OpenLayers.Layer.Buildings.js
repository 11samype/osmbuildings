var OSMBuildings=function(){function d(c,b){var a=c[0]-b[0],g=c[1]-b[1];return a*a+g*g}function v(c){for(var b=0,a=0,g=0,h=c.length-3;g<h;g+=2)b+=c[g],a+=c[g+1];c=2*(c.length-2);return[b/c<<0,a/c<<0]}function D(c){var b,a,g,h,d=0,j,f;j=0;for(f=c.length-3;j<f;j+=2)b=c[j],a=c[j+1],g=c[j+2],h=c[j+3],d+=b*h-g*a;if("CW"===(0<d/2?"CW":"CCW"))return c;b=[];for(a=c.length-2;0<=a;a-=2)b.push(c[a],c[a+1]);return b}var O=O||Array,ia=ia||Array,f=Math,qa=f.exp,ra=f.log,sa=f.sin,ta=f.cos,fa=f.tan,ua=f.atan,P=f.min,
S=f.max,ca=document,J,T=function(c){var b,a,g;if(0===c.s)b=a=g=c.l;else{g=0.5>c.l?c.l*(1+c.s):c.l+c.s-c.l*c.s;var h=2*c.l-g;c.h/=360;b=K(h,g,c.h+1/3);a=K(h,g,c.h);g=K(h,g,c.h-1/3)}return new l(255*b<<0,255*a<<0,255*g<<0,c.a)},K=function(c,b,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?c+6*(b-c)*a:0.5>a?b:a<2/3?c+6*(b-c)*(2/3-a):c},l=function(c,b,a,g){this.r=c;this.g=b;this.b=a;this.a=4>arguments.length?1:g},f=l.prototype;f.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};f.adjustLightness=function(c){var b=l.toHSLA(this);b.l*=c;b.l=Math.min(1,Math.max(0,b.l));return T(b)};f.adjustAlpha=function(c){return new l(this.r,this.g,this.b,this.a*c)};l.parse=function(c){var b;c+="";if(~c.indexOf("#"))return b=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),new l(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new l(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),
b[4]?parseFloat(b[5]):1);if(b=c.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return T({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};l.toHSLA=function(c){var b=c.r/255,a=c.g/255,g=c.b/255,h=Math.max(b,a,g),d=Math.min(b,a,g),j,f=(h+d)/2,E;if(h===d)j=d=0;else{E=h-d;d=0.5<f?E/(2-h-d):E/(h+d);switch(h){case b:j=(a-g)/E+(a<g?6:0);break;case a:j=(g-b)/E+2;break;case g:j=(b-a)/E+4}j/=6}return{h:360*j,s:d,l:f,a:c.a}};J=l;var ja,f=Math,C=f.sin,m=f.cos,
va=f.tan,ka=f.asin,la=f.atan2,L=f.PI,p=180/L,wa=357.5291/p,xa=0.98560028/p,ya=1.9148/p,za=0.02/p,Aa=3E-4/p,Ba=102.9372/p,ma=23.45/p,Ca=280.16/p,Da=360.9856235/p;ja=function(c,b,a){a=-a/p;b/=p;c=c.valueOf()/864E5-0.5+2440588;var g=wa+xa*(c-2451545),d=ya*C(g)+za*C(2*g)+Aa*C(3*g),d=g+Ba+d+L,g=ka(C(d)*C(ma)),d=la(C(d)*m(ma),m(d));a=Ca+Da*(c-2451545)-a-d;return{altitude:ka(C(b)*C(g)+m(b)*m(g)*m(a)),azimuth:la(C(a),m(a)*C(b)-va(g)*m(b))-L/2}};var na=function(c,b){var a,d;void 0===b&&(b=[]);var h=c[0]?c:
c.features;if(h){a=0;for(d=h.length;a<d;a++)na(h[a],b);return b}if("Feature"!==c.type)return b;a=c.geometry;var h=c.properties,f;"Polygon"===a.type&&(f=[a.coordinates]);"MultiPolygon"===a.type&&(f=a.coordinates);if(!f)return b;var j,x;if(h.color||h.wallColor)a=h.color||h.wallColor,j=J.parse(materialColors[a]||a);h.roofColor&&(a=h.roofColor,x=J.parse(materialColors[a]||a));var E=h.height,v,F,w,y,p;a=0;for(d=f.length;a<d;a++){v=f[a][0];F=[];y=w=0;for(p=v.length;y<p;y++)F.push(v[y][1],v[y][0]),w+=E||
v[y][2]||0;w&&b.push({id:h.id||F[0]+","+F[1],footprint:D(F),height:w/v.length<<0||Ea,minHeight:h.minHeight,wallColor:j,altColor:j&&j.adjustLightness(0.8),roofColor:x})}return b},U=Math.PI,oa=U/2,Fa=U/4,Ga=180/U,Ha=256,V="latitude",W="longitude",Ea=5,f=function(){function c(e,n){var r={};e/=C;n/=C;r[V]=0>=n?90:1<=n?-90:Ga*(2*ua(qa(U*(1-2*n)))-oa);r[W]=360*(1===e?1:(e%1+1)%1)-180;return r}function b(e){y=e;C=Ha<<y;e=y;var n=da,r=ga;e=P(S(e,n),r);H=1-P(S(0+0.3*((e-n)/(r-n)),0),0.3);K=l.adjustAlpha(H)+
"";X=m.adjustAlpha(H)+"";Y=Q.adjustAlpha(H)+"";A.scale(y)}function a(){Z.render();ea.render();g()}function g(){B.clearRect(0,0,j,x);if(!(y<da||$)){var e,n,r,c,a,b,g,M,k,pa=F,G=w,t=ea.getMaxHeight(),v=[aa+pa,ba+G],z,q,s,u,N,l;A.rendering.sort(function(e,n){return d(n.center,v)/n.height-d(e.center,v)/e.height});e=0;for(n=A.rendering.length;e<n;e++)if(a=A.rendering[e],!(a.height<=t)){q=!1;b=a.footprint;z=[];r=0;for(c=b.length-1;r<c;r+=2)z[r]=M=b[r]-pa,z[r+1]=k=b[r+1]-G,q||(q=0<M&&M<j&&0<k&&k<x);if(q){r=
a.isNew?a.height*I:a.height;b=R/(R-r);a.minHeight&&(r=a.isNew?a.minHeight*I:a.minHeight,g=R/(R-r));M=[];r=0;for(c=z.length-3;r<c;r+=2)k=z[r],s=z[r+1],q=z[r+2],u=z[r+3],N=p(k,s,b),l=p(q,u,b),a.minHeight&&(s=p(k,s,g),u=p(q,u,g),k=s.x,s=s.y,q=u.x,u=u.y),(q-k)*(N.y-s)>(N.x-k)*(u-s)&&(B.fillStyle=k<q&&s<u||k>q&&s>u?a.altColor||X:a.wallColor||K,f([q,u,k,s,N.x,N.y,l.x,l.y])),M[r]=N.x,M[r+1]=N.y;B.fillStyle=a.roofColor||Y;B.strokeStyle=a.altColor||X;f(M,!0)}}}}function f(e,n){if(e.length){B.beginPath();B.moveTo(e[0],
e[1]);for(var a=2,c=e.length;a<c;a+=2)B.lineTo(e[a],e[a+1]);B.closePath();n&&B.stroke();B.fill()}}function p(e,n,a){return{x:(e-aa)*a+aa<<0,y:(n-ba)*a+ba<<0}}var j=0,x=0,E=0,D=0,F=0,w=0,y,C,B,l=new J(200,190,180),m=l.adjustLightness(0.8),Q=l.adjustLightness(1.2),K=l+"",X=m+"",Y=Q+"",I=1,L,H=1,da=14,ga=20,ha,aa,ba,R,$,T={container:null,items:[],init:function(e){var n=this.container=ca.createElement("DIV");n.style.pointerEvents="none";n.style.position="absolute";n.style.left=0;n.style.top=0;Z.init(this.create());
ea.init(this.create());B=this.create();e.appendChild(n);return n},create:function(){var e=ca.createElement("CANVAS");e.style.webkitTransform="translate3d(0,0,0)";e.style.imageRendering="optimizeSpeed";e.style.position="absolute";e.style.left=0;e.style.top=0;var n=e.getContext("2d");n.lineCap="round";n.lineJoin="round";n.lineWidth=1;n.mozImageSmoothingEnabled=!1;n.webkitImageSmoothingEnabled=!1;this.items.push(e);this.container.appendChild(e);return n},setSize:function(e,n){for(var a=this.items,c=
0,b=a.length;c<b;c++)a[c].width=e,a[c].height=n}},A={url:"",type:"",raw:[],rendering:[],init:function(){},load:function(e,a){this.url=e;this.type=a;this.update()},update:function(){if(this.url&&!(14>y)){var e=c(F-E,w-D),a=c(F+j+E,w+x+D),b={w:e[W],n:e[V],e:a[W],s:a[V]},e=this.url.replace(/\{ *([\w_]+) *\}/g,function(e,a){return b[a]||e}),d=function(e){this.set(e,this.type)}.bind(this),g=ca.documentElement,f=ca.createElement("script");window.jsonpCallback=function(e){delete window.jsonpCallback;g.removeChild(f);
d(e)};g.insertBefore(f,g.lastChild).src=e.replace(/\{callback\}/,"jsonpCallback")}},set:function(e){if(e){var a,c,b=this.raw,d={};a=0;for(c=b.length;a<c;a++)d[b[a].id]=1;b=this.raw=na(e);this.n=-90;this.w=180;this.s=90;this.e=-180;a=0;for(c=b.length;a<c;a++){b[a].isNew=!d[b[a].id];e=b[a].footprint;for(var f=0,j=e.length-1;f<j;f+=2)this.n=S(e[f],this.n),this.e=S(e[f+1],this.e),this.s=P(e[f],this.s),this.w=P(e[f+1],this.w)}this.scale(y);clearInterval(L);I=0;ea.render();L=setInterval(function(){I+=0.1;
if(1<I){clearInterval(L);I=1;for(var e=0,a=A.rendering.length;e<a;e++)A.rendering[e].isNew=0}Z.render();g()},33)}},scale:function(e){var a,c,b,d,g,f=this.raw,j=[],k,h,G,t,l=ga-e;e=0;for(b=f.length;e<b;e++)if(k=f[e],G=k.minHeight>>l,!(G>ha)){h=k.footprint;t=new O(h.length);d=0;for(g=h.length-1;d<g;d+=2)a=h[d+1],c=P(1,S(0,0.5-ra(fa(Fa+oa*h[d]/180))/U/2)),a=(a/360+0.5)*C<<0,c=c*C<<0,t[d]=a,t[d+1]=c;d=t;g=d.length/2;h=new ia(g);t=0;a=g-1;var z=c=void 0,q=void 0,s=void 0,u=[],p=[],A=[];for(h[t]=h[a]=1;a;){z=
0;for(c=t+1;c<a;c++){var q=d[2*c],D=d[2*c+1],x=d[2*t],y=d[2*t+1],E=d[2*a],F=d[2*a+1],w=E-x,m=F-y,B=void 0;if(0!==w||0!==m)B=((q-x)*w+(D-y)*m)/(w*w+m*m),1<B?(x=E,y=F):0<B&&(x+=w*B,y+=m*B);w=q-x;m=D-y;q=w*w+m*m;q>z&&(s=c,z=q)}2<z&&(h[s]=1,u.push(t),p.push(s),u.push(s),p.push(a));t=u.pop();a=p.pop()}for(c=0;c<g;c++)h[c]&&A.push(d[2*c],d[2*c+1]);t=A;8>t.length||j.push({footprint:t,height:P(k.height>>l,ha),minHeight:G,wallColor:k.wallColor&&k.wallColor.adjustAlpha(H)+"",altColor:k.wallColor&&k.altColor.adjustAlpha(H)+
"",roofColor:k.roofColor&&k.roofColor.adjustAlpha(H)+"",center:v(t),isNew:k.isNew})}this.rendering=j}},Z={enabled:!0,context:null,color:new J(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(e){this.context=e;this.setDate((new Date).setHours(10))},setEnabled:function(e){this.enabled=!!e},render:function(){var e=this.context,a,b,d,g;e.clearRect(0,0,j,x);if(this.enabled&&!(y<da||$))if(a=c(F+E,w+D),a=ja(this.date,a.latitude,a.longitude),!(0>=a.altitude)){b=
1/fa(a.altitude);d=0.4/b;this.directionX=ta(a.azimuth)*b;this.directionY=sa(a.azimuth)*b;this.color.a=d;g=this.color+"";var f,h,l,k,p,G,t=F,v=w,z,q,s,u,m,B,C=[];e.beginPath();a=0;for(b=A.rendering.length;a<b;a++){h=A.rendering[a];q=!1;l=h.footprint;z=[];d=0;for(f=l.length-1;d<f;d+=2)z[d]=p=l[d]-t,z[d+1]=G=l[d+1]-v,q||(q=0<p&&p<j&&0<G&&G<x);if(q){l=h.isNew?h.height*I:h.height;h.minHeight&&(k=h.isNew?h.minHeight*I:h.minHeight);p=null;d=0;for(f=z.length-3;d<f;d+=2)G=z[d],s=z[d+1],q=z[d+2],u=z[d+3],m=
this.project(G,s,l),B=this.project(q,u,l),h.minHeight&&(s=this.project(G,s,k),u=this.project(q,u,k),G=s.x,s=s.y,q=u.x,u=u.y),(q-G)*(m.y-s)>(m.x-G)*(u-s)?(1===p&&e.lineTo(G,s),p=0,d||e.moveTo(G,s),e.lineTo(q,u)):(0===p&&e.lineTo(m.x,m.y),p=1,d||e.moveTo(m.x,m.y),e.lineTo(B.x,B.y));e.closePath();C.push(z)}}e.fillStyle=g;e.fill();e.globalCompositeOperation="destination-out";e.beginPath();a=0;for(b=C.length;a<b;a++){k=C[a];e.moveTo(k[0],k[1]);d=2;for(f=k.length;d<f;d+=2)e.lineTo(k[d],k[d+1]);e.lineTo(k[0],
k[1]);e.closePath()}e.fillStyle="#00ff00";e.fill();e.globalCompositeOperation="source-over"}},project:function(a,c,d){return{x:a+this.directionX*d,y:c+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},ea={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,j,x);if(!(y<da||$)){var c,d,b,g,f,h,l,k=F,p=w,m,t;a.beginPath();c=0;for(d=A.rendering.length;c<d;c++){b=A.rendering[c];t=!1;f=b.footprint;m=[];b=0;for(g=f.length-1;b<g;b+=
2)m[b]=h=f[b]-k,m[b+1]=l=f[b+1]-p,t||(t=0<h&&h<j&&0<l&&l<x);if(t){b=0;for(g=m.length-3;b<g;b+=2)t=m[b],f=m[b+1],b?a.lineTo(t,f):a.moveTo(t,f);a.closePath()}}a.fillStyle=Y;a.strokeStyle=X;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(e){e=e||{};if(e.color||e.wallColor)l=J.parse(e.color||e.wallColor),K=l.adjustAlpha(H)+"",m=l.adjustLightness(0.8),X=m.adjustAlpha(H)+"",Q=l.adjustLightness(1.2),Y=Q.adjustAlpha(H)+"";e.roofColor&&(Q=J.parse(e.roofColor),Y=
Q.adjustAlpha(H)+"");void 0!==e.shadows&&Z.setEnabled(e.shadows);a();return this};this.setCamOffset=function(a,b){aa=E+a;ba=x+b};this.setMaxZoom=function(a){ga=a};this.setDate=function(a){Z.setDate(a);return this};this.appendTo=function(a){return T.init(a)};this.loadData=function(a,b){A.load(a,b);return this};this.setData=function(a,b){A.set(a,b);return this};this.onMoveEnd=function(){var b=c(F,w),d=c(F+j,w+x);a();(b[V]>A.n||b[W]<A.w||d[V]<A.s||d[W]>A.e)&&A.update()};this.onZoomEnd=function(c){$=
!1;b(c.zoom);A.update();a()};this.onZoomStart=function(){$=!0;a()};this.setOrigin=function(a,b){F=a;w=b};this.setSize=function(a,b){j=a;x=b;E=j/2<<0;D=x/2<<0;aa=E;ba=x;R=j/(1.5/(window.devicePixelRatio||1))/fa(45)<<0;T.setSize(j,x);ha=R-50};this.setZoom=b;this.render=g};f.VERSION="0.1.8a";f.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';f.OSM_XAPI_URL=OSM_XAPI_URL;return f}();
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(d){d=d||{};d.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,d)},setOrigin:function(){var d=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),v=this.map.resolution,D=this.maxExtent,O=Math.round((d.lon-D.left)/v),d=Math.round((D.top-d.lat)/
v);this.osmb.setOrigin(O,d)},setMap:function(d){this.map||OpenLayers.Layer.prototype.setMap.call(this,d);this.osmb||(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin()},removeMap:function(d){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,d)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(d,v,D){d=OpenLayers.Layer.prototype.moveTo.call(this,d,v,D);if(!D){D=parseInt(this.map.layerContainerDiv.style.left,10);var O=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-D+"px";this.div.style.top=-O+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(v)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return d},moveByPx:function(d,v){this.dxSum+=d;this.dySum+=v;var D=
OpenLayers.Layer.prototype.moveByPx.call(this,d,v);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return D},geoJSON:function(d){return this.osmb.geoJSON(d)},setStyle:function(d){return this.osmb.setStyle(d)},setDate:function(d){return this.osmb.setDate(d)},load:function(d,v){this.osmb.loadData(d,v)}});
