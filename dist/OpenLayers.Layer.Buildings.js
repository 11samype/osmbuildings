(function(c){function B(b,d){var h=b[0]-d[0],g=b[1]-d[1];return h*h+g*g}function C(b){for(var d=0,h=0,g=0,c=b.length-3;g<c;g+=2)d+=b[g],h+=b[g+1];b=2*(b.length-2);return[d/b<<0,h/b<<0]}function T(b){var d=b.length/2,h=new $(d),g=0,c=d-1,k,f,l,D,B=[],C=[],H=[];for(h[g]=h[c]=1;c;){f=0;for(k=g+1;k<c;k++){l=b[2*k];var I=b[2*k+1],m=b[2*g],w=b[2*g+1],z=b[2*c],E=b[2*c+1],J=z-m,s=E-w,G=void 0;if(0!==J||0!==s)G=((l-m)*J+(I-w)*s)/(J*J+s*s),1<G?(m=z,w=E):0<G&&(m+=J*G,w+=s*G);J=l-m;s=I-w;l=J*J+s*s;l>f&&(D=k,
f=l)}2<f&&(h[D]=1,B.push(g),C.push(D),B.push(D),C.push(c));g=B.pop();c=C.pop()}for(k=0;k<d;k++)h[k]&&H.push(b[2*k],b[2*k+1]);return H}var Ba=Ba||Array,$=$||Array,f=Math,Ka=f.exp,La=f.log,Ma=f.sin,Na=f.cos,va=f.tan,Oa=f.atan,ba=f.min,oa=f.max,pa=document,l,Ca=function(b){var d,h,g;if(0===b.s)d=h=g=b.l;else{g=0.5>b.l?b.l*(1+b.s):b.l+b.s-b.l*b.s;var c=2*b.l-g;b.h/=360;d=V(c,g,b.h+1/3);h=V(c,g,b.h);g=V(c,g,b.h-1/3)}return new l(255*d<<0,255*h<<0,255*g<<0,b.a)},V=function(b,d,h){0>h&&(h+=1);1<h&&(h-=1);
return h<1/6?b+6*(d-b)*h:0.5>h?d:h<2/3?b+6*(d-b)*(2/3-h):b},f=function(b,d,h,c){this.r=b;this.g=d;this.b=h;this.a=4>arguments.length?1:c},W=f.prototype;W.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};W.adjustLightness=function(b){var d=l.toHSLA(this);d.l*=b;d.l=Math.min(1,Math.max(0,d.l));return Ca(d)};W.adjustAlpha=function(b){return new l(this.r,this.g,this.b,this.a*b)};f.parse=function(b){var d;b+="";if(~b.indexOf("#"))return d=b.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new l(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16),d[4]?parseInt(d[4],16)/255:1);if(d=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new l(parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5]):1);if(d=b.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ca({h:parseInt(d[1],10),s:parseFloat(d[2]),l:parseFloat(d[3]),a:d[4]?parseFloat(d[5]):1})};f.toHSLA=function(b){var d=b.r/255,c=b.g/255,g=b.b/255,f=Math.max(d,c,g),k=Math.min(d,c,g),
l,D=(f+k)/2,m;if(f===k)l=k=0;else{m=f-k;k=0.5<D?m/(2-f-k):m/(f+k);switch(f){case d:l=(c-g)/m+(c<g?6:0);break;case c:l=(g-d)/m+2;break;case g:l=(d-c)/m+4}l/=6}return{h:360*l,s:k,l:D,a:b.a}};l=f;var Da,f=Math,F=f.sin,L=f.cos,Pa=f.tan,Ea=f.asin,Fa=f.atan2,X=f.PI,m=180/X,Qa=357.5291/m,Ra=0.98560028/m,Sa=1.9148/m,Ta=0.02/m,Ua=3E-4/m,Va=102.9372/m,Ga=23.45/m,Wa=280.16/m,Xa=360.9856235/m;Da=function(b,d,c){c=-c/m;d/=m;b=b.valueOf()/864E5-0.5+2440588;var g=Qa+Ra*(b-2451545),f=Sa*F(g)+Ta*F(2*g)+Ua*F(3*g),
f=g+Va+f+X,g=Ea(F(f)*F(Ga)),f=Fa(F(f)*L(Ga),L(f));c=Wa+Xa*(b-2451545)-c-f;return{altitude:Ea(F(d)*F(g)+L(d)*L(g)*L(c)),azimuth:Fa(F(c),L(c)*F(d)-Pa(g)*L(d))-X/2}};var ca=Math.PI,Ha=ca/2,Ya=ca/4,Za=180/ca,$a=256,wa=14,da="latitude",ea="longitude",Ia=3,Ja=4,H=0,D=1,I=2,E=3,qa=4,S=5,O=6;c.OSMBuildings=function(b){function d(a,p){var e={};a/=fa;p/=fa;e[da]=0>=p?90:1<=p?-90:Za*(2*Oa(Ka(ca*(1-2*p)))-Ha);e[ea]=360*(1===a?1:(a%1+1)%1)-180;return e}function f(){if(xa&&!(K<wa)){var a=d(s-U,G-J),p=d(s+w+U,G+
z+J);ra&&ra.abort();var e={w:a[ea],n:a[da],e:p[ea],s:p[da],z:K},a=xa.replace(/\{ *([\w_]+) *\}/g,function(a,p){return e[p]}),q=g,n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&n.status&&!(200>n.status||299<n.status)&&n.responseText&&q(JSON.parse(n.responseText))};n.open("GET",a);n.send(null);ra=n}}function g(a){var p,e,q,n,b=[],d=e=0;Y=wa;L(K);ra=null;if(a&&a.meta.z===K){n=a.meta;q=a.data;if(A&&u&&A.z===n.z){e=A.x-n.x;d=A.y-n.y;a=0;for(p=u.length;a<p;a++)b[a]=u[a][I][0]+e+
","+(u[a][I][1]+d)}A=n;u=[];a=0;for(p=q.length;a<p;a++)if(n=[],!(q[a][D]>ga)&&(e=T(q[a][I]),!(8>e.length))){n[I]=e;n[qa]=C(e);n[H]=ba(q[a][H],ga);n[D]=q[a][D];e=n[I][0]+","+n[I][1];n[S]=!(b&&~b.indexOf(e));n[E]=[];n[O]=[];e=q[a][Ia]?l.parse(q[a][Ia]):null;d=q[a][Ja]?l.parse(q[a][Ja]):null;n[E]=[e||null,e?e.adjustLightness(0.8):null,d?d:e?e.adjustLightness(1.2):P];for(e=0;3>e;e++)n[E][e]&&(n[O][e]=n[E][e].adjustAlpha(M)+"");u.push(n)}V()}}function m(a,p){var e,q,n=[],b,d,c,j,f,g,h,l,k=ya-K;b=0;for(d=
a.length;b<d;b++)if(f=a[b],h=f[D]>>k,!(h>ga)){g=f[I];l=new Ba(g.length);c=0;for(j=g.length-1;c<j;c+=2)e=g[c+1],q=ba(1,oa(0,0.5-La(va(Ya+Ha*g[c]/180))/ca/2)),e=(e/360+0.5)*fa<<0,q=q*fa<<0,l[c]=e,l[c+1]=q;l=T(l);if(!(8>l.length)){j=[];j[I]=l;j[qa]=C(l);j[H]=ba(f[H]>>k,ga);j[D]=h;j[S]=p;j[E]=f[E];j[O]=[];for(c=0;3>c;c++)j[E][c]&&(j[O][c]=j[E][c].adjustAlpha(M)+"");n.push(j)}}return n}function k(a,p,e){void 0===e&&(e=[]);var q,n,c,b=a[0]?a:a.features,d,j,f,g,h,m,w=p?1:0,x=p?0:1;if(b){a=0;for(q=b.length;a<
q;a++)k(b[a],p,e);return e}"Feature"===a.type&&(q=a.geometry,j=a.properties);"Polygon"===q.type&&(d=[q.coordinates]);"MultiPolygon"===q.type&&(d=q.coordinates);if(d){g=j.height;if(j.color||j.wallColor)h=l.parse(j.color||j.wallColor);j.roofColor&&(m=l.parse(j.roofColor));a=0;for(q=d.length;a<q;a++){p=d[a][0];f=[];n=b=0;for(c=p.length;n<c;n++)f.push(p[n][w],p[n][x]),b+=g||p[n][2]||0;if(b){c=n=[];var v=I;for(var t=void 0,y=void 0,u=void 0,A=void 0,z=0,s=void 0,B=void 0,s=0,B=f.length-3;s<B;s+=2)t=f[s],
y=f[s+1],u=f[s+2],A=f[s+3],z+=t*A-u*y;if("CW"!==(0<z/2?"CW":"CCW")){t=[];for(y=f.length-2;0<=y;y-=2)t.push(f[y],f[y+1]);f=t}c[v]=f;n[H]=b/p.length<<0;n[D]=j.minHeight;n[E]=[h||null,h?h.adjustLightness(0.8):null,m?m:h?h.adjustLightness(1.2):P];e.push(n)}}}return e}function F(a,p){a?(ha=k(a,p),Y=0,L(K),A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:K},u=m(ha,!0),V()):(ha=null,aa())}function L(a){var p,e,q;K=a;fa=$a<<K;a=K;p=Y;e=ya;a=ba(oa(a,p),e);M=1-ba(oa(0+0.4*((a-p)/(e-p)),0),0.4);za=R.adjustAlpha(M)+"";ia=
sa.adjustAlpha(M)+"";ja=P.adjustAlpha(M)+"";if(u){a=0;for(p=u.length;a<p;a++){q=u[a];q[O]=[];for(e=0;3>e;e++)q[E][e]&&(q[O][e]=q[E][e].adjustAlpha(M)+"")}}}function V(){clearInterval(Aa);Q=0;ta.render();Aa=setInterval(function(){Q+=0.1;if(1<Q){clearInterval(Aa);Q=1;for(var a=0,p=u.length;a<p;a++)u[a][S]=0}ua.render();aa()},33)}function ma(){ua.render();ta.render();aa()}function W(){r.clearRect(0,0,w,z);if(A&&u&&!(K<Y||ka)){var a,p,e,q,b,c,d,f,j,g=s-A.x,h=G-A.y,l=ta.getMaxHeight(),m=[N+g,la+h],k,x,
v,t,y,C;u.sort(function(a,e){return B(e[qa],m)/e[H]-B(a[qa],m)/a[H]});a=0;for(p=u.length;a<p;a++)if(b=u[a],!(b[H]<=l)){x=!1;c=b[I];k=[];e=0;for(q=c.length-1;e<q;e+=2)k[e]=f=c[e]-g,k[e+1]=j=c[e+1]-h,x||(x=0<f&&f<w&&0<j&&j<z);if(x){e=b[S]?b[H]*Q:b[H];c=Z/(Z-e);b[D]&&(e=b[S]?b[D]*Q:b[D],d=Z/(Z-e));f=[];e=0;for(q=k.length-3;e<q;e+=2)j=k[e],v=k[e+1],x=k[e+2],t=k[e+3],y=na(j,v,c),C=na(x,t,c),b[D]&&(v=na(j,v,d),t=na(x,t,d),j=v.x,v=v.y,x=t.x,t=t.y),(x-j)*(y.y-v)>(y.x-j)*(t-v)&&(r.fillStyle=j<x&&v<t||j>x&&
v>t?b[O][1]||ia:b[O][0]||za,X([x,t,j,v,y.x,y.y,C.x,C.y])),f[e]=y.x,f[e+1]=y.y;r.fillStyle=b[O][2]||ja;r.strokeStyle=b[O][1]||ia;X(f,!0)}}}}function aa(){var a=w/(window.devicePixelRatio||1)/30;N-=a;W();var b=r.getImageData(0,0,w,z);N+=2*a;W();var e=r.getImageData(0,0,w,z);N-=a;for(var a=b.data,e=e.data,q,c,d,f,g=0,j=a.length;g<j;g+=4)if(q=g,c=g+1,d=g+2,f=g+3,a[f]||e[f])a[q]=0.7*(a[c]||235)+0.3*(a[d]||230),a[c]=e[c]||P.g,a[d]=e[d]||P.b,a[f]=oa(e[f],e[f]);r.clearRect(0,0,w,z);r.putImageData(b,0,0)}
function X(a,b){if(a.length){r.beginPath();r.moveTo(a[0],a[1]);for(var e=2,c=a.length;e<c;e+=2)r.lineTo(a[e],a[e+1]);r.closePath();b&&r.stroke();r.fill()}}function na(a,b,e){return{x:(a-N)*e+N<<0,y:(b-la)*e+la<<0}}var w=0,z=0,U=0,J=0,s=0,G=0,K,fa,ra,r,xa,R=new l(200,190,180),sa=R.adjustLightness(0.8),P=R.adjustLightness(1.2),za=R+"",ia=sa+"",ja=P+"",ha,A,u,Q=1,Aa,M=1,Y=wa,ya=20,ga,N,la,Z,ka,$={container:null,items:[],init:function(a){var b=this.container=pa.createElement("DIV");b.style.pointerEvents=
"none";b.style.position="absolute";b.style.left=0;b.style.top=0;ua.init(this.create());ta.init(this.create());r=this.create();a.appendChild(b);return b},create:function(){var a=pa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";b.lineJoin="round";b.lineWidth=1;try{b.mozImageSmoothingEnabled=!1}catch(e){}this.items.push(a);this.container.appendChild(a);
return b},setSize:function(a,b){for(var e=this.items,c=0,d=e.length;c<d;c++)e[c].width=a,e[c].height=b}},ua={context:null,color:new l(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,b,e,c,f;a.clearRect(0,0,w,z);if(A&&u&&!(K<Y||ka))if(b=d(s+U,G+J),b=Da(this.date,b.latitude,b.longitude),!(0>=b.altitude)){e=1/va(b.altitude);c=0.4/e;this.directionX=Na(b.azimuth)*
e;this.directionY=Ma(b.azimuth)*e;this.color.a=c;f=this.color+"";var g,h,l,j,k,m,B=s-A.x,C=G-A.y,r,x,v,t,y,E,F=[];a.beginPath();b=0;for(e=u.length;b<e;b++){h=u[b];x=!1;l=h[I];r=[];c=0;for(g=l.length-1;c<g;c+=2)r[c]=k=l[c]-B,r[c+1]=m=l[c+1]-C,x||(x=0<k&&k<w&&0<m&&m<z);if(x){l=h[S]?h[H]*Q:h[H];h[D]&&(j=h[S]?h[D]*Q:h[D]);k=null;c=0;for(g=r.length-3;c<g;c+=2)m=r[c],v=r[c+1],x=r[c+2],t=r[c+3],y=this.project(m,v,l),E=this.project(x,t,l),h[D]&&(v=this.project(m,v,j),t=this.project(x,t,j),m=v.x,v=v.y,x=t.x,
t=t.y),(x-m)*(y.y-v)>(y.x-m)*(t-v)?(1===k&&a.lineTo(m,v),k=0,c||a.moveTo(m,v),a.lineTo(x,t)):(0===k&&a.lineTo(y.x,y.y),k=1,c||a.moveTo(y.x,y.y),a.lineTo(E.x,E.y));a.closePath();F.push(r)}}a.fillStyle=f;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();b=0;for(e=F.length;b<e;b++){j=F[b];a.moveTo(j[0],j[1]);c=2;for(g=j.length;c<g;c+=2)a.lineTo(j[c],j[c+1]);a.lineTo(j[0],j[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,
b,c){return{x:a+this.directionX*c,y:b+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},ta={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,w,z);if(A&&u&&!(K<Y||ka)){var b,c,d,f,g,h,l,j=s-A.x,m=G-A.y,k,r;a.beginPath();b=0;for(c=u.length;b<c;b++){d=u[b];r=!1;g=d[I];k=[];d=0;for(f=g.length-1;d<f;d+=2)k[d]=h=g[d]-j,k[d+1]=l=g[d+1]-m,r||(r=0<h&&h<w&&0<l&&l<z);if(r){d=0;for(f=k.length-3;d<f;d+=2)r=k[d],g=k[d+1],d?a.lineTo(r,
g):a.moveTo(r,g);a.closePath()}}a.fillStyle=ja;a.strokeStyle=ia;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)R=l.parse(a.color||a.wallColor),za=R.adjustAlpha(M)+"",sa=R.adjustLightness(0.8),ia=sa.adjustAlpha(M)+"",P=R.adjustLightness(1.2),ja=P.adjustAlpha(M)+"";a.roofColor&&(P=l.parse(a.roofColor),ja=P.adjustAlpha(M)+"");ma();return this};this.geoJSON=function(a,b){if("object"===typeof a)F(a,!b);else{var e=pa.documentElement,
d=pa.createElement("script");c.jsonpCallback=function(a){delete c.jsonpCallback;e.removeChild(d);F(a,!b)};e.insertBefore(d,e.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){N=U+a;la=z+b};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return $.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=d(s,G),b=d(s+w,G+z);ma();A&&(a[da]>A.n||a[ea]<A.w||b[da]<A.s||b[ea]>A.e)&&f()};this.onZoomEnd=
function(a){ka=!1;L(a.zoom);ha?(u=m(ha),ma()):(aa(),f())};this.onZoomStart=function(){ka=!0;ma()};this.setOrigin=function(a,b){s=a;G=b};this.setSize=function(a,b){w=a;z=b;U=w/2<<0;J=z/2<<0;N=U;la=z;Z=w/(1.5/(window.devicePixelRatio||1))/va(45)<<0;$.setSize(w,z);ga=Z-50};this.setZoom=L;this.render=aa;xa=b};c.OSMBuildings.VERSION="0.1.8a";c.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(c){c=c||{};c.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,c)},setOrigin:function(){var c=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),B=this.map.resolution,C=this.maxExtent,T=Math.round((c.lon-C.left)/B),c=Math.round((C.top-c.lat)/
B);this.osmb.setOrigin(T,c)},setMap:function(c){this.map||OpenLayers.Layer.prototype.setMap.call(this,c);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(c){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,c)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(c,B,C){c=OpenLayers.Layer.prototype.moveTo.call(this,c,B,C);if(!C){C=parseInt(this.map.layerContainerDiv.style.left,10);var T=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-C+"px";this.div.style.top=-T+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(B)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return c},moveByPx:function(c,
B){this.dxSum+=c;this.dySum+=B;var C=OpenLayers.Layer.prototype.moveByPx.call(this,c,B);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return C},geoJSON:function(c,B){return this.osmb.geoJSON(c,B)},setStyle:function(c){return this.osmb.setStyle(c)},setDate:function(c){return this.osmb.setDate(c)}});
