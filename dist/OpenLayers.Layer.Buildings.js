var OSMBuildings=function(){function g(d,c){var h=d[0]-c[0],e=d[1]-c[1];return h*h+e*e}function J(d){for(var c=0,h=0,e=0,g=d.length-3;e<g;e+=2)c+=d[e],h+=d[e+1];d=(d.length-2)/2;return[c/d<<0,h/d<<0]}var m=m||Array,S=S||Array,f=Math,Da=f.exp,Ea=f.log,Fa=f.sin,Ga=f.cos,oa=f.tan,Ha=f.atan,fa=f.min,pa=f.max,xa=document,Q,U=function(d){var c,h,e;if(0===d.s)c=h=e=d.l;else{e=0.5>d.l?d.l*(1+d.s):d.l+d.s-d.l*d.s;var g=2*d.l-e;d.h/=360;c=D(g,e,d.h+1/3);h=D(g,e,d.h);e=D(g,e,d.h-1/3)}return new t(255*c<<0,255*
h<<0,255*e<<0,d.a)},D=function(d,c,h){0>h&&(h+=1);1<h&&(h-=1);return h<1/6?d+6*(c-d)*h:0.5>h?c:h<2/3?d+6*(c-d)*(2/3-h):d},t=function(d,c,h,e){this.r=d;this.g=c;this.b=h;this.a=4>arguments.length?1:e},f=t.prototype;f.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};f.setLightness=function(d){var c=t.toHSLA(this);c.l*=d;c.l=Math.min(1,Math.max(0,c.l));return U(c)};f.setAlpha=function(d){return new t(this.r,this.g,this.b,this.a*d)};t.parse=function(d){var c;
d+="";if(~d.indexOf("#")&&(c=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new t(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1);if(c=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new t(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5]):1);if(c=d.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return U({h:parseInt(c[1],10),s:parseFloat(c[2]),l:parseFloat(c[3]),a:c[4]?parseFloat(c[5]):1})};t.toHSLA=
function(d){var c=d.r/255,h=d.g/255,e=d.b/255,g=Math.max(c,h,e),f=Math.min(c,h,e),m,j=(g+f)/2,w;if(g===f)m=f=0;else{w=g-f;f=0.5<j?w/(2-g-f):w/(g+f);switch(g){case c:m=(h-e)/w+(h<e?6:0);break;case h:m=(e-c)/w+2;break;case e:m=(c-h)/w+4}m/=6}return{h:360*m,s:f,l:j,a:d.a}};Q=t;var ya,f=Math,r=f.sin,y=f.cos,Ia=f.tan,V=f.asin,W=f.atan2,K=f.PI,j=180/K,Ja=357.5291/j,Ka=0.98560028/j,La=1.9148/j,Ma=0.02/j,Na=3E-4/j,Oa=102.9372/j,X=23.45/j,Pa=280.16/j,Qa=360.9856235/j;ya=function(d,c,g){g=-g/j;c/=j;d=d.valueOf()/
864E5-0.5+2440588;var e=Ja+Ka*(d-2451545),f=La*r(e)+Ma*r(2*e)+Na*r(3*e),f=e+Oa+f+K,e=V(r(f)*r(X)),f=W(r(f)*y(X),y(f));g=Pa+Qa*(d-2451545)-g-f;return{altitude:V(r(c)*r(e)+y(c)*y(e)*y(g)),azimuth:W(r(g),y(g)*r(c)-Ia(e)*y(c))-K/2}};var Y=Math.PI,za=Y/2,Ra=Y/4,Sa=180/Y,Ta=256,Ua="latitude",Va="longitude",f=function(){function d(a,l){var b={};a/=Z;l/=Z;b[Ua]=0>=l?90:1<=l?-90:Sa*(2*Ha(Da(Y*(1-2*l)))-za);b[Va]=360*(1===a?1:(a%1+1)%1)-180;return b}function c(a,l){return a.replace(/\{ *([\w_]+) *\}/g,function(a,
d){return l[d]||a})}function f(a,l){var b=new XMLHttpRequest;b.onreadystatechange=function(){4===b.readyState&&b.status&&!(200>b.status||299<b.status)&&l&&b.responseText&&l(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function e(a){B=a;Z=Ta<<B;a=B;var l=ga,b=qa;a=fa(pa(a,l),b);L=1-fa(pa(0+0.3*((a-l)/(b-l)),0),0.3);K=E.setAlpha(L)+"";$=ha.setAlpha(L)+"";aa=M.setAlpha(L)+"";p.renderItems=p.scale(p.rawItems,B)}function j(){ba.render();ia.render();r()}function r(){z.clearRect(0,
0,w,A);if(!(B<ga||ca)){var a,l,b,d,s,c,x,R,F,f=ia.MAX_HEIGHT,e=[da+G,ea+I],h,n,k,u,q,m;p.renderItems.sort(function(a,b){return g(b.center,e)/b.height-g(a.center,e)/a.height});a=0;for(l=p.renderItems.length;a<l;a++)if(s=p.renderItems[a],!(s.height<=f)){n=!1;c=s.footprint;h=[];b=0;for(d=c.length-1;b<d;b+=2)h[b]=R=c[b]-G,h[b+1]=F=c[b+1]-I,n||(n=0<R&&R<w&&0<F&&F<A);if(n){b=1>s.scale?s.height*s.scale:s.height;c=N/(N-b);s.minHeight&&(b=1>s.scale?s.minHeight*s.scale:s.minHeight,x=N/(N-b));R=[];b=0;for(d=
h.length-3;b<d;b+=2)F=h[b],k=h[b+1],n=h[b+2],u=h[b+3],q=y(F,k,c),m=y(n,u,c),s.minHeight&&(k=y(F,k,x),u=y(n,u,x),F=k.x,k=k.y,n=u.x,u=u.y),(n-F)*(q.y-k)>(q.x-F)*(u-k)&&(z.fillStyle=F<n&&k<u||F>n&&k>u?s.altColor||$:s.wallColor||K,t([n,u,F,k,q.x,q.y,m.x,m.y])),R[b]=q.x,R[b+1]=q.y;z.fillStyle=s.roofColor||aa;z.strokeStyle=s.altColor||$;t(R,!0)}}}}function t(a,l){if(a.length){z.beginPath();z.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)z.lineTo(a[b],a[b+1]);z.closePath();l&&z.stroke();z.fill()}}function y(a,
l,b){return{x:(a-da)*b+da<<0,y:(l-ea)*b+ea<<0}}var w=0,A=0,ja=0,D=0,G=0,I=0,B,Z,z,E=new Q(200,190,180),ha=E.setLightness(0.8),M=E.setLightness(1.2),K=E+"",$=ha+"",aa=M+"",ka,L=1,ga=15,qa=20,ra,da,ea,N,ca,sa,ta=function(){var a=xa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var l=a.getContext("2d");l.lineCap="round";l.lineJoin="round";l.lineWidth=1;l.mozImageSmoothingEnabled=!1;
l.webkitImageSmoothingEnabled=!1;la.push(a);C.appendChild(a);return l},C=xa.createElement("DIV");C.style.pointerEvents="none";C.style.position="absolute";C.style.left=0;C.style.top=0;var la=[];ba.setContext(ta());ia.setContext(ta());z=ta();sa={appendTo:function(a){a.appendChild(C);return C},setSize:function(a,l){for(var b=0,d=la.length;b<d;b++)la[b].width=a,la[b].height=l}};var ua=new Date,H={},U={add:function(a,l){H[a]={data:l,time:Date.now()}},get:function(a){return H[a]&&H[a].data},purge:function(){ua.setMinutes(ua.getMinutes()-
5);for(var a in H)H[a].time<ua&&delete H[a]}},p,V=function(){T.rawItems=[];T.renderItems=[];U.purge()},W=function(a,l){for(var b=T.scale(a,B,l),d=0,c=b.length;d<c;d++)T.renderItems.push(b[d]);ka||(ka=setInterval(function(){for(var a,b=!1,d=0,l=p.renderItems.length;d<l;d++)a=p.renderItems[d],1>a.scale&&(a.scale+=0.1,1<a.scale&&(a.scale=1),b=!0);j();b||(clearInterval(ka),ka=null)},33))},va,T={rawItems:[],renderItems:[],load:function(a){va=a;T.update()},update:function(){if(va&&!(15>B)){var a=d(G,I),
l=d(G+w,I+A),b=0.0075*(a.latitude/0.0075<<0)+0.0075,g=0.015*(l.longitude/0.015<<0)+0.015,l=0.0075*(l.latitude/0.0075<<0),a=0.015*(a.longitude/0.015<<0);V();for(var s,e,x;l<=b;l+=0.0075)for(e=a;e<=g;e+=0.015)x=l+","+e,(s=U.get(x))?W(s):f(c(va,{n:(1E4*(l+0.0075)<<0)/1E4,e:(1E4*(e+0.015)<<0)/1E4,s:(1E4*l<<0)/1E4,w:(1E4*e<<0)/1E4}))}},set:function(a){V();if(a){a=a.features;var d,b,c,s,g=[],x,e,f,h,q,m,n,k;d=0;for(b=a.length;d<b;d++)if(x=a[d],"Feature"===x.type&&(e=x.geometry,x=x.properties,"LineString"===
e.type&&(m=f.length-1,f[0][0]===f[m][0]&&f[0][1]===f[m][1]&&(f=e.coordinates)),"Polygon"===e.type&&(f=e.coordinates),"MultiPolygon"===e.type&&(f=e.coordinates[0]),f)){if(x.color||x.wallColor)h=x.color||x.wallColor;x.roofColor&&(q=x.roofColor);e=f[0];k=[];n=x.height;c=m=0;for(s=e.length;c<s;c++)k.push(e[c][1],e[c][0]),m+=n||e[c][2]||0;c=x.id||k[0]+","+k[1];for(var u=n=s=void 0,j=void 0,w=0,p=void 0,r=void 0,p=0,r=k.length-3;p<r;p+=2)s=k[p],n=k[p+1],u=k[p+2],j=k[p+3],w+=s*j-u*n;if("CW"!==(0<w/2?"CW":
"CCW")){s=[];for(n=k.length-2;0<=n;n-=2)s.push(k[n],k[n+1]);k=s}c={id:c,footprint:k};m&&(c.height=m/e.length<<0);x.minHeight&&(c.minHeight=x.minHeight);h&&(c.wallColor=h);q&&(c.roofColor=q);g.push(c)}W(g,!0)}},scale:function(a,d,b){var c,e,g,f,h,q=[],p,j,w,n,k,u,r,t,y,A=qa-d;d=0;for(g=a.length;d<g;d++)if(y=t=r=null,p=a[d],w=3*(p.height||15)>>A)if(n=3*p.minHeight>>A,!(n>ra)){j=p.footprint;k=new m(j.length);f=0;for(h=j.length-1;f<h;f+=2)c=j[f+1],e=fa(1,pa(0,0.5-Ea(oa(Ra+za*j[f]/180))/Y/2)),c=(c/360+
0.5)*Z<<0,e=e*Z<<0,k[f]=c,k[f+1]=e;f=k;h=f.length/2;j=new S(h);k=0;c=h-1;var z=e=void 0,v=void 0,B=void 0,E=[],G=[],I=[];for(j[k]=j[c]=1;c;){z=0;for(e=k+1;e<c;e++){var v=f[2*e],K=f[2*e+1],C=f[2*k],D=f[2*k+1],M=f[2*c],N=f[2*c+1],O=M-C,P=N-D,H=void 0;if(0!==O||0!==P)H=((v-C)*O+(K-D)*P)/(O*O+P*P),1<H?(C=M,D=N):0<H&&(C+=O*H,D+=P*H);O=v-C;P=K-D;v=O*O+P*P;v>z&&(B=e,z=v)}2<z&&(j[B]=1,E.push(k),G.push(B),E.push(B),G.push(c));k=E.pop();c=G.pop()}for(e=0;e<h;e++)j[e]&&I.push(f[2*e],f[2*e+1]);k=I;if(!(8>k.length)){if(p.wallColor&&
(u=Q.parse(p.wallColor)))r=u.setAlpha(L),t=""+r.setLightness(0.8),r=""+r;if(p.roofColor&&(u=Q.parse(p.roofColor)))y=""+u.setAlpha(L);q.push({id:p.id,footprint:k,height:fa(w,ra),minHeight:n,wallColor:r,altColor:t,roofColor:y,center:J(k),scale:b?0:1})}}return q}};p=T;var ba,na=function(a,c,b){return{x:a+ma.x*b,y:c+ma.y*b}},q,X=!0,Aa=new Q(0,0,0),Ba=null,ma={x:0,y:0},wa={setContext:function(a){q=a;wa.setDate((new Date).setHours(10))},enable:function(a){X=!!a},render:function(){var a,c,b,e;q.clearRect(0,
0,w,A);if(X&&!(B<ga||ca))if(a=d(G+ja,I+D),a=ya(Ba,a.latitude,a.longitude),!(0>=a.altitude)){c=1/oa(a.altitude);b=0.4/c;ma.x=Ga(a.azimuth)*c;ma.y=Fa(a.azimuth)*c;Aa.a=b;e=Aa+"";var f,g,h,j,m,r,v,t,n,k,u,y,z=[];q.beginPath();a=0;for(c=p.renderItems.length;a<c;a++){g=p.renderItems[a];t=!1;h=g.footprint;v=[];b=0;for(f=h.length-1;b<f;b+=2)v[b]=m=h[b]-G,v[b+1]=r=h[b+1]-I,t||(t=0<m&&m<w&&0<r&&r<A);if(t){h=1>g.scale?g.height*g.scale:g.height;g.minHeight&&(j=1>g.scale?g.minHeight*g.scale:g.minHeight);m=null;
b=0;for(f=v.length-3;b<f;b+=2)r=v[b],n=v[b+1],t=v[b+2],k=v[b+3],u=na(r,n,h),y=na(t,k,h),g.minHeight&&(n=na(r,n,j),k=na(t,k,j),r=n.x,n=n.y,t=k.x,k=k.y),(t-r)*(u.y-n)>(u.x-r)*(k-n)?(1===m&&q.lineTo(r,n),m=0,b||q.moveTo(r,n),q.lineTo(t,k)):(0===m&&q.lineTo(u.x,u.y),m=1,b||q.moveTo(u.x,u.y),q.lineTo(y.x,y.y));q.closePath();z.push(v)}}q.fillStyle=e;q.fill();q.globalCompositeOperation="destination-out";q.beginPath();a=0;for(c=z.length;a<c;a++){j=z[a];q.moveTo(j[0],j[1]);b=2;for(f=j.length;b<f;b+=2)q.lineTo(j[b],
j[b+1]);q.lineTo(j[0],j[1]);q.closePath()}q.fillStyle="#00ff00";q.fill();q.globalCompositeOperation="source-over"}},setDate:function(a){Ba=a;wa.render()}};ba=wa;var ia,v,Ca={MAX_HEIGHT:8,setContext:function(a){v=a},render:function(){v.clearRect(0,0,w,A);if(!(B<ga||ca)){var a,c,b,d,e,f,g,h,j;v.beginPath();a=0;for(c=p.renderItems.length;a<c;a++)if(b=p.renderItems[a],!(b.height>Ca.MAX_HEIGHT)){j=!1;e=b.footprint;h=[];b=0;for(d=e.length-1;b<d;b+=2)h[b]=f=e[b]-G,h[b+1]=g=e[b+1]-I,j||(j=0<f&&f<w&&0<g&&
g<A);if(j){b=0;for(d=h.length-3;b<d;b+=2)j=h[b],e=h[b+1],b?v.lineTo(j,e):v.moveTo(j,e);v.closePath()}}v.fillStyle=aa;v.strokeStyle=$;v.stroke();v.fill()}}};ia=Ca;this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)E=Q.parse(a.color||a.wallColor),K=E.setAlpha(L)+"",ha=E.setLightness(0.8),$=ha.setAlpha(L)+"",M=E.setLightness(1.2),aa=M.setAlpha(L)+"";a.roofColor&&(M=Q.parse(a.roofColor),aa=M.setAlpha(L)+"");void 0!==a.shadows&&ba.enable(a.shadows);j();return this};this.setCamOffset=function(a,
c){da=ja+a;ea=A+c};this.setMaxZoom=function(a){qa=a};this.setDate=function(a){ba.setDate(a);return this};this.appendTo=function(a){return sa.appendTo(a)};this.loadData=function(a){p.load(a);return this};this.setData=function(a){p.set(a);return this};this.onMoveEnd=function(){j();p.update()};this.onZoomEnd=function(a){ca=!1;e(a.zoom);p.update();j()};this.onZoomStart=function(){ca=!0;j()};this.setOrigin=function(a,c){G=a;I=c};this.setSize=function(a,c){w=a;A=c;ja=w/2<<0;D=A/2<<0;da=ja;ea=A;N=w/(1.5/
(window.devicePixelRatio||1))/oa(45)<<0;sa.setSize(w,A);ra=N-50};this.setZoom=e;this.render=r};f.VERSION="0.1.8a";f.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';f.OSM_XAPI_URL="http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";return f}();
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(g){g=g||{};g.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,g)},setOrigin:function(){var g=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),J=this.map.resolution,m=this.maxExtent,S=Math.round((g.lon-m.left)/J),g=Math.round((m.top-g.lat)/
J);this.osmb.setOrigin(S,g)},setMap:function(g){this.map||OpenLayers.Layer.prototype.setMap.call(this,g);this.osmb||(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin()},removeMap:function(g){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,g)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(g,J,m){g=OpenLayers.Layer.prototype.moveTo.call(this,g,J,m);if(!m){m=parseInt(this.map.layerContainerDiv.style.left,10);var S=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-m+"px";this.div.style.top=-S+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(J)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return g},moveByPx:function(g,J){this.dxSum+=g;this.dySum+=J;var m=
OpenLayers.Layer.prototype.moveByPx.call(this,g,J);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return m},setStyle:function(g){return this.osmb.setStyle(g)},setDate:function(g){return this.osmb.setDate(g)},load:function(g){this.osmb.loadData(g)},geoJSON:function(g){this.osmb.setData(g)}});
