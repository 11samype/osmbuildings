(function(d){function w(b,c){var a=b[0]-c[0],g=b[1]-c[1];return a*a+g*g}function n(b){for(var c=0,a=0,g=0,h=b.length-3;g<h;g+=2)c+=b[g],a+=b[g+1];b=2*(b.length-2);return[c/b<<0,a/b<<0]}function z(b){var c,a,g,h,d=0,j,t;j=0;for(t=b.length-3;j<t;j+=2)c=b[j],a=b[j+1],g=b[j+2],h=b[j+3],d+=c*h-g*a;if("CW"===(0<d/2?"CW":"CCW"))return b;c=[];for(a=b.length-2;0<=a;a-=2)c.push(b[a],b[a+1]);return c}var ha=ha||Array,ia=ia||Array,f=Math,qa=f.exp,ra=f.log,sa=f.sin,ta=f.cos,ea=f.tan,ua=f.atan,O=f.min,R=f.max,
ba=document,K,S=function(b){var c,a,g;if(0===b.s)c=a=g=b.l;else{g=0.5>b.l?b.l*(1+b.s):b.l+b.s-b.l*b.s;var h=2*b.l-g;b.h/=360;c=L(h,g,b.h+1/3);a=L(h,g,b.h);g=L(h,g,b.h-1/3)}return new A(255*c<<0,255*a<<0,255*g<<0,b.a)},L=function(b,c,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?b+6*(c-b)*a:0.5>a?c:a<2/3?b+6*(c-b)*(2/3-a):b},A=function(b,c,a,g){this.r=b;this.g=c;this.b=a;this.a=4>arguments.length?1:g},f=A.prototype;f.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};f.adjustLightness=function(b){var c=A.toHSLA(this);c.l*=b;c.l=Math.min(1,Math.max(0,c.l));return S(c)};f.adjustAlpha=function(b){return new A(this.r,this.g,this.b,this.a*b)};A.parse=function(b){var c;b+="";if(~b.indexOf("#"))return c=b.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),new A(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1);if(c=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new A(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),
c[4]?parseFloat(c[5]):1);if(c=b.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return S({h:parseInt(c[1],10),s:parseFloat(c[2]),l:parseFloat(c[3]),a:c[4]?parseFloat(c[5]):1})};A.toHSLA=function(b){var c=b.r/255,a=b.g/255,g=b.b/255,h=Math.max(c,a,g),d=Math.min(c,a,g),j,t=(h+d)/2,f;if(h===d)j=d=0;else{f=h-d;d=0.5<t?f/(2-h-d):f/(h+d);switch(h){case c:j=(a-g)/f+(a<g?6:0);break;case a:j=(g-c)/f+2;break;case g:j=(c-a)/f+4}j/=6}return{h:360*j,s:d,l:t,a:b.a}};K=A;var ja,f=Math,m=f.sin,H=f.cos,
va=f.tan,ka=f.asin,la=f.atan2,M=f.PI,l=180/M,wa=357.5291/l,xa=0.98560028/l,ya=1.9148/l,za=0.02/l,Aa=3E-4/l,Ba=102.9372/l,ma=23.45/l,Ca=280.16/l,Da=360.9856235/l;ja=function(b,c,a){a=-a/l;c/=l;b=b.valueOf()/864E5-0.5+2440588;var g=wa+xa*(b-2451545),d=ya*m(g)+za*m(2*g)+Aa*m(3*g),d=g+Ba+d+M,g=ka(m(d)*m(ma)),d=la(m(d)*H(ma),H(d));a=Ca+Da*(b-2451545)-a-d;return{altitude:ka(m(c)*m(g)+H(c)*H(g)*H(a)),azimuth:la(m(a),H(a)*m(c)-va(g)*H(c))-M/2}};var na=function(b,c){var a,d;void 0===c&&(c=[]);var h=b[0]?b:
b.features;if(h){a=0;for(d=h.length;a<d;a++)na(h[a],c);return c}if("Feature"!==b.type)return c;a=b.geometry;var h=b.properties,f;"Polygon"===a.type&&(f=[a.coordinates]);"MultiPolygon"===a.type&&(f=a.coordinates);if(!f)return c;var j,t;if(h.color||h.wallColor)a=h.color||h.wallColor,j=K.parse(materialColors[a]||a);h.roofColor&&(a=h.roofColor,t=K.parse(materialColors[a]||a));var w=h.height,n,C,x,B,l;a=0;for(d=f.length;a<d;a++){n=f[a][0];C=[];B=x=0;for(l=n.length;B<l;B++)C.push(n[B][1],n[B][0]),x+=w||
n[B][2]||0;x&&c.push({id:h.id||C[0]+","+C[1],footprint:z(C),height:x/n.length<<0||Ea,minHeight:h.minHeight,wallColor:j,altColor:j&&j.adjustLightness(0.8),roofColor:t})}return c},T=Math.PI,oa=T/2,Fa=T/4,Ga=180/T,Ha=256,U="latitude",V="longitude",Ea=5;d.OSMBuildings=function(){function b(e,I){var p={};e/=H;I/=H;p[U]=0>=I?90:1<=I?-90:Ga*(2*ua(qa(T*(1-2*I)))-oa);p[V]=360*(1===e?1:(e%1+1)%1)-180;return p}function c(e){B=e;H=Ha<<B;e=B;var I=ca,p=fa;e=O(R(e,I),p);J=1-O(R(0+0.3*((e-I)/(p-I)),0),0.3);L=D.adjustAlpha(J)+
"";W=z.adjustAlpha(J)+"";X=P.adjustAlpha(J)+"";u.scale(B)}function a(){Y.render();da.render();g()}function g(){E.clearRect(0,0,j,t);if(u.rendering&&!(B<ca||Z)){var e,I,p,b,a,c,d,g,k,pa=C,F=x,s=da.getMaxHeight(),n=[$+pa,aa+F],y,v,q,r,N,m;u.rendering.sort(function(e,a){return w(a.center,n)/a.height-w(e.center,n)/e.height});e=0;for(I=u.rendering.length;e<I;e++)if(a=u.rendering[e],!(a.height<=s)){v=!1;c=a.footprint;y=[];p=0;for(b=c.length-1;p<b;p+=2)y[p]=g=c[p]-pa,y[p+1]=k=c[p+1]-F,v||(v=0<g&&g<j&&0<
k&&k<t);if(v){p=a.isNew?a.height*G:a.height;c=Q/(Q-p);a.minHeight&&(p=a.isNew?a.minHeight*G:a.minHeight,d=Q/(Q-p));g=[];p=0;for(b=y.length-3;p<b;p+=2)k=y[p],q=y[p+1],v=y[p+2],r=y[p+3],N=l(k,q,c),m=l(v,r,c),a.minHeight&&(q=l(k,q,d),r=l(v,r,d),k=q.x,q=q.y,v=r.x,r=r.y),(v-k)*(N.y-q)>(N.x-k)*(r-q)&&(E.fillStyle=k<v&&q<r||k>v&&q>r?a.altColor||W:a.wallColor||L,f([v,r,k,q,N.x,N.y,m.x,m.y])),g[p]=N.x,g[p+1]=N.y;E.fillStyle=a.roofColor||X;E.strokeStyle=a.altColor||W;f(g,!0)}}}}function f(e,a){if(e.length){E.beginPath();
E.moveTo(e[0],e[1]);for(var b=2,c=e.length;b<c;b+=2)E.lineTo(e[b],e[b+1]);E.closePath();a&&E.stroke();E.fill()}}function l(e,a,b){return{x:(e-$)*b+$<<0,y:(a-aa)*b+aa<<0}}var j=0,t=0,m=0,A=0,C=0,x=0,B,H,E,D=new K(200,190,180),z=D.adjustLightness(0.8),P=D.adjustLightness(1.2),L=D+"",W=z+"",X=P+"",G=1,M,J=1,ca=14,fa=20,ga,$,aa,Q,Z,S={container:null,items:[],init:function(e){var a=this.container=ba.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=
0;Y.init(this.create());da.init(this.create());E=this.create();e.appendChild(a);return a},create:function(){var e=ba.createElement("CANVAS");e.style.webkitTransform="translate3d(0,0,0)";e.style.imageRendering="optimizeSpeed";e.style.position="absolute";e.style.left=0;e.style.top=0;var a=e.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.mozImageSmoothingEnabled=!1;a.webkitImageSmoothingEnabled=!1;this.items.push(e);this.container.appendChild(e);return a},setSize:function(e,a){for(var b=
this.items,c=0,d=b.length;c<d;c++)b[c].width=e,b[c].height=a}},u={raw:[],rendering:[],init:function(){},setUrl:function(e){this.url=e},setLatLon:function(e){this.isLatLon=e},load:function(){if(this.url&&!(14>B)){var e=b(C-m,x-A),a=b(C+j+m,x+t+A),c={w:e[V],n:e[U],e:a[V],s:a[U]},e=this.url.replace(/\{ *([\w_]+) *\}/g,function(e,a){return c[a]||e}),Ia=this.set.bind(this),g=ba.documentElement,f=ba.createElement("script");d.jsonpCallback=function(e){delete d.jsonpCallback;g.removeChild(f);Ia(e)};g.insertBefore(f,
g.lastChild).src=e.replace(/\{callback\}/,"jsonpCallback")}},set:function(e){if(e){e=this.raw=na(e);var a;this.n=-90;this.w=180;this.s=90;this.e=-180;for(var b=0,c=e.length;b<c;b++){a=e[b].footprint;for(var d=0,f=a.length-1;d<f;d+=2)this.n=R(a[d],this.n),this.e=R(a[d+1],this.e),this.s=O(a[d],this.s),this.w=O(a[d+1],this.w)}this.scale(B,!0);clearInterval(M);G=0;da.render();M=setInterval(function(){G+=0.1;if(1<G){clearInterval(M);G=1;for(var e=0,a=u.rendering.length;e<a;e++)u.rendering[e].isNew=0}Y.render();
g()},33)}},scale:function(e,a){for(var b,c,d=this.raw,g=[],f,j,k,h,F,s,t=fa-e,y=0,v=d.length;y<v;y++)if(k=d[y],F=k.minHeight>>t,!(F>ga)){h=k.footprint;s=new ha(h.length);f=0;for(j=h.length-1;f<j;f+=2)b=h[f+1],c=O(1,R(0,0.5-ra(ea(Fa+oa*h[f]/180))/T/2)),b=(b/360+0.5)*H<<0,c=c*H<<0,s[f]=b,s[f+1]=c;f=s;j=f.length/2;h=new ia(j);s=0;b=j-1;var q=c=void 0,r=void 0,m=void 0,u=[],l=[],B=[];for(h[s]=h[b]=1;b;){q=0;for(c=s+1;c<b;c++){var r=f[2*c],C=f[2*c+1],x=f[2*s],A=f[2*s+1],w=f[2*b],E=f[2*b+1],z=w-x,G=E-A,
D=void 0;if(0!==z||0!==G)D=((r-x)*z+(C-A)*G)/(z*z+G*G),1<D?(x=w,A=E):0<D&&(x+=z*D,A+=G*D);z=r-x;G=C-A;r=z*z+G*G;r>q&&(m=c,q=r)}2<q&&(h[m]=1,u.push(s),l.push(m),u.push(m),l.push(b));s=u.pop();b=l.pop()}for(c=0;c<j;c++)h[c]&&B.push(f[2*c],f[2*c+1]);s=B;8>s.length||g.push({footprint:s,height:O(k.height>>t,ga),minHeight:F,wallColor:k.wallColor&&k.wallColor.adjustAlpha(J)+"",altColor:k.wallColor&&k.altColor.adjustAlpha(J)+"",roofColor:k.roofColor&&k.roofColor.adjustAlpha(J)+"",center:n(s),isNew:a})}this.rendering=
g}};this.geoJSON=function(e){var a=typeof e,b=this.Data;b.setLatLon(!1);"string"===a&&(b.setUrl(e),b.load());"object"===a&&b.set(e);return this};var Y={enabled:!0,context:null,color:new K(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(e){this.context=e;this.setDate((new Date).setHours(10))},setEnabled:function(e){this.enabled=!!e},render:function(){var e=this.context,a,c,d,f;e.clearRect(0,0,j,t);if(this.enabled&&u.rendering&&!(B<ca||Z))if(a=b(C+m,
x+A),a=ja(this.date,a.latitude,a.longitude),!(0>=a.altitude)){c=1/ea(a.altitude);d=0.4/c;this.directionX=ta(a.azimuth)*c;this.directionY=sa(a.azimuth)*c;this.color.a=d;f=this.color+"";var g,h,l,k,n,F,s=C,z=x,y,v,q,r,w,D,E=[];e.beginPath();a=0;for(c=u.rendering.length;a<c;a++){h=u.rendering[a];v=!1;l=h.footprint;y=[];d=0;for(g=l.length-1;d<g;d+=2)y[d]=n=l[d]-s,y[d+1]=F=l[d+1]-z,v||(v=0<n&&n<j&&0<F&&F<t);if(v){l=h.isNew?h.height*G:h.height;h.minHeight&&(k=h.isNew?h.minHeight*G:h.minHeight);n=null;d=
0;for(g=y.length-3;d<g;d+=2)F=y[d],q=y[d+1],v=y[d+2],r=y[d+3],w=this.project(F,q,l),D=this.project(v,r,l),h.minHeight&&(q=this.project(F,q,k),r=this.project(v,r,k),F=q.x,q=q.y,v=r.x,r=r.y),(v-F)*(w.y-q)>(w.x-F)*(r-q)?(1===n&&e.lineTo(F,q),n=0,d||e.moveTo(F,q),e.lineTo(v,r)):(0===n&&e.lineTo(w.x,w.y),n=1,d||e.moveTo(w.x,w.y),e.lineTo(D.x,D.y));e.closePath();E.push(y)}}e.fillStyle=f;e.fill();e.globalCompositeOperation="destination-out";e.beginPath();a=0;for(c=E.length;a<c;a++){k=E[a];e.moveTo(k[0],
k[1]);d=2;for(g=k.length;d<g;d+=2)e.lineTo(k[d],k[d+1]);e.lineTo(k[0],k[1]);e.closePath()}e.fillStyle="#00ff00";e.fill();e.globalCompositeOperation="source-over"}},project:function(a,b,c){return{x:a+this.directionX*c,y:b+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},da={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,j,t);if(u.rendering&&!(B<ca||Z)){var b,c,d,g,f,h,l,k=C,n=x,m,s;a.beginPath();b=0;for(c=u.rendering.length;b<
c;b++){d=u.rendering[b];s=!1;f=d.footprint;m=[];d=0;for(g=f.length-1;d<g;d+=2)m[d]=h=f[d]-k,m[d+1]=l=f[d+1]-n,s||(s=0<h&&h<j&&0<l&&l<t);if(s){d=0;for(g=m.length-3;d<g;d+=2)s=m[d],f=m[d+1],d?a.lineTo(s,f):a.moveTo(s,f);a.closePath()}}a.fillStyle=X;a.strokeStyle=W;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(b){b=b||{};if(b.color||b.wallColor)D=K.parse(b.color||b.wallColor),L=D.adjustAlpha(J)+"",z=D.adjustLightness(0.8),W=z.adjustAlpha(J)+"",P=D.adjustLightness(1.2),
X=P.adjustAlpha(J)+"";b.roofColor&&(P=K.parse(b.roofColor),X=P.adjustAlpha(J)+"");void 0!==b.shadows&&Y.setEnabled(b.shadows);a();return this};this.setCamOffset=function(a,b){$=m+a;aa=t+b};this.setMaxZoom=function(a){fa=a};this.setDate=function(a){Y.setDate(a);return this};this.appendTo=function(a){return S.init(a)};this.loadData=u.load;this.onMoveEnd=function(){var c=b(C,x),d=b(C+j,x+t);a();(c[U]>u.n||c[V]<u.w||d[U]<u.s||d[V]>u.e)&&u.load()};this.onZoomEnd=function(b){Z=!1;c(b.zoom);u.load();a()};
this.onZoomStart=function(){Z=!0;a()};this.setOrigin=function(a,b){C=a;x=b};this.setSize=function(a,b){j=a;t=b;m=j/2<<0;A=t/2<<0;$=m;aa=t;Q=j/(1.5/(window.devicePixelRatio||1))/ea(45)<<0;S.setSize(j,t);ga=Q-50};this.setZoom=c;this.render=g;u.setUrl(url)};d.OSMBuildings.VERSION="0.1.8a";d.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(d){d=d||{};d.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,d)},setOrigin:function(){var d=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),w=this.map.resolution,n=this.maxExtent,z=Math.round((d.lon-n.left)/w),d=Math.round((n.top-d.lat)/
w);this.osmb.setOrigin(z,d)},setMap:function(d){this.map||OpenLayers.Layer.prototype.setMap.call(this,d);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(d){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,d)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(d,w,n){d=OpenLayers.Layer.prototype.moveTo.call(this,d,w,n);if(!n){n=parseInt(this.map.layerContainerDiv.style.left,10);var z=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-n+"px";this.div.style.top=-z+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(w)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return d},moveByPx:function(d,
w){this.dxSum+=d;this.dySum+=w;var n=OpenLayers.Layer.prototype.moveByPx.call(this,d,w);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return n},geoJSON:function(d){return this.osmb.geoJSON(d)},setStyle:function(d){return this.osmb.setStyle(d)},setDate:function(d){return this.osmb.setDate(d)}});
