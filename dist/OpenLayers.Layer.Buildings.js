(function(g){function l(c,b){var j=c[0]-b[0],h=c[1]-b[1];return j*j+h*h}function E(c){for(var b=0,j=0,h=0,g=c.length-3;h<g;h+=2)b+=c[h],j+=c[h+1];c=2*(c.length-2);return[b/c<<0,j/c<<0]}function T(c){var b=c.length/2,j=new $(b),h=0,g=b-1,n,f,k,C,l=[],E=[],H=[];for(j[h]=j[g]=1;g;){f=0;for(n=h+1;n<g;n++){k=c[2*n];var I=c[2*n+1],A=c[2*h],B=c[2*h+1],y=c[2*g],F=c[2*g+1],r=y-A,D=F-B,x=void 0;if(0!==r||0!==D)x=((k-A)*r+(I-B)*D)/(r*r+D*D),1<x?(A=y,B=F):0<x&&(A+=r*x,B+=D*x);r=k-A;D=I-B;k=r*r+D*D;k>f&&(C=n,
f=k)}2<f&&(j[C]=1,l.push(h),E.push(C),l.push(C),E.push(g));h=l.pop();g=E.pop()}for(n=0;n<b;n++)j[n]&&H.push(c[2*n],c[2*n+1]);return H}var Da=Da||Array,$=$||Array,f=Math,Ka=f.exp,La=f.log,Ma=f.sin,Na=f.cos,xa=f.tan,Oa=f.atan,ba=f.min,ya=f.max,ra=document,k,Ea=function(c){var b,j,h;if(0===c.s)b=j=h=c.l;else{h=0.5>c.l?c.l*(1+c.s):c.l+c.s-c.l*c.s;var g=2*c.l-h;c.h/=360;b=V(g,h,c.h+1/3);j=V(g,h,c.h);h=V(g,h,c.h-1/3)}return new k(255*b<<0,255*j<<0,255*h<<0,c.a)},V=function(c,b,j){0>j&&(j+=1);1<j&&(j-=1);
return j<1/6?c+6*(b-c)*j:0.5>j?b:j<2/3?c+6*(b-c)*(2/3-j):c},f=function(c,b,j,g){this.r=c;this.g=b;this.b=j;this.a=4>arguments.length?1:g},W=f.prototype;W.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};W.adjustLightness=function(c){var b=k.toHSLA(this);b.l*=c;b.l=Math.min(1,Math.max(0,b.l));return Ea(b)};W.adjustAlpha=function(c){return new k(this.r,this.g,this.b,this.a*c)};f.parse=function(c){var b;c+="";if(~c.indexOf("#"))return b=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new k(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new k(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?parseFloat(b[5]):1);if(b=c.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ea({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};f.toHSLA=function(c){var b=c.r/255,g=c.g/255,h=c.b/255,f=Math.max(b,g,h),n=Math.min(b,g,h),
k,C=(f+n)/2,l;if(f===n)k=n=0;else{l=f-n;n=0.5<C?l/(2-f-n):l/(f+n);switch(f){case b:k=(g-h)/l+(g<h?6:0);break;case g:k=(h-b)/l+2;break;case h:k=(b-g)/l+4}k/=6}return{h:360*k,s:n,l:C,a:c.a}};k=f;var Fa,f=Math,K=f.sin,L=f.cos,Pa=f.tan,Ga=f.asin,Ha=f.atan2,R=f.PI,y=180/R,Qa=357.5291/y,Ra=0.98560028/y,Sa=1.9148/y,Ta=0.02/y,Ua=3E-4/y,Va=102.9372/y,Ia=23.45/y,Wa=280.16/y,Xa=360.9856235/y;Fa=function(c,b,g){g=-g/y;b/=y;c=c.valueOf()/864E5-0.5+2440588;var h=Qa+Ra*(c-2451545),f=Sa*K(h)+Ta*K(2*h)+Ua*K(3*h),
f=h+Va+f+R,h=Ga(K(f)*K(Ia)),f=Ha(K(f)*L(Ia),L(f));g=Wa+Xa*(c-2451545)-g-f;return{altitude:Ga(K(b)*K(h)+L(b)*L(h)*L(g)),azimuth:Ha(K(g),L(g)*K(b)-Pa(h)*L(b))-R/2}};var ca=Math.PI,Ja=ca/2,Ya=ca/4,Za=180/ca,$a=256,za=14,da="latitude",ea="longitude",ab=3,bb=4,H=0,C=1,I=2,F=3,sa=4,S=5,O=6;g.OSMBuildings=function(c){function b(a,p){var d={};a/=fa;p/=fa;d[da]=0>=p?90:1<=p?-90:Za*(2*Oa(Ka(ca*(1-2*p)))-Ja);d[ea]=360*(1===a?1:(a%1+1)%1)-180;return d}function f(){if(R&&!(x<za)){var a=b(r-U,D-qa),p=b(r+A+U,D+
B+qa);ta&&ta.abort();var d={w:a[ea],n:a[da],e:p[ea],s:p[da],z:x},a=R.replace(/\{ *([\w_]+) *\}/g,function(a,p){return d[p]}),e=h,q=new XMLHttpRequest;q.onreadystatechange=function(){4===q.readyState&&q.status&&!(200>q.status||299<q.status)&&q.responseText&&e(JSON.parse(q.responseText))};q.open("GET",a);q.send(null);ta=q}}function h(a){var p,d,e,q,c=[],b=d=0;X=za;L(x);ta=null;if(a&&a.meta.z===x){q=a.meta;e=a.data;if(z&&s&&z.z===q.z){d=z.x-q.x;b=z.y-q.y;a=0;for(p=s.length;a<p;a++)c[a]=s[a][I][0]+d+
","+(s[a][I][1]+b)}z=q;s=[];a=0;for(p=e.length;a<p;a++)if(q=[],!(e[a][C]>ga)&&(d=T(e[a][I]),!(8>d.length))){q[I]=d;q[sa]=E(d);q[H]=ba(e[a][H],ga);q[C]=e[a][C];d=q[I][0]+","+q[I][1];q[S]=!(c&&~c.indexOf(d));q[F]=[];q[O]=[];d=(b=e[a][ab])?k.parse(ua[b]||b):null;b=(b=e[a][bb])?k.parse(ua[b]||b):null;q[F]=[d,d?d.adjustLightness(0.8):null,b];for(d=0;3>d;d++)q[F][d]&&(q[O][d]=q[F][d].adjustAlpha(M)+"");s.push(q)}V()}}function y(a,p){var d,e,b=[],c,g,f,J,h,m,j,k,l=Aa-x;c=0;for(g=a.length;c<g;c++)if(h=a[c],
j=h[C]>>l,!(j>ga)){m=h[I];k=new Da(m.length);f=0;for(J=m.length-1;f<J;f+=2)d=m[f+1],e=ba(1,ya(0,0.5-La(xa(Ya+Ja*m[f]/180))/ca/2)),d=(d/360+0.5)*fa<<0,e=e*fa<<0,k[f]=d,k[f+1]=e;k=T(k);if(!(8>k.length)){J=[];J[I]=k;J[sa]=E(k);J[H]=ba(h[H]>>l,ga);J[C]=j;J[S]=p;J[F]=h[F];J[O]=[];for(f=0;3>f;f++)J[F][f]&&(J[O][f]=J[F][f].adjustAlpha(M)+"");b.push(J)}}return b}function n(a,p,d){void 0===d&&(d=[]);var e,b,c,g=a[0]?a:a.features,f,h,j,m,l,s,B=p?1:0,v=p?0:1;if(g){a=0;for(e=g.length;a<e;a++)n(g[a],p,d);return d}"Feature"===
a.type&&(e=a.geometry,j=a.properties);"Polygon"===e.type&&(f=[e.coordinates]);"MultiPolygon"===e.type&&(f=e.coordinates);if(f){p=j.height;s=g=null;if(j.color||j.wallColor)a=j.color||j.wallColor,g=k.parse(ua[a]||a);j.roofColor&&(a=j.roofColor,s=k.parse(ua[a]||a));a=0;for(e=f.length;a<e;a++){h=f[a][0];m=[];b=l=0;for(c=h.length;b<c;b++)m.push(h[b][B],h[b][v]),l+=p||h[b][2]||0;if(l){c=b=[];var u=I;for(var t=void 0,w=void 0,z=void 0,A=void 0,x=0,r=void 0,D=void 0,r=0,D=m.length-3;r<D;r+=2)t=m[r],w=m[r+
1],z=m[r+2],A=m[r+3],x+=t*A-z*w;if("CW"!==(0<x/2?"CW":"CCW")){t=[];for(w=m.length-2;0<=w;w-=2)t.push(m[w],m[w+1]);m=t}c[u]=m;b[H]=l/h.length<<0;b[C]=j.minHeight;b[F]=[g,g?g.adjustLightness(0.8):null,s];d.push(b)}}}return d}function K(a,p){a?(ha=n(a,p),X=0,L(x),z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:x},s=y(ha,!0),V()):(ha=null,aa())}function L(a){var p,d,e;x=a;fa=$a<<x;a=x;p=X;d=Aa;a=ba(ya(a,p),d);M=1-ba(ya(0+0.3*((a-p)/(d-p)),0),0.3);Ba=Q.adjustAlpha(M)+"";ia=va.adjustAlpha(M)+"";ja=Y.adjustAlpha(M)+
"";if(s){a=0;for(p=s.length;a<p;a++){e=s[a];e[O]=[];for(d=0;3>d;d++)e[F][d]&&(e[O][d]=e[F][d].adjustAlpha(M)+"")}}}function V(){clearInterval(Ca);P=0;wa.render();Ca=setInterval(function(){P+=0.1;if(1<P){clearInterval(Ca);P=1;for(var a=0,p=s.length;a<p;a++)s[a][S]=0}ka.render();aa()},33)}function oa(){ka.render();wa.render();aa()}function aa(){N.clearRect(0,0,A,B);if(z&&s&&!(x<X||la)){var a,p,d,e,b,c,g,f,h,j=r-z.x,m=D-z.y,k=wa.getMaxHeight(),n=[ma+j,na+m],G,v,u,t,w,y;s.sort(function(a,b){return l(b[sa],
n)/b[H]-l(a[sa],n)/a[H]});a=0;for(p=s.length;a<p;a++)if(b=s[a],!(b[H]<=k)){v=!1;c=b[I];G=[];d=0;for(e=c.length-1;d<e;d+=2)G[d]=f=c[d]-j,G[d+1]=h=c[d+1]-m,v||(v=0<f&&f<A&&0<h&&h<B);if(v){d=b[S]?b[H]*P:b[H];c=Z/(Z-d);b[C]&&(d=b[S]?b[C]*P:b[C],g=Z/(Z-d));f=[];d=0;for(e=G.length-3;d<e;d+=2)h=G[d],u=G[d+1],v=G[d+2],t=G[d+3],w=pa(h,u,c),y=pa(v,t,c),b[C]&&(u=pa(h,u,g),t=pa(v,t,g),h=u.x,u=u.y,v=t.x,t=t.y),(v-h)*(w.y-u)>(w.x-h)*(t-u)&&(N.fillStyle=h<v&&u<t||h>v&&u>t?b[O][1]||ia:b[O][0]||Ba,W([v,t,h,u,w.x,
w.y,y.x,y.y])),f[d]=w.x,f[d+1]=w.y;N.fillStyle=b[O][2]||ja;N.strokeStyle=b[O][1]||ia;W(f,!0)}}}}function W(a,b){if(a.length){N.beginPath();N.moveTo(a[0],a[1]);for(var d=2,e=a.length;d<e;d+=2)N.lineTo(a[d],a[d+1]);N.closePath();b&&N.stroke();N.fill()}}function pa(a,b,d){return{x:(a-ma)*d+ma<<0,y:(b-na)*d+na<<0}}var A=0,B=0,U=0,qa=0,r=0,D=0,x,fa,ta,N,R,Q=new k(200,190,180),va=Q.adjustLightness(0.8),Y=Q.adjustLightness(1.2),Ba=Q+"",ia=va+"",ja=Y+"",ha,z,s,P=1,Ca,M=1,X=za,Aa=20,ga,ma,na,Z,la,ua={brick:"#cc7755",
bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",grass:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},$={container:null,items:[],init:function(a){var b=this.container=ra.createElement("DIV");b.style.pointerEvents="none";b.style.position="absolute";b.style.left=0;b.style.top=0;ka.init(this.create());wa.init(this.create());N=this.create();
a.appendChild(b);return b},create:function(){var a=ra.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";b.lineJoin="round";b.lineWidth=1;b.mozImageSmoothingEnabled=!1;b.webkitImageSmoothingEnabled=!1;this.items.push(a);this.container.appendChild(a);return b},setSize:function(a,b){for(var d=this.items,e=0,c=d.length;e<c;e++)d[e].width=a,d[e].height=
b}},ka={enabled:!0,context:null,color:new k(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},setEnabled:function(a){this.enabled=!!a},render:function(){var a=this.context,c,d,e,g;a.clearRect(0,0,A,B);if(this.enabled&&z&&s&&!(x<X||la))if(c=b(r+U,D+qa),c=Fa(this.date,c.latitude,c.longitude),!(0>=c.altitude)){d=1/xa(c.altitude);e=0.4/d;this.directionX=Na(c.azimuth)*d;this.directionY=Ma(c.azimuth)*
d;this.color.a=e;g=this.color+"";var f,h,j,k,l,m,n=r-z.x,y=D-z.y,G,v,u,t,w,E,F=[];a.beginPath();c=0;for(d=s.length;c<d;c++){h=s[c];v=!1;j=h[I];G=[];e=0;for(f=j.length-1;e<f;e+=2)G[e]=l=j[e]-n,G[e+1]=m=j[e+1]-y,v||(v=0<l&&l<A&&0<m&&m<B);if(v){j=h[S]?h[H]*P:h[H];h[C]&&(k=h[S]?h[C]*P:h[C]);l=null;e=0;for(f=G.length-3;e<f;e+=2)m=G[e],u=G[e+1],v=G[e+2],t=G[e+3],w=this.project(m,u,j),E=this.project(v,t,j),h[C]&&(u=this.project(m,u,k),t=this.project(v,t,k),m=u.x,u=u.y,v=t.x,t=t.y),(v-m)*(w.y-u)>(w.x-m)*
(t-u)?(1===l&&a.lineTo(m,u),l=0,e||a.moveTo(m,u),a.lineTo(v,t)):(0===l&&a.lineTo(w.x,w.y),l=1,e||a.moveTo(w.x,w.y),a.lineTo(E.x,E.y));a.closePath();F.push(G)}}a.fillStyle=g;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();c=0;for(d=F.length;c<d;c++){k=F[c];a.moveTo(k[0],k[1]);e=2;for(f=k.length;e<f;e+=2)a.lineTo(k[e],k[e+1]);a.lineTo(k[0],k[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,b,c){return{x:a+this.directionX*
c,y:b+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},wa={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,A,B);if(z&&s&&!(x<X||la)){var b,c,e,g,f,h,j,k=r-z.x,l=D-z.y,m,n;a.beginPath();b=0;for(c=s.length;b<c;b++){e=s[b];n=!1;f=e[I];m=[];e=0;for(g=f.length-1;e<g;e+=2)m[e]=h=f[e]-k,m[e+1]=j=f[e+1]-l,n||(n=0<h&&h<A&&0<j&&j<B);if(n){e=0;for(g=m.length-3;e<g;e+=2)n=m[e],f=m[e+1],e?a.lineTo(n,f):a.moveTo(n,f);a.closePath()}}a.fillStyle=
ja;a.strokeStyle=ia;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)Q=k.parse(a.color||a.wallColor),Ba=Q.adjustAlpha(M)+"",va=Q.adjustLightness(0.8),ia=va.adjustAlpha(M)+"",Y=Q.adjustLightness(1.2),ja=Y.adjustAlpha(M)+"";a.roofColor&&(Y=k.parse(a.roofColor),ja=Y.adjustAlpha(M)+"");void 0!==a.shadows&&ka.setEnabled(a.shadows);oa();return this};this.geoJSON=function(a,b){if("object"===typeof a)K(a,!b);else{var c=ra.documentElement,
e=ra.createElement("script");g.jsonpCallback=function(a){delete g.jsonpCallback;c.removeChild(e);K(a,!b)};c.insertBefore(e,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){ma=U+a;na=B+b};this.setMaxZoom=function(a){Aa=a};this.setDate=function(a){ka.setDate(a);return this};this.appendTo=function(a){return $.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=b(r,D),c=b(r+A,D+B);oa();z&&(a[da]>z.n||a[ea]<z.w||c[da]<z.s||c[ea]>z.e)&&f()};this.onZoomEnd=
function(a){la=!1;L(a.zoom);ha?(s=y(ha),oa()):(aa(),f())};this.onZoomStart=function(){la=!0;oa()};this.setOrigin=function(a,b){r=a;D=b};this.setSize=function(a,b){A=a;B=b;U=A/2<<0;qa=B/2<<0;ma=U;na=B;Z=A/(1.5/(window.devicePixelRatio||1))/xa(45)<<0;$.setSize(A,B);ga=Z-50};this.setZoom=L;this.render=aa;R=c};g.OSMBuildings.VERSION="0.1.8a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(g){g=g||{};g.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,g)},setOrigin:function(){var g=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),l=this.map.resolution,E=this.maxExtent,T=Math.round((g.lon-E.left)/l),g=Math.round((E.top-g.lat)/
l);this.osmb.setOrigin(T,g)},setMap:function(g){this.map||OpenLayers.Layer.prototype.setMap.call(this,g);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(g){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,g)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(g,l,E){g=OpenLayers.Layer.prototype.moveTo.call(this,g,l,E);if(!E){E=parseInt(this.map.layerContainerDiv.style.left,10);var T=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-E+"px";this.div.style.top=-T+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(l)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return g},moveByPx:function(g,
l){this.dxSum+=g;this.dySum+=l;var E=OpenLayers.Layer.prototype.moveByPx.call(this,g,l);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return E},geoJSON:function(g,l){return this.osmb.geoJSON(g,l)},setStyle:function(g){return this.osmb.setStyle(g)},setDate:function(g){return this.osmb.setDate(g)}});
