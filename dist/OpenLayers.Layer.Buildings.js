(function(c){function l(b,f){var j=b[0]-f[0],g=b[1]-f[1];return j*j+g*g}function r(b){for(var f=0,j=0,g=0,c=b.length-3;g<c;g+=2)f+=b[g],j+=b[g+1];b=2*(b.length-2);return[f/b<<0,j/b<<0]}function S(b){var f=b.length/2,j=new Y(f),g=0,c=f-1,p,d,h,C,l=[],r=[],H=[];for(j[g]=j[c]=1;c;){d=0;for(p=g+1;p<c;p++){h=b[2*p];var I=b[2*p+1],A=b[2*g],s=b[2*g+1],B=b[2*c],q=b[2*c+1],t=B-A,D=q-s,y=void 0;if(0!==t||0!==D)y=((h-A)*t+(I-s)*D)/(t*t+D*D),1<y?(A=B,s=q):0<y&&(A+=t*y,s+=D*y);t=h-A;D=I-s;h=t*t+D*D;h>d&&(C=p,
d=h)}2<d&&(j[C]=1,l.push(g),r.push(C),l.push(C),r.push(c));g=l.pop();c=r.pop()}for(p=0;p<f;p++)j[p]&&H.push(b[2*p],b[2*p+1]);return H}var Aa=Aa||Array,Y=Y||Array,d=Math,Ja=d.exp,Ka=d.log,La=d.sin,Ma=d.cos,ua=d.tan,Na=d.atan,$=d.min,va=d.max,oa=document,h,Ba=function(b){var f,j,g;if(0===b.s)f=j=g=b.l;else{g=0.5>b.l?b.l*(1+b.s):b.l+b.s-b.l*b.s;var c=2*b.l-g;b.h/=360;f=U(c,g,b.h+1/3);j=U(c,g,b.h);g=U(c,g,b.h-1/3)}return new h(255*f<<0,255*j<<0,255*g<<0,b.a)},U=function(b,f,j){0>j&&(j+=1);1<j&&(j-=1);
return j<1/6?b+6*(f-b)*j:0.5>j?f:j<2/3?b+6*(f-b)*(2/3-j):b},d=function(b,f,j,c){this.r=b;this.g=f;this.b=j;this.a=4>arguments.length?1:c},V=d.prototype;V.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};V.adjustLightness=function(b){var f=h.toHSLA(this);f.l*=b;f.l=Math.min(1,Math.max(0,f.l));return Ba(f)};V.adjustAlpha=function(b){return new h(this.r,this.g,this.b,this.a*b)};d.parse=function(b){var f;b+="";if(~b.indexOf("#"))return f=b.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new h(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1);if(f=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new h(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5]):1);if(f=b.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ba({h:parseInt(f[1],10),s:parseFloat(f[2]),l:parseFloat(f[3]),a:f[4]?parseFloat(f[5]):1})};d.toHSLA=function(b){var f=b.r/255,c=b.g/255,g=b.b/255,d=Math.max(f,c,g),p=Math.min(f,c,g),
h,C=(d+p)/2,l;if(d===p)h=p=0;else{l=d-p;p=0.5<C?l/(2-d-p):l/(d+p);switch(d){case f:h=(c-g)/l+(c<g?6:0);break;case c:h=(g-f)/l+2;break;case g:h=(f-c)/l+4}h/=6}return{h:360*h,s:p,l:C,a:b.a}};h=d;var Ca,d=Math,F=d.sin,G=d.cos,Oa=d.tan,Da=d.asin,Ea=d.atan2,Q=d.PI,B=180/Q,Pa=357.5291/B,Qa=0.98560028/B,Ra=1.9148/B,Sa=0.02/B,Ta=3E-4/B,Ua=102.9372/B,Fa=23.45/B,Va=280.16/B,Wa=360.9856235/B;Ca=function(b,f,c){c=-c/B;f/=B;b=b.valueOf()/864E5-0.5+2440588;var g=Pa+Qa*(b-2451545),d=Ra*F(g)+Sa*F(2*g)+Ta*F(3*g),
d=g+Ua+d+Q,g=Da(F(d)*F(Fa)),d=Ea(F(d)*G(Fa),G(d));c=Va+Wa*(b-2451545)-c-d;return{altitude:Da(F(f)*F(g)+G(f)*G(g)*G(c)),azimuth:Ea(F(c),G(c)*F(f)-Oa(g)*G(f))-Q/2}};var aa=Math.PI,Ga=aa/2,Xa=aa/4,Ya=180/aa,Za=256,wa=14,ba="latitude",ca="longitude",Ha=3,Ia=4,H=0,C=1,I=2,q=3,pa=4,R=5,M=6;c.OSMBuildings=function(b){function f(a,n){var e={};a/=da;n/=da;e[ba]=0>=n?90:1<=n?-90:Ya*(2*Na(Ja(aa*(1-2*n)))-Ga);e[ca]=360*(1===a?1:(a%1+1)%1)-180;return e}function d(){if(Q&&!(y<wa)){var a=f(t-T,D-na),n=f(t+A+T,D+
s+na);qa&&qa.abort();var e={w:a[ca],n:a[ba],e:n[ca],s:n[ba],z:y},a=Q.replace(/\{ *([\w_]+) *\}/g,function(a,n){return e[n]}),m=g,k=new XMLHttpRequest;k.onreadystatechange=function(){4===k.readyState&&k.status&&!(200>k.status||299<k.status)&&k.responseText&&m(JSON.parse(k.responseText))};k.open("GET",a);k.send(null);qa=k}}function g(a){var n,e,m,k,b=[],f=e=0;W=wa;G(y);qa=null;if(a&&a.meta.z===y){k=a.meta;m=a.data;if(z&&u&&z.z===k.z){e=z.x-k.x;f=z.y-k.y;a=0;for(n=u.length;a<n;a++)b[a]=u[a][I][0]+e+
","+(u[a][I][1]+f)}z=k;u=[];a=0;for(n=m.length;a<n;a++)if(k=[],!(m[a][C]>ea)&&(e=S(m[a][I]),!(8>e.length))){k[I]=e;k[pa]=r(e);k[H]=$(m[a][H],ea);k[C]=m[a][C];e=k[I][0]+","+k[I][1];k[R]=!(b&&~b.indexOf(e));k[q]=[];k[M]=[];e=m[a][Ha]?h.parse(m[a][Ha]):null;f=m[a][Ia]?h.parse(m[a][Ia]):null;k[q]=[e||null,e?e.adjustLightness(0.8):null,f?f:e?e.adjustLightness(1.2):O];for(e=0;3>e;e++)k[q][e]&&(k[M][e]=k[q][e].adjustAlpha(K)+"");u.push(k)}U()}}function B(a,n){var e,m,k=[],b,f,c,J,d,g,j,h,l=xa-y;b=0;for(f=
a.length;b<f;b++)if(d=a[b],j=d[C]>>l,!(j>ea)){g=d[I];h=new Aa(g.length);c=0;for(J=g.length-1;c<J;c+=2)e=g[c+1],m=$(1,va(0,0.5-Ka(ua(Xa+Ga*g[c]/180))/aa/2)),e=(e/360+0.5)*da<<0,m=m*da<<0,h[c]=e,h[c+1]=m;h=S(h);if(!(8>h.length)){J=[];J[I]=h;J[pa]=r(h);J[H]=$(d[H]>>l,ea);J[C]=j;J[R]=n;J[q]=d[q];J[M]=[];for(c=0;3>c;c++)J[q][c]&&(J[M][c]=J[q][c].adjustAlpha(K)+"");k.push(J)}}return k}function p(a,n,e){void 0===e&&(e=[]);var m,k,c,b=a[0]?a:a.features,f,d,g,j,l,u,E=n?1:0,v=n?0:1;if(b){a=0;for(m=b.length;a<
m;a++)p(b[a],n,e);return e}"Feature"===a.type&&(m=a.geometry,d=a.properties);"Polygon"===m.type&&(f=[m.coordinates]);"MultiPolygon"===m.type&&(f=m.coordinates);if(f){j=d.height;if(d.color||d.wallColor)l=h.parse(d.color||d.wallColor);d.roofColor&&(u=h.parse(d.roofColor));a=0;for(m=f.length;a<m;a++){n=f[a][0];g=[];k=b=0;for(c=n.length;k<c;k++)g.push(n[k][E],n[k][v]),b+=j||n[k][2]||0;if(b){c=k=[];var x=I;for(var w=void 0,s=void 0,z=void 0,A=void 0,y=0,t=void 0,D=void 0,t=0,D=g.length-3;t<D;t+=2)w=g[t],
s=g[t+1],z=g[t+2],A=g[t+3],y+=w*A-z*s;if("CW"!==(0<y/2?"CW":"CCW")){w=[];for(s=g.length-2;0<=s;s-=2)w.push(g[s],g[s+1]);g=w}c[x]=g;k[H]=b/n.length<<0;k[C]=d.minHeight;k[q]=[l||null,l?l.adjustLightness(0.8):null,u?u:l?l.adjustLightness(1.2):O];e.push(k)}}}return e}function F(a,n){a?(fa=p(a,n),W=0,G(y),z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:y},u=B(fa,!0),U()):(fa=null,Z())}function G(a){var n,e,m;y=a;da=Za<<y;a=y;n=W;e=xa;a=$(va(a,n),e);K=1-$(va(0+0.4*((a-n)/(e-n)),0),0.4);ya=P.adjustAlpha(K)+"";ga=ra.adjustAlpha(K)+
"";ha=O.adjustAlpha(K)+"";if(u){a=0;for(n=u.length;a<n;a++){m=u[a];m[M]=[];for(e=0;3>e;e++)m[q][e]&&(m[M][e]=m[q][e].adjustAlpha(K)+"")}}}function U(){clearInterval(za);N=0;sa.render();za=setInterval(function(){N+=0.1;if(1<N){clearInterval(za);N=1;for(var a=0,n=u.length;a<n;a++)u[a][R]=0}ta.render();Z()},33)}function la(){ta.render();sa.render();Z()}function Z(){L.clearRect(0,0,A,s);if(z&&u&&!(y<W||ia)){var a,n,e,m,b,c,f,g,d,h=t-z.x,j=D-z.y,p=sa.getMaxHeight(),B=[ja+h,ka+j],E,v,x,w,r,q;u.sort(function(a,
e){return l(e[pa],B)/e[H]-l(a[pa],B)/a[H]});a=0;for(n=u.length;a<n;a++)if(b=u[a],!(b[H]<=p)){v=!1;c=b[I];E=[];e=0;for(m=c.length-1;e<m;e+=2)E[e]=g=c[e]-h,E[e+1]=d=c[e+1]-j,v||(v=0<g&&g<A&&0<d&&d<s);if(v){e=b[R]?b[H]*N:b[H];c=X/(X-e);b[C]&&(e=b[R]?b[C]*N:b[C],f=X/(X-e));g=[];e=0;for(m=E.length-3;e<m;e+=2)d=E[e],x=E[e+1],v=E[e+2],w=E[e+3],r=ma(d,x,c),q=ma(v,w,c),b[C]&&(x=ma(d,x,f),w=ma(v,w,f),d=x.x,x=x.y,v=w.x,w=w.y),(v-d)*(r.y-x)>(r.x-d)*(w-x)&&(L.fillStyle=d<v&&x<w||d>v&&x>w?b[M][1]||ga:b[M][0]||
ya,V([v,w,d,x,r.x,r.y,q.x,q.y])),g[e]=r.x,g[e+1]=r.y;L.fillStyle=b[M][2]||ha;L.strokeStyle=b[M][1]||ga;V(g,!0)}}}}function V(a,b){if(a.length){L.beginPath();L.moveTo(a[0],a[1]);for(var e=2,m=a.length;e<m;e+=2)L.lineTo(a[e],a[e+1]);L.closePath();b&&L.stroke();L.fill()}}function ma(a,b,e){return{x:(a-ja)*e+ja<<0,y:(b-ka)*e+ka<<0}}var A=0,s=0,T=0,na=0,t=0,D=0,y,da,qa,L,Q,P=new h(200,190,180),ra=P.adjustLightness(0.8),O=P.adjustLightness(1.2),ya=P+"",ga=ra+"",ha=O+"",fa,z,u,N=1,za,K=1,W=wa,xa=20,ea,ja,
ka,X,ia,Y={container:null,items:[],init:function(a){var b=this.container=oa.createElement("DIV");b.style.pointerEvents="none";b.style.position="absolute";b.style.left=0;b.style.top=0;ta.init(this.create());sa.init(this.create());L=this.create();a.appendChild(b);return b},create:function(){var a=oa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";
b.lineJoin="round";b.lineWidth=1;try{b.mozImageSmoothingEnabled=!1}catch(e){}this.items.push(a);this.container.appendChild(a);return b},setSize:function(a,b){for(var e=this.items,m=0,c=e.length;m<c;m++)e[m].width=a,e[m].height=b}},ta={context:null,color:new h(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,b,e,c,d;a.clearRect(0,0,A,s);if(z&&u&&!(y<W||ia))if(b=
f(t+T,D+na),b=Ca(this.date,b.latitude,b.longitude),!(0>=b.altitude)){e=1/ua(b.altitude);c=0.4/e;this.directionX=Ma(b.azimuth)*e;this.directionY=La(b.azimuth)*e;this.color.a=c;d=this.color+"";var g,h,j,l,p,r=t-z.x,B=D-z.y,q,E,v,x,w,F,G=[];a.beginPath();b=0;for(e=u.length;b<e;b++){h=u[b];E=!1;j=h[I];q=[];c=0;for(g=j.length-1;c<g;c+=2)q[c]=l=j[c]-r,q[c+1]=p=j[c+1]-B,E||(E=0<l&&l<A&&0<p&&p<s);if(E){j=h[R]?h[H]*N:h[H];h[C]&&(j=h[R]?h[C]*N:h[C]);l=null;c=0;for(g=q.length-3;c<g;c+=2)p=q[c],v=q[c+1],E=q[c+
2],x=q[c+3],w=this.project(p,v,j),F=this.project(E,x,j),h[C]&&(v=this.project(p,v,j),x=this.project(E,x,j),p=v.x,v=v.y,E=x.x,x=x.y),(E-p)*(w.y-v)>(w.x-p)*(x-v)?(1===l&&a.lineTo(p,v),l=0,c||a.moveTo(p,v),a.lineTo(E,x)):(0===l&&a.lineTo(w.x,w.y),l=1,c||a.moveTo(w.x,w.y),a.lineTo(F.x,F.y));a.closePath();G.push(q)}}a.fillStyle=d;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();b=0;for(e=G.length;b<e;b++){d=G[b];a.moveTo(d[0],d[1]);c=2;for(g=d.length;c<g;c+=2)a.lineTo(d[c],d[c+1]);a.lineTo(d[0],
d[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,b,c){return{x:a+this.directionX*c,y:b+this.directionY*c}},setDate:function(a){this.date=a;this.render()}},sa={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,A,s);if(z&&u&&!(y<W||ia)){var b,c,d,f,g,h,j,l=t-z.x,p=D-z.y,q,r;a.beginPath();b=0;for(c=u.length;b<c;b++){d=u[b];r=!1;g=d[I];q=[];d=0;for(f=g.length-1;d<f;d+=2)q[d]=h=
g[d]-l,q[d+1]=j=g[d+1]-p,r||(r=0<h&&h<A&&0<j&&j<s);if(r){d=0;for(f=q.length-3;d<f;d+=2)r=q[d],g=q[d+1],d?a.lineTo(r,g):a.moveTo(r,g);a.closePath()}}a.fillStyle=ha;a.strokeStyle=ga;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)P=h.parse(a.color||a.wallColor),ya=P.adjustAlpha(K)+"",ra=P.adjustLightness(0.8),ga=ra.adjustAlpha(K)+"",O=P.adjustLightness(1.2),ha=O.adjustAlpha(K)+"";a.roofColor&&(O=h.parse(a.roofColor),ha=
O.adjustAlpha(K)+"");la();return this};this.geoJSON=function(a,b){if("object"===typeof a)F(a,!b);else{var d=oa.documentElement,f=oa.createElement("script");c.jsonpCallback=function(a){delete c.jsonpCallback;d.removeChild(f);F(a,!b)};d.insertBefore(f,d.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){ja=T+a;ka=s+b};this.setMaxZoom=function(a){xa=a};this.setDate=function(a){ta.setDate(a);return this};this.appendTo=function(a){return Y.init(a)};this.loadData=
d;this.onMoveEnd=function(){var a=f(t,D),b=f(t+A,D+s);la();z&&(a[ba]>z.n||a[ca]<z.w||b[ba]<z.s||b[ca]>z.e)&&d()};this.onZoomEnd=function(a){ia=!1;G(a.zoom);fa?(u=B(fa),la()):(Z(),d())};this.onZoomStart=function(){ia=!0;la()};this.setOrigin=function(a,b){t=a;D=b};this.setSize=function(a,b){A=a;s=b;T=A/2<<0;na=s/2<<0;ja=T;ka=s;X=A/(1.5/(window.devicePixelRatio||1))/ua(45)<<0;Y.setSize(A,s);ea=X-50};this.setZoom=G;this.render=Z;Q=b};c.OSMBuildings.VERSION="0.1.8a";c.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(c){c=c||{};c.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,c)},setOrigin:function(){var c=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),l=this.map.resolution,r=this.maxExtent,S=Math.round((c.lon-r.left)/l),c=Math.round((r.top-c.lat)/
l);this.osmb.setOrigin(S,c)},setMap:function(c){this.map||OpenLayers.Layer.prototype.setMap.call(this,c);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(c){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,c)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(c,l,r){c=OpenLayers.Layer.prototype.moveTo.call(this,c,l,r);if(!r){r=parseInt(this.map.layerContainerDiv.style.left,10);var S=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-r+"px";this.div.style.top=-S+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(l)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return c},moveByPx:function(c,
l){this.dxSum+=c;this.dySum+=l;var r=OpenLayers.Layer.prototype.moveByPx.call(this,c,l);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return r},geoJSON:function(c,l){return this.osmb.geoJSON(c,l)},setStyle:function(c){return this.osmb.setStyle(c)},setDate:function(c){return this.osmb.setDate(c)}});
