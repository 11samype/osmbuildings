(function(l){function F(i,s){for(var z=s>3?5:1E3,c,f=[i[0],i[1]],j,m=[i[0],i[1]],r=2,G=i.length-3;r<G;r+=2){c=[i[r],i[r+1]];j=[i[r+2]||i[0],i[r+3]||i[1]];var H=f,w=H[0],x=H[1],A=j[0]-w,T=j[1]-x,L=void 0;if(A!==0||T!==0){L=((c[0]-w)*A+(c[1]-x)*T)/(A*A+T*T);if(L>1){w=j[0];x=j[1]}else if(L>0){w+=A*L;x+=T*L}}w=B(c,[w,x])*2;j=B(H,j);if(w*j>z){m.push(c[0],c[1]);f=c}}if(c[0]!==i[0]||c[1]!==i[1])m.push(i[0],i[1]);console.log(i.length,m.length,s,z);return m}function B(i,s){var z=i[0]-s[0],c=i[1]-s[1];return z*
z+c*c}function pa(i){for(var s=0,z=0,c=0,f=i.length-3;c<f;c+=2){s+=i[c];z+=i[c+1]}i=(i.length-2)*2;return[s/i<<0,z/i<<0]}var Ea=Ea||Array,Ia=Math.exp,Ja=Math.log,Ka=Math.tan,La=Math.atan,va=Math.min,Ma=Math.max,wa=l.document,M=function(){function i(c,f,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return c+(f-c)*6*j;if(j<0.5)return f;if(j<2/3)return c+(f-c)*(2/3-j)*6;return c}function s(c,f,j,m){this.r=c;this.g=f;this.b=j;this.a=arguments.length<4?1:m}var z=s.prototype;z.toString=function(){return"rgba("+[this.r<<
0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};z.adjustLightness=function(c){var f=M.toHSLA(this);f.l*=c;f.l=Math.min(1,Math.max(0,f.l));var j,m;if(f.s===0)c=j=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var r=2*f.l-m;c=i(r,m,f.h+1/3);j=i(r,m,f.h);m=i(r,m,f.h-1/3)}return new M(c*255<<0,j*255<<0,m*255<<0,f.a)};z.adjustAlpha=function(c){return new M(this.r,this.g,this.b,this.a*c)};s.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new M(parseInt(c[1],
16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new M(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};s.toHSLA=function(c){var f=c.r/255,j=c.g/255,m=c.b/255,r=Math.max(f,j,m),G=Math.min(f,j,m),H,w=(r+G)/2,x;if(r===G)H=G=0;else{x=r-G;G=w>0.5?x/(2-r-G):x/(r+G);switch(r){case f:H=(j-m)/x+(j<m?6:0);break;case j:H=(m-f)/x+2;break;case m:H=(f-j)/x+4;break}H/=6}return{h:H,s:G,l:w,
a:c.a}};return s}(),da=Math.PI,Fa=da/2,Na=da/4,Oa=180/da,Pa=256,xa=14,ea=400,Ga=ea-50,fa="latitude",ga="longitude",J=0,U=1,N=2,V=3,qa=4,ha=5,R=6;l.OSMBuildings=function(i){function s(a,e){var b={};a/=ia;e/=ia;b[fa]=e<=0?90:e>=1?-90:Oa*(2*La(Ia(da*(1-2*e)))-Fa);b[ga]=(a===1?1:(a%1+1)%1)*360-180;return b}function z(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||
b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!ya||K<xa)){var a=s(aa-ja,ba-za),e=s(aa+Z+ja,ba+S+za);ra&&ra.abort();ra=c(z(ya,{w:a[ga],n:a[fa],e:e[ga],s:e[fa],z:K}),j)}}function j(a){var e,b,d,h=[],g,k=g=0;ka=xa;w(K);ra=null;if(!(!a||a.meta.z!==K)){d=a.meta;b=a.data;if(C&&v&&C.z===d.z){g=C.x-d.x;k=C.y-d.y;a=0;for(e=v.length;a<e;a++)h[a]=v[a][N][0]+g+","+(v[a][N][1]+k)}C=d;v=[];a=0;for(e=b.length;a<e;a++){d=[];g=F(b[a][N],b[a][J]);
if(!(g.length<8)){d[N]=g;d[qa]=pa(g);d[J]=va(b[a][J],Ga);d[U]=b[a][U];g=d[N][0]+","+d[N][1];d[ha]=!(h&&~h.indexOf(g));d[V]=[];d[R]=[];v.push(d)}}x()}}function m(a,e){var b=[],d,h,g,k,n,o,p,t,W=Aa-K;d=0;for(h=a.length;d<h;d++){n=a[d];o=n[N];t=new Ea(o.length);g=0;for(k=o.length-1;g<k;g+=2){p=o[g+1];var I=va(1,Ma(0,0.5-Ja(Ka(Na+Fa*o[g]/180))/da/2));p={x:(p/360+0.5)*ia<<0,y:I*ia<<0};t[g]=p.x;t[g+1]=p.y}t=F(t,n[J]);if(!(t.length<8)){k=[];k[N]=t;k[qa]=pa(t);k[J]=va(n[J]>>W,Ga);k[U]=n[U];k[ha]=e;k[V]=n[V];
k[R]=[];for(g=0;g<3;g++)if(k[V][g])k[R][g]=k[V][g].adjustAlpha(O)+"";b.push(k)}}return b}function r(a,e){if(typeof a==="object")H(a,!e);else{var b=wa.documentElement,d=wa.createElement("script");l.jsonpCallback=function(h){delete l.jsonpCallback;b.removeChild(d);H(h,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function G(a,e,b){if(b===undefined)b=[];var d,h,g,k=a[0]?a:a.features,n,o,p,t,W,I=e?1:0,X=e?0:1;if(k){d=0;for(a=k.length;d<a;d++)G(k[d],e,b);return b}if(a.type===
"Feature"){n=a.geometry;d=a.properties}if(n.type==="Polygon")o=[n.coordinates];if(n.type==="MultiPolygon")o=n.coordinates;if(o){e=d.height;if(d.color||d.wallColor)t=M.parse(d.color||d.wallColor);if(d.roofColor)W=M.parse(d.roofColor);d=0;for(a=o.length;d<a;d++){k=o[d][0];p=[];h=n=0;for(g=k.length;h<g;h++){p.push(k[h][I],k[h][X]);n+=e||k[h][2]||0}if(n){h=[];g=N;var u=void 0,q=void 0,D=void 0,P=void 0,la=0,Q=void 0,Ha=void 0;Q=0;for(Ha=p.length-3;Q<Ha;Q+=2){u=p[Q];q=p[Q+1];D=p[Q+2];P=p[Q+3];la+=u*P-
D*q}if((la/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}h[g]=p;h[J]=n/k.length<<0;h[V]=[t||null,t?t.adjustLightness(0.8):null,W?W:t?t.adjustLightness(1.2):$];b.push(h)}}}return b}function H(a,e){if(a){ma=G(a,e);ka=0;w(K);C={n:90,w:-180,s:-90,e:180,x:0,y:0,z:K};v=m(ma,true);x()}else{ma=null;A()}}function w(a){var e,b,d;K=a;ia=Pa<<K;O=1-(K-ka)*0.3/(Aa-ka);Ba=Y.adjustAlpha(O)+"";sa=ta.adjustAlpha(O)+"";ua=$.adjustAlpha(O)+"";if(v){a=0;for(e=v.length;a<e;a++){d=
v[a];d[R]=[];for(b=0;b<3;b++)if(d[V][b])d[R][b]=d[V][b].adjustAlpha(O)+""}}}function x(){ca=0;clearInterval(Ca);Ca=setInterval(function(){ca+=0.1;if(ca>1){clearInterval(Ca);ca=1;for(var a=0,e=v.length;a<e;a++)v[a][ha]=0}A()},33)}function A(){y.clearRect(0,0,Z,S);if(C&&v)if(!(K<ka||Da)){var a,e,b,d,h,g,k,n,o,p=aa-C.x,t=ba-C.y,W=[na+p,oa+t],I,X,u,q,D,P;v.sort(function(la,Q){return B(Q[qa],W)/Q[J]-B(la[qa],W)/la[J]});a=0;for(e=v.length;a<e;a++){h=v[a];u=false;g=h[N];I=[];b=0;for(d=g.length-1;b<d;b+=
2){I[b]=n=g[b]-p;I[b+1]=o=g[b+1]-t;u||(u=n>0&&n<Z&&o>0&&o<S)}if(u){b=h[ha]?h[J]*ca:h[J];g=ea/(ea-b);if(h[U]){b=h[ha]?h[U]*ca:h[U];k=ea/(ea-b)}n=[];X=[];b=0;for(d=I.length-3;b<d;b+=2){o=I[b];q=I[b+1];u=I[b+2];D=I[b+3];P=L(o,q,g);X=L(u,D,g);if(h[U]){q=L(o,q,k);D=L(u,D,k);o=q.x;q=q.y;u=D.x;D=D.y}if((u-o)*(P.y-q)>(P.x-o)*(D-q)){X=[u+0.5,D+0.5,o+0.5,q+0.5,P.x,P.y,X.x,X.y];y.fillStyle=o<u&&q<D||o>u&&q>D?h[R][1]||sa:h[R][0]||Ba;T(X)}n[b]=P.x;n[b+1]=P.y}y.fillStyle=h[R][2]||ua;y.strokeStyle=h[R][1]||sa;T(n,
true)}}}}function T(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function L(a,e,b){return{x:((a-na)*b+na<<0)+0.5,y:((e-oa)*b+oa<<0)+0.5}}var Z=0,S=0,ja=0,za=0,aa=0,ba=0,K,ia,ra,E,y,ya,Y=new M(200,190,180),ta=Y.adjustLightness(0.8),$=Y.adjustLightness(1.2),Ba=Y+"",sa=ta+"",ua=$+"",ma,C,v,ca=1,Ca,O=1,ka=xa,Aa=20,na,oa,Da;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){Y=M.parse(a.color||
a.wallColor);Ba=Y.adjustAlpha(O)+"";ta=Y.adjustLightness(0.8);sa=ta.adjustAlpha(O)+"";$=Y.adjustLightness(1.2);ua=$.adjustAlpha(O)+""}if(a.roofColor){$=M.parse(a.roofColor);ua=$.adjustAlpha(O)+""}A();return this};this.geoJSON=function(a,e){r(a,e);return this};this.setCamOffset=function(a,e){na=ja+a;oa=S+e};this.setMaxZoom=function(a){Aa=a};this.createCanvas=function(a){E=wa.createElement("canvas");E.style.webkitTransform="translate3d(0,0,0)";E.style.imageRendering="optimizeSpeed";E.style.position=
"absolute";E.style.pointerEvents="none";E.style.left=0;E.style.top=0;a.appendChild(E);y=E.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return E};this.destroyCanvas=function(){E.parentNode.removeChild(E)};this.loadData=f;this.onMoveEnd=function(){var a=s(aa,ba),e=s(aa+Z,ba+S);A();if(C&&(a[fa]>C.n||a[ga]<C.w||e[fa]<C.s||e[ga]>C.e))f()};this.onZoomEnd=function(a){Da=false;w(a.zoom);if(ma){v=m(ma);A()}else{A();f()}};this.onZoomStart=
function(){Da=true;A()};this.render=A;this.setOrigin=function(a,e){aa=a;ba=e};this.setSize=function(a,e){Z=a;S=e;ja=Z/2<<0;za=S/2<<0;na=ja;oa=S;E.width=Z;E.height=S};this.setZoom=w;ya=i};l.OSMBuildings.VERSION="0.1.7a";l.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(l){l=l||{};l.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,l)},setOrigin:function(){var l=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),F=this.map.resolution,B=this.maxExtent;this.osmb.setOrigin(Math.round((l.lon-B.left)/F),Math.round((B.top-
l.lat)/F))},setMap:function(l){if(!this.map){OpenLayers.Layer.prototype.setMap(l);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(l){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(l)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(l,F,B){l=OpenLayers.Layer.prototype.moveTo(l,F,B);if(!B){B=parseInt(this.map.layerContainerDiv.style.left,10);var pa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-B+"px";this.div.style.top=-pa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);F?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return l},moveByPx:function(l,F){this.dxSum+=l;this.dySum+=F;var B=OpenLayers.Layer.prototype.moveByPx(l,F);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return B},geoJSON:function(l,F){return this.osmb.geoJSON(l,F)},setStyle:function(l){return this.osmb.setStyle(l)}});
