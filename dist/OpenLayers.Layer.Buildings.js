(function(k){function D(l,r){var w=l[0]-r[0],d=l[1]-r[1];return w*w+d*d}function F(l){for(var r=0,w=0,d=0,f=l.length-3;d<f;d+=2){r+=l[d];w+=l[d+1]}l=(l.length-2)*2;return[r/l<<0,w/l<<0]}function qa(l){var r=l.length/2,w=new Ea(r),d=0,f=r-1,g,m,s,x,E=[],L=[],G=[];for(w[d]=w[f]=1;f;){m=0;for(g=d+1;g<f;g++){s=l[g*2];var M=l[g*2+1],X=l[d*2],P=l[d*2+1],Q=l[f*2],H=l[f*2+1],z=Q-X,I=H-P,J=void 0;if(z!==0||I!==0){J=((s-X)*z+(M-P)*I)/(z*z+I*I);if(J>1){X=Q;P=H}else if(J>0){X+=z*J;P+=I*J}}z=s-X;I=M-P;s=z*z+I*
I;if(s>m){x=g;m=s}}if(m>7){w[x]=1;E.push(d);L.push(x);E.push(x);L.push(f)}d=E.pop();f=L.pop()}for(g=0;g<r;g++)w[g]&&G.push(l[g*2],l[g*2+1]);return G}var Fa=Fa||Array,Ea=Ea||Array,Ja=Math.exp,Ka=Math.log,La=Math.tan,Ma=Math.atan,wa=Math.min,Na=Math.max,xa=k.document,R=function(){function l(d,f,g){if(g<0)g+=1;if(g>1)g-=1;if(g<1/6)return d+(f-d)*6*g;if(g<0.5)return f;if(g<2/3)return d+(f-d)*(2/3-g)*6;return d}function r(d,f,g,m){this.r=d;this.g=f;this.b=g;this.a=arguments.length<4?1:m}var w=r.prototype;
w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(d){var f=R.toHSLA(this);f.l*=d;f.l=Math.min(1,Math.max(0,f.l));var g,m;if(f.s===0)d=g=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var s=2*f.l-m;d=l(s,m,f.h+1/3);g=l(s,m,f.h);m=l(s,m,f.h-1/3)}return new R(d*255<<0,g*255<<0,m*255<<0,f.a)};w.adjustAlpha=function(d){return new R(this.r,this.g,this.b,this.a*d)};r.parse=function(d){d+="";if(~d.indexOf("#")){d=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);
return new R(parseInt(d[1],16),parseInt(d[2],16),parseInt(d[3],16),d[4]?parseInt(d[4],16)/255:1)}if(d=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new R(parseInt(d[1],10),parseInt(d[2],10),parseInt(d[3],10),d[4]?parseFloat(d[5],10):1)};r.toHSLA=function(d){var f=d.r/255,g=d.g/255,m=d.b/255,s=Math.max(f,g,m),x=Math.min(f,g,m),E,L=(s+x)/2,G;if(s===x)E=x=0;else{G=s-x;x=L>0.5?G/(2-s-x):G/(s+x);switch(s){case f:E=(g-m)/G+(g<m?6:0);break;case g:E=(m-f)/G+2;break;case m:E=(f-g)/G+4;break}E/=
6}return{h:E,s:x,l:L,a:d.a}};return r}(),fa=Math.PI,Ga=fa/2,Oa=fa/4,Pa=180/fa,Qa=256,ya=14,ga=400,Ha=ga-50,ha="latitude",ia="longitude",N=0,Y=1,S=2,Z=3,ra=4,ja=5,W=6;k.OSMBuildings=function(l){function r(a,e){var b={};a/=ka;e/=ka;b[ha]=e<=0?90:e>=1?-90:Pa*(2*Ma(Ja(fa*(1-2*e)))-Ga);b[ia]=(a===1?1:(a%1+1)%1)*360-180;return b}function w(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return e[c]})}function d(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||
b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!za||O<ya)){var a=r(J-z,da-I),e=r(J+Q+z,da+H+I);sa&&sa.abort();sa=d(w(za,{w:a[ia],n:a[ha],e:e[ia],s:e[ha],z:O}),g)}}function g(a){var e,b,c,i=[],h,j=h=0;la=ya;L(O);sa=null;if(!(!a||a.meta.z!==O)){c=a.meta;b=a.data;if(A&&v&&A.z===c.z){h=A.x-c.x;j=A.y-c.y;a=0;for(e=v.length;a<e;a++)i[a]=v[a][S][0]+h+","+(v[a][S][1]+j)}A=c;v=[];a=0;for(e=b.length;a<e;a++){c=[];h=qa(b[a][S],
b[a][N]);if(!(h.length<8)){c[S]=h;c[ra]=F(h);c[N]=wa(b[a][N],Ha);c[Y]=b[a][Y];h=c[S][0]+","+c[S][1];c[ja]=!(i&&~i.indexOf(h));c[Z]=[];c[W]=[];v.push(c)}}G()}}function m(a,e){var b=[],c,i,h,j,n,o,p,t,$=Aa-O;c=0;for(i=a.length;c<i;c++){n=a[c];o=n[S];t=new Fa(o.length);h=0;for(j=o.length-1;h<j;h+=2){p=o[h+1];var K=wa(1,Na(0,0.5-Ka(La(Oa+Ga*o[h]/180))/fa/2));p={x:(p/360+0.5)*ka<<0,y:K*ka<<0};t[h]=p.x;t[h+1]=p.y}t=qa(t,n[N]);if(!(t.length<8)){j=[];j[S]=t;j[ra]=F(t);j[N]=wa(n[N]>>$,Ha);j[Y]=n[Y];j[ja]=
e;j[Z]=n[Z];j[W]=[];for(h=0;h<3;h++)if(j[Z][h])j[W][h]=j[Z][h].adjustAlpha(T)+"";b.push(j)}}return b}function s(a,e){if(typeof a==="object")E(a,!e);else{var b=xa.documentElement,c=xa.createElement("script");k.jsonpCallback=function(i){delete k.jsonpCallback;b.removeChild(c);E(i,!e)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function x(a,e,b){if(b===undefined)b=[];var c,i,h,j=a[0]?a:a.features,n,o,p,t,$,K=e?1:0,aa=e?0:1;if(j){c=0;for(a=j.length;c<a;c++)x(j[c],e,b);
return b}if(a.type==="Feature"){n=a.geometry;c=a.properties}if(n.type==="Polygon")o=[n.coordinates];if(n.type==="MultiPolygon")o=n.coordinates;if(o){e=c.height;if(c.color||c.wallColor)t=R.parse(c.color||c.wallColor);if(c.roofColor)$=R.parse(c.roofColor);c=0;for(a=o.length;c<a;c++){j=o[c][0];p=[];i=n=0;for(h=j.length;i<h;i++){p.push(j[i][K],j[i][aa]);n+=e||j[i][2]||0}if(n){i=[];h=S;var u=void 0,q=void 0,B=void 0,U=void 0,ma=0,V=void 0,Ia=void 0;V=0;for(Ia=p.length-3;V<Ia;V+=2){u=p[V];q=p[V+1];B=p[V+
2];U=p[V+3];ma+=u*U-B*q}if((ma/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}i[h]=p;i[N]=n/j.length<<0;i[Z]=[t||null,t?t.adjustLightness(0.8):null,$?$:t?t.adjustLightness(1.2):ca];b.push(i)}}}return b}function E(a,e){if(a){na=x(a,e);la=0;L(O);A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:O};v=m(na,true);G()}else{na=null;M()}}function L(a){var e,b,c;O=a;ka=Qa<<O;T=1-(O-la)*0.3/(Aa-la);Ba=ba.adjustAlpha(T)+"";ta=ua.adjustAlpha(T)+"";va=ca.adjustAlpha(T)+"";if(v){a=0;
for(e=v.length;a<e;a++){c=v[a];c[W]=[];for(b=0;b<3;b++)if(c[Z][b])c[W][b]=c[Z][b].adjustAlpha(T)+""}}}function G(){ea=0;clearInterval(Ca);Ca=setInterval(function(){ea+=0.1;if(ea>1){clearInterval(Ca);ea=1;for(var a=0,e=v.length;a<e;a++)v[a][ja]=0}M()},33)}function M(){y.clearRect(0,0,Q,H);if(A&&v)if(!(O<la||Da)){var a,e,b,c,i,h,j,n,o,p=J-A.x,t=da-A.y,$=[oa+p,pa+t],K,aa,u,q,B,U;v.sort(function(ma,V){return D(V[ra],$)/V[N]-D(ma[ra],$)/ma[N]});a=0;for(e=v.length;a<e;a++){i=v[a];u=false;h=i[S];K=[];b=
0;for(c=h.length-1;b<c;b+=2){K[b]=n=h[b]-p;K[b+1]=o=h[b+1]-t;u||(u=n>0&&n<Q&&o>0&&o<H)}if(u){b=i[ja]?i[N]*ea:i[N];h=ga/(ga-b);if(i[Y]){b=i[ja]?i[Y]*ea:i[Y];j=ga/(ga-b)}n=[];aa=[];b=0;for(c=K.length-3;b<c;b+=2){o=K[b];q=K[b+1];u=K[b+2];B=K[b+3];U=P(o,q,h);aa=P(u,B,h);if(i[Y]){q=P(o,q,j);B=P(u,B,j);o=q.x;q=q.y;u=B.x;B=B.y}if((u-o)*(U.y-q)>(U.x-o)*(B-q)){aa=[u+0.5,B+0.5,o+0.5,q+0.5,U.x,U.y,aa.x,aa.y];y.fillStyle=o<u&&q<B||o>u&&q>B?i[W][1]||ta:i[W][0]||Ba;X(aa)}n[b]=U.x;n[b+1]=U.y}y.fillStyle=i[W][2]||
va;y.strokeStyle=i[W][1]||ta;X(n,true)}}}}function X(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function P(a,e,b){return{x:((a-oa)*b+oa<<0)+0.5,y:((e-pa)*b+pa<<0)+0.5}}var Q=0,H=0,z=0,I=0,J=0,da=0,O,ka,sa,C,y,za,ba=new R(200,190,180),ua=ba.adjustLightness(0.8),ca=ba.adjustLightness(1.2),Ba=ba+"",ta=ua+"",va=ca+"",na,A,v,ea=1,Ca,T=1,la=ya,Aa=20,oa,pa,Da;this.setStyle=function(a){a=(a=a)||{};if(a.color||
a.wallColor){ba=R.parse(a.color||a.wallColor);Ba=ba.adjustAlpha(T)+"";ua=ba.adjustLightness(0.8);ta=ua.adjustAlpha(T)+"";ca=ba.adjustLightness(1.2);va=ca.adjustAlpha(T)+""}if(a.roofColor){ca=R.parse(a.roofColor);va=ca.adjustAlpha(T)+""}M();return this};this.geoJSON=function(a,e){s(a,e);return this};this.setCamOffset=function(a,e){oa=z+a;pa=H+e};this.setMaxZoom=function(a){Aa=a};this.createCanvas=function(a){C=xa.createElement("canvas");C.style.webkitTransform="translate3d(0,0,0)";C.style.imageRendering=
"optimizeSpeed";C.style.position="absolute";C.style.pointerEvents="none";C.style.left=0;C.style.top=0;a.appendChild(C);y=C.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return C};this.destroyCanvas=function(){C.parentNode.removeChild(C)};this.loadData=f;this.onMoveEnd=function(){var a=r(J,da),e=r(J+Q,da+H);M();if(A&&(a[ha]>A.n||a[ia]<A.w||e[ha]<A.s||e[ia]>A.e))f()};this.onZoomEnd=function(a){Da=false;L(a.zoom);if(na){v=m(na);M()}else{M();
f()}};this.onZoomStart=function(){Da=true;M()};this.render=M;this.setOrigin=function(a,e){J=a;da=e};this.setSize=function(a,e){Q=a;H=e;z=Q/2<<0;I=H/2<<0;oa=z;pa=H;C.width=Q;C.height=H};this.setZoom=L;za=l};k.OSMBuildings.VERSION="0.1.7a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(k){k=k||{};k.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,k)},setOrigin:function(){var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),D=this.map.resolution,F=this.maxExtent;this.osmb.setOrigin(Math.round((k.lon-F.left)/D),Math.round((F.top-
k.lat)/D))},setMap:function(k){if(!this.map){OpenLayers.Layer.prototype.setMap(k);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(k){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(k)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(k,D,F){k=OpenLayers.Layer.prototype.moveTo(k,D,F);if(!F){F=parseInt(this.map.layerContainerDiv.style.left,10);var qa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-F+"px";this.div.style.top=-qa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);D?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return k},moveByPx:function(k,D){this.dxSum+=k;this.dySum+=D;var F=OpenLayers.Layer.prototype.moveByPx(k,D);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return F},geoJSON:function(k,D){return this.osmb.geoJSON(k,D)},setStyle:function(k){return this.osmb.setStyle(k)}});
