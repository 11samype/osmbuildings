(function(j){var v=v||Array,C=Math.exp,ja=Math.log,za=Math.tan,Aa=Math.atan,ka=Math.min,ua=Math.max,la=j.document,D=function(){function W(g,i,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return g+(i-g)*6*l;if(l<0.5)return i;if(l<2/3)return g+(i-g)*(2/3-l)*6;return g}function I(g,i,l,o){this.r=g;this.g=i;this.b=l;this.a=arguments.length<4?1:o}var X=I.prototype;X.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};X.adjustLightness=function(g){var i=D.toHSLA(this);i.l*=
g;i.l=Math.min(1,Math.max(0,i.l));var l,o;if(i.s===0)g=l=o=i.l;else{o=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var z=2*i.l-o;g=W(z,o,i.h+1/3);l=W(z,o,i.h);o=W(z,o,i.h-1/3)}return new D(g*255<<0,l*255<<0,o*255<<0,i.a)};X.adjustAlpha=function(g){return new D(this.r,this.g,this.b,this.a*g)};I.parse=function(g){g+="";if(~g.indexOf("#")){g=g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new D(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new D(parseInt(g[1],
10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};I.toHSLA=function(g){var i=g.r/255,l=g.g/255,o=g.b/255,z=Math.max(i,l,o),E=Math.min(i,l,o),J,O=(z+E)/2,K;if(z===E)J=E=0;else{K=z-E;E=O>0.5?K/(2-z-E):K/(z+E);switch(z){case i:J=(l-o)/K+(l<o?6:0);break;case l:J=(o-i)/K+2;break;case o:J=(i-l)/K+4;break}J/=6}return{h:J,s:E,l:O,a:g.a}};return I}(),Y=Math.PI,va=Y/2,Ba=Y/4,Ca=180/Y,Da=256,ma=14,na=400,wa=na-50,Z="latitude",$="longitude",P=0,F=1,w=2,fa=3;j.OSMBuildings=function(W){function I(a,
d){var b={};a/=aa;d/=aa;b[Z]=d<=0?90:d>=1?-90:Ca*(2*Aa(C(Y*(1-2*d)))-va);b[$]=(a===1?1:(a%1+1)%1)*360-180;return b}function X(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function g(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!oa||A<ma)){var a=I(R-ba,S-pa),d=I(R+Q+ba,S+L+pa);ga&&ga.abort();ga=g(X(oa,
{w:a[$],n:a[Z],e:d[$],s:d[Z],z:A}),l)}}function l(a){var d,b,c,f=[],h,e=h=0,m=ua(1,(A-T)*2);T=ma;O(A);ga=null;if(!(!a||a.meta.z!==A)){c=a.meta;b=a.data;if(t&&x&&t.z===c.z){h=t.x-c.x;e=t.y-c.y;a=0;for(d=x.length;a<d;a++)f[a]=x[a][F][0]+h+","+(x[a][F][1]+e)}t=c;x=[];a=0;for(d=b.length;a<d;a++){c={};h=F;e=b[a][F];for(var q=m*m,k=void 0,n=[e[0],e[1]],s=[e[0],e[1]],p=2,G=e.length-3;p<G;p+=2){k=[e[p],e[p+1]];var B=k[0]-n[0],y=k[1]-n[1];if(B*B+y*y>q){s.push(k[0],k[1]);n=k}}if(k[0]!==e[0]||k[1]!==e[1])s.push(e[0],
e[1]);c[h]=s;if(!(c[F].length<8)){c[P]=ka(b[a][P],wa);h=b[a][F][0]+","+b[a][F][1];c[fa]=!(f&&~f.indexOf(h));x.push(c)}}K()}}function o(a,d){var b=[],c,f,h,e,m,q,k,n,s=qa-A;c=0;for(f=a.length;c<f;c++){m=a[c];q=m[F];k=new v(q.length);h=0;for(e=q.length-1;h<e;h+=2){n=q[h+1];var p=ka(1,ua(0,0.5-ja(za(Ba+va*q[h]/180))/Y/2));n={x:(n/360+0.5)*aa<<0,y:p*aa<<0};k[h]=n.x;k[h+1]=n.y}b[c]=[];b[c][P]=ka(m[P]>>s,wa);b[c][F]=k;b[c][w]=m[w];b[c][fa]=d}return b}function z(a,d){if(typeof a==="object")J(a,!d);else{var b=
la.documentElement,c=la.createElement("script");j.jsonpCallback=function(f){delete j.jsonpCallback;b.removeChild(c);J(f,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function E(a,d,b){if(b===undefined)b=[];var c,f,h,e=a[0]?a:a.features,m,q,k,n,s,p=d?1:0,G=d?0:1;if(e){c=0;for(a=e.length;c<a;c++)E(e[c],d,b);return b}if(a.type==="Feature"){f=a.geometry;c=a.properties}if(f.type==="Polygon")m=[f.coordinates];if(f.type==="MultiPolygon")m=f.coordinates;if(m){d=c.height;
if(c.color||c.wallColor)n=D.parse(c.color||c.wallColor);if(c.roofColor)s=D.parse(c.roofColor);c=0;for(a=m.length;c<a;c++){q=m[c][0];e=[];f=k=0;for(h=q.length;f<h;f++){e.push(q[f][p],q[f][G]);k+=d||q[f][2]||0}if(k){f=[];f[P]=k/q.length<<0;q=F;k=void 0;h=void 0;var B=void 0,y=void 0,ca=0,H=void 0,xa=void 0;H=0;for(xa=e.length-3;H<xa;H+=2){k=e[H];h=e[H+1];B=e[H+2];y=e[H+3];ca+=k*y-B*h}if((ca/2>0?"CW":"CCW")==="CW")e=e;else{k=[];for(h=e.length-2;h>=0;h-=2)k.push(e[h],e[h+1]);e=k}f[q]=e;if(n||s)f[w]=[n,
s];b.push(f)}}}return b}function J(a,d){if(a){da=E(a,d);T=0;O(A);t={n:90,w:-180,s:-90,e:180,x:0,y:0,z:A};x=o(da,true);K()}else{da=null;N()}}function O(a){A=a;aa=Da<<A;M=1-(A-T)*0.3/(qa-T)}function K(){ea=0;clearInterval(ra);ra=setInterval(function(){ea+=0.1;if(ea>1){clearInterval(ra);ea=1;for(var a=0,d=x.length;a<d;a++)x[a][fa]=0}N()},33)}function N(){r.clearRect(0,0,Q,L);if(t&&x)if(!(A<T||sa)){var a,d,b,c,f,h,e,m,q=R-t.x,k=S-t.y,n,s,p,G,B,y,ca=ha.adjustAlpha(M)+"",H=(ta||ha.adjustLightness(1.2)).adjustAlpha(M)+
"";if(ia)r.strokeStyle=Ea.adjustAlpha(M)+"";a=0;for(d=x.length;a<d;a++){f=x[a];p=false;h=f[F];n=[];b=0;for(c=h.length-1;b<c;b+=2){n[b]=e=h[b]-q;n[b+1]=m=h[b+1]-k;p||(p=e>0&&e<Q&&m>0&&m<L)}if(p){r.fillStyle=f[w]&&f[w][0]?f[w][0].adjustAlpha(M)+"":ca;b=f[fa]?f[P]*ea:f[P];h=na/(na-b);e=[];b=0;for(c=n.length-3;b<c;b+=2){m=n[b];p=n[b+1];G=n[b+2];B=n[b+3];y={x:((m-U)*h+U<<0)+0.5,y:((p-V)*h+V<<0)+0.5};s={x:((G-U)*h+U<<0)+0.5,y:((B-V)*h+V<<0)+0.5};if((G-m)*(y.y-p)>(y.x-m)*(B-p)){s=[G+0.5,B+0.5,m+0.5,p+0.5,
y.x,y.y,s.x,s.y];r.fillStyle=m<G&&p<B||m>G&&p>B?ha.adjustAlpha(M).adjustLightness(0.8)+"":f[w]&&f[w][0]?f[w][0].adjustAlpha(M)+"":ca;ya(s)}e[b]=y.x;e[b+1]=y.y}r.fillStyle=!f[w]?H:f[w][1]?f[w][1].adjustAlpha(M)+"":ta?H:f[w][0].adjustLightness(1.2).adjustAlpha(M)+"";ya(e,ia)}}}}function ya(a,d){if(a.length){r.beginPath();r.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)r.lineTo(a[b],a[b+1]);r.closePath();d&&r.stroke();r.fill()}}var Q=0,L=0,ba=0,pa=0,R=0,S=0,A,aa,ga,u,r,oa,ia,ha=new D(200,190,180),
ta,Ea=new D(145,140,135),da,t,x,M=1,ea=1,ra,T=ma,qa=20,U,V,sa;this.setStyle=function(a){a=(a=a)||{};ia=a.strokeRoofs!==undefined?a.strokeRoofs:ia;if(a.color||a.wallColor)ha=D.parse(a.color||a.wallColor);if(a.roofColor!==undefined)ta=D.parse(a.roofColor);N();return this};this.geoJSON=function(a,d){z(a,d);return this};this.setCamOffset=function(a,d){U=ba+a;V=L+d};this.setMaxZoom=function(a){qa=a};this.createCanvas=function(a){u=la.createElement("canvas");u.style.webkitTransform="translate3d(0,0,0)";
u.style.imageRendering="optimizeSpeed";u.style.position="absolute";u.style.pointerEvents="none";u.style.left=0;u.style.top=0;a.appendChild(u);r=u.getContext("2d");r.lineCap="round";r.lineJoin="round";r.lineWidth=1;try{r.mozImageSmoothingEnabled=false}catch(d){}return u};this.destroyCanvas=function(){u.parentNode.removeChild(u)};this.loadData=i;this.onMoveEnd=function(){var a=I(R,S),d=I(R+Q,S+L);N();if(t&&(a[Z]>t.n||a[$]<t.w||d[Z]<t.s||d[$]>t.e))i()};this.onZoomEnd=function(a){sa=false;O(a.zoom);if(da){x=
o(da);N()}else{N();i()}};this.onZoomStart=function(){sa=true;N()};this.render=N;this.setOrigin=function(a,d){R=a;S=d};this.setSize=function(a,d){Q=a;L=d;ba=Q/2<<0;pa=L/2<<0;U=ba;V=L;u.width=Q;u.height=L};this.setZoom=O;oa=W};j.OSMBuildings.VERSION="0.1.7a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(j){j=j||{};j.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,j)},setOrigin:function(){var j=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),v=this.map.resolution,C=this.maxExtent;this.osmb.setOrigin(Math.round((j.lon-C.left)/v),Math.round((C.top-
j.lat)/v))},setMap:function(j){if(!this.map){OpenLayers.Layer.prototype.setMap(j);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(j){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(j)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(j,v,C){j=OpenLayers.Layer.prototype.moveTo(j,v,C);if(!C){C=parseInt(this.map.layerContainerDiv.style.left,10);var ja=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-C+"px";this.div.style.top=-ja+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);v?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return j},moveByPx:function(j,v){this.dxSum+=j;this.dySum+=v;var C=OpenLayers.Layer.prototype.moveByPx(j,v);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return C},geoJSON:function(j,v){return this.osmb.geoJSON(j,v)},setStyle:function(j){return this.osmb.setStyle(j)}});
