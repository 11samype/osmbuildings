(function(n){function O(l,o){var y=l[0]-o[0],e=l[1]-o[1];return y*y+e*e}function P(l){for(var o=0,y=0,e=0,h=l.length-3;e<h;e+=2){o+=l[e];y+=l[e+1]}l=(l.length-2)*2;return[o/l<<0,y/l<<0]}function ua(l){var o=l.length/2,y=new Ka(o),e=0,h=o-1,i,q,m,G,K=[],S=[],J=[];for(y[e]=y[h]=1;h;){q=0;for(i=e+1;i<h;i++){m=l[i*2];var ea=l[i*2+1],H=l[e*2],Q=l[e*2+1],Z=l[h*2],L=l[h*2+1],v=Z-H,B=L-Q,E=void 0;if(v!==0||B!==0){E=((m-H)*v+(ea-Q)*B)/(v*v+B*B);if(E>1){H=Z;Q=L}else if(E>0){H+=v*E;Q+=B*E}}v=m-H;B=ea-Q;m=v*
v+B*B;if(m>q){G=i;q=m}}if(q>2){y[G]=1;K.push(e);S.push(G);K.push(G);S.push(h)}e=K.pop();h=S.pop()}for(i=0;i<o;i++)y[i]&&J.push(l[i*2],l[i*2+1]);return J}var La=La||Array,Ka=Ka||Array,ba=Math,Oa=ba.exp,Pa=ba.log,Qa=ba.sin,Ra=ba.cos,Ca=ba.tan,Sa=ba.atan,ja=ba.min,Da=ba.max,Ea=n.document,T=function(){function l(e,h,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(h-e)*6*i;if(i<0.5)return h;if(i<2/3)return e+(h-e)*(2/3-i)*6;return e}function o(e,h,i,q){this.r=e;this.g=h;this.b=i;this.a=arguments.length<
4?1:q}var y=o.prototype;y.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};y.adjustLightness=function(e){var h=T.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var i,q;if(h.s===0)e=i=q=h.l;else{q=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var m=2*h.l-q;e=l(m,q,h.h+1/3);i=l(m,q,h.h);q=l(m,q,h.h-1/3)}return new T(e*255<<0,i*255<<0,q*255<<0,h.a)};y.adjustAlpha=function(e){return new T(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new T(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new T(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var h=e.r/255,i=e.g/255,q=e.b/255,m=Math.max(h,i,q),G=Math.min(h,i,q),K,S=(m+G)/2,J;if(m===G)K=G=0;else{J=m-G;G=S>0.5?J/(2-m-G):J/(m+G);switch(m){case h:K=(i-q)/J+(i<q?6:0);break;case i:K=
(q-h)/J+2;break;case q:K=(h-i)/J+4;break}K/=6}return{h:K,s:G,l:S,a:e.a}};return o}(),Ta=function(){var l=Math,o=l.sin,y=l.cos,e=l.tan,h=l.asin,i=l.atan2,q=l.PI,m=180/q,G=357.5291/m,K=0.98560028/m,S=1.9148/m,J=0.02/m,ea=3.0E-4/m,H=102.9372/m,Q=23.45/m,Z=280.16/m,L=360.9856235/m;return function(v,B,E){E=-E/m;B=B/m;v=v.valueOf()/864E5-0.5+2440588;var D=G+K*(v-2451545),F=S*o(D)+J*o(2*D)+ea*o(3*D);F=D+H+F+q;D=h(o(F)*o(Q));F=i(o(F)*y(Q),y(F));E=Z+L*(v-2451545)-E-F;return{altitude:h(o(B)*o(D)+y(B)*y(D)*
y(E)),azimuth:i(o(E),y(E)*o(B)-e(D)*y(B))-q/2}}}(),ka=Math.PI,Ma=ka/2,Ua=ka/4,Va=180/ka,Wa=256,Fa=14,la="latitude",ma="longitude",X=0,R=1,U=2,ca=3,va=4,na=5,$=6;n.OSMBuildings=function(l){function o(a,c){var b={};a/=oa;c/=oa;b[la]=c<=0?90:c>=1?-90:Va*(2*Sa(Oa(ka*(1-2*c)))-Ma);b[ma]=(a===1?1:(a%1+1)%1)*360-180;return b}function y(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c,b,d,g){a=ja(Da(a,c),b);return ja(Da(d+(a-c)/(b-c)*(g-d),d),g)}function h(a,c){var b=new XMLHttpRequest;
b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!Ga||V<Fa)){var a=o(D-B,F-E),c=o(D+L+B,F+v+E);wa&&wa.abort();wa=h(y(Ga,{w:a[ma],n:a[la],e:c[ma],s:c[la],z:V}),q)}}function q(a){var c,b,d,g=[],f,j=f=0;xa=Fa;J(V);wa=null;if(!(!a||a.meta.z!==V)){d=a.meta;b=a.data;if(I&&C&&I.z===d.z){f=I.x-d.x;j=I.y-d.y;a=0;for(c=C.length;a<c;a++)g[a]=C[a][U][0]+f+","+(C[a][U][1]+
j)}I=d;C=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][R]>pa)){f=ua(b[a][U]);if(!(f.length<8)){d[U]=f;d[va]=P(f);d[X]=ja(b[a][X],pa);d[R]=b[a][R];f=d[U][0]+","+d[U][1];d[na]=!(g&&~g.indexOf(f));d[ca]=[];d[$]=[];C.push(d)}}}ea()}}function m(a,c){var b=[],d,g,f,j,k,r,w,z,s,x=Ha-V;d=0;for(g=a.length;d<g;d++){k=a[d];z=k[R]>>x;if(!(z>pa)){r=k[U];s=new La(r.length);f=0;for(j=r.length-1;f<j;f+=2){w=r[f+1];var t=ja(1,Da(0,0.5-Pa(Ca(Ua+Ma*r[f]/180))/ka/2));w={x:(w/360+0.5)*oa<<0,y:t*oa<<0};s[f]=w.x;s[f+1]=
w.y}s=ua(s);if(!(s.length<8)){j=[];j[U]=s;j[va]=P(s);j[X]=ja(k[X]>>x,pa);j[R]=z;j[na]=c;j[ca]=k[ca];j[$]=[];for(f=0;f<3;f++)if(j[ca][f])j[$][f]=j[ca][f].adjustAlpha(W)+"";b.push(j)}}}return b}function G(a,c){if(typeof a==="object")S(a,!c);else{var b=Ea.documentElement,d=Ea.createElement("script");n.jsonpCallback=function(g){delete n.jsonpCallback;b.removeChild(d);S(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function K(a,c,b){if(b===undefined)b=[];var d,g,f,
j=a[0]?a:a.features,k,r,w,z,s,x=c?1:0,t=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)K(j[d],c,b);return b}if(a.type==="Feature"){k=a.geometry;d=a.properties}if(k.type==="Polygon")r=[k.coordinates];if(k.type==="MultiPolygon")r=k.coordinates;if(r){c=d.height;if(d.color||d.wallColor)z=T.parse(d.color||d.wallColor);if(d.roofColor)s=T.parse(d.roofColor);d=0;for(a=r.length;d<a;d++){j=r[d][0];w=[];g=k=0;for(f=j.length;g<f;g++){w.push(j[g][x],j[g][t]);k+=c||j[g][2]||0}if(k){g=[];f=U;var u=void 0,A=void 0,N=void 0,
ga=void 0,qa=0,Y=void 0,Na=void 0;Y=0;for(Na=w.length-3;Y<Na;Y+=2){u=w[Y];A=w[Y+1];N=w[Y+2];ga=w[Y+3];qa+=u*ga-N*A}if((qa/2>0?"CW":"CCW")==="CW")w=w;else{u=[];for(A=w.length-2;A>=0;A-=2)u.push(w[A],w[A+1]);w=u}g[f]=w;g[X]=k/j.length<<0;g[ca]=[z||null,z?z.adjustLightness(0.8):null,s?s:z?z.adjustLightness(1.2):fa];b.push(g)}}}return b}function S(a,c){if(a){ra=K(a,c);xa=0;J(V);I={n:90,w:-180,s:-90,e:180,x:0,y:0,z:V};C=m(ra,true);ea()}else{ra=null;H()}}function J(a){var c,b,d;V=a;oa=Wa<<V;W=1-e(V,xa,
Ha,0,0.3);ya=da.adjustAlpha(W)+"";za=Aa.adjustAlpha(W)+"";Ba=fa.adjustAlpha(W)+"";aa.colorStr=aa.color.adjustAlpha(W)+"";if(C){a=0;for(c=C.length;a<c;a++){d=C[a];d[$]=[];for(b=0;b<3;b++)if(d[ca][b])d[$][b]=d[ca][b].adjustAlpha(W)+""}}}function ea(){ha=0;aa.create();clearInterval(Ia);Ia=setInterval(function(){ha+=0.1;if(ha>1){clearInterval(Ia);ha=1;for(var a=0,c=C.length;a<c;a++)C[a][na]=0}H()},33)}function H(){p.clearRect(0,0,L,v);if(I&&C)if(!(V<xa||Ja)){aa.enabled&&aa.render();var a,c,b,d,g,f,j,
k,r,w=D-I.x,z=F-I.y,s=[sa+w,ta+z],x,t,u,A,N,ga;C.sort(function(qa,Y){return O(Y[va],s)/Y[X]-O(qa[va],s)/qa[X]});a=0;for(c=C.length;a<c;a++){g=C[a];t=false;f=g[U];x=[];b=0;for(d=f.length-1;b<d;b+=2){x[b]=k=f[b]-w;x[b+1]=r=f[b+1]-z;t||(t=k>0&&k<L&&r>0&&r<v)}if(t){b=g[na]?g[X]*ha:g[X];f=ia/(ia-b);if(g[R]){b=g[na]?g[R]*ha:g[R];j=ia/(ia-b)}k=[];b=0;for(d=x.length-3;b<d;b+=2){r=x[b];u=x[b+1];t=x[b+2];A=x[b+3];N=Z(r,u,f);ga=Z(t,A,f);if(g[R]){u=Z(r,u,j);A=Z(t,A,j);r=u.x;u=u.y;t=A.x;A=A.y}if((t-r)*(N.y-u)>
(N.x-r)*(A-u)){p.fillStyle=r<t&&u<A||r>t&&u>A?g[$][1]||za:g[$][0]||ya;Q([t,A,r,u,N.x,N.y,ga.x,ga.y])}k[b]=N.x;k[b+1]=N.y}p.fillStyle=g[$][2]||Ba;p.strokeStyle=g[$][1]||za;Q(k,true)}}}}function Q(a,c){if(a.length){p.beginPath();p.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)p.lineTo(a[b],a[b+1]);p.closePath();c&&p.stroke();p.fill()}}function Z(a,c,b){return{x:(a-sa)*b+sa<<0,y:(c-ta)*b+ta<<0}}var L=0,v=0,B=0,E=0,D=0,F=0,V,oa,wa,M,p,Ga,da=new T(200,190,180),Aa=da.adjustLightness(0.8),fa=da.adjustLightness(1.2),
ya=da+"",za=Aa+"",Ba=fa+"",ra,I,C,ha=1,Ia,W=1,xa=Fa,Ha=20,pa,sa,ta,ia,Ja,aa={enabled:true,originX:0,originY:0,buffer:new Image,color:new T(0,0,0),colorStr:this.color+"",sunAlpha:1,length:0,directionX:0,directionY:0,create:function(){if(I&&C)if(this.length){console.log("creates buffer");this.originX=D;this.originY=F;var a,c,b,d,g,f,j,k,r=D-I.x,w=F-I.y,z,s,x,t,u,A,N=[];p.fillStyle=this.colorStr;a=0;for(c=C.length;a<c;a++){g=C[a];s=false;f=g[U];z=[];b=0;for(d=f.length-1;b<d;b+=2){z[b]=j=f[b]-r;z[b+1]=
k=f[b+1]-w;s||(s=j>0&&j<L&&k>0&&k<v)}if(s){f=g[X];if(g[R])f=g[R];j=null;p.beginPath();b=0;for(d=z.length-3;b<d;b+=2){k=z[b];x=z[b+1];s=z[b+2];t=z[b+3];u=this.project(k,x,f);A=this.project(s,t,f);if(g[R]){x=this.project(k,x,f);t=this.project(s,t,f);k=x.x;x=x.y;s=t.x;t=t.y}if((s-k)*(u.y-x)>(u.x-k)*(t-x)){j===1&&p.lineTo(k,x);j=0;b||p.moveTo(k,x);p.lineTo(s,t)}else{j===0&&p.lineTo(u.x,u.y);j=1;b||p.moveTo(u.x,u.y);p.lineTo(A.x,A.y)}}p.closePath();p.fill();N.push(z)}}p.fillStyle=ya;a=0;for(c=N.length;a<
c;a++)Q(N[a]);this.filter();this.buffer.src=M.toDataURL()}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},filter:function(){for(var a=p.getImageData(0,0,L,v),c=a.data,b=this.sunAlpha*255<<0,d,g,f=0,j=c.length;f<j;f+=4){d=c[f+0];g=c[f+3];if(d&&g>=255)c[f+3]=0;else if(g>b)c[f+3]=b}p.putImageData(a,0,0)},render:function(){if(this.length){console.log("should draw buffer");p.drawImage(this.buffer,this.originX-D,this.originY-F)}},setSun:function(a){if(a.altitude<=0){this.length=
0;this.sunAlpha=e(-a.altitude,0,1,0.1,0.8)}else{this.length=1/Ca(a.altitude);this.sunAlpha=0.4/this.length;this.directionX=Ra(a.azimuth)*this.length;this.directionY=Qa(a.azimuth)*this.length}this.color.a=this.sunAlpha;this.colorStr=this.color+"";this.create()}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=T.parse(a.color||a.wallColor);ya=da.adjustAlpha(W)+"";Aa=da.adjustLightness(0.8);za=Aa.adjustAlpha(W)+"";fa=da.adjustLightness(1.2);Ba=fa.adjustAlpha(W)+""}if(a.roofColor){fa=
T.parse(a.roofColor);Ba=fa.adjustAlpha(W)+""}if(a.shadows!==undefined)aa.enabled=!!a.shadows;H();return this};this.geoJSON=function(a,c){G(a,c);return this};this.setCamOffset=function(a,c){sa=B+a;ta=v+c};this.setMaxZoom=function(a){Ha=a};this.setDate=function(a){var c=o(D+B,F+E);aa.setSun(Ta(a,c.latitude,c.longitude));H();return this};this.createCanvas=function(a){M=Ea.createElement("CANVAS");M.style.webkitTransform="translate3d(0,0,0)";M.style.imageRendering="optimizeSpeed";M.style.position="absolute";
M.style.pointerEvents="none";M.style.left=0;M.style.top=0;a.appendChild(M);p=M.getContext("2d");p.lineCap="round";p.lineJoin="round";p.lineWidth=1;try{p.mozImageSmoothingEnabled=false}catch(c){}return M};this.destroyCanvas=function(){M.parentNode.removeChild(M)};this.loadData=i;this.onMoveEnd=function(){var a=o(D,F),c=o(D+L,F+v);aa.create();H();if(I&&(a[la]>I.n||a[ma]<I.w||c[la]<I.s||c[ma]>I.e))i()};this.onZoomEnd=function(a){Ja=false;J(a.zoom);if(ra){C=m(ra);aa.create();H()}else{H();i()}};this.onZoomStart=
function(){Ja=true;H()};this.render=H;this.setOrigin=function(a,c){D=a;F=c};this.setSize=function(a,c){L=a;v=c;B=L/2<<0;E=v/2<<0;sa=B;ta=v;ia=L/1.5/Ca(45)<<0;M.width=L;M.height=v;pa=ia-50};this.setZoom=J;Ga=l};n.OSMBuildings.VERSION="0.1.8a";n.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(n){n=n||{};n.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,n)},setOrigin:function(){var n=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),O=this.map.resolution,P=this.maxExtent;this.osmb.setOrigin(Math.round((n.lon-P.left)/O),Math.round((P.top-
n.lat)/O))},setMap:function(n){if(!this.map){OpenLayers.Layer.prototype.setMap(n);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(n){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(n)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(n,O,P){n=OpenLayers.Layer.prototype.moveTo(n,O,P);if(!P){P=parseInt(this.map.layerContainerDiv.style.left,10);var ua=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-P+"px";this.div.style.top=-ua+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);O?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return n},moveByPx:function(n,O){this.dxSum+=n;this.dySum+=O;var P=OpenLayers.Layer.prototype.moveByPx(n,O);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return P},geoJSON:function(n,O){return this.osmb.geoJSON(n,O)},setStyle:function(n){return this.osmb.setStyle(n)},setDate:function(n){return this.osmb.setDate(n)}});
