(function(p){function N(m,q){var w=m[0]-q[0],f=m[1]-q[1];return w*w+f*f}function Q(m){for(var q=0,w=0,f=0,i=m.length-3;f<i;f+=2){q+=m[f];w+=m[f+1]}m=(m.length-2)*2;return[q/m<<0,w/m<<0]}function za(m){var q=m.length/2,w=new La(q),f=0,i=q-1,j,r,n,G,L=[],T=[],J=[];for(w[f]=w[i]=1;i;){r=0;for(j=f+1;j<i;j++){n=m[j*2];var ea=m[j*2+1],K=m[f*2],U=m[f*2+1],Z=m[i*2],H=m[i*2+1],u=Z-K,z=H-U,C=void 0;if(u!==0||z!==0){C=((n-K)*u+(ea-U)*z)/(u*u+z*z);if(C>1){K=Z;U=H}else if(C>0){K+=u*C;U+=z*C}}u=n-K;z=ea-U;n=u*
u+z*z;if(n>r){G=j;r=n}}if(r>2){w[G]=1;L.push(f);T.push(G);L.push(G);T.push(i)}f=L.pop();i=T.pop()}for(j=0;j<q;j++)w[j]&&J.push(m[j*2],m[j*2+1]);return J}var Ma=Ma||Array,La=La||Array,aa=Math,Pa=aa.exp,Qa=aa.log,Ra=aa.sin,Sa=aa.cos,Ea=aa.tan,Ta=aa.atan,la=aa.min,Fa=aa.max,Aa=p.document,V=function(){function m(f,i,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return f+(i-f)*6*j;if(j<0.5)return i;if(j<2/3)return f+(i-f)*(2/3-j)*6;return f}function q(f,i,j,r){this.r=f;this.g=i;this.b=j;this.a=arguments.length<
4?1:r}var w=q.prototype;w.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};w.adjustLightness=function(f){var i=V.toHSLA(this);i.l*=f;i.l=Math.min(1,Math.max(0,i.l));var j,r;if(i.s===0)f=j=r=i.l;else{r=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var n=2*i.l-r;f=m(n,r,i.h+1/3);j=m(n,r,i.h);r=m(n,r,i.h-1/3)}return new V(f*255<<0,j*255<<0,r*255<<0,i.a)};w.adjustAlpha=function(f){return new V(this.r,this.g,this.b,this.a*f)};q.parse=function(f){f+="";if(~f.indexOf("#")){f=
f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new V(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new V(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};q.toHSLA=function(f){var i=f.r/255,j=f.g/255,r=f.b/255,n=Math.max(i,j,r),G=Math.min(i,j,r),L,T=(n+G)/2,J;if(n===G)L=G=0;else{J=n-G;G=T>0.5?J/(2-n-G):J/(n+G);switch(n){case i:L=(j-r)/J+(j<r?6:0);break;case j:L=
(r-i)/J+2;break;case r:L=(i-j)/J+4;break}L/=6}return{h:L,s:G,l:T,a:f.a}};return q}(),Ua=function(){var m=Math,q=m.sin,w=m.cos,f=m.tan,i=m.asin,j=m.atan2,r=m.PI,n=180/r,G=357.5291/n,L=0.98560028/n,T=1.9148/n,J=0.02/n,ea=3.0E-4/n,K=102.9372/n,U=23.45/n,Z=280.16/n,H=360.9856235/n;return function(u,z,C){C=-C/n;z=z/n;u=u.valueOf()/864E5-0.5+2440588;var D=G+L*(u-2451545),I=T*q(D)+J*q(2*D)+ea*q(3*D);I=D+K+I+r;D=i(q(I)*q(U));I=j(q(I)*w(U),w(I));C=Z+H*(u-2451545)-C-I;return{altitude:i(q(z)*q(D)+w(z)*w(D)*
w(C)),azimuth:j(q(C),w(C)*q(z)-f(D)*w(z))-r/2}}}(),ma=Math.PI,Na=ma/2,Va=ma/4,Wa=180/ma,Xa=256,Ga=14,na="latitude",oa="longitude",R=0,O=1,S=2,ba=3,Ba=4,fa=5,$=6;p.OSMBuildings=function(m){function q(a,d){var c={};a/=pa;d/=pa;c[na]=d<=0?90:d>=1?-90:Wa*(2*Ta(Pa(ma*(1-2*d)))-Na);c[oa]=(a===1?1:(a%1+1)%1)*360-180;return c}function w(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(c,b){return d[b]})}function f(a,d,c,b,g){a=la(Fa(a,d),c);return la(Fa(b+(a-d)/(c-d)*(g-b),b),g)}function i(a,d){var c=new XMLHttpRequest;
c.onreadystatechange=function(){if(c.readyState===4)!c.status||c.status<200||c.status>299||c.responseText&&d(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}function j(){if(!(!Ha||P<Ga)){var a=q(D-z,I-C),d=q(D+H+z,I+u+C);Ca&&Ca.abort();Ca=i(w(Ha,{w:a[oa],n:a[na],e:d[oa],s:d[na],z:P}),r)}}function r(a){var d,c,b,g=[],e,h=e=0;ia=Ga;J(P);Ca=null;if(!(!a||a.meta.z!==P)){b=a.meta;c=a.data;if(B&&y&&B.z===b.z){e=B.x-b.x;h=B.y-b.y;a=0;for(d=y.length;a<d;a++)g[a]=y[a][S][0]+e+","+(y[a][S][1]+
h)}B=b;y=[];a=0;for(d=c.length;a<d;a++){b=[];if(!(c[a][O]>qa)){e=za(c[a][S]);if(!(e.length<8)){b[S]=e;b[Ba]=Q(e);b[R]=la(c[a][R],qa);b[O]=c[a][O];e=b[S][0]+","+b[S][1];b[fa]=!(g&&~g.indexOf(e));b[ba]=[];b[$]=[];y.push(b)}}}ea()}}function n(a,d){var c=[],b,g,e,h,l,k,v,A,o,E=Ia-P;b=0;for(g=a.length;b<g;b++){l=a[b];A=l[O]>>E;if(!(A>qa)){k=l[S];o=new Ma(k.length);e=0;for(h=k.length-1;e<h;e+=2){v=k[e+1];var x=la(1,Fa(0,0.5-Qa(Ea(Va+Na*k[e]/180))/ma/2));v={x:(v/360+0.5)*pa<<0,y:x*pa<<0};o[e]=v.x;o[e+1]=
v.y}o=za(o);if(!(o.length<8)){h=[];h[S]=o;h[Ba]=Q(o);h[R]=la(l[R]>>E,qa);h[O]=A;h[fa]=d;h[ba]=l[ba];h[$]=[];for(e=0;e<3;e++)if(h[ba][e])h[$][e]=h[ba][e].adjustAlpha(W)+"";c.push(h)}}}return c}function G(a,d){if(typeof a==="object")T(a,!d);else{var c=Aa.documentElement,b=Aa.createElement("script");p.jsonpCallback=function(g){delete p.jsonpCallback;c.removeChild(b);T(g,!d)};c.insertBefore(b,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function L(a,d,c){if(c===undefined)c=[];var b,g,e,
h=a[0]?a:a.features,l,k,v,A,o,E=d?1:0,x=d?0:1;if(h){b=0;for(a=h.length;b<a;b++)L(h[b],d,c);return c}if(a.type==="Feature"){l=a.geometry;b=a.properties}if(l.type==="Polygon")k=[l.coordinates];if(l.type==="MultiPolygon")k=l.coordinates;if(k){d=b.height;if(b.color||b.wallColor)A=V.parse(b.color||b.wallColor);if(b.roofColor)o=V.parse(b.roofColor);b=0;for(a=k.length;b<a;b++){h=k[b][0];v=[];g=l=0;for(e=h.length;g<e;g++){v.push(h[g][E],h[g][x]);l+=d||h[g][2]||0}if(l){g=[];e=S;var s=void 0,t=void 0,F=void 0,
M=void 0,ja=0,Y=void 0,ra=void 0;Y=0;for(ra=v.length-3;Y<ra;Y+=2){s=v[Y];t=v[Y+1];F=v[Y+2];M=v[Y+3];ja+=s*M-F*t}if((ja/2>0?"CW":"CCW")==="CW")v=v;else{s=[];for(t=v.length-2;t>=0;t-=2)s.push(v[t],v[t+1]);v=s}g[e]=v;g[R]=l/h.length<<0;g[ba]=[A||null,A?A.adjustLightness(0.8):null,o?o:A?A.adjustLightness(1.2):ga];c.push(g)}}}return c}function T(a,d){if(a){sa=L(a,d);ia=0;J(P);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:P};y=n(sa,true);ea()}else{sa=null;K()}}function J(a){var d,c,b;P=a;pa=Xa<<P;W=1-f(P,ia,Ia,
0,0.4);Ja=ca.adjustAlpha(W)+"";ta=Da.adjustAlpha(W)+"";ua=ga.adjustAlpha(W)+"";ha.setAlpha(W);if(y){a=0;for(d=y.length;a<d;a++){b=y[a];b[$]=[];for(c=0;c<3;c++)if(b[ba][c])b[$][c]=b[ba][c].adjustAlpha(W)+""}}}function ea(){clearInterval(Ka);da=0;va.render();Ka=setInterval(function(){da+=0.1;if(da>1){clearInterval(Ka);da=1;for(var a=0,d=y.length;a<d;a++)y[a][fa]=0}ha.render();K()},33)}function K(){X.clearRect(0,0,H,u);if(!(!B||!y||P<ia||wa)){var a,d,c,b,g,e,h,l,k,v=D-B.x,A=I-B.y,o=va.getMaxHeight(),
E=[xa+v,ya+A],x,s,t,F,M,ja;y.sort(function(Y,ra){return N(ra[Ba],E)/ra[R]-N(Y[Ba],E)/Y[R]});a=0;for(d=y.length;a<d;a++){g=y[a];if(!(g[R]<=o)){s=false;e=g[S];x=[];c=0;for(b=e.length-1;c<b;c+=2){x[c]=l=e[c]-v;x[c+1]=k=e[c+1]-A;s||(s=l>0&&l<H&&k>0&&k<u)}if(s){c=g[fa]?g[R]*da:g[R];e=ka/(ka-c);if(g[O]){c=g[fa]?g[O]*da:g[O];h=ka/(ka-c)}l=[];c=0;for(b=x.length-3;c<b;c+=2){k=x[c];t=x[c+1];s=x[c+2];F=x[c+3];M=Z(k,t,e);ja=Z(s,F,e);if(g[O]){t=Z(k,t,h);F=Z(s,F,h);k=t.x;t=t.y;s=F.x;F=F.y}if((s-k)*(M.y-t)>(M.x-
k)*(F-t)){X.fillStyle=k<s&&t<F||k>s&&t>F?g[$][1]||ta:g[$][0]||Ja;U([s,F,k,t,M.x,M.y,ja.x,ja.y])}l[c]=M.x;l[c+1]=M.y}X.fillStyle=g[$][2]||ua;X.strokeStyle=g[$][1]||ta;U(l,true)}}}}}function U(a,d){if(a.length){X.beginPath();X.moveTo(a[0],a[1]);for(var c=2,b=a.length;c<b;c+=2)X.lineTo(a[c],a[c+1]);X.closePath();d&&X.stroke();X.fill()}}function Z(a,d,c){return{x:(a-xa)*c+xa<<0,y:(d-ya)*c+ya<<0}}var H=0,u=0,z=0,C=0,D=0,I=0,P,pa,Ca,X,Ha,ca=new V(200,190,180),Da=ca.adjustLightness(0.8),ga=ca.adjustLightness(1.2),
Ja=ca+"",ta=Da+"",ua=ga+"",sa,B,y,da=1,Ka,W=1,ia=Ga,Ia=20,qa,xa,ya,ka,wa,Oa={container:null,items:[],create:function(a){var d=this.container=Aa.createElement("DIV");d.style.pointerEvents="none";d.style.position="absolute";d.style.left=0;d.style.top=0;ha.setContext(this.add());va.setContext(this.add());X=this.add();a.appendChild(d);return d},add:function(){var a=Aa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";
a.style.left=0;a.style.top=0;var d=a.getContext("2d");d.lineCap="round";d.lineJoin="round";d.lineWidth=1;try{d.mozImageSmoothingEnabled=false}catch(c){}this.items.push(a);this.container.appendChild(a);return d},setSize:function(a,d){for(var c=this.items,b=0,g=c.length;b<g;b++){c[b].width=a;c[b].height=d}}},ha={enabled:true,context:null,color:new V(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,directionY:0,setContext:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,
0,H,u);if(!(!this.enabled||!B||!y||P<ia||wa||!this.length)){var d,c,b,g,e,h,l,k,v=D-B.x,A=I-B.y,o,E,x,s,t,F,M=[];a.beginPath();d=0;for(c=y.length;d<c;d++){e=y[d];E=false;h=e[S];o=[];b=0;for(g=h.length-1;b<g;b+=2){o[b]=l=h[b]-v;o[b+1]=k=h[b+1]-A;E||(E=l>0&&l<H&&k>0&&k<u)}if(E){h=e[fa]?e[R]*da:e[R];if(e[O])h=e[fa]?e[O]*da:e[O];l=null;b=0;for(g=o.length-3;b<g;b+=2){k=o[b];x=o[b+1];E=o[b+2];s=o[b+3];t=this.project(k,x,h);F=this.project(E,s,h);if(e[O]){x=this.project(k,x,h);s=this.project(E,s,h);k=x.x;
x=x.y;E=s.x;s=s.y}if((E-k)*(t.y-x)>(t.x-k)*(s-x)){l===1&&a.lineTo(k,x);l=0;b||a.moveTo(k,x);a.lineTo(E,s)}else{l===0&&a.lineTo(t.x,t.y);l=1;b||a.moveTo(t.x,t.y);a.lineTo(F.x,F.y)}}a.closePath();M.push(o)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=M.length;d<c;d++){e=M[d];a.moveTo(e[0],e[1]);b=2;for(g=e.length;b<g;b+=2)a.lineTo(e[b],e[b+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},
project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=q(D+z,I+C);a=Ua(a,d.latitude,d.longitude);if(a.altitude<=0){this.length=0;this.alpha=f(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Ea(a.altitude);this.alpha=0.4/this.length;this.directionX=Sa(a.azimuth)*this.length;this.directionY=Ra(a.azimuth)*this.length}this.color.a=
this.alpha;this.colorStr=this.color+"";this.render()}},va={context:null,maxHeight:8,setContext:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,H,u);if(!(!B||!y||P<ia||wa)){var d,c,b,g,e,h,l,k=D-B.x,v=I-B.y,A,o;a.beginPath();d=0;for(c=y.length;d<c;d++){b=y[d];o=false;e=b[S];A=[];b=0;for(g=e.length-1;b<g;b+=2){A[b]=h=e[b]-k;A[b+1]=l=e[b+1]-v;o||(o=h>0&&h<H&&l>0&&l<u)}if(o){b=0;for(g=A.length-3;b<g;b+=2){o=A[b];e=A[b+1];b?a.lineTo(o,e):a.moveTo(o,e)}a.closePath()}}a.fillStyle=
ua;a.strokeStyle=ta;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ca=V.parse(a.color||a.wallColor);Ja=ca.adjustAlpha(W)+"";Da=ca.adjustLightness(0.8);ta=Da.adjustAlpha(W)+"";ga=ca.adjustLightness(1.2);ua=ga.adjustAlpha(W)+""}if(a.roofColor){ga=V.parse(a.roofColor);ua=ga.adjustAlpha(W)+""}a.shadows!==undefined&&ha.setEnabled(a.shadows);K();return this};this.geoJSON=function(a,d){G(a,d);return this};this.setCamOffset=
function(a,d){xa=z+a;ya=u+d};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){ha.setDate(a);return this};this.appendTo=function(a){return Oa.create(a)};this.loadData=j;this.onMoveEnd=function(){var a=q(D,I),d=q(D+H,I+u);ha.render();va.render();K();if(B&&(a[na]>B.n||a[oa]<B.w||d[na]<B.s||d[oa]>B.e))j()};this.onZoomEnd=function(a){wa=false;J(a.zoom);if(sa){y=n(sa);K()}else{K();j()}};this.onZoomStart=function(){wa=true;ha.render();va.render();K()};this.setOrigin=function(a,d){D=a;I=d};this.setSize=
function(a,d){H=a;u=d;z=H/2<<0;C=u/2<<0;xa=z;ya=u;ka=H/1.5/Ea(45)<<0;Oa.setSize(H,u);qa=ka-50};this.setZoom=J;this.render=K;Ha=m};p.OSMBuildings.VERSION="0.1.8a";p.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(p){p=p||{};p.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,p)},setOrigin:function(){var p=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),N=this.map.resolution,Q=this.maxExtent;this.osmb.setOrigin(Math.round((p.lon-Q.left)/N),Math.round((Q.top-
p.lat)/N))},setMap:function(p){this.map||OpenLayers.Layer.prototype.setMap(p);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(p){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(p)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(p,N,Q){p=OpenLayers.Layer.prototype.moveTo(p,N,Q);if(!Q){Q=parseInt(this.map.layerContainerDiv.style.left,10);var za=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-Q+"px";this.div.style.top=-za+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);N?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return p},moveByPx:function(p,N){this.dxSum+=p;this.dySum+=N;var Q=OpenLayers.Layer.prototype.moveByPx(p,
N);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return Q},geoJSON:function(p,N){return this.osmb.geoJSON(p,N)},setStyle:function(p){return this.osmb.setStyle(p)},setDate:function(p){return this.osmb.setDate(p)}});
