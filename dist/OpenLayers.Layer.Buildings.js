<<<<<<< HEAD
var OSMBuildings=function(){function h(a,b){var d=a[0]-b[0],f=a[1]-b[1];return d*d+f*f}function L(a){for(var b=0,d=0,f=0,e=a.length-3;f<e;f+=2)b+=a[f],d+=a[f+1];a=(a.length-2)/2;return[b/a<<0,d/a<<0]}function r(a){var b,d,f,e,h=0,l,g;l=0;for(g=a.length-3;l<g;l+=2)b=a[l],d=a[l+1],f=a[l+2],e=a[l+3],h+=b*e-f*d;if("CW"===(0<h/2?"CW":"CCW"))return a;b=[];for(d=a.length-2;0<=d;d-=2)b.push(a[d],a[d+1]);return b}var X=X||Array,Ca=Ca||Array,g=Math,Ka=g.exp,La=g.log,Ma=g.sin,Na=g.cos,va=g.tan,Oa=g.atan,pa=
g.min,wa=g.max,Da=document,R,ba=function(a){var b,d,f;if(0===a.s)b=d=f=a.l;else{f=0.5>a.l?a.l*(1+a.s):a.l+a.s-a.l*a.s;var e=2*a.l-f;a.h/=360;b=S(e,f,a.h+1/3);d=S(e,f,a.h);f=S(e,f,a.h-1/3)}return new w(255*b<<0,255*d<<0,255*f<<0,a.a)},S=function(a,b,d){0>d&&(d+=1);1<d&&(d-=1);return d<1/6?a+6*(b-a)*d:0.5>d?b:d<2/3?a+6*(b-a)*(2/3-d):a},w=function(a,b,d,f){this.r=a;this.g=b;this.b=d;this.a=4>arguments.length?1:f},g=w.prototype;g.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+
")"};g.setLightness=function(a){var b=w.toHSLA(this);b.l*=a;b.l=Math.min(1,Math.max(0,b.l));return ba(b)};g.setAlpha=function(a){return new w(this.r,this.g,this.b,this.a*a)};w.parse=function(a){var b;a+="";if(~a.indexOf("#")&&(b=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new w(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new w(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?
parseFloat(b[5]):1);if(b=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return ba({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};w.toHSLA=function(a){var b=a.r/255,d=a.g/255,f=a.b/255,e=Math.max(b,d,f),h=Math.min(b,d,f),l,g=(e+h)/2,v;if(e===h)l=h=0;else{v=e-h;h=0.5<g?v/(2-e-h):v/(e+h);switch(e){case b:l=(d-f)/v+(d<f?6:0);break;case d:l=(f-b)/v+2;break;case f:l=(b-d)/v+4}l/=6}return{h:360*l,s:h,l:g,a:a.a}};R=w;var Ea,g=Math,x=g.sin,E=g.cos,
Pa=g.tan,ca=g.asin,da=g.atan2,T=g.PI,u=180/T,Qa=357.5291/u,Ra=0.98560028/u,Sa=1.9148/u,Ta=0.02/u,Ua=3E-4/u,Va=102.9372/u,ea=23.45/u,Wa=280.16/u,Xa=360.9856235/u;Ea=function(a,b,d){d=-d/u;b/=u;a=a.valueOf()/864E5-0.5+2440588;var f=Qa+Ra*(a-2451545),e=Sa*x(f)+Ta*x(2*f)+Ua*x(3*f),e=f+Va+e+T,f=ca(x(e)*x(ea)),e=da(x(e)*E(ea),E(e));d=Wa+Xa*(a-2451545)-d-e;return{altitude:ca(x(b)*x(f)+E(b)*E(f)*E(d)),azimuth:da(x(d),E(d)*x(b)-Pa(f)*E(b))-T/2}};var Fa,N=function(a){var b=parseFloat(a);return~a.indexOf("m")?
b<<0:~a.indexOf("yd")?b*Ya<<0:~a.indexOf("ft")?b*fa<<0:~a.indexOf("'")?(a=a.split("'"),a[0]*fa+a[1]*Za<<0):b<<0},A=function(a){a=a.toLowerCase();return"#"===a[0]?a:$a[a]||null},H=function(a){a=a.toLowerCase();return"#"===a[0]?a:ab[bb[a]||a]||null},Ga=function(a){return(a=a.tags)&&!a.landuse&&(a.building||a["building:part"])&&(!a.layer||0<=a.layer)},Ha=function(a){if(a){for(var b=[],d,f=0,e=a.length;f<e;f++)d=F[a[f]],b.push(d[0],d[1]);b[b.length-2]!==b[0]&&b[b.length-1]!==b[1]&&b.push(b[0],b[1]);if(!(8>
b.length))return b}},U=function(a){var b=0,d=0;a.height&&(b=N(a.height));!b&&a["building:height"]&&(b=N(a["building:height"]));!b&&a.levels&&(b=a.levels*z<<0);!b&&a["building:levels"]&&(b=a["building:levels"]*z<<0);a.min_height&&(d=N(a.min_height));!d&&a["building:min_height"]&&(d=N(a["building:min_height"]));!d&&a.min_level&&(d=a.min_level*z<<0);!d&&a["building:min_level"]&&(d=a["building:min_level"]*z<<0);var f,e;a["building:material"]&&(f=H(a["building:material"]));a["building:facade:material"]&&
(f=H(a["building:facade:material"]));a["building:cladding"]&&(f=H(a["building:cladding"]));a["building:color"]&&(f=A(a["building:color"]));a["building:colour"]&&(f=A(a["building:colour"]));a["roof:material"]&&(e=H(a["roof:material"]));a["building:roof:material"]&&(e=H(a["building:roof:material"]));a["roof:color"]&&(e=A(a["roof:color"]));a["roof:colour"]&&(e=A(a["roof:colour"]));a["building:roof:color"]&&(e=A(a["building:roof:color"]));a["building:roof:colour"]&&(e=A(a["building:roof:colour"]));return{height:b,
minHeight:d,wallColor:f,roofColor:e}},Ia=function(a,b,d){a={id:a,footprint:r(d)};b.height&&(a.height=b.height);b.minHeight&&(a.minHeight=b.minHeight);b.wallColor&&(a.wallColor=b.wallColor);b.roofColor&&(a.roofColor=b.roofColor);ga.push(a)},Ya=0.9144,fa=0.3048,Za=0.0254,z=3,$a={black:"#000000",white:"#ffffff",brown:"#8b4513",green:"#00ff7f",grey:"#bebebe",gray:"#bebebe",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",yellow:"#ffff00",red:"#ff0000",blue:"#0000ff"},bb={asphalt:"tar_paper",bitumen:"tar_paper",
block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},ab={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",
glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},F,Y,ga;Fa=function(a){F={};Y={};ga=[];for(var b,d=0,f=a.length;d<f;d++)switch(b=a[d],b.type){case "node":F[b.id]=[b.lat,b.lon];break;case "way":var e=void 0,h=void 0;Ga(b)?(e=U(b.tags),(h=Ha(b.nodes))&&Ia(b.id,e,h)):(e=b.tags)&&(!e.highway&&!e.railway&&!e.landuse)&&(Y[b.id]=b);break;case "relation":var g=
e=e=void 0,h=void 0;if(Ga(b)&&("multipolygon"===b.tags.type||"building"===b.tags.type)){a:{for(var e=b.members,h=void 0,g=0,r=e.length;g<r;g++)if(h=e[g],"way"===h.type&&"outer"===h.role){e=h;break a}e=void 0}if(e&&(b=U(b.tags),e=Y[e.ref]))if(g=U(e.tags),h=Ha(e.nodes)){r=void 0;for(r in b)g[r]||(g[r]=b[r]);Ia(e.id,g,h)}}}return ga};var ha=Math.PI,Ja=ha/2,cb=ha/4,db=180/ha,eb=256,fb="latitude",gb="longitude",g=function(){function a(a,b){var c={};a/=E;b/=E;c[fb]=0>=b?90:1<=b?-90:db*(2*Oa(Ka(ha*(1-2*
b)))-Ja);c[gb]=360*(1===a?1:(a%1+1)%1)-180;return c}function b(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,hb){return b[hb]||a})}function d(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&c.status&&!(200>c.status||299<c.status)&&b&&c.responseText&&b(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}function f(){ia.render();qa.render();e()}function e(){B.clearRect(0,0,v,y);if(!(O<z||ja)){var a,b,c,d,f,e,xa,t,j,m=qa.MAX_HEIGHT,p=[ka+C,la+J],
I,q,k,s,V,n;D.renderItems.sort(function(a,b){return h(b.center,p)/b.height-h(a.center,p)/a.height});a=0;for(b=D.renderItems.length;a<b;a++)if(f=D.renderItems[a],!(f.height<=m)){q=!1;e=f.footprint;I=[];c=0;for(d=e.length-1;c<d;c+=2)I[c]=t=e[c]-C,I[c+1]=j=e[c+1]-J,q||(q=0<t&&t<v&&0<j&&j<y);if(q){c=1>f.scale?f.height*f.scale:f.height;e=Z/(Z-c);f.minHeight&&(c=1>f.scale?f.minHeight*f.scale:f.minHeight,xa=Z/(Z-c));t=[];c=0;for(d=I.length-3;c<d;c+=2)j=I[c],k=I[c+1],q=I[c+2],s=I[c+3],V=l(j,k,e),n=l(q,s,
e),f.minHeight&&(k=l(j,k,xa),s=l(q,s,xa),j=k.x,k=k.y,q=s.x,s=s.y),(q-j)*(V.y-k)>(V.x-j)*(s-k)&&(B.fillStyle=j<q&&k<s||j>q&&k>s?f.altColor||ma:f.wallColor||H,g([q,s,j,k,V.x,V.y,n.x,n.y])),t[c]=V.x,t[c+1]=V.y;B.fillStyle=f.roofColor||na;B.strokeStyle=f.altColor||ma;g(t,!0)}}}}function g(a,b){if(a.length){B.beginPath();B.moveTo(a[0],a[1]);for(var c=2,f=a.length;c<f;c+=2)B.lineTo(a[c],a[c+1]);B.closePath();b&&B.stroke();B.fill()}}function l(a,b,c){return{x:(a-ka)*c+ka<<0,y:(b-la)*c+la<<0}}function u(a){O=
a;E=eb<<O;a=O;var b=z,c=S;a=pa(wa(a,b),c);M=1-pa(wa(0+0.3*((a-b)/(c-b)),0),0.3);H=K.setAlpha(M)+"";ma=A.setAlpha(M)+"";na=$.setAlpha(M)+""}var v=0,y=0,x=0,w=0,C=0,J=0,O,E,B,K=new R(200,190,180),A=K.setLightness(0.8),$=K.setLightness(1.2),H=K+"",ma=A+"",na=$+"",N,M=1,z=15,S=20,T,ka,la,Z,ja,F=new Date,aa={},U={add:function(a,b){aa[a]={data:b,time:Date.now()}},get:function(a){return aa[a]&&aa[a].data},purge:function(){F.setMinutes(F.getMinutes()-5);for(var a in aa)aa[a].time<F&&delete aa[a]}},D,ga=function(a){return function(b){Y(b,
a)}},Y=function(a,b){if(a){var c;if("FeatureCollection"===a.type){c=a.features;var f,d,e,h,g=[],j,m,p,I,q,k,s,n;f=0;for(d=c.length;f<d;f++)if(j=c[f],"Feature"===j.type&&(m=j.geometry,j=j.properties,"LineString"===m.type&&(k=p.length-1,p[0][0]===p[k][0]&&p[0][1]===p[k][1]&&(p=m.coordinates)),"Polygon"===m.type&&(p=m.coordinates),"MultiPolygon"===m.type&&(p=m.coordinates[0]),p)){if(j.color||j.wallColor)I=j.color||j.wallColor;j.roofColor&&(q=j.roofColor);m=p[0];n=[];s=j.height;e=k=0;for(h=m.length;e<
h;e++)n.push(m[e][1],m[e][0]),k+=s||m[e][2]||0;e={id:j.id||n[0]+","+n[1],footprint:r(n)};k&&(e.height=k/m.length<<0);j.minHeight&&(e.minHeight=j.minHeight);I&&(e.wallColor=I);q&&(e.roofColor=q);g.push(e)}c=g}else a.osm3s&&(c=Fa(a.elements));b&&U.add(b,c);ba(c,!0)}},ba=function(a,b){var c,d,e,h,g,t,j=[],m,p,n,q,k,s,l,r,v,x=S-O;e=0;for(h=a.length;e<h;e++)if(v=r=l=null,m=a[e],n=3*(m.height||15)>>x)if(q=3*m.minHeight>>x,!(q>T)){p=m.footprint;k=new X(p.length);g=0;for(t=p.length-1;g<t;g+=2)c=p[g+1],d=
pa(1,wa(0,0.5-La(va(cb+Ja*p[g]/180))/ha/2)),c=(c/360+0.5)*E<<0,d=d*E<<0,k[g]=c,k[g+1]=d;g=k;t=g.length/2;p=new Ca(t);k=0;c=t-1;var u=d=void 0,w=void 0,y=void 0,A=[],B=[],G=[];for(p[k]=p[c]=1;c;){u=0;for(d=k+1;d<c;d++){var w=g[2*d],H=g[2*d+1],z=g[2*k],C=g[2*k+1],J=g[2*c],K=g[2*c+1],P=J-z,Q=K-C,F=void 0;if(0!==P||0!==Q)F=((w-z)*P+(H-C)*Q)/(P*P+Q*Q),1<F?(z=J,C=K):0<F&&(z+=P*F,C+=Q*F);P=w-z;Q=H-C;w=P*P+Q*Q;w>u&&(y=d,u=w)}2<u&&(p[y]=1,A.push(k),B.push(y),A.push(y),B.push(c));k=A.pop();c=B.pop()}for(d=
0;d<t;d++)p[d]&&G.push(g[2*d],g[2*d+1]);k=G;if(!(8>k.length)){if(m.wallColor&&(s=R.parse(m.wallColor)))l=s.setAlpha(M),r=""+l.setLightness(0.8),l=""+l;if(m.roofColor&&(s=R.parse(m.roofColor)))v=""+s.setAlpha(M);j.push({id:m.id,footprint:k,height:pa(n,T),minHeight:q,wallColor:l,altColor:r,roofColor:v,center:L(k)})}}h=0;for(m=j.length;h<m;h++)e=j[h],ra[e.id]||(e.scale=b?0:1,oa.renderItems.push(j[h]),ra[e.id]=1);N||(N=setInterval(function(){for(var a,b=!1,c=0,d=D.renderItems.length;c<d;c++)a=D.renderItems[c],
1>a.scale&&(a.scale+=0.1,1<a.scale&&(a.scale=1),b=!0);f();b||(clearInterval(N),N=null)},33))},ya,ra={},oa={renderItems:[],load:function(a){ya=a;oa.update()},update:function(){if(ya&&!(15>O)){var e=a(C,J),f=a(C+v,J+y),c=0.0075*(e.latitude/0.0075<<0)+0.0075,h=0.015*(f.longitude/0.015<<0)+0.015,f=0.0075*(f.latitude/0.0075<<0),e=0.015*(e.longitude/0.015<<0);U.purge();oa.renderItems=[];ra={};for(var g,n,l;f<=c;f+=0.0075)for(g=e;g<=h;g+=0.015)l=f+","+g,(n=U.get(l))?ba(n):d(b(ya,{n:(1E4*(f+0.0075)<<0)/1E4,
e:(1E4*(g+0.015)<<0)/1E4,s:(1E4*f<<0)/1E4,w:(1E4*g<<0)/1E4}),ga(l))}},set:function(a){oa.renderItems=[];ra={};Y(a)}};D=oa;var ia,ta=function(a,b,c){return{x:a+sa.x*c,y:b+sa.y*c}},n,ca=!0,da=new R(0,0,0),ea=null,sa={x:0,y:0},za={setContext:function(a){n=a;za.setDate((new Date).setHours(10))},enable:function(a){ca=!!a},render:function(){var b,d,c,f;n.clearRect(0,0,v,y);if(ca&&!(O<z||ja))if(b=a(C+x,J+w),b=Ea(ea,b.latitude,b.longitude),!(0>=b.altitude)){d=1/va(b.altitude);c=0.4/d;sa.x=Na(b.azimuth)*d;
sa.y=Ma(b.azimuth)*d;da.a=c;f=da+"";var e,g,h,t,j,m,p,l,q,k,s,r,u=[];n.beginPath();b=0;for(d=D.renderItems.length;b<d;b++){g=D.renderItems[b];l=!1;h=g.footprint;p=[];c=0;for(e=h.length-1;c<e;c+=2)p[c]=j=h[c]-C,p[c+1]=m=h[c+1]-J,l||(l=0<j&&j<v&&0<m&&m<y);if(l){h=1>g.scale?g.height*g.scale:g.height;g.minHeight&&(t=1>g.scale?g.minHeight*g.scale:g.minHeight);j=null;c=0;for(e=p.length-3;c<e;c+=2)m=p[c],q=p[c+1],l=p[c+2],k=p[c+3],s=ta(m,q,h),r=ta(l,k,h),g.minHeight&&(q=ta(m,q,t),k=ta(l,k,t),m=q.x,q=q.y,
l=k.x,k=k.y),(l-m)*(s.y-q)>(s.x-m)*(k-q)?(1===j&&n.lineTo(m,q),j=0,c||n.moveTo(m,q),n.lineTo(l,k)):(0===j&&n.lineTo(s.x,s.y),j=1,c||n.moveTo(s.x,s.y),n.lineTo(r.x,r.y));n.closePath();u.push(p)}}n.fillStyle=f;n.fill();n.globalCompositeOperation="destination-out";n.beginPath();b=0;for(d=u.length;b<d;b++){t=u[b];n.moveTo(t[0],t[1]);c=2;for(e=t.length;c<e;c+=2)n.lineTo(t[c],t[c+1]);n.lineTo(t[0],t[1]);n.closePath()}n.fillStyle="#00ff00";n.fill();n.globalCompositeOperation="source-over"}},setDate:function(a){ea=
a;za.render()}};ia=za;var qa,G,fa={MAX_HEIGHT:8,setContext:function(a){G=a},render:function(){G.clearRect(0,0,v,y);if(!(O<z||ja)){var a,b,c,d,e,f,g,h,j;G.beginPath();a=0;for(b=D.renderItems.length;a<b;a++)if(c=D.renderItems[a],!(c.height>fa.MAX_HEIGHT)){j=!1;e=c.footprint;h=[];c=0;for(d=e.length-1;c<d;c+=2)h[c]=f=e[c]-C,h[c+1]=g=e[c+1]-J,j||(j=0<f&&f<v&&0<g&&g<y);if(j){c=0;for(d=h.length-3;c<d;c+=2)j=h[c],e=h[c+1],c?G.lineTo(j,e):G.moveTo(j,e);G.closePath()}}G.fillStyle=na;G.strokeStyle=ma;G.stroke();
G.fill()}}};qa=fa;var Aa,Ba=function(){var a=Da.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");b.lineCap="round";b.lineJoin="round";b.lineWidth=1;b.mozImageSmoothingEnabled=!1;b.webkitImageSmoothingEnabled=!1;ua.push(a);W.appendChild(a);return b},W=Da.createElement("DIV");W.style.pointerEvents="none";W.style.position="absolute";W.style.left=0;W.style.top=0;
var ua=[];ia.setContext(Ba());qa.setContext(Ba());B=Ba();Aa={appendTo:function(a){a.appendChild(W);return W},setSize:function(a,b){for(var c=0,d=ua.length;c<d;c++)ua[c].width=a,ua[c].height=b}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)K=R.parse(a.color||a.wallColor),H=K.setAlpha(M)+"",A=K.setLightness(0.8),ma=A.setAlpha(M)+"",$=K.setLightness(1.2),na=$.setAlpha(M)+"";a.roofColor&&($=R.parse(a.roofColor),na=$.setAlpha(M)+"");void 0!==a.shadows&&ia.enable(a.shadows);f();return this};
this.setCamOffset=function(a,b){ka=x+a;la=y+b};this.setMaxZoom=function(a){S=a};this.setDate=function(a){ia.setDate(a);return this};this.appendTo=function(a){return Aa.appendTo(a)};this.loadData=function(a){D.load(a);return this};this.setData=function(a){D.set(a);return this};this.onMoveEnd=function(){f();D.update()};this.onZoomEnd=function(a){ja=!1;u(a.zoom);D.update();f()};this.onZoomStart=function(){ja=!0;f()};this.setOrigin=function(a,b){C=a;J=b};this.setSize=function(a,b){v=a;y=b;x=v/2<<0;w=
y/2<<0;ka=x;la=y;Z=v/(1.5/(window.devicePixelRatio||1))/va(45)<<0;Aa.setSize(v,y);T=Z-50};this.setZoom=u;this.render=e};g.VERSION="0.1.8a";g.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';g.OSM_XAPI_URL="http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";return g}();
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(h){h=h||{};h.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,h)},setOrigin:function(){var h=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),L=this.map.resolution,r=this.maxExtent,X=Math.round((h.lon-r.left)/L),h=Math.round((r.top-h.lat)/
L);this.osmb.setOrigin(X,h)},setMap:function(h){this.map||OpenLayers.Layer.prototype.setMap.call(this,h);this.osmb||(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin()},removeMap:function(h){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,h)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(h,L,r){h=OpenLayers.Layer.prototype.moveTo.call(this,h,L,r);if(!r){r=parseInt(this.map.layerContainerDiv.style.left,10);var X=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-r+"px";this.div.style.top=-X+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(L)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return h},moveByPx:function(h,L){this.dxSum+=h;this.dySum+=L;var r=
OpenLayers.Layer.prototype.moveByPx.call(this,h,L);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return r},setStyle:function(h){return this.osmb.setStyle(h)},setDate:function(h){return this.osmb.setDate(h)},load:function(h){this.osmb.loadData(h)},geoJSON:function(h){this.osmb.setData(h)}});
=======
var OSMBuildings=function(){function g(d,c){var h=d[0]-c[0],e=d[1]-c[1];return h*h+e*e}function J(d){for(var c=0,h=0,e=0,g=d.length-3;e<g;e+=2)c+=d[e],h+=d[e+1];d=(d.length-2)/2;return[c/d<<0,h/d<<0]}var m=m||Array,S=S||Array,f=Math,Da=f.exp,Ea=f.log,Fa=f.sin,Ga=f.cos,oa=f.tan,Ha=f.atan,fa=f.min,pa=f.max,xa=document,Q,U=function(d){var c,h,e;if(0===d.s)c=h=e=d.l;else{e=0.5>d.l?d.l*(1+d.s):d.l+d.s-d.l*d.s;var g=2*d.l-e;d.h/=360;c=D(g,e,d.h+1/3);h=D(g,e,d.h);e=D(g,e,d.h-1/3)}return new t(255*c<<0,255*
h<<0,255*e<<0,d.a)},D=function(d,c,h){0>h&&(h+=1);1<h&&(h-=1);return h<1/6?d+6*(c-d)*h:0.5>h?c:h<2/3?d+6*(c-d)*(2/3-h):d},t=function(d,c,h,e){this.r=d;this.g=c;this.b=h;this.a=4>arguments.length?1:e},f=t.prototype;f.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};f.setLightness=function(d){var c=t.toHSLA(this);c.l*=d;c.l=Math.min(1,Math.max(0,c.l));return U(c)};f.setAlpha=function(d){return new t(this.r,this.g,this.b,this.a*d)};t.parse=function(d){var c;
d+="";if(~d.indexOf("#")&&(c=d.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/)))return new t(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1);if(c=d.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new t(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5]):1);if(c=d.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return U({h:parseInt(c[1],10),s:parseFloat(c[2]),l:parseFloat(c[3]),a:c[4]?parseFloat(c[5]):1})};t.toHSLA=
function(d){var c=d.r/255,h=d.g/255,e=d.b/255,g=Math.max(c,h,e),f=Math.min(c,h,e),m,j=(g+f)/2,w;if(g===f)m=f=0;else{w=g-f;f=0.5<j?w/(2-g-f):w/(g+f);switch(g){case c:m=(h-e)/w+(h<e?6:0);break;case h:m=(e-c)/w+2;break;case e:m=(c-h)/w+4}m/=6}return{h:360*m,s:f,l:j,a:d.a}};Q=t;var ya,f=Math,r=f.sin,y=f.cos,Ia=f.tan,V=f.asin,W=f.atan2,K=f.PI,j=180/K,Ja=357.5291/j,Ka=0.98560028/j,La=1.9148/j,Ma=0.02/j,Na=3E-4/j,Oa=102.9372/j,X=23.45/j,Pa=280.16/j,Qa=360.9856235/j;ya=function(d,c,g){g=-g/j;c/=j;d=d.valueOf()/
864E5-0.5+2440588;var e=Ja+Ka*(d-2451545),f=La*r(e)+Ma*r(2*e)+Na*r(3*e),f=e+Oa+f+K,e=V(r(f)*r(X)),f=W(r(f)*y(X),y(f));g=Pa+Qa*(d-2451545)-g-f;return{altitude:V(r(c)*r(e)+y(c)*y(e)*y(g)),azimuth:W(r(g),y(g)*r(c)-Ia(e)*y(c))-K/2}};var Y=Math.PI,za=Y/2,Ra=Y/4,Sa=180/Y,Ta=256,Ua="latitude",Va="longitude",f=function(){function d(a,l){var b={};a/=Z;l/=Z;b[Ua]=0>=l?90:1<=l?-90:Sa*(2*Ha(Da(Y*(1-2*l)))-za);b[Va]=360*(1===a?1:(a%1+1)%1)-180;return b}function c(a,l){return a.replace(/\{ *([\w_]+) *\}/g,function(a,
d){return l[d]||a})}function f(a,l){var b=new XMLHttpRequest;b.onreadystatechange=function(){4===b.readyState&&b.status&&!(200>b.status||299<b.status)&&l&&b.responseText&&l(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function e(a){B=a;Z=Ta<<B;a=B;var l=ga,b=qa;a=fa(pa(a,l),b);L=1-fa(pa(0+0.3*((a-l)/(b-l)),0),0.3);K=E.setAlpha(L)+"";$=ha.setAlpha(L)+"";aa=M.setAlpha(L)+"";p.renderItems=p.scale(p.rawItems,B)}function j(){ba.render();ia.render();r()}function r(){z.clearRect(0,
0,w,A);if(!(B<ga||ca)){var a,l,b,d,s,c,x,R,F,f=ia.MAX_HEIGHT,e=[da+G,ea+I],h,n,k,u,q,m;p.renderItems.sort(function(a,b){return g(b.center,e)/b.height-g(a.center,e)/a.height});a=0;for(l=p.renderItems.length;a<l;a++)if(s=p.renderItems[a],!(s.height<=f)){n=!1;c=s.footprint;h=[];b=0;for(d=c.length-1;b<d;b+=2)h[b]=R=c[b]-G,h[b+1]=F=c[b+1]-I,n||(n=0<R&&R<w&&0<F&&F<A);if(n){b=1>s.scale?s.height*s.scale:s.height;c=N/(N-b);s.minHeight&&(b=1>s.scale?s.minHeight*s.scale:s.minHeight,x=N/(N-b));R=[];b=0;for(d=
h.length-3;b<d;b+=2)F=h[b],k=h[b+1],n=h[b+2],u=h[b+3],q=y(F,k,c),m=y(n,u,c),s.minHeight&&(k=y(F,k,x),u=y(n,u,x),F=k.x,k=k.y,n=u.x,u=u.y),(n-F)*(q.y-k)>(q.x-F)*(u-k)&&(z.fillStyle=F<n&&k<u||F>n&&k>u?s.altColor||$:s.wallColor||K,t([n,u,F,k,q.x,q.y,m.x,m.y])),R[b]=q.x,R[b+1]=q.y;z.fillStyle=s.roofColor||aa;z.strokeStyle=s.altColor||$;t(R,!0)}}}}function t(a,l){if(a.length){z.beginPath();z.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)z.lineTo(a[b],a[b+1]);z.closePath();l&&z.stroke();z.fill()}}function y(a,
l,b){return{x:(a-da)*b+da<<0,y:(l-ea)*b+ea<<0}}var w=0,A=0,ja=0,D=0,G=0,I=0,B,Z,z,E=new Q(200,190,180),ha=E.setLightness(0.8),M=E.setLightness(1.2),K=E+"",$=ha+"",aa=M+"",ka,L=1,ga=15,qa=20,ra,da,ea,N,ca,sa,ta=function(){var a=xa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var l=a.getContext("2d");l.lineCap="round";l.lineJoin="round";l.lineWidth=1;l.mozImageSmoothingEnabled=!1;
l.webkitImageSmoothingEnabled=!1;la.push(a);C.appendChild(a);return l},C=xa.createElement("DIV");C.style.pointerEvents="none";C.style.position="absolute";C.style.left=0;C.style.top=0;var la=[];ba.setContext(ta());ia.setContext(ta());z=ta();sa={appendTo:function(a){a.appendChild(C);return C},setSize:function(a,l){for(var b=0,d=la.length;b<d;b++)la[b].width=a,la[b].height=l}};var ua=new Date,H={},U={add:function(a,l){H[a]={data:l,time:Date.now()}},get:function(a){return H[a]&&H[a].data},purge:function(){ua.setMinutes(ua.getMinutes()-
5);for(var a in H)H[a].time<ua&&delete H[a]}},p,V=function(){T.rawItems=[];T.renderItems=[];U.purge()},W=function(a,l){for(var b=T.scale(a,B,l),d=0,c=b.length;d<c;d++)T.renderItems.push(b[d]);ka||(ka=setInterval(function(){for(var a,b=!1,d=0,l=p.renderItems.length;d<l;d++)a=p.renderItems[d],1>a.scale&&(a.scale+=0.1,1<a.scale&&(a.scale=1),b=!0);j();b||(clearInterval(ka),ka=null)},33))},va,T={rawItems:[],renderItems:[],load:function(a){va=a;T.update()},update:function(){if(va&&!(15>B)){var a=d(G,I),
l=d(G+w,I+A),b=0.0075*(a.latitude/0.0075<<0)+0.0075,g=0.015*(l.longitude/0.015<<0)+0.015,l=0.0075*(l.latitude/0.0075<<0),a=0.015*(a.longitude/0.015<<0);V();for(var s,e,x;l<=b;l+=0.0075)for(e=a;e<=g;e+=0.015)x=l+","+e,(s=U.get(x))?W(s):f(c(va,{n:(1E4*(l+0.0075)<<0)/1E4,e:(1E4*(e+0.015)<<0)/1E4,s:(1E4*l<<0)/1E4,w:(1E4*e<<0)/1E4}))}},set:function(a){V();if(a){a=a.features;var d,b,c,s,g=[],x,e,f,h,q,m,n,k;d=0;for(b=a.length;d<b;d++)if(x=a[d],"Feature"===x.type&&(e=x.geometry,x=x.properties,"LineString"===
e.type&&(m=f.length-1,f[0][0]===f[m][0]&&f[0][1]===f[m][1]&&(f=e.coordinates)),"Polygon"===e.type&&(f=e.coordinates),"MultiPolygon"===e.type&&(f=e.coordinates[0]),f)){if(x.color||x.wallColor)h=x.color||x.wallColor;x.roofColor&&(q=x.roofColor);e=f[0];k=[];n=x.height;c=m=0;for(s=e.length;c<s;c++)k.push(e[c][1],e[c][0]),m+=n||e[c][2]||0;c=x.id||k[0]+","+k[1];for(var u=n=s=void 0,j=void 0,w=0,p=void 0,r=void 0,p=0,r=k.length-3;p<r;p+=2)s=k[p],n=k[p+1],u=k[p+2],j=k[p+3],w+=s*j-u*n;if("CW"!==(0<w/2?"CW":
"CCW")){s=[];for(n=k.length-2;0<=n;n-=2)s.push(k[n],k[n+1]);k=s}c={id:c,footprint:k};m&&(c.height=m/e.length<<0);x.minHeight&&(c.minHeight=x.minHeight);h&&(c.wallColor=h);q&&(c.roofColor=q);g.push(c)}W(g,!0)}},scale:function(a,d,b){var c,e,g,f,h,q=[],p,j,w,n,k,u,r,t,y,A=qa-d;d=0;for(g=a.length;d<g;d++)if(y=t=r=null,p=a[d],w=3*(p.height||15)>>A)if(n=3*p.minHeight>>A,!(n>ra)){j=p.footprint;k=new m(j.length);f=0;for(h=j.length-1;f<h;f+=2)c=j[f+1],e=fa(1,pa(0,0.5-Ea(oa(Ra+za*j[f]/180))/Y/2)),c=(c/360+
0.5)*Z<<0,e=e*Z<<0,k[f]=c,k[f+1]=e;f=k;h=f.length/2;j=new S(h);k=0;c=h-1;var z=e=void 0,v=void 0,B=void 0,E=[],G=[],I=[];for(j[k]=j[c]=1;c;){z=0;for(e=k+1;e<c;e++){var v=f[2*e],K=f[2*e+1],C=f[2*k],D=f[2*k+1],M=f[2*c],N=f[2*c+1],O=M-C,P=N-D,H=void 0;if(0!==O||0!==P)H=((v-C)*O+(K-D)*P)/(O*O+P*P),1<H?(C=M,D=N):0<H&&(C+=O*H,D+=P*H);O=v-C;P=K-D;v=O*O+P*P;v>z&&(B=e,z=v)}2<z&&(j[B]=1,E.push(k),G.push(B),E.push(B),G.push(c));k=E.pop();c=G.pop()}for(e=0;e<h;e++)j[e]&&I.push(f[2*e],f[2*e+1]);k=I;if(!(8>k.length)){if(p.wallColor&&
(u=Q.parse(p.wallColor)))r=u.setAlpha(L),t=""+r.setLightness(0.8),r=""+r;if(p.roofColor&&(u=Q.parse(p.roofColor)))y=""+u.setAlpha(L);q.push({id:p.id,footprint:k,height:fa(w,ra),minHeight:n,wallColor:r,altColor:t,roofColor:y,center:J(k),scale:b?0:1})}}return q}};p=T;var ba,na=function(a,c,b){return{x:a+ma.x*b,y:c+ma.y*b}},q,X=!0,Aa=new Q(0,0,0),Ba=null,ma={x:0,y:0},wa={setContext:function(a){q=a;wa.setDate((new Date).setHours(10))},enable:function(a){X=!!a},render:function(){var a,c,b,e;q.clearRect(0,
0,w,A);if(X&&!(B<ga||ca))if(a=d(G+ja,I+D),a=ya(Ba,a.latitude,a.longitude),!(0>=a.altitude)){c=1/oa(a.altitude);b=0.4/c;ma.x=Ga(a.azimuth)*c;ma.y=Fa(a.azimuth)*c;Aa.a=b;e=Aa+"";var f,g,h,j,m,r,v,t,n,k,u,y,z=[];q.beginPath();a=0;for(c=p.renderItems.length;a<c;a++){g=p.renderItems[a];t=!1;h=g.footprint;v=[];b=0;for(f=h.length-1;b<f;b+=2)v[b]=m=h[b]-G,v[b+1]=r=h[b+1]-I,t||(t=0<m&&m<w&&0<r&&r<A);if(t){h=1>g.scale?g.height*g.scale:g.height;g.minHeight&&(j=1>g.scale?g.minHeight*g.scale:g.minHeight);m=null;
b=0;for(f=v.length-3;b<f;b+=2)r=v[b],n=v[b+1],t=v[b+2],k=v[b+3],u=na(r,n,h),y=na(t,k,h),g.minHeight&&(n=na(r,n,j),k=na(t,k,j),r=n.x,n=n.y,t=k.x,k=k.y),(t-r)*(u.y-n)>(u.x-r)*(k-n)?(1===m&&q.lineTo(r,n),m=0,b||q.moveTo(r,n),q.lineTo(t,k)):(0===m&&q.lineTo(u.x,u.y),m=1,b||q.moveTo(u.x,u.y),q.lineTo(y.x,y.y));q.closePath();z.push(v)}}q.fillStyle=e;q.fill();q.globalCompositeOperation="destination-out";q.beginPath();a=0;for(c=z.length;a<c;a++){j=z[a];q.moveTo(j[0],j[1]);b=2;for(f=j.length;b<f;b+=2)q.lineTo(j[b],
j[b+1]);q.lineTo(j[0],j[1]);q.closePath()}q.fillStyle="#00ff00";q.fill();q.globalCompositeOperation="source-over"}},setDate:function(a){Ba=a;wa.render()}};ba=wa;var ia,v,Ca={MAX_HEIGHT:8,setContext:function(a){v=a},render:function(){v.clearRect(0,0,w,A);if(!(B<ga||ca)){var a,c,b,d,e,f,g,h,j;v.beginPath();a=0;for(c=p.renderItems.length;a<c;a++)if(b=p.renderItems[a],!(b.height>Ca.MAX_HEIGHT)){j=!1;e=b.footprint;h=[];b=0;for(d=e.length-1;b<d;b+=2)h[b]=f=e[b]-G,h[b+1]=g=e[b+1]-I,j||(j=0<f&&f<w&&0<g&&
g<A);if(j){b=0;for(d=h.length-3;b<d;b+=2)j=h[b],e=h[b+1],b?v.lineTo(j,e):v.moveTo(j,e);v.closePath()}}v.fillStyle=aa;v.strokeStyle=$;v.stroke();v.fill()}}};ia=Ca;this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)E=Q.parse(a.color||a.wallColor),K=E.setAlpha(L)+"",ha=E.setLightness(0.8),$=ha.setAlpha(L)+"",M=E.setLightness(1.2),aa=M.setAlpha(L)+"";a.roofColor&&(M=Q.parse(a.roofColor),aa=M.setAlpha(L)+"");void 0!==a.shadows&&ba.enable(a.shadows);j();return this};this.setCamOffset=function(a,
c){da=ja+a;ea=A+c};this.setMaxZoom=function(a){qa=a};this.setDate=function(a){ba.setDate(a);return this};this.appendTo=function(a){return sa.appendTo(a)};this.loadData=function(a){p.load(a);return this};this.setData=function(a){p.set(a);return this};this.onMoveEnd=function(){j();p.update()};this.onZoomEnd=function(a){ca=!1;e(a.zoom);p.update();j()};this.onZoomStart=function(){ca=!0;j()};this.setOrigin=function(a,c){G=a;I=c};this.setSize=function(a,c){w=a;A=c;ja=w/2<<0;D=A/2<<0;da=ja;ea=A;N=w/(1.5/
(window.devicePixelRatio||1))/oa(45)<<0;sa.setSize(w,A);ra=N-50};this.setZoom=e;this.render=r};f.VERSION="0.1.8a";f.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';f.OSM_XAPI_URL="http://overpass-api.de/api/interpreter?data=[out:json];(way[%22building%22]({s},{w},{n},{e});node(w);way[%22building:part%22=%22yes%22]({s},{w},{n},{e});node(w);relation[%22building%22]({s},{w},{n},{e});way(r);node(w););out;";return f}();
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(g){g=g||{};g.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,g)},setOrigin:function(){var g=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),J=this.map.resolution,m=this.maxExtent,S=Math.round((g.lon-m.left)/J),g=Math.round((m.top-g.lat)/
J);this.osmb.setOrigin(S,g)},setMap:function(g){this.map||OpenLayers.Layer.prototype.setMap.call(this,g);this.osmb||(this.osmb=new OSMBuildings,this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin()},removeMap:function(g){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,g)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(g,J,m){g=OpenLayers.Layer.prototype.moveTo.call(this,g,J,m);if(!m){m=parseInt(this.map.layerContainerDiv.style.left,10);var S=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-m+"px";this.div.style.top=-S+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(J)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return g},moveByPx:function(g,J){this.dxSum+=g;this.dySum+=J;var m=
OpenLayers.Layer.prototype.moveByPx.call(this,g,J);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return m},setStyle:function(g){return this.osmb.setStyle(g)},setDate:function(g){return this.osmb.setDate(g)},load:function(g){this.osmb.loadData(g)},geoJSON:function(g){this.osmb.setData(g)}});
>>>>>>> be06c3628419de661af2c8bb557af93385a05bab
