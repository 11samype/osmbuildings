(function(m){function I(p,x){var C=p[0]-x[0],f=p[1]-x[1];return C*C+f*f}function L(p){for(var x=0,C=0,f=0,h=p.length-3;f<h;f+=2){x+=p[f];C+=p[f+1]}p=(p.length-2)*2;return[x/p<<0,C/p<<0]}function Ba(p){var x=p.length/2,C=new Xa(x),f=0,h=x-1,j,u,y,E,J=[],Z=[],G=[];for(C[f]=C[h]=1;h;){u=0;for(j=f+1;j<h;j++){y=p[j*2];var oa=p[j*2+1],fa=p[f*2],aa=p[f*2+1],M=p[h*2],ja=p[h*2+1],K=M-fa,z=ja-aa,B=void 0;if(K!==0||z!==0){B=((y-fa)*K+(oa-aa)*z)/(K*K+z*z);if(B>1){fa=M;aa=ja}else if(B>0){fa+=K*B;aa+=z*B}}K=y-
fa;z=oa-aa;y=K*K+z*z;if(y>u){E=j;u=y}}if(u>2){C[E]=1;J.push(f);Z.push(E);J.push(E);Z.push(h)}f=J.pop();h=Z.pop()}for(j=0;j<x;j++)C[j]&&G.push(p[j*2],p[j*2+1]);return G}var Ya=Ya||Array,Xa=Xa||Array,U=Math,gb=U.exp,hb=U.log,P=U.sin,ba=U.cos,Ca=U.tan,Za=U.asin,ib=U.atan,$a=U.atan2,pa=U.min,Pa=U.max,Qa=m.document,Q=function(){function p(f,h,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return f+(h-f)*6*j;if(j<0.5)return h;if(j<2/3)return f+(h-f)*(2/3-j)*6;return f}function x(f,h,j,u){this.r=f;this.g=h;this.b=
j;this.a=arguments.length<4?1:u}var C=x.prototype;C.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};C.adjustLightness=function(f){var h=Q.toHSLA(this);h.l*=f;h.l=Math.min(1,Math.max(0,h.l));var j,u;if(h.s===0)f=j=u=h.l;else{u=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var y=2*h.l-u;f=p(y,u,h.h+1/3);j=p(y,u,h.h);u=p(y,u,h.h-1/3)}return new Q(f*255<<0,j*255<<0,u*255<<0,h.a)};C.adjustAlpha=function(f){return new Q(this.r,this.g,this.b,this.a*f)};x.parse=function(f){f+=
"";if(~f.indexOf("#")){f=f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};x.toHSLA=function(f){var h=f.r/255,j=f.g/255,u=f.b/255,y=Math.max(h,j,u),E=Math.min(h,j,u),J,Z=(y+E)/2,G;if(y===E)J=E=0;else{G=y-E;E=Z>0.5?G/(2-y-E):G/(y+E);switch(y){case h:J=(j-
u)/G+(j<u?6:0);break;case j:J=(u-h)/G+2;break;case u:J=(h-j)/G+4;break}J/=6}return{h:J,s:E,l:Z,a:f.a}};return x}(),ga=Math.PI,ab=ga/2,jb=ga/4,N=180/ga,kb=256,Ra=14,qa="latitude",ra="longitude",V=0,O=1,R=2,ca=3,Da=4,sa=5,$=6;m.OSMBuildings=function(p){function x(a,c){var b={};a/=ta;c/=ta;b[qa]=c<=0?90:c>=1?-90:N*(2*ib(gb(ga*(1-2*c)))-ab);b[ra]=(a===1?1:(a%1+1)%1)*360-180;return b}function C(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function f(a,c,b,d,e){a=pa(Pa(a,c),b);
return pa(Pa(d+(a-c)/(b-c)*(e-d),d),e)}function h(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function j(){if(!(!Sa||S<Ra)){var a=x(W-ka,X-Ea),c=x(W+z+ka,X+B+Ea);Fa&&Fa.abort();Fa=h(C(Sa,{w:a[ra],n:a[qa],e:c[ra],s:c[qa],z:S}),u)}}function u(a){var c,b,d,e=[],g,i=g=0;Ga=Ra;G(S);Fa=null;if(!(!a||a.meta.z!==S)){d=a.meta;b=a.data;if(D&&A&&D.z===
d.z){g=D.x-d.x;i=D.y-d.y;a=0;for(c=A.length;a<c;a++)e[a]=A[a][R][0]+g+","+(A[a][R][1]+i)}D=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][O]>ua)){g=Ba(b[a][R]);if(!(g.length<8)){d[R]=g;d[Da]=L(g);d[V]=pa(b[a][V],ua);d[O]=b[a][O];g=d[R][0]+","+d[R][1];d[sa]=!(e&&~e.indexOf(g));d[ca]=[];d[$]=[];A.push(d)}}}aa()}}function y(a,c){var b=[],d,e,g,i,k,l,o,v,q,t=Ta-S;d=0;for(e=a.length;d<e;d++){k=a[d];v=k[O]>>t;if(!(v>ua)){l=k[R];q=new Ya(l.length);g=0;for(i=l.length-1;g<i;g+=2){o=l[g+1];var r=pa(1,Pa(0,
0.5-hb(Ca(jb+ab*l[g]/180))/ga/2));o={x:(o/360+0.5)*ta<<0,y:r*ta<<0};q[g]=o.x;q[g+1]=o.y}q=Ba(q);if(!(q.length<8)){i=[];i[R]=q;i[Da]=L(q);i[V]=pa(k[V]>>t,ua);i[O]=v;i[sa]=c;i[ca]=k[ca];i[$]=[];for(g=0;g<3;g++)if(i[ca][g])i[$][g]=i[ca][g].adjustAlpha(T)+"";b.push(i)}}}return b}function E(a,c){if(typeof a==="object")Z(a,!c);else{var b=Qa.documentElement,d=Qa.createElement("script");m.jsonpCallback=function(e){delete m.jsonpCallback;b.removeChild(d);Z(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,
"jsonpCallback")}}function J(a,c,b){if(b===undefined)b=[];var d,e,g,i=a[0]?a:a.features,k,l,o,v,q,t=c?1:0,r=c?0:1;if(i){d=0;for(a=i.length;d<a;d++)J(i[d],c,b);return b}if(a.type==="Feature"){k=a.geometry;d=a.properties}if(k.type==="Polygon")l=[k.coordinates];if(k.type==="MultiPolygon")l=k.coordinates;if(l){c=d.height;if(d.color||d.wallColor)v=Q.parse(d.color||d.wallColor);if(d.roofColor)q=Q.parse(d.roofColor);d=0;for(a=l.length;d<a;d++){i=l[d][0];o=[];e=k=0;for(g=i.length;e<g;e++){o.push(i[e][t],
i[e][r]);k+=c||i[e][2]||0}if(k){e=[];g=R;var s=void 0,w=void 0,H=void 0,la=void 0,va=0,Y=void 0,bb=void 0;Y=0;for(bb=o.length-3;Y<bb;Y+=2){s=o[Y];w=o[Y+1];H=o[Y+2];la=o[Y+3];va+=s*la-H*w}if((va/2>0?"CW":"CCW")==="CW")o=o;else{s=[];for(w=o.length-2;w>=0;w-=2)s.push(o[w],o[w+1]);o=s}e[g]=o;e[V]=k/i.length<<0;e[ca]=[v||null,v?v.adjustLightness(0.8):null,q?q:v?v.adjustLightness(1.2):ha];b.push(e)}}}return b}function Z(a,c){if(a){wa=J(a,c);Ga=0;G(S);D={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};A=y(wa,true);
aa()}else{wa=null;M()}}function G(a){var c,b,d;S=a;ta=kb<<S;T=1-f(S,Ga,Ta,0,0.3);Ha=da.adjustAlpha(T)+"";Ia=Ja.adjustAlpha(T)+"";Ka=ha.adjustAlpha(T)+"";La=Ma.adjustAlpha(T)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[$]=[];for(b=0;b<3;b++)if(d[ca][b])d[$][b]=d[ca][b].adjustAlpha(T)+""}}}function oa(a){var c;Na=a;ea=null;if(Na){c=x(W+ka,X+Ea);a=-c.longitude/N;c=c.latitude/N;var b=Na.valueOf()/lb-0.5+mb,d=nb+ob*(b-cb),e=pb*P(d)+qb*P(2*d)+rb*P(3*d);e=d+sb+e+ga;d=Za(P(e)*P(db));e=$a(P(e)*ba(db),ba(e));
a=tb+ub*(b-cb)-a-e;a={altitude:Za(P(c)*P(d)+ba(c)*ba(d)*ba(a)),azimuth:$a(P(a),ba(a)*P(c)-Ca(d)*ba(c))-ga/2};if(a.altitude<=0){ia=-1;Oa=f(-a.altitude,0,1,0.1,0.8)}else{ia=1/Ca(a.altitude);Oa=0.4/ia;xa=ba(a.azimuth)*ia;ya=P(a.azimuth)*ia}Ma.a=Oa;La=Ma+"";M()}}function fa(){var a,c,b,d,e,g,i,k,l=W-D.x,o=X-D.y,v,q,t,r,s,w,H=[];n.fillStyle=La;a=0;for(c=A.length;a<c;a++){e=A[a];q=false;g=e[R];v=[];b=0;for(d=g.length-1;b<d;b+=2){v[b]=i=g[b]-l;v[b+1]=k=g[b+1]-o;q||(q=i>0&&i<z&&k>0&&k<B)}if(q){g=e[V];if(e[O])g=
e[O];i=null;n.beginPath();b=0;for(d=v.length-3;b<d;b+=2){k=v[b];t=v[b+1];q=v[b+2];r=v[b+3];s={x:k+xa*g,y:t+ya*g};w={x:q+xa*g,y:r+ya*g};if(e[O]){t={x:k+xa*g,y:t+ya*g};r={x:q+xa*g,y:r+ya*g};k=t.x;t=t.y;q=r.x;r=r.y}if((q-k)*(s.y-t)>(s.x-k)*(r-t)){i===1&&n.lineTo(k,t);i=0;b||n.moveTo(k,t);n.lineTo(q,r)}else{i===0&&n.lineTo(s.x,s.y);i=1;b||n.moveTo(s.x,s.y);n.lineTo(w.x,w.y)}}n.closePath();n.fill();H.push(v)}}n.fillStyle=Ha;a=0;for(c=H.length;a<c;a++)ja(H[a]);a=n.getImageData(0,0,z,B);c=a.data;b=Oa*255<<
0;l=0;for(o=c.length;l<o;l+=4){d=c[l+0];e=c[l+3];if(d&&e>=255)c[l+3]=0;else if(e>b)c[l+3]=b}n.putImageData(a,0,0);ea=new Image;ea.src=F.toDataURL()}function aa(){ma=0;ea=null;clearInterval(Ua);Ua=setInterval(function(){ma+=0.1;if(ma>1){clearInterval(Ua);ma=1;for(var a=0,c=A.length;a<c;a++)A[a][sa]=0}M()},33)}function M(){n.clearRect(0,0,z,B);if(D&&A)if(!(S<Ga||Va)){if(Wa&&ia>-1){Na||oa(new Date);if(ea)n.drawImage(ea,eb-W,fb-X);else{fa();eb=W;fb=X}}var a,c,b,d,e,g,i,k,l,o=W-D.x,v=X-D.y,q=[za+o,Aa+
v],t,r,s,w,H,la;A.sort(function(va,Y){return I(Y[Da],q)/Y[V]-I(va[Da],q)/va[V]});a=0;for(c=A.length;a<c;a++){e=A[a];r=false;g=e[R];t=[];b=0;for(d=g.length-1;b<d;b+=2){t[b]=k=g[b]-o;t[b+1]=l=g[b+1]-v;r||(r=k>0&&k<z&&l>0&&l<B)}if(r){b=e[sa]?e[V]*ma:e[V];g=na/(na-b);if(e[O]){b=e[sa]?e[O]*ma:e[O];i=na/(na-b)}k=[];b=0;for(d=t.length-3;b<d;b+=2){l=t[b];s=t[b+1];r=t[b+2];w=t[b+3];H=K(l,s,g);la=K(r,w,g);if(e[O]){s=K(l,s,i);w=K(r,w,i);l=s.x;s=s.y;r=w.x;w=w.y}if((r-l)*(H.y-s)>(H.x-l)*(w-s)){n.fillStyle=l<r&&
s<w||l>r&&s>w?e[$][1]||Ia:e[$][0]||Ha;ja([r,w,l,s,H.x,H.y,la.x,la.y])}k[b]=H.x;k[b+1]=H.y}n.fillStyle=e[$][2]||Ka;n.strokeStyle=e[$][1]||Ia;ja(k,true)}}if(Wa&&ia===-1){n.fillStyle=La;n.fillRect(0,0,z,B)}}}function ja(a,c){if(a.length){n.beginPath();n.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)n.lineTo(a[b],a[b+1]);n.closePath();c&&n.stroke();n.fill()}}function K(a,c,b){return{x:(a-za)*b+za<<0,y:(c-Aa)*b+Aa<<0}}var z=0,B=0,ka=0,Ea=0,W=0,X=0,S,ta,Fa,F,n,Sa,da=new Q(200,190,180),Ja=da.adjustLightness(0.8),
ha=da.adjustLightness(1.2),Ma=new Q(0,0,0),Ha=da+"",Ia=Ja+"",Ka=ha+"",La=Ma+"",Wa=true,wa,D,A,ma=1,Ua,T=1,Ga=Ra,Ta=20,ua,za,Aa,na,Va,eb,fb,ea,Oa=1,ia=-1,xa=0,ya=0,Na,lb=864E5,mb=2440588,cb=2451545,nb=357.5291/N,ob=0.98560028/N,pb=1.9148/N,qb=0.02/N,rb=3.0E-4/N,sb=102.9372/N,db=23.45/N,tb=280.16/N,ub=360.9856235/N;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=Q.parse(a.color||a.wallColor);Ha=da.adjustAlpha(T)+"";Ja=da.adjustLightness(0.8);Ia=Ja.adjustAlpha(T)+"";ha=da.adjustLightness(1.2);
Ka=ha.adjustAlpha(T)+""}if(a.roofColor){ha=Q.parse(a.roofColor);Ka=ha.adjustAlpha(T)+""}if(a.shadows!==undefined)Wa=!!a.shadows;M();return this};this.geoJSON=function(a,c){E(a,c);return this};this.setCamOffset=function(a,c){za=ka+a;Aa=B+c};this.setMaxZoom=function(a){Ta=a};this.createCanvas=function(a){F=Qa.createElement("CANVAS");F.style.webkitTransform="translate3d(0,0,0)";F.style.imageRendering="optimizeSpeed";F.style.position="absolute";F.style.pointerEvents="none";F.style.left=0;F.style.top=
0;a.appendChild(F);n=F.getContext("2d");n.lineCap="round";n.lineJoin="round";n.lineWidth=1;try{n.mozImageSmoothingEnabled=false}catch(c){}return F};this.destroyCanvas=function(){F.parentNode.removeChild(F)};this.loadData=j;this.onMoveEnd=function(){var a=x(W,X),c=x(W+z,X+B);ea=null;M();if(D&&(a[qa]>D.n||a[ra]<D.w||c[qa]<D.s||c[ra]>D.e))j()};this.onZoomEnd=function(a){Va=false;G(a.zoom);if(wa){A=y(wa);ea=null;M()}else{M();j()}};this.onZoomStart=function(){Va=true;M()};this.render=M;this.setOrigin=
function(a,c){W=a;X=c};this.setSize=function(a,c){z=a;B=c;ka=z/2<<0;Ea=B/2<<0;za=ka;Aa=B;na=z/1.5/Ca(45)<<0;F.width=z;F.height=B;ua=na-50};this.setZoom=G;this.setDate=oa;Sa=p};m.OSMBuildings.VERSION="0.1.8a";m.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(m){m=m||{};m.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,m)},setOrigin:function(){var m=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),I=this.map.resolution,L=this.maxExtent;this.osmb.setOrigin(Math.round((m.lon-L.left)/I),Math.round((L.top-
m.lat)/I))},setMap:function(m){if(!this.map){OpenLayers.Layer.prototype.setMap(m);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(m){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(m)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(m,I,L){m=OpenLayers.Layer.prototype.moveTo(m,I,L);if(!L){L=parseInt(this.map.layerContainerDiv.style.left,10);var Ba=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-L+"px";this.div.style.top=-Ba+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);I?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return m},moveByPx:function(m,I){this.dxSum+=m;this.dySum+=I;var L=OpenLayers.Layer.prototype.moveByPx(m,I);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return L},geoJSON:function(m,I){return this.osmb.geoJSON(m,I)},setStyle:function(m){return this.osmb.setStyle(m)},setDate:function(m){return this.osmb.setDate(m)}});
