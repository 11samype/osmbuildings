(function(j){var w=w||Array,I=Math.exp,ja=Math.log,ya=Math.tan,za=Math.atan,ka=Math.min,Aa=Math.max,la=j.document,x=function(){function W(e,g,l){if(l<0)l+=1;if(l>1)l-=1;if(l<1/6)return e+(g-e)*6*l;if(l<0.5)return g;if(l<2/3)return e+(g-e)*(2/3-l)*6;return e}function C(e,g,l,m){this.r=e;this.g=g;this.b=l;this.a=arguments.length<4?1:m}var X=C.prototype;X.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};X.adjustLightness=function(e){var g=x.toHSLA(this);g.l*=
e;g.l=Math.min(1,Math.max(0,g.l));var l,m;if(g.s===0)e=l=m=g.l;else{m=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var v=2*g.l-m;e=W(v,m,g.h+1/3);l=W(v,m,g.h);m=W(v,m,g.h-1/3)}return new x(~~(e*255),~~(l*255),~~(m*255),g.a)};X.adjustAlpha=function(e){return new x(this.r,this.g,this.b,this.a*e)};C.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new x(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new x(parseInt(e[1],
10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};C.toHSLA=function(e){var g=e.r/255,l=e.g/255,m=e.b/255,v=Math.max(g,l,m),y=Math.min(g,l,m),D,K=(v+y)/2,E;if(v===y)D=y=0;else{E=v-y;y=K>0.5?E/(2-v-y):E/(v+y);switch(v){case g:D=(l-m)/E+(l<m?6:0);break;case l:D=(m-g)/E+2;break;case m:D=(g-l)/E+4;break}D/=6}return{h:D,s:y,l:K,a:e.a}};return C}(),Y=Math.PI,wa=Y/2,Ba=Y/4,Ca=180/Y,Da=256,ma=14,na=400,xa=na-50,Z="latitude",$="longitude",L=0,J=1,A=2,ga=3;j.OSMBuildings=function(W){function C(a,
c){var b={};a/=aa;c/=aa;b[Z]=c<=0?90:c>=1?-90:Ca*(2*za(I(Y*(1-2*c)))-wa);b[$]=(a===1?1:(a%1+1)%1)*360-180;return b}function X(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function g(){if(!(!oa||z<ma)){var a=C(P-ba,Q-pa),c=C(P+M+ba,Q+F+pa);ha&&ha.abort();ha=e(X(oa,
{w:a[$],n:a[Z],e:c[$],s:c[Z],z:z}),l)}}function l(a){var c,b,d,f=[],h=0,i=0;ca=ma;K(z);ha=null;if(!(!a||a.meta.z!==z)){d=a.meta;b=a.data;if(t&&n&&t.z===d.z){h=t.x-d.x;i=t.y-d.y;a=0;for(c=n.length;a<c;a++)f[a]=n[a][J][0]+h+","+(n[a][J][1]+i)}t=d;n=[];a=0;for(c=b.length;a<c;a++){n[a]=b[a];n[a][L]=ka(n[a][L],xa);d=n[a][J][0]+","+n[a][J][1];n[a][ga]=!(f&&~f.indexOf(d))}E()}}function m(a,c){var b=[],d,f,h,i,k,q,p,o,r=qa-z;d=0;for(f=a.length;d<f;d++){k=a[d];q=k[J];p=new w(q.length);h=0;for(i=q.length-1;h<
i;h+=2){o=q[h+1];var G=ka(1,Aa(0,0.5-ja(ya(Ba+wa*q[h]/180))/Y/2));o={x:~~((o/360+0.5)*aa),y:~~(G*aa)};p[h]=o.x;p[h+1]=o.y}b[d]=[];b[d][L]=ka(k[L]>>r,xa);b[d][J]=p;b[d][A]=k[A];b[d][ga]=c}return b}function v(a,c){if(typeof a==="object")D(a,!c);else{var b=la.documentElement,d=la.createElement("script");j.jsonpCallback=function(f){delete j.jsonpCallback;b.removeChild(d);D(f,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function y(a,c,b){if(b===undefined)b=[];var d,
f,h,i=a[0]?a:a.features,k,q,p,o,r,G=c?1:0,R=c?0:1;if(i){d=0;for(a=i.length;d<a;d++)y(i[d],c,b);return b}if(a.type==="Feature"){f=a.geometry;d=a.properties}if(f.type==="Polygon")k=[f.coordinates];if(f.type==="MultiPolygon")k=f.coordinates;if(k){c=d.height;if(d.color||d.wallColor)o=x.parse(d.color||d.wallColor);if(d.roofColor)r=x.parse(d.roofColor);d=0;for(a=k.length;d<a;d++){q=k[d][0];i=[];f=p=0;for(h=q.length;f<h;f++){i.push(q[f][G],q[f][R]);p+=c||q[f][2]||0}if(p){f=[];f[L]=~~(p/q.length);q=J;p=void 0;
h=void 0;var N=void 0,B=void 0,S=0,H=void 0,da=void 0;H=0;for(da=i.length-3;H<da;H+=2){p=i[H];h=i[H+1];N=i[H+2];B=i[H+3];S+=p*B-N*h}if((S/2>0?"CW":"CCW")==="CW")i=i;else{p=[];for(h=i.length-2;h>=0;h-=2)p.push(i[h],i[h+1]);i=p}f[q]=i;if(o||r)f[A]=[o,r];b.push(f)}}}return b}function D(a,c){if(a){ea=y(a,c);ca=0;K(z);t={n:90,w:-180,s:-90,e:180,x:0,y:0,z:z};n=m(ea,true);E()}else{ea=null;T()}}function K(a){z=a;aa=Da<<z;O=1-(z-ca)*0.3/(qa-ca)}function E(){fa=0;clearInterval(ra);ra=setInterval(function(){fa+=
0.1;if(fa>1){clearInterval(ra);fa=1;for(var a=0,c=n.length;a<c;a++)n[a][ga]=0}T()},33)}function T(){s.clearRect(0,0,M,F);if(t&&n)if(!(z<ca||sa)){var a,c,b,d,f,h,i,k,q=P-t.x,p=Q-t.y,o,r,G,R,N,B,S,H=ta.adjustAlpha(O)+"",da=(ua||ta.adjustLightness(1.2)).adjustAlpha(O)+"";if(ia)s.strokeStyle=Ea.adjustAlpha(O)+"";a=0;for(c=n.length;a<c;a++){f=n[a];r=false;h=f[J];o=[];b=0;for(d=h.length-1;b<d;b+=2){o[b]=i=h[b]-q;o[b+1]=k=h[b+1]-p;r||(r=i>0&&i<M&&k>0&&k<F)}if(r){s.fillStyle=f[A]&&f[A][0]?f[A][0].adjustAlpha(O)+
"":H;b=f[ga]?f[L]*fa:f[L];h=na/(na-b);i=[];k=[];b=0;for(d=o.length-3;b<d;b+=2){r=o[b];G=o[b+1];R=o[b+2];N=o[b+3];B={x:~~((r-U)*h+U)+0.5,y:~~((G-V)*h+V)+0.5};S={x:~~((R-U)*h+U)+0.5,y:~~((N-V)*h+V)+0.5};if((R-r)*(B.y-G)>(B.x-r)*(N-G)){if(!k.length){k.unshift(G+0.5);k.unshift(r+0.5);k.push(B.x,B.y)}k.unshift(N+0.5);k.unshift(R+0.5);k.push(S.x,S.y)}else{va(k);k=[]}i[b]=B.x;i[b+1]=B.y}va(k);s.fillStyle=!f[A]?da:f[A][1]?f[A][1].adjustAlpha(O)+"":ua?da:f[A][0].adjustLightness(1.2).adjustAlpha(O)+"";va(i,
ia)}}}}function va(a,c){if(a.length){s.beginPath();s.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)s.lineTo(a[b],a[b+1]);s.closePath();c&&s.stroke();s.fill()}}oa=W;var M=0,F=0,ba=0,pa=0,P=0,Q=0,z,aa,ha,u,s,oa,ia,ta=new x(200,190,180),ua,Ea=new x(145,140,135),ea,t,n,O=1,fa=1,ra,ca=ma,qa=20,U,V,sa;this.setStyle=function(a){a=(a=a)||{};ia=a.strokeRoofs!==undefined?a.strokeRoofs:ia;if(a.color||a.wallColor)ta=x.parse(a.color||a.wallColor);if(a.roofColor!==undefined)ua=x.parse(a.roofColor);T();return this};
this.geoJSON=function(a,c){v(a,c);return this};this.setCamOffset=function(a,c){U=ba+a;V=F+c};this.setMaxZoom=function(a){qa=a};this.createCanvas=function(a){u=la.createElement("canvas");u.style.webkitTransform="translate3d(0,0,0)";u.style.imageRendering="optimizeSpeed";u.style.position="absolute";u.style.pointerEvents="none";u.style.left=0;u.style.top=0;a.appendChild(u);s=u.getContext("2d");s.lineCap="round";s.lineJoin="round";s.lineWidth=1;try{s.mozImageSmoothingEnabled=false}catch(c){}return u};
this.destroyCanvas=function(){u.parentNode.removeChild(u)};this.loadData=g;this.onMoveEnd=function(){var a=C(P,Q),c=C(P+M,Q+F);if(t&&(a[Z]>t.n||a[$]<t.w||c[Z]<t.s||c[$]>t.e))g()};this.onZoomEnd=function(a){sa=false;K(a.zoom);if(ea){n=m(ea);T()}else g()};this.onZoomStart=function(){sa=true;T()};this.render=T;this.setOrigin=function(a,c){P=a;Q=c};this.setSize=function(a,c){M=a;F=c;ba=~~(M/2);pa=~~(F/2);U=ba;V=F;u.width=M;u.height=F};this.setZoom=K};j.OSMBuildings.VERSION="0.1.6a";j.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(j){j.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,j);this.osmb=new OSMBuildings(j.url)},updateOrigin:function(){var j=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),w=this.map.getResolution();this.osmb.setOrigin(~~((j.lon-this.maxExtent.left)/
w),~~((this.maxExtent.top-j.lat)/w))},setMap:function(j){if(!this.map){OpenLayers.Layer.prototype.setMap(j);this.osmb.createCanvas(this.div);j=this.map.getSize();this.osmb.setSize(j.w,j.h);this.osmb.setZoom(this.map.getZoom());this.updateOrigin();this.osmb.loadData()}},removeMap:function(j){this.osmb.destroyCanvas();OpenLayers.Layer.prototype.removeMap(j)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();var j=this.map.getSize();this.osmb.setSize(j.w,j.h);this.osmb.render()},moveTo:function(j,
w,I){j=OpenLayers.Layer.prototype.moveTo(j,w,I);if(!I){I=parseInt(this.map.layerContainerDiv.style.left,10);var ja=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-I+"px";this.div.style.top=-ja+"px"}w&&this.osmb.onZoomEnd({zoom:this.map.getZoom()});this.updateOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();this.osmb.onMoveEnd({});return j},moveByPx:function(j,w){this.dxSum+=j;this.dySum+=w;var I=OpenLayers.Layer.prototype.moveByPx(j,
w);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return I}});
