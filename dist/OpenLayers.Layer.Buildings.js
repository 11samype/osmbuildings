(function(m){function I(t,x){var C=t[0]-x[0],e=t[1]-x[1];return C*C+e*e}function K(t){for(var x=0,C=0,e=0,h=t.length-3;e<h;e+=2){x+=t[e];C+=t[e+1]}t=(t.length-2)*2;return[x/t<<0,C/t<<0]}function xa(t){var x=t.length/2,C=new Qa(x),e=0,h=x-1,i,u,z,D,J=[],O=[],P=[];for(C[e]=C[h]=1;h;){u=0;for(i=e+1;i<h;i++){z=t[i*2];var ea=t[i*2+1],aa=t[e*2],F=t[e*2+1],ja=t[h*2],fa=t[h*2+1],A=ja-aa,y=fa-F,L=void 0;if(A!==0||y!==0){L=((z-aa)*A+(ea-F)*y)/(A*A+y*y);if(L>1){aa=ja;F=fa}else if(L>0){aa+=A*L;F+=y*L}}A=z-aa;
y=ea-F;z=A*A+y*y;if(z>u){D=i;u=z}}if(u>2){C[D]=1;J.push(e);O.push(D);J.push(D);O.push(h)}e=J.pop();h=O.pop()}for(i=0;i<x;i++)C[i]&&P.push(t[i*2],t[i*2+1]);return P}var Ra=Ra||Array,Qa=Qa||Array,Za=Math.exp,$a=Math.log,Ga=Math.tan,ab=Math.atan,Ha=Math.min,bb=Math.max,Ia=m.document,M=function(){function t(e,h,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(h-e)*6*i;if(i<0.5)return h;if(i<2/3)return e+(h-e)*(2/3-i)*6;return e}function x(e,h,i,u){this.r=e;this.g=h;this.b=i;this.a=arguments.length<4?1:u}
var C=x.prototype;C.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};C.adjustLightness=function(e){var h=M.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var i,u;if(h.s===0)e=i=u=h.l;else{u=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var z=2*h.l-u;e=t(z,u,h.h+1/3);i=t(z,u,h.h);u=t(z,u,h.h-1/3)}return new M(e*255<<0,i*255<<0,u*255<<0,h.a)};C.adjustAlpha=function(e){return new M(this.r,this.g,this.b,this.a*e)};x.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new M(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new M(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};x.toHSLA=function(e){var h=e.r/255,i=e.g/255,u=e.b/255,z=Math.max(h,i,u),D=Math.min(h,i,u),J,O=(z+D)/2,P;if(z===D)J=D=0;else{P=z-D;D=O>0.5?P/(2-z-D):P/(z+D);switch(z){case h:J=(i-u)/P+(i<u?6:0);break;case i:J=
(u-h)/P+2;break;case u:J=(h-i)/P+4;break}J/=6}return{h:J,s:D,l:O,a:e.a}};return x}(),ga=Math.PI,Sa=ga/2,cb=ga/4,db=180/ga,eb=256,Ja=14,na="latitude",oa="longitude",U=0,N=1,Q=2,ba=3,ya=4,pa=5,$=6;m.OSMBuildings=function(t){function x(a,c){var b={};a/=qa;c/=qa;b[na]=c<=0?90:c>=1?-90:db*(2*ab(Za(ga*(1-2*c)))-Sa);b[oa]=(a===1?1:(a%1+1)%1)*360-180;return b}function C(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===
4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function h(){if(!(!Ka||R<Ja)){var a=x(V-L,W-za),c=x(V+A+L,W+y+za);Aa&&Aa.abort();Aa=e(C(Ka,{w:a[oa],n:a[na],e:c[oa],s:c[na],z:R}),i)}}function i(a){var c,b,d,f=[],g,j=g=0;ra=Ja;O(R);Aa=null;if(!(!a||a.meta.z!==R)){d=a.meta;b=a.data;if(E&&B&&E.z===d.z){g=E.x-d.x;j=E.y-d.y;a=0;for(c=B.length;a<c;a++)f[a]=B[a][Q][0]+g+","+(B[a][Q][1]+j)}E=d;B=[];a=0;for(c=b.length;a<c;a++){d=
[];if(!(b[a][N]>sa)){g=xa(b[a][Q]);if(!(g.length<8)){d[Q]=g;d[ya]=K(g);d[U]=Ha(b[a][U],sa);d[N]=b[a][N];g=d[Q][0]+","+d[Q][1];d[pa]=!(f&&~f.indexOf(g));d[ba]=[];d[$]=[];B.push(d)}}}aa()}}function u(a,c){var b=[],d,f,g,j,l,k,o,w,r,v=La-R;d=0;for(f=a.length;d<f;d++){l=a[d];w=l[N]>>v;if(!(w>sa)){k=l[Q];r=new Ra(k.length);g=0;for(j=k.length-1;g<j;g+=2){o=k[g+1];var p=Ha(1,bb(0,0.5-$a(Ga(cb+Sa*k[g]/180))/ga/2));o={x:(o/360+0.5)*qa<<0,y:p*qa<<0};r[g]=o.x;r[g+1]=o.y}r=xa(r);if(!(r.length<8)){j=[];j[Q]=r;
j[ya]=K(r);j[U]=Ha(l[U]>>v,sa);j[N]=w;j[pa]=c;j[ba]=l[ba];j[$]=[];for(g=0;g<3;g++)if(j[ba][g])j[$][g]=j[ba][g].adjustAlpha(S)+"";b.push(j)}}}return b}function z(a,c){if(typeof a==="object")J(a,!c);else{var b=Ia.documentElement,d=Ia.createElement("script");m.jsonpCallback=function(f){delete m.jsonpCallback;b.removeChild(d);J(f,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,c,b){if(b===undefined)b=[];var d,f,g,j=a[0]?a:a.features,l,k,o,w,r,v=c?1:0,p=c?
0:1;if(j){d=0;for(a=j.length;d<a;d++)D(j[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")k=[l.coordinates];if(l.type==="MultiPolygon")k=l.coordinates;if(k){c=d.height;if(d.color||d.wallColor)w=M.parse(d.color||d.wallColor);if(d.roofColor)r=M.parse(d.roofColor);d=0;for(a=k.length;d<a;d++){j=k[d][0];o=[];f=l=0;for(g=j.length;f<g;f++){o.push(j[f][v],j[f][p]);l+=c||j[f][2]||0}if(l){f=[];g=Q;var q=void 0,s=void 0,H=void 0,X=void 0,ta=0,Y=void 0,Ta=void 0;Y=0;for(Ta=
o.length-3;Y<Ta;Y+=2){q=o[Y];s=o[Y+1];H=o[Y+2];X=o[Y+3];ta+=q*X-H*s}if((ta/2>0?"CW":"CCW")==="CW")o=o;else{q=[];for(s=o.length-2;s>=0;s-=2)q.push(o[s],o[s+1]);o=q}f[g]=o;f[U]=l/j.length<<0;f[ba]=[w||null,w?w.adjustLightness(0.8):null,r?r:w?w.adjustLightness(1.2):ha];b.push(f)}}}return b}function J(a,c){if(a){ua=D(a,c);ra=0;O(R);E={n:90,w:-180,s:-90,e:180,x:0,y:0,z:R};B=u(ua,true);aa()}else{ua=null;F()}}function O(a){var c,b,d;R=a;qa=eb<<R;S=1-(R-ra)*0.3/(La-ra);Ba=ca.adjustAlpha(S)+"";Ca=Da.adjustAlpha(S)+
"";Ea=ha.adjustAlpha(S)+"";Ma=Ua.adjustAlpha(S)+"";if(B){a=0;for(c=B.length;a<c;a++){d=B[a];d[$]=[];for(b=0;b<3;b++)if(d[ba][b])d[$][b]=d[ba][b].adjustAlpha(S)+""}}}function P(){var a,c,b,d,f,g,j,l,k,o=V-E.x,w=W-E.y,r,v,p,q,s,H,X=[];n.fillStyle=Ma;a=0;for(c=B.length;a<c;a++){f=B[a];v=false;g=f[Q];r=[];b=0;for(d=g.length-1;b<d;b+=2){r[b]=l=g[b]-o;r[b+1]=k=g[b+1]-w;v||(v=l>0&&l<A&&k>0&&k<y)}if(v){b=f[U];g=va/(va-b);if(f[N]){b=f[N];j=va/(va-b)}l=null;n.beginPath();b=0;for(d=r.length-3;b<d;b+=2){k=r[b];
p=r[b+1];v=r[b+2];q=r[b+3];s=ea(k,p,g);H=ea(v,q,g);if(f[N]){p=ea(k,p,j);q=ea(v,q,j);k=p.x;p=p.y;v=q.x;q=q.y}if((v-k)*(s.y-p)>(s.x-k)*(q-p)){l===1&&n.lineTo(k,p);l=0;b||n.moveTo(k,p);n.lineTo(v,q)}else{l===0&&n.lineTo(s.x,s.y);l=1;b||n.moveTo(s.x,s.y);n.lineTo(H.x,H.y)}}n.closePath();n.fill();X.push(r)}}n.fillStyle=Ba;a=0;for(c=X.length;a<c;a++)ja(X[a]);a=n.getImageData(0,0,A,y);c=a.data;f=M.parse(Ma).a*255<<0;w=0;for(r=c.length;w<r;w+=4){j=c[w+0];o=c[w+3];if(j&&o>=255)c[w+3]=0;else if(o>f)c[w+3]=
f}n.putImageData(a,0,0);da=new Image;da.src=G.toDataURL()}function ea(a,c,b){return{x:(a-Na)*b+Na,y:(c-Fa)*b+Fa}}function aa(){ka=0;da=null;clearInterval(Oa);Oa=setInterval(function(){ka+=0.1;if(ka>1){clearInterval(Oa);ka=1;for(var a=0,c=B.length;a<c;a++)B[a][pa]=0}F()},33)}function F(){n.clearRect(0,0,A,y);if(E&&B)if(!(R<ra||Pa)){if(Va)if(da)n.drawImage(da,Wa-V,Xa-W);else{P();Wa=V;Xa=W}var a,c,b,d,f,g,j,l,k,o=V-E.x,w=W-E.y,r=[la+o,wa+w],v,p,q,s,H,X;B.sort(function(ta,Y){return I(Y[ya],r)/Y[U]-I(ta[ya],
r)/ta[U]});a=0;for(c=B.length;a<c;a++){f=B[a];p=false;g=f[Q];v=[];b=0;for(d=g.length-1;b<d;b+=2){v[b]=l=g[b]-o;v[b+1]=k=g[b+1]-w;p||(p=l>0&&l<A&&k>0&&k<y)}if(p){b=f[pa]?f[U]*ka:f[U];g=ma/(ma-b);if(f[N]){b=f[pa]?f[N]*ka:f[N];j=ma/(ma-b)}l=[];b=0;for(d=v.length-3;b<d;b+=2){k=v[b];q=v[b+1];p=v[b+2];s=v[b+3];H=fa(k,q,g);X=fa(p,s,g);if(f[N]){q=fa(k,q,j);s=fa(p,s,j);k=q.x;q=q.y;p=s.x;s=s.y}if((p-k)*(H.y-q)>(H.x-k)*(s-q)){n.fillStyle=k<p&&q<s||k>p&&q>s?f[$][1]||Ca:f[$][0]||Ba;ja([p,s,k,q,H.x,H.y,X.x,X.y])}l[b]=
H.x;l[b+1]=H.y}n.fillStyle=f[$][2]||Ea;n.strokeStyle=f[$][1]||Ca;ja(l,true)}}}}function ja(a,c){if(a.length){n.beginPath();n.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)n.lineTo(a[b],a[b+1]);n.closePath();c&&n.stroke();n.fill()}}function fa(a,c,b){return{x:(a-la)*b+la<<0,y:(c-wa)*b+wa<<0}}var A=0,y=0,L=0,za=0,V=0,W=0,R,qa,Aa,G,n,Ka,ca=new M(200,190,180),Da=ca.adjustLightness(0.8),ha=ca.adjustLightness(1.2),Ua=new M(0,0,0,0.4),Ba=ca+"",Ca=Da+"",Ea=ha+"",Ma=Ua+"",Va=true,ua,E,B,ka=1,Oa,S=1,ra=
Ja,La=20,sa,la,wa,ma,Pa,Na,Fa,va,Wa,Xa,da,Z=Math.sin,ia=Math.cos,T=ga/180,fb=T*357.5291,gb=T*0.98560028,hb=T*1.9148,ib=T*0.02,jb=T*3.0E-4,kb=T*102.9372,Ya=T*23.45,lb=T*280.16,mb=T*360.9856235;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ca=M.parse(a.color||a.wallColor);Ba=ca.adjustAlpha(S)+"";Da=ca.adjustLightness(0.8);Ca=Da.adjustAlpha(S)+"";ha=ca.adjustLightness(1.2);Ea=ha.adjustAlpha(S)+""}if(a.roofColor){ha=M.parse(a.roofColor);Ea=ha.adjustAlpha(S)+""}if(a.shadows!==undefined)Va=
!!a.shadows;F();return this};this.geoJSON=function(a,c){z(a,c);return this};this.setCamOffset=function(a,c){la=L+a;wa=y+c};this.setMaxZoom=function(a){La=a};this.createCanvas=function(a){G=Ia.createElement("CANVAS");G.style.webkitTransform="translate3d(0,0,0)";G.style.imageRendering="optimizeSpeed";G.style.position="absolute";G.style.pointerEvents="none";G.style.left=0;G.style.top=0;a.appendChild(G);n=G.getContext("2d");n.lineCap="round";n.lineJoin="round";n.lineWidth=1;try{n.mozImageSmoothingEnabled=
false}catch(c){}return G};this.destroyCanvas=function(){G.parentNode.removeChild(G)};this.loadData=h;this.onMoveEnd=function(){var a=x(V,W),c=x(V+A,W+y);da=null;F();if(E&&(a[na]>E.n||a[oa]<E.w||c[na]<E.s||c[oa]>E.e))h()};this.onZoomEnd=function(a){Pa=false;O(a.zoom);if(ua){B=u(ua);da=null;F()}else{F();h()}};this.onZoomStart=function(){Pa=true;F()};this.render=F;this.setOrigin=function(a,c){V=a;W=c};this.setSize=function(a,c){A=a;y=c;L=A/2<<0;za=y/2<<0;la=L;wa=y;ma=A/1.5/Ga(45)<<0;G.width=A;G.height=
y;sa=ma-50};this.setZoom=O;this.setDate=function(a){if(a){var c=x(V+L,W+za),b;b=T*-c.longitude;c=T*c.latitude;a=a.valueOf()/864E5-0.5+2440588;var d=fb+gb*(a-2451545),f=hb*Z(d)+ib*Z(2*d)+jb*Z(3*d);f=d+kb+f+ga;d=Math.asin(Z(f)*Z(Ya));f=Math.atan2(Z(f)*ia(Ya),ia(f));b=lb+mb*(a-2451545)-b-f;b={azimuth:Math.atan2(Z(b),ia(b)*Z(c)-Math.tan(d)*ia(c)),altitude:Math.asin(Z(c)*Z(d)+ia(c)*ia(d)*ia(b))};if(!(b.altitude<0)){Na=la;Fa=5E4;va=2*Fa*Ga(b.altitude);da=null;F()}}};Ka=t};m.OSMBuildings.VERSION="0.1.7a";
m.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(m){m=m||{};m.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,m)},setOrigin:function(){var m=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),I=this.map.resolution,K=this.maxExtent;this.osmb.setOrigin(Math.round((m.lon-K.left)/I),Math.round((K.top-
m.lat)/I))},setMap:function(m){if(!this.map){OpenLayers.Layer.prototype.setMap(m);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(m){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(m)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(m,I,K){m=OpenLayers.Layer.prototype.moveTo(m,I,K);if(!K){K=parseInt(this.map.layerContainerDiv.style.left,10);var xa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-K+"px";this.div.style.top=-xa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);I?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return m},moveByPx:function(m,I){this.dxSum+=m;this.dySum+=I;var K=OpenLayers.Layer.prototype.moveByPx(m,I);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return K},geoJSON:function(m,I){return this.osmb.geoJSON(m,I)},setStyle:function(m){return this.osmb.setStyle(m)},setDate:function(m){return this.osmb.setDate(m)}});
