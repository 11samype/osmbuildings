(function(k){function u(P,z){var Q=P[0]-z[0],f=P[1]-z[1];return Q*Q+f*f}var A=A||Array,ka=Math.exp,Ca=Math.log,Da=Math.tan,Ea=Math.atan,la=Math.min,wa=Math.max,ma=k.document,E=function(){function P(f,i,m){if(m<0)m+=1;if(m>1)m-=1;if(m<1/6)return f+(i-f)*6*m;if(m<0.5)return i;if(m<2/3)return f+(i-f)*(2/3-m)*6;return f}function z(f,i,m,p){this.r=f;this.g=i;this.b=m;this.a=arguments.length<4?1:p}var Q=z.prototype;Q.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};
Q.adjustLightness=function(f){var i=E.toHSLA(this);i.l*=f;i.l=Math.min(1,Math.max(0,i.l));var m,p;if(i.s===0)f=m=p=i.l;else{p=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var B=2*i.l-p;f=P(B,p,i.h+1/3);m=P(B,p,i.h);p=P(B,p,i.h-1/3)}return new E(f*255<<0,m*255<<0,p*255<<0,i.a)};Q.adjustAlpha=function(f){return new E(this.r,this.g,this.b,this.a*f)};z.parse=function(f){f+="";if(~f.indexOf("#")){f=f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new E(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?
parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new E(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};z.toHSLA=function(f){var i=f.r/255,m=f.g/255,p=f.b/255,B=Math.max(i,m,p),F=Math.min(i,m,p),I,S=(B+F)/2,J;if(B===F)I=F=0;else{J=B-F;F=S>0.5?J/(2-B-F):J/(B+F);switch(B){case i:I=(m-p)/J+(m<p?6:0);break;case m:I=(p-i)/J+2;break;case p:I=(i-m)/J+4;break}I/=6}return{h:I,s:F,l:S,a:f.a}};return z}(),Z=Math.PI,xa=Z/2,Fa=Z/4,Ga=
180/Z,Ha=256,na=14,oa=400,ya=oa-50,$="latitude",aa="longitude",K=0,C=1,y=2,pa=3,ga=4;k.OSMBuildings=function(P){function z(a,d){var b={};a/=ba;d/=ba;b[$]=d<=0?90:d>=1?-90:Ga*(2*Ea(ka(Z*(1-2*d)))-xa);b[aa]=(a===1?1:(a%1+1)%1)*360-180;return b}function Q(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function f(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function i(){if(!(!qa||D<na)){var a=z(W-ca,X-ra),d=z(W+T+ca,X+L+ra);ha&&ha.abort();ha=f(Q(qa,{w:a[aa],n:a[$],e:d[aa],s:d[$],z:D}),m)}}function m(a){var d,b,c,g=[],h,e=h=0,n=wa(1,(D-Y)*2);Y=na;S(D);ha=null;if(!(!a||a.meta.z!==D)){c=a.meta;b=a.data;if(v&&w&&v.z===c.z){h=v.x-c.x;e=v.y-c.y;a=0;for(d=w.length;a<d;a++)g[a]=w[a][C][0]+h+","+(w[a][C][1]+e)}v=c;w=[];a=0;for(d=b.length;a<d;a++){c={};h=C;e=b[a][C];for(var l=n*n,j=void 0,q=[e[0],e[1]],o=[e[0],e[1]],s=2,t=
e.length-3;s<t;s+=2){j=[e[s],e[s+1]];if(u(j,q)>l){o.push(j[0],j[1]);q=j}}if(j[0]!==e[0]||j[1]!==e[1])o.push(e[0],e[1]);c[h]=o;if(!(c[C].length<8)){c[K]=la(b[a][K],ya);h=pa;e=c[C];l=void 0;j=e.length-2;for(l=o=q=0;l<j-1;l+=2){q+=e[l];o+=e[l+1]}c[h]=[q/j*2<<0,o/j*2<<0];h=c[C][0]+","+c[C][1];c[ga]=!(g&&~g.indexOf(h));w.push(c)}}J()}}function p(a,d){var b=[],c,g,h,e,n,l,j,q,o=sa-D;c=0;for(g=a.length;c<g;c++){n=a[c];l=n[C];j=new A(l.length);h=0;for(e=l.length-1;h<e;h+=2){q=l[h+1];var s=la(1,wa(0,0.5-Ca(Da(Fa+
xa*l[h]/180))/Z/2));q={x:(q/360+0.5)*ba<<0,y:s*ba<<0};j[h]=q.x;j[h+1]=q.y}b[c]=[];b[c][K]=la(n[K]>>o,ya);b[c][C]=j;b[c][y]=n[y];b[c][ga]=d}return b}function B(a,d){if(typeof a==="object")I(a,!d);else{var b=ma.documentElement,c=ma.createElement("script");k.jsonpCallback=function(g){delete k.jsonpCallback;b.removeChild(c);I(g,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function F(a,d,b){if(b===undefined)b=[];var c,g,h,e=a[0]?a:a.features,n,l,j,q,o,s=d?1:0,t=d?0:
1;if(e){c=0;for(a=e.length;c<a;c++)F(e[c],d,b);return b}if(a.type==="Feature"){g=a.geometry;c=a.properties}if(g.type==="Polygon")n=[g.coordinates];if(g.type==="MultiPolygon")n=g.coordinates;if(n){d=c.height;if(c.color||c.wallColor)q=E.parse(c.color||c.wallColor);if(c.roofColor)o=E.parse(c.roofColor);c=0;for(a=n.length;c<a;c++){l=n[c][0];e=[];g=j=0;for(h=l.length;g<h;g++){e.push(l[g][s],l[g][t]);j+=d||l[g][2]||0}if(j){g=[];g[K]=j/l.length<<0;l=C;j=void 0;h=void 0;var M=void 0,N=void 0,G=0,H=void 0,
da=void 0;H=0;for(da=e.length-3;H<da;H+=2){j=e[H];h=e[H+1];M=e[H+2];N=e[H+3];G+=j*N-M*h}if((G/2>0?"CW":"CCW")==="CW")e=e;else{j=[];for(h=e.length-2;h>=0;h-=2)j.push(e[h],e[h+1]);e=j}g[l]=e;if(q||o)g[y]=[q,o];b.push(g)}}}return b}function I(a,d){if(a){ea=F(a,d);Y=0;S(D);v={n:90,w:-180,s:-90,e:180,x:0,y:0,z:D};w=p(ea,true);J()}else{ea=null;R()}}function S(a){D=a;ba=Ha<<D;O=1-(D-Y)*0.3/(sa-Y)}function J(){fa=0;clearInterval(ta);ta=setInterval(function(){fa+=0.1;if(fa>1){clearInterval(ta);fa=1;for(var a=
0,d=w.length;a<d;a++)w[a][ga]=0}R()},33)}function R(){r.clearRect(0,0,T,L);if(v&&w)if(!(D<Y||ua)){var a,d,b,c,g,h,e,n,l=W-v.x,j=X-v.y,q=[U+l,V+j],o,s,t,M,N,G,H=ia.adjustAlpha(O)+"",da=(va||ia.adjustLightness(1.2)).adjustAlpha(O)+"";if(ja)r.strokeStyle=Ia.adjustAlpha(O)+"";w.sort(function(za,Aa){return u(Aa[pa],q)/Aa[K]-u(za[pa],q)/za[K]});a=0;for(d=w.length;a<d;a++){g=w[a];t=false;h=g[C];o=[];b=0;for(c=h.length-1;b<c;b+=2){o[b]=e=h[b]-l;o[b+1]=n=h[b+1]-j;t||(t=e>0&&e<T&&n>0&&n<L)}if(t){r.fillStyle=
g[y]&&g[y][0]?g[y][0].adjustAlpha(O)+"":H;b=g[ga]?g[K]*fa:g[K];h=oa/(oa-b);e=[];s=[];b=0;for(c=o.length-3;b<c;b+=2){n=o[b];t=o[b+1];M=o[b+2];N=o[b+3];G={x:((n-U)*h+U<<0)+0.5,y:((t-V)*h+V<<0)+0.5};s={x:((M-U)*h+U<<0)+0.5,y:((N-V)*h+V<<0)+0.5};if((M-n)*(G.y-t)>(G.x-n)*(N-t)){s=[M+0.5,N+0.5,n+0.5,t+0.5,G.x,G.y,s.x,s.y];r.fillStyle=n<M&&t<N||n>M&&t>N?ia.adjustAlpha(O).adjustLightness(0.8)+"":g[y]&&g[y][0]?g[y][0].adjustAlpha(O)+"":H;Ba(s)}e[b]=G.x;e[b+1]=G.y}r.fillStyle=!g[y]?da:g[y][1]?g[y][1].adjustAlpha(O)+
"":va?da:g[y][0].adjustLightness(1.2).adjustAlpha(O)+"";Ba(e,ja)}}}}function Ba(a,d){if(a.length){r.beginPath();r.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)r.lineTo(a[b],a[b+1]);r.closePath();d&&r.stroke();r.fill()}}var T=0,L=0,ca=0,ra=0,W=0,X=0,D,ba,ha,x,r,qa,ja,ia=new E(200,190,180),va,Ia=new E(145,140,135),ea,v,w,O=1,fa=1,ta,Y=na,sa=20,U,V,ua;this.setStyle=function(a){a=(a=a)||{};ja=a.strokeRoofs!==undefined?a.strokeRoofs:ja;if(a.color||a.wallColor)ia=E.parse(a.color||a.wallColor);if(a.roofColor!==
undefined)va=E.parse(a.roofColor);R();return this};this.geoJSON=function(a,d){B(a,d);return this};this.setCamOffset=function(a,d){U=ca+a;V=L+d};this.setMaxZoom=function(a){sa=a};this.createCanvas=function(a){x=ma.createElement("canvas");x.style.webkitTransform="translate3d(0,0,0)";x.style.imageRendering="optimizeSpeed";x.style.position="absolute";x.style.pointerEvents="none";x.style.left=0;x.style.top=0;a.appendChild(x);r=x.getContext("2d");r.lineCap="round";r.lineJoin="round";r.lineWidth=1;try{r.mozImageSmoothingEnabled=
false}catch(d){}return x};this.destroyCanvas=function(){x.parentNode.removeChild(x)};this.loadData=i;this.onMoveEnd=function(){var a=z(W,X),d=z(W+T,X+L);R();if(v&&(a[$]>v.n||a[aa]<v.w||d[$]<v.s||d[aa]>v.e))i()};this.onZoomEnd=function(a){ua=false;S(a.zoom);if(ea){w=p(ea);R()}else{R();i()}};this.onZoomStart=function(){ua=true;R()};this.render=R;this.setOrigin=function(a,d){W=a;X=d};this.setSize=function(a,d){T=a;L=d;ca=T/2<<0;ra=L/2<<0;U=ca;V=L;x.width=T;x.height=L};this.setZoom=S;qa=P};k.OSMBuildings.VERSION=
"0.1.7a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(k){k=k||{};k.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,k)},setOrigin:function(){var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),u=this.map.resolution,A=this.maxExtent;this.osmb.setOrigin(Math.round((k.lon-A.left)/u),Math.round((A.top-
k.lat)/u))},setMap:function(k){if(!this.map){OpenLayers.Layer.prototype.setMap(k);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(k){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(k)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(k,u,A){k=OpenLayers.Layer.prototype.moveTo(k,u,A);if(!A){A=parseInt(this.map.layerContainerDiv.style.left,10);var ka=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-A+"px";this.div.style.top=-ka+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);u?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return k},moveByPx:function(k,u){this.dxSum+=k;this.dySum+=u;var A=OpenLayers.Layer.prototype.moveByPx(k,u);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return A},geoJSON:function(k,u){return this.osmb.geoJSON(k,u)},setStyle:function(k){return this.osmb.setStyle(k)}});
