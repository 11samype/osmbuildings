(function(k){function E(i){for(var l,x=[i[0],i[1]],c,g=[i[0],i[1]],j=2,p=i.length-3;j<p;j+=2){l=[i[j],i[j+1]];c=[i[j+2]||i[0],i[j+3]||i[1]];var t=x,q=t[0],u=t[1],F=c[0]-q,v=c[1]-u,P=void 0;if(F!==0||v!==0){P=((l[0]-q)*F+(l[1]-u)*v)/(F*F+v*v);if(P>1){q=c[0];u=c[1]}else if(P>0){q+=F*P;u+=v*P}}q=y(l,[q,u])*2;c=y(t,c);if(q*c>750){g.push(l[0],l[1]);x=l}}if(l[0]!==i[0]||l[1]!==i[1])g.push(i[0],i[1]);return g}function y(i,l){var x=i[0]-l[0],c=i[1]-l[1];return x*x+c*c}function ja(i){for(var l=0,x=0,c=0,g=
i.length-3;c<g;c+=2){l+=i[c];x+=i[c+1]}i=(i.length-2)*2;return[l/i<<0,x/i<<0]}var za=za||Array,Ga=Math.exp,Ha=Math.log,Ia=Math.tan,Ja=Math.atan,pa=Math.min,Ka=Math.max,qa=k.document,J=function(){function i(c,g,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return c+(g-c)*6*j;if(j<0.5)return g;if(j<2/3)return c+(g-c)*(2/3-j)*6;return c}function l(c,g,j,p){this.r=c;this.g=g;this.b=j;this.a=arguments.length<4?1:p}var x=l.prototype;x.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};x.adjustLightness=function(c){var g=J.toHSLA(this);g.l*=c;g.l=Math.min(1,Math.max(0,g.l));var j,p;if(g.s===0)c=j=p=g.l;else{p=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var t=2*g.l-p;c=i(t,p,g.h+1/3);j=i(t,p,g.h);p=i(t,p,g.h-1/3)}return new J(c*255<<0,j*255<<0,p*255<<0,g.a)};x.adjustAlpha=function(c){return new J(this.r,this.g,this.b,this.a*c)};l.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new J(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],
16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new J(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};l.toHSLA=function(c){var g=c.r/255,j=c.g/255,p=c.b/255,t=Math.max(g,j,p),q=Math.min(g,j,p),u,F=(t+q)/2,v;if(t===q)u=q=0;else{v=t-q;q=F>0.5?v/(2-t-q):v/(t+q);switch(t){case g:u=(j-p)/v+(j<p?6:0);break;case j:u=(p-g)/v+2;break;case p:u=(g-j)/v+4;break}u/=6}return{h:u,s:q,l:F,a:c.a}};return l}(),aa=Math.PI,Aa=aa/
2,La=aa/4,Ma=180/aa,Na=256,ra=14,sa=400,Ba=sa-50,ba="latitude",ca="longitude",N=0,K=1,Y=2,ka=3,la=4,Q=5;k.OSMBuildings=function(i){function l(a,e){var b={};a/=da;e/=da;b[ba]=e<=0?90:e>=1?-90:Ma*(2*Ja(Ga(aa*(1-2*e)))-Aa);b[ca]=(a===1?1:(a%1+1)%1)*360-180;return b}function x(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function g(){if(!(!ta||H<ra)){var a=l(Z-ea,$-ua),e=l(Z+S+ea,$+O+ua);ma&&ma.abort();ma=c(x(ta,{w:a[ca],n:a[ba],e:e[ca],s:e[ba],z:H}),j)}}function j(a){var e,b,d,h=[],f,n=f=0;T=ra;F(H);ma=null;if(!(!a||a.meta.z!==H)){d=a.meta;b=a.data;if(z&&s&&z.z===d.z){f=z.x-d.x;n=z.y-d.y;a=0;for(e=s.length;a<e;a++)h[a]=s[a][K][0]+f+","+(s[a][K][1]+n)}z=d;s=[];a=0;for(e=b.length;a<e;a++){d=[];f=E(b[a][K]);if(!(f.length<8)){d[K]=f;d[ka]=ja(f);d[N]=pa(b[a][N],Ba);f=d[K][0]+","+
d[K][1];d[la]=!(h&&~h.indexOf(f));d[Y]=[];d[Q]=[];s.push(d)}}P()}}function p(a,e){var b=[],d,h,f,n,m,A,o,r,B=na-H;d=0;for(h=a.length;d<h;d++){m=a[d];A=m[K];r=new za(A.length);f=0;for(n=A.length-1;f<n;f+=2){o=A[f+1];var L=pa(1,Ka(0,0.5-Ha(Ia(La+Aa*A[f]/180))/aa/2));o={x:(o/360+0.5)*da<<0,y:L*da<<0};r[f]=o.x;r[f+1]=o.y}r=E(r);if(!(r.length<8)){f=[];f[K]=r;f[ka]=ja(r);f[N]=pa(m[N]>>B,Ba);f[la]=e;f[Y]=m[Y];f[Q]=[];b.push(f)}}return b}function t(a,e){if(typeof a==="object")u(a,!e);else{var b=qa.documentElement,
d=qa.createElement("script");k.jsonpCallback=function(h){delete k.jsonpCallback;b.removeChild(d);u(h,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function q(a,e,b){if(b===undefined)b=[];var d,h,f,n=a[0]?a:a.features,m,A,o,r,B,L=e?1:0,G=e?0:1;if(n){d=0;for(a=n.length;d<a;d++)q(n[d],e,b);return b}if(a.type==="Feature"){m=a.geometry;d=a.properties}if(m.type==="Polygon")A=[m.coordinates];if(m.type==="MultiPolygon")A=m.coordinates;if(A){e=d.height;if(d.color||d.wallColor)r=
J.parse(d.color||d.wallColor);if(d.roofColor)B=J.parse(d.roofColor);d=0;for(a=A.length;d<a;d++){n=A[d][0];o=[];h=m=0;for(f=n.length;h<f;h++){o.push(n[h][L],n[h][G]);m+=e||n[h][2]||0}if(m){h=[];f=K;var I=void 0,C=void 0,M=void 0,fa=void 0,ga=0,U=void 0,Ca=void 0;U=0;for(Ca=o.length-3;U<Ca;U+=2){I=o[U];C=o[U+1];M=o[U+2];fa=o[U+3];ga+=I*fa-M*C}if((ga/2>0?"CW":"CCW")==="CW")o=o;else{I=[];for(C=o.length-2;C>=0;C-=2)I.push(o[C],o[C+1]);o=I}h[f]=o;h[N]=m/n.length<<0;h[Y]=[r||null,r?r.adjustLightness(0.8):
null,B?B:r?r.adjustLightness(1.2):null];b.push(h)}}}return b}function u(a,e){if(a){ha=q(a,e);T=0;F(H);z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:H};s=p(ha,true);P()}else{ha=null;R()}}function F(a){var e,b,d,h;H=a;da=Na<<H;d=1-(H-T)*0.3/(na-T);v();if(s){a=0;for(e=s.length;a<e;a++){h=s[a];h[Q]=[];for(b=0;b<3;b++)if(h[Y][b])h[Q][b]=h[Y][b].adjustAlpha(d)+""}}}function v(){var a=1-(H-T)*0.3/(na-T);Da=V.adjustAlpha(a)+"";va=wa.adjustAlpha(a)+"";Ea=oa.adjustAlpha(a)+""}function P(){ia=0;clearInterval(xa);xa=
setInterval(function(){ia+=0.1;if(ia>1){clearInterval(xa);ia=1;for(var a=0,e=s.length;a<e;a++)s[a][la]=0}R()},33)}function R(){w.clearRect(0,0,S,O);if(z&&s)if(!(H<T||ya)){var a,e,b,d,h,f,n,m,A=Z-z.x,o=$-z.y,r=[W+A,X+o],B,L,G,I,C,M;s.sort(function(fa,ga){return y(ga[ka],r)/ga[N]-y(fa[ka],r)/fa[N]});a=0;for(e=s.length;a<e;a++){h=s[a];G=false;f=h[K];B=[];b=0;for(d=f.length-1;b<d;b+=2){B[b]=n=f[b]-A;B[b+1]=m=f[b+1]-o;G||(G=n>0&&n<S&&m>0&&m<O)}if(G){b=h[la]?h[N]*ia:h[N];f=sa/(sa-b);n=[];L=[];b=0;for(d=
B.length-3;b<d;b+=2){m=B[b];G=B[b+1];I=B[b+2];C=B[b+3];M={x:((m-W)*f+W<<0)+0.5,y:((G-X)*f+X<<0)+0.5};L={x:((I-W)*f+W<<0)+0.5,y:((C-X)*f+X<<0)+0.5};if((I-m)*(M.y-G)>(M.x-m)*(C-G)){L=[I+0.5,C+0.5,m+0.5,G+0.5,M.x,M.y,L.x,L.y];w.fillStyle=m<I&&G<C||m>I&&G>C?h[Q][1]||va:h[Q][0]||Da;Fa(L)}n[b]=M.x;n[b+1]=M.y}w.fillStyle=h[Q][2]||Ea;w.strokeStyle=h[Q][1]||va;Fa(n,true)}}}}function Fa(a,e){if(a.length){w.beginPath();w.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)w.lineTo(a[b],a[b+1]);w.closePath();e&&
w.stroke();w.fill()}}var S=0,O=0,ea=0,ua=0,Z=0,$=0,H,da,ma,D,w,ta,V=new J(200,190,180),wa=V.adjustLightness(0.8),oa=V.adjustLightness(1.2),Da=V+"",va=wa+"",Ea=oa+"",ha,z,s,ia=1,xa,T=ra,na=20,W,X,ya;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){V=J.parse(a.color||a.wallColor);wa=V.adjustLightness(0.8);oa=V.adjustLightness(1.2)}if(a.roofColor)oa=J.parse(a.roofColor);v();R();return this};this.geoJSON=function(a,e){t(a,e);return this};this.setCamOffset=function(a,e){W=ea+a;X=O+e};this.setMaxZoom=
function(a){na=a};this.createCanvas=function(a){D=qa.createElement("canvas");D.style.webkitTransform="translate3d(0,0,0)";D.style.imageRendering="optimizeSpeed";D.style.position="absolute";D.style.pointerEvents="none";D.style.left=0;D.style.top=0;a.appendChild(D);w=D.getContext("2d");w.lineCap="round";w.lineJoin="round";w.lineWidth=1;try{w.mozImageSmoothingEnabled=false}catch(e){}return D};this.destroyCanvas=function(){D.parentNode.removeChild(D)};this.loadData=g;this.onMoveEnd=function(){var a=l(Z,
$),e=l(Z+S,$+O);R();if(z&&(a[ba]>z.n||a[ca]<z.w||e[ba]<z.s||e[ca]>z.e))g()};this.onZoomEnd=function(a){ya=false;F(a.zoom);if(ha){s=p(ha);R()}else{R();g()}};this.onZoomStart=function(){ya=true;R()};this.render=R;this.setOrigin=function(a,e){Z=a;$=e};this.setSize=function(a,e){S=a;O=e;ea=S/2<<0;ua=O/2<<0;W=ea;X=O;D.width=S;D.height=O};this.setZoom=F;ta=i};k.OSMBuildings.VERSION="0.1.7a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(k){k=k||{};k.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,k)},setOrigin:function(){var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),E=this.map.resolution,y=this.maxExtent;this.osmb.setOrigin(Math.round((k.lon-y.left)/E),Math.round((y.top-
k.lat)/E))},setMap:function(k){if(!this.map){OpenLayers.Layer.prototype.setMap(k);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(k){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(k)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(k,E,y){k=OpenLayers.Layer.prototype.moveTo(k,E,y);if(!y){y=parseInt(this.map.layerContainerDiv.style.left,10);var ja=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-y+"px";this.div.style.top=-ja+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);E?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return k},moveByPx:function(k,E){this.dxSum+=k;this.dySum+=E;var y=OpenLayers.Layer.prototype.moveByPx(k,E);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return y},geoJSON:function(k,E){return this.osmb.geoJSON(k,E)},setStyle:function(k){return this.osmb.setStyle(k)}});
