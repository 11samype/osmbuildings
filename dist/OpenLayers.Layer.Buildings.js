(function(l){function w(O,C){var P=O[0]-C[0],h=O[1]-C[1];return P*P+h*h}var D=D||Array,ma=Math.exp,Ea=Math.log,Fa=Math.tan,Ga=Math.atan,na=Math.min,Ha=Math.max,oa=l.document,I=function(){function O(h,k,m){if(m<0)m+=1;if(m>1)m-=1;if(m<1/6)return h+(k-h)*6*m;if(m<0.5)return k;if(m<2/3)return h+(k-h)*(2/3-m)*6;return h}function C(h,k,m,q){this.r=h;this.g=k;this.b=m;this.a=arguments.length<4?1:q}var P=C.prototype;P.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+")"};
P.adjustLightness=function(h){var k=I.toHSLA(this);k.l*=h;k.l=Math.min(1,Math.max(0,k.l));var m,q;if(k.s===0)h=m=q=k.l;else{q=k.l<0.5?k.l*(1+k.s):k.l+k.s-k.l*k.s;var E=2*k.l-q;h=O(E,q,k.h+1/3);m=O(E,q,k.h);q=O(E,q,k.h-1/3)}return new I(h*255<<0,m*255<<0,q*255<<0,k.a)};P.adjustAlpha=function(h){return new I(this.r,this.g,this.b,this.a*h)};C.parse=function(h){h+="";if(~h.indexOf("#")){h=h.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new I(parseInt(h[1],16),parseInt(h[2],16),parseInt(h[3],16),h[4]?
parseInt(h[4],16)/255:1)}if(h=h.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new I(parseInt(h[1],10),parseInt(h[2],10),parseInt(h[3],10),h[4]?parseFloat(h[5],10):1)};C.toHSLA=function(h){var k=h.r/255,m=h.g/255,q=h.b/255,E=Math.max(k,m,q),F=Math.min(k,m,q),K,S=(E+F)/2,L;if(E===F)K=F=0;else{L=E-F;F=S>0.5?L/(2-E-F):L/(E+F);switch(E){case k:K=(m-q)/L+(m<q?6:0);break;case m:K=(q-k)/L+2;break;case q:K=(k-m)/L+4;break}K/=6}return{h:K,s:F,l:S,a:h.a}};return C}(),$=Math.PI,za=$/2,Ia=$/4,Ja=
180/$,Ka=256,pa=14,qa=400,Aa=qa-50,aa="latitude",ba="longitude",M=0,J=1,X=2,ra=3,ia=4,Q=5;l.OSMBuildings=function(O){function C(a,d){var b={};a/=ca;d/=ca;b[aa]=d<=0?90:d>=1?-90:Ja*(2*Ga(ma($*(1-2*d)))-za);b[ba]=(a===1?1:(a%1+1)%1)*360-180;return b}function P(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function h(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function k(){if(!(!sa||G<pa)){var a=C(Y-da,Z-ta),d=C(Y+T+da,Z+N+ta);ja&&ja.abort();ja=h(P(sa,{w:a[ba],n:a[aa],e:d[ba],s:d[aa],z:G}),m)}}function m(a){var d,b,c,g=[],f=0,i=0;ea=pa;S(G);ja=null;if(!(!a||a.meta.z!==G)){c=a.meta;b=a.data;if(A&&s&&A.z===c.z){f=A.x-c.x;i=A.y-c.y;a=0;for(d=s.length;a<d;a++)g[a]=s[a][J][0]+f+","+(s[a][J][1]+i)}A=c;s=[];a=0;for(d=b.length;a<d;a++){var e=b[a][J];c=[];var j=void 0;j=void 0;var n=void 0;i=f=0;e=e;j=void 0;n=[e[0],e[1]];for(var o=
void 0,p=[e[0],e[1]],r=2,x=e.length-3;r<x;r+=2){j=[e[r],e[r+1]];o=[e[r+2]||e[0],e[r+3]||e[1]];var y=n;o=o;var t=y[0],u=y[1],v=o[0]-t,H=o[1]-u,fa=void 0;if(v!==0||H!==0){fa=((j[0]-t)*v+(j[1]-u)*H)/(v*v+H*H);if(fa>1){t=o[0];u=o[1]}else if(fa>0){t+=v*fa;u+=H*fa}}t=w(j,[t,u])*2;y=w(y,o);if(t*y>750){p.push(j[0],j[1]);n=j}}if(j[0]!==e[0]||j[1]!==e[1])p.push(e[0],e[1]);e=p;if(e.length<8)f=void 0;else{p=0;for(r=e.length-3;p<r;p+=2){j=e[p];n=e[p+1];f+=j;i+=n}j=(e.length-2)*2;c[J]=e;c[ra]=[f/j<<0,i/j<<0];f=
c}if(f){f[M]=na(b[a][M],Aa);c=f[J][0]+","+f[J][1];f[ia]=!(g&&~g.indexOf(c));f[X]=[];f[Q]=[];s.push(f)}}L()}}function q(a,d){var b=[],c,g,f,i,e,j,n,o,p=ua-G;c=0;for(g=a.length;c<g;c++){e=a[c];j=e[J];n=new D(j.length);f=0;for(i=j.length-1;f<i;f+=2){o=j[f+1];var r=na(1,Ha(0,0.5-Ea(Fa(Ia+za*j[f]/180))/$/2));o={x:(o/360+0.5)*ca<<0,y:r*ca<<0};n[f]=o.x;n[f+1]=o.y}b[c]=[];b[c][M]=na(e[M]>>p,Aa);b[c][J]=n;b[c][X]=e[X];b[c][ia]=d}return b}function E(a,d){if(typeof a==="object")K(a,!d);else{var b=oa.documentElement,
c=oa.createElement("script");l.jsonpCallback=function(g){delete l.jsonpCallback;b.removeChild(c);K(g,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function F(a,d,b){if(b===undefined)b=[];var c,g,f,i=a[0]?a:a.features,e,j,n,o,p,r=d?1:0,x=d?0:1;if(i){c=0;for(a=i.length;c<a;c++)F(i[c],d,b);return b}if(a.type==="Feature"){g=a.geometry;c=a.properties}if(g.type==="Polygon")e=[g.coordinates];if(g.type==="MultiPolygon")e=g.coordinates;if(e){d=c.height;if(c.color||c.wallColor)o=
I.parse(c.color||c.wallColor);if(c.roofColor)p=I.parse(c.roofColor);c=0;for(a=e.length;c<a;c++){j=e[c][0];i=[];g=n=0;for(f=j.length;g<f;g++){i.push(j[g][r],j[g][x]);n+=d||j[g][2]||0}if(n){g=[];g[M]=n/j.length<<0;j=J;n=void 0;f=void 0;var y=void 0,t=void 0,u=0,v=void 0,H=void 0;v=0;for(H=i.length-3;v<H;v+=2){n=i[v];f=i[v+1];y=i[v+2];t=i[v+3];u+=n*t-y*f}if((u/2>0?"CW":"CCW")==="CW")i=i;else{n=[];for(f=i.length-2;f>=0;f-=2)n.push(i[f],i[f+1]);i=n}g[j]=i;g[X]=[o||null,o?o.adjustLightness(0.8):null,p?
p:o?o.adjustLightness(1.2):null];g[Q]=[];b.push(g)}}}return b}function K(a,d){if(a){ga=F(a,d);ea=0;S(G);A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:G};s=q(ga,true);L()}else{ga=null;R()}}function S(a){var d,b,c,g;G=a;ca=Ka<<G;c=1-(G-ea)*0.3/(ua-ea);Ba=U.adjustAlpha(c)+"";va=wa.adjustAlpha(c)+"";Ca=ka.adjustAlpha(c)+"";if(s){a=0;for(d=s.length;a<d;a++){g=s[a];g[Q]=[];for(b=0;b<3;b++)if(g[X][b])g[Q][b]=g[X][b].adjustAlpha(c)+""}}}function L(){ha=0;clearInterval(xa);xa=setInterval(function(){ha+=0.1;if(ha>1){clearInterval(xa);
ha=1;for(var a=0,d=s.length;a<d;a++)s[a][ia]=0}R()},33)}function R(){z.clearRect(0,0,T,N);if(A&&s)if(!(G<ea||ya)){var a,d,b,c,g,f,i,e,j=Y-A.x,n=Z-A.y,o=[V+j,W+n],p,r,x,y,t,u;s.sort(function(v,H){return w(H[ra],o)/H[M]-w(v[ra],o)/v[M]});a=0;for(d=s.length;a<d;a++){g=s[a];x=false;f=g[J];p=[];b=0;for(c=f.length-1;b<c;b+=2){p[b]=i=f[b]-j;p[b+1]=e=f[b+1]-n;x||(x=i>0&&i<T&&e>0&&e<N)}if(x){b=g[ia]?g[M]*ha:g[M];f=qa/(qa-b);i=[];r=[];b=0;for(c=p.length-3;b<c;b+=2){e=p[b];x=p[b+1];y=p[b+2];t=p[b+3];u={x:((e-
V)*f+V<<0)+0.5,y:((x-W)*f+W<<0)+0.5};r={x:((y-V)*f+V<<0)+0.5,y:((t-W)*f+W<<0)+0.5};if((y-e)*(u.y-x)>(u.x-e)*(t-x)){r=[y+0.5,t+0.5,e+0.5,x+0.5,u.x,u.y,r.x,r.y];z.fillStyle=e<y&&x<t||e>y&&x>t?g[Q][1]||va:g[Q][0]||Ba;Da(r)}i[b]=u.x;i[b+1]=u.y}z.fillStyle=g[Q][2]||Ca;if(la)z.strokeStyle=g[Q][1]||va;Da(i,la)}}}}function Da(a,d){if(a.length){z.beginPath();z.moveTo(a[0],a[1]);for(var b=2,c=a.length;b<c;b+=2)z.lineTo(a[b],a[b+1]);z.closePath();d&&z.stroke();z.fill()}}var T=0,N=0,da=0,ta=0,Y=0,Z=0,G,ca,ja,
B,z,sa,la,U=new I(200,190,180),wa=U.adjustLightness(0.8),ka=U.adjustLightness(1.2),Ba=U+"",va=wa+"",Ca=ka+"",ga,A,s,ha=1,xa,ea=pa,ua=20,V,W,ya;this.setStyle=function(a){a=(a=a)||{};la=a.strokeRoofs!==undefined?a.strokeRoofs:la;if(a.color||a.wallColor){U=I.parse(a.color||a.wallColor);wa=U.adjustLightness(0.8);ka=U.adjustLightness(1.2)}if(a.roofColor)ka=I.parse(a.roofColor);R();return this};this.geoJSON=function(a,d){E(a,d);return this};this.setCamOffset=function(a,d){V=da+a;W=N+d};this.setMaxZoom=
function(a){ua=a};this.createCanvas=function(a){B=oa.createElement("canvas");B.style.webkitTransform="translate3d(0,0,0)";B.style.imageRendering="optimizeSpeed";B.style.position="absolute";B.style.pointerEvents="none";B.style.left=0;B.style.top=0;a.appendChild(B);z=B.getContext("2d");z.lineCap="round";z.lineJoin="round";z.lineWidth=1;try{z.mozImageSmoothingEnabled=false}catch(d){}return B};this.destroyCanvas=function(){B.parentNode.removeChild(B)};this.loadData=k;this.onMoveEnd=function(){var a=C(Y,
Z),d=C(Y+T,Z+N);R();if(A&&(a[aa]>A.n||a[ba]<A.w||d[aa]<A.s||d[ba]>A.e))k()};this.onZoomEnd=function(a){ya=false;S(a.zoom);if(ga){s=q(ga);R()}else{R();k()}};this.onZoomStart=function(){ya=true;R()};this.render=R;this.setOrigin=function(a,d){Y=a;Z=d};this.setSize=function(a,d){T=a;N=d;da=T/2<<0;ta=N/2<<0;V=da;W=N;B.width=T;B.height=N};this.setZoom=S;sa=O};l.OSMBuildings.VERSION="0.1.7a";l.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(l){l=l||{};l.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,l)},setOrigin:function(){var l=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),w=this.map.resolution,D=this.maxExtent;this.osmb.setOrigin(Math.round((l.lon-D.left)/w),Math.round((D.top-
l.lat)/w))},setMap:function(l){if(!this.map){OpenLayers.Layer.prototype.setMap(l);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(l){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(l)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(l,w,D){l=OpenLayers.Layer.prototype.moveTo(l,w,D);if(!D){D=parseInt(this.map.layerContainerDiv.style.left,10);var ma=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-D+"px";this.div.style.top=-ma+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);w?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return l},moveByPx:function(l,w){this.dxSum+=l;this.dySum+=w;var D=OpenLayers.Layer.prototype.moveByPx(l,w);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return D},geoJSON:function(l,w){return this.osmb.geoJSON(l,w)},setStyle:function(l){return this.osmb.setStyle(l)}});
