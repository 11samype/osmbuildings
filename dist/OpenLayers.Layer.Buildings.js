(function(o){function M(n,p){var v=n[0]-p[0],f=n[1]-p[1];return v*v+f*f}function S(n){for(var p=0,v=0,f=0,h=n.length-3;f<h;f+=2){p+=n[f];v+=n[f+1]}n=(n.length-2)*2;return[p/n<<0,v/n<<0]}function xa(n){var p=n.length/2,v=new La(p),f=0,h=p-1,j,t,q,D,J=[],N=[],K=[];for(v[f]=v[h]=1;h;){t=0;for(j=f+1;j<h;j++){q=n[j*2];var ba=n[j*2+1],O=n[f*2],V=n[f*2+1],ca=n[h*2],G=n[h*2+1],u=ca-O,z=G-V,E=void 0;if(u!==0||z!==0){E=((q-O)*u+(ba-V)*z)/(u*u+z*z);if(E>1){O=ca;V=G}else if(E>0){O+=u*E;V+=z*E}}u=q-O;z=ba-V;q=
u*u+z*z;if(q>t){D=j;t=q}}if(t>2){v[D]=1;J.push(f);N.push(D);J.push(D);N.push(h)}f=J.pop();h=N.pop()}for(j=0;j<p;j++)v[j]&&K.push(n[j*2],n[j*2+1]);return K}var Ma=Ma||Array,La=La||Array,da=Math,Ra=da.exp,Sa=da.log,Ta=da.sin,Ua=da.cos,Ea=da.tan,Va=da.atan,ka=da.min,Fa=da.max,ya=o.document,P=function(){function n(f,h,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return f+(h-f)*6*j;if(j<0.5)return h;if(j<2/3)return f+(h-f)*(2/3-j)*6;return f}function p(f,h,j,t){this.r=f;this.g=h;this.b=j;this.a=arguments.length<
4?1:t}var v=p.prototype;v.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};v.adjustLightness=function(f){var h=P.toHSLA(this);h.l*=f;h.l=Math.min(1,Math.max(0,h.l));var j,t;if(h.s===0)f=j=t=h.l;else{t=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var q=2*h.l-t;f=n(q,t,h.h+1/3);j=n(q,t,h.h);t=n(q,t,h.h-1/3)}return new P(f*255<<0,j*255<<0,t*255<<0,h.a)};v.adjustAlpha=function(f){return new P(this.r,this.g,this.b,this.a*f)};p.parse=function(f){f+="";if(~f.indexOf("#")){f=
f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new P(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new P(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};p.toHSLA=function(f){var h=f.r/255,j=f.g/255,t=f.b/255,q=Math.max(h,j,t),D=Math.min(h,j,t),J,N=(q+D)/2,K;if(q===D)J=D=0;else{K=q-D;D=N>0.5?K/(2-q-D):K/(q+D);switch(q){case h:J=(j-t)/K+(j<t?6:0);break;case j:J=
(t-h)/K+2;break;case t:J=(h-j)/K+4;break}J/=6}return{h:J,s:D,l:N,a:f.a}};return p}(),Wa=function(){var n=Math,p=n.sin,v=n.cos,f=n.tan,h=n.asin,j=n.atan2,t=n.PI,q=180/t,D=357.5291/q,J=0.98560028/q,N=1.9148/q,K=0.02/q,ba=3.0E-4/q,O=102.9372/q,V=23.45/q,ca=280.16/q,G=360.9856235/q;return function(u,z,E){E=-E/q;z=z/q;u=u.valueOf()/864E5-0.5+2440588;var F=D+J*(u-2451545),H=N*p(F)+K*p(2*F)+ba*p(3*F);H=F+O+H+t;F=h(p(H)*p(V));H=j(p(H)*v(V),v(H));E=ca+G*(u-2451545)-E-H;return{altitude:h(p(z)*p(F)+v(z)*v(F)*
v(E)),azimuth:j(p(E),v(E)*p(z)-f(F)*v(z))-t/2}}}(),la=Math.PI,Na=la/2,Xa=la/4,Ya=180/la,Za=256,Ga=14,ma="latitude",na="longitude",Oa=3,Pa=4,T=0,Q=1,U=2,W=3,za=4,ha=5,Z=6;o.OSMBuildings=function(n){function p(a,c){var b={};a/=oa;c/=oa;b[ma]=c<=0?90:c>=1?-90:Ya*(2*Va(Ra(la*(1-2*c)))-Na);b[na]=(a===1?1:(a%1+1)%1)*360-180;return b}function v(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function f(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===
4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function h(){if(!(!Ha||R<Ga)){var a=p(F-z,H-E),c=p(F+G+z,H+u+E);Aa&&Aa.abort();Aa=f(v(Ha,{w:a[na],n:a[ma],e:c[na],s:c[ma],z:R}),j)}}function j(a){var c,b,d,e,i=[],g=b=0;ia=Ga;N(R);Aa=null;if(!(!a||a.meta.z!==R)){e=a.meta;d=a.data;if(C&&x&&C.z===e.z){b=C.x-e.x;g=C.y-e.y;a=0;for(c=x.length;a<c;a++)i[a]=x[a][U][0]+b+","+(x[a][U][1]+g)}C=e;x=[];a=0;for(c=d.length;a<c;a++){e=[];
if(!(d[a][Q]>pa)){b=xa(d[a][U]);if(!(b.length<8)){e[U]=b;e[za]=S(b);e[T]=ka(d[a][T],pa);e[Q]=d[a][Q];b=e[U][0]+","+e[U][1];e[ha]=!(i&&~i.indexOf(b));e[W]=[];e[Z]=[];b=d[a][Oa]?P.parse(d[a][Oa]):null;g=d[a][Pa]?P.parse(d[a][Pa]):null;e[W]=[b||null,b?b.adjustLightness(0.8):null,g?g:b?b.adjustLightness(1.2):ea];for(b=0;b<3;b++)if(e[W][b])e[Z][b]=e[W][b].adjustAlpha(X)+"";x.push(e)}}}K()}}function t(a,c){var b=[],d,e,i,g,k,m,l,A,w,I=Ia-R;d=0;for(e=a.length;d<e;d++){k=a[d];A=k[Q]>>I;if(!(A>pa)){m=k[U];
w=new Ma(m.length);i=0;for(g=m.length-1;i<g;i+=2){l=m[i+1];var y=ka(1,Fa(0,0.5-Sa(Ea(Xa+Na*m[i]/180))/la/2));l={x:(l/360+0.5)*oa<<0,y:y*oa<<0};w[i]=l.x;w[i+1]=l.y}w=xa(w);if(!(w.length<8)){g=[];g[U]=w;g[za]=S(w);g[T]=ka(k[T]>>I,pa);g[Q]=A;g[ha]=c;g[W]=k[W];g[Z]=[];for(i=0;i<3;i++)if(g[W][i])g[Z][i]=g[W][i].adjustAlpha(X)+"";b.push(g)}}}return b}function q(a,c){if(typeof a==="object")J(a,!c);else{var b=ya.documentElement,d=ya.createElement("script");o.jsonpCallback=function(e){delete o.jsonpCallback;
b.removeChild(d);J(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,c,b){if(b===undefined)b=[];var d,e,i,g=a[0]?a:a.features,k,m,l,A,w,I=c?1:0,y=c?0:1;if(g){d=0;for(a=g.length;d<a;d++)D(g[d],c,b);return b}if(a.type==="Feature"){k=a.geometry;d=a.properties}if(k.type==="Polygon")m=[k.coordinates];if(k.type==="MultiPolygon")m=k.coordinates;if(m){c=d.height;if(d.color||d.wallColor)A=P.parse(d.color||d.wallColor);if(d.roofColor)w=P.parse(d.roofColor);d=0;
for(a=m.length;d<a;d++){g=m[d][0];l=[];e=k=0;for(i=g.length;e<i;e++){l.push(g[e][I],g[e][y]);k+=c||g[e][2]||0}if(k){e=[];i=U;var r=void 0,s=void 0,B=void 0,L=void 0,$=0,aa=void 0,qa=void 0;aa=0;for(qa=l.length-3;aa<qa;aa+=2){r=l[aa];s=l[aa+1];B=l[aa+2];L=l[aa+3];$+=r*L-B*s}if(($/2>0?"CW":"CCW")==="CW")l=l;else{r=[];for(s=l.length-2;s>=0;s-=2)r.push(l[s],l[s+1]);l=r}e[i]=l;e[T]=k/g.length<<0;e[W]=[A||null,A?A.adjustLightness(0.8):null,w?w:A?A.adjustLightness(1.2):ea];b.push(e)}}}return b}function J(a,
c){if(a){ra=D(a,c);ia=0;N(R);C={n:90,w:-180,s:-90,e:180,x:0,y:0,z:R};x=t(ra,true);K()}else{ra=null;O()}}function N(a){var c,b,d;R=a;oa=Za<<R;a=R;c=ia;b=Ia;a=ka(Fa(a,c),b);X=1-ka(Fa(0+(a-c)/(b-c)*0.4,0),0.4);Ja=fa.adjustAlpha(X)+"";sa=Ba.adjustAlpha(X)+"";ta=ea.adjustAlpha(X)+"";if(x){a=0;for(c=x.length;a<c;a++){d=x[a];d[Z]=[];for(b=0;b<3;b++)if(d[W][b])d[Z][b]=d[W][b].adjustAlpha(X)+""}}}function K(){clearInterval(Ka);ga=0;Ca.render();Ka=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(Ka);ga=
1;for(var a=0,c=x.length;a<c;a++)x[a][ha]=0}Da.render();O()},33)}function ba(){Da.render();Ca.render();O()}function O(){Y.clearRect(0,0,G,u);if(!(!C||!x||R<ia||ua)){var a,c,b,d,e,i,g,k,m,l=F-C.x,A=H-C.y,w=Ca.getMaxHeight(),I=[va+l,wa+A],y,r,s,B,L,$;x.sort(function(aa,qa){return M(qa[za],I)/qa[T]-M(aa[za],I)/aa[T]});a=0;for(c=x.length;a<c;a++){e=x[a];if(!(e[T]<=w)){r=false;i=e[U];y=[];b=0;for(d=i.length-1;b<d;b+=2){y[b]=k=i[b]-l;y[b+1]=m=i[b+1]-A;r||(r=k>0&&k<G&&m>0&&m<u)}if(r){b=e[ha]?e[T]*ga:e[T];
i=ja/(ja-b);if(e[Q]){b=e[ha]?e[Q]*ga:e[Q];g=ja/(ja-b)}k=[];b=0;for(d=y.length-3;b<d;b+=2){m=y[b];s=y[b+1];r=y[b+2];B=y[b+3];L=ca(m,s,i);$=ca(r,B,i);if(e[Q]){s=ca(m,s,g);B=ca(r,B,g);m=s.x;s=s.y;r=B.x;B=B.y}if((r-m)*(L.y-s)>(L.x-m)*(B-s)){Y.fillStyle=m<r&&s<B||m>r&&s>B?e[Z][1]||sa:e[Z][0]||Ja;V([r,B,m,s,L.x,L.y,$.x,$.y])}k[b]=L.x;k[b+1]=L.y}Y.fillStyle=e[Z][2]||ta;Y.strokeStyle=e[Z][1]||sa;V(k,true)}}}}}function V(a,c){if(a.length){Y.beginPath();Y.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)Y.lineTo(a[b],
a[b+1]);Y.closePath();c&&Y.stroke();Y.fill()}}function ca(a,c,b){return{x:(a-va)*b+va<<0,y:(c-wa)*b+wa<<0}}var G=0,u=0,z=0,E=0,F=0,H=0,R,oa,Aa,Y,Ha,fa=new P(200,190,180),Ba=fa.adjustLightness(0.8),ea=fa.adjustLightness(1.2),Ja=fa+"",sa=Ba+"",ta=ea+"",ra,C,x,ga=1,Ka,X=1,ia=Ga,Ia=20,pa,va,wa,ja,ua,Qa={container:null,items:[],init:function(a){var c=this.container=ya.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;Da.init(this.create());Ca.init(this.create());
Y=this.create();a.appendChild(c);return c},create:function(){var a=ya.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,e=b.length;d<e;d++){b[d].width=a;b[d].height=
c}}},Da={context:null,color:new P(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,c,b,d,e;a.clearRect(0,0,G,u);if(!(!C||!x||R<ia||ua)){c=p(F+z,H+E);c=Wa(this.date,c.latitude,c.longitude);if(!(c.altitude<=0)){b=1/Ea(c.altitude);d=0.4/b;this.directionX=Ua(c.azimuth)*b;this.directionY=Ta(c.azimuth)*b;this.color.a=d;e=this.color+"";var i,g,k,m,l,A=F-C.x,w=H-C.y,
I,y,r,s,B,L,$=[];a.beginPath();c=0;for(b=x.length;c<b;c++){g=x[c];y=false;k=g[U];I=[];d=0;for(i=k.length-1;d<i;d+=2){I[d]=m=k[d]-A;I[d+1]=l=k[d+1]-w;y||(y=m>0&&m<G&&l>0&&l<u)}if(y){k=g[ha]?g[T]*ga:g[T];if(g[Q])k=g[ha]?g[Q]*ga:g[Q];m=null;d=0;for(i=I.length-3;d<i;d+=2){l=I[d];r=I[d+1];y=I[d+2];s=I[d+3];B=this.project(l,r,k);L=this.project(y,s,k);if(g[Q]){r=this.project(l,r,k);s=this.project(y,s,k);l=r.x;r=r.y;y=s.x;s=s.y}if((y-l)*(B.y-r)>(B.x-l)*(s-r)){m===1&&a.lineTo(l,r);m=0;d||a.moveTo(l,r);a.lineTo(y,
s)}else{m===0&&a.lineTo(B.x,B.y);m=1;d||a.moveTo(B.x,B.y);a.lineTo(L.x,L.y)}}a.closePath();$.push(I)}}a.fillStyle=e;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();c=0;for(b=$.length;c<b;c++){e=$[c];a.moveTo(e[0],e[1]);d=2;for(i=e.length;d<i;d+=2)a.lineTo(e[d],e[d+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},setDate:function(a){this.date=
a;this.render()}},Ca={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,G,u);if(!(!C||!x||R<ia||ua)){var c,b,d,e,i,g,k,m=F-C.x,l=H-C.y,A,w;a.beginPath();c=0;for(b=x.length;c<b;c++){d=x[c];w=false;i=d[U];A=[];d=0;for(e=i.length-1;d<e;d+=2){A[d]=g=i[d]-m;A[d+1]=k=i[d+1]-l;w||(w=g>0&&g<G&&k>0&&k<u)}if(w){d=0;for(e=A.length-3;d<e;d+=2){w=A[d];i=A[d+1];d?a.lineTo(w,i):a.moveTo(w,i)}a.closePath()}}a.fillStyle=ta;a.strokeStyle=sa;a.stroke();a.fill()}},
getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){fa=P.parse(a.color||a.wallColor);Ja=fa.adjustAlpha(X)+"";Ba=fa.adjustLightness(0.8);sa=Ba.adjustAlpha(X)+"";ea=fa.adjustLightness(1.2);ta=ea.adjustAlpha(X)+""}if(a.roofColor){ea=P.parse(a.roofColor);ta=ea.adjustAlpha(X)+""}ba();return this};this.geoJSON=function(a,c){q(a,c);return this};this.setCamOffset=function(a,c){va=z+a;wa=u+c};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){Da.setDate(a);
return this};this.appendTo=function(a){return Qa.init(a)};this.loadData=h;this.onMoveEnd=function(){var a=p(F,H),c=p(F+G,H+u);ba();if(C&&(a[ma]>C.n||a[na]<C.w||c[ma]<C.s||c[na]>C.e))h()};this.onZoomEnd=function(a){ua=false;N(a.zoom);if(ra){x=t(ra);ba()}else{O();h()}};this.onZoomStart=function(){ua=true;ba()};this.setOrigin=function(a,c){F=a;H=c};this.setSize=function(a,c){G=a;u=c;z=G/2<<0;E=u/2<<0;va=z;wa=u;ja=G/(1.5/(window.devicePixelRatio||1))/Ea(45)<<0;Qa.setSize(G,u);pa=ja-50};this.setZoom=N;
this.render=O;Ha=n};o.OSMBuildings.VERSION="0.1.8a";o.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(o){o=o||{};o.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,o)},setOrigin:function(){var o=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),M=this.map.resolution,S=this.maxExtent;this.osmb.setOrigin(Math.round((o.lon-S.left)/M),
Math.round((S.top-o.lat)/M))},setMap:function(o){this.map||OpenLayers.Layer.prototype.setMap.call(this,o);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(o){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,o)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(o,M,S){o=OpenLayers.Layer.prototype.moveTo.call(this,o,M,S);if(!S){S=parseInt(this.map.layerContainerDiv.style.left,10);var xa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-S+"px";this.div.style.top=-xa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);M?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return o},moveByPx:function(o,M){this.dxSum+=
o;this.dySum+=M;var S=OpenLayers.Layer.prototype.moveByPx.call(this,o,M);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return S},geoJSON:function(o,M){return this.osmb.geoJSON(o,M)},setStyle:function(o){return this.osmb.setStyle(o)},setDate:function(o){return this.osmb.setDate(o)}});
