(function(n){function K(l,q){var r=l[0]-q[0],e=l[1]-q[1];return r*r+e*e}function N(l){for(var q=0,r=0,e=0,g=l.length-3;e<g;e+=2){q+=l[e];r+=l[e+1]}l=(l.length-2)*2;return[q/l<<0,r/l<<0]}function wa(l){var q=l.length/2,r=new Ma(q),e=0,g=q-1,j,p,o,C,H=[],P=[],I=[];for(r[e]=r[g]=1;g;){p=0;for(j=e+1;j<g;j++){o=l[j*2];var Z=l[j*2+1],W=l[e*2],D=l[e*2+1],ha=l[g*2],$=l[g*2+1],w=ha-W,s=$-D,A=void 0;if(w!==0||s!==0){A=((o-W)*w+(Z-D)*s)/(w*w+s*s);if(A>1){W=ha;D=$}else if(A>0){W+=w*A;D+=s*A}}w=o-W;s=Z-D;o=w*
w+s*s;if(o>p){C=j;p=o}}if(p>2){r[C]=1;H.push(e);P.push(C);H.push(C);P.push(g)}e=H.pop();g=P.pop()}for(j=0;j<q;j++)r[j]&&I.push(l[j*2],l[j*2+1]);return I}var Na=Na||Array,Ma=Ma||Array,ba=Math,Qa=ba.exp,Ra=ba.log,Sa=ba.sin,Ta=ba.cos,Fa=ba.tan,Ua=ba.atan,la=ba.min,Ga=ba.max,xa=n.document,Q=function(){function l(e,g,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return e+(g-e)*6*j;if(j<0.5)return g;if(j<2/3)return e+(g-e)*(2/3-j)*6;return e}function q(e,g,j,p){this.r=e;this.g=g;this.b=j;this.a=arguments.length<
4?1:p}var r=q.prototype;r.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};r.adjustLightness=function(e){var g=Q.toHSLA(this);g.l*=e;g.l=Math.min(1,Math.max(0,g.l));var j,p;if(g.s===0)e=j=p=g.l;else{p=g.l<0.5?g.l*(1+g.s):g.l+g.s-g.l*g.s;var o=2*g.l-p;e=l(o,p,g.h+1/3);j=l(o,p,g.h);p=l(o,p,g.h-1/3)}return new Q(e*255<<0,j*255<<0,p*255<<0,g.a)};r.adjustAlpha=function(e){return new Q(this.r,this.g,this.b,this.a*e)};q.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};q.toHSLA=function(e){var g=e.r/255,j=e.g/255,p=e.b/255,o=Math.max(g,j,p),C=Math.min(g,j,p),H,P=(o+C)/2,I;if(o===C)H=C=0;else{I=o-C;C=P>0.5?I/(2-o-C):I/(o+C);switch(o){case g:H=(j-p)/I+(j<p?6:0);break;case j:H=
(p-g)/I+2;break;case p:H=(g-j)/I+4;break}H/=6}return{h:H,s:C,l:P,a:e.a}};return q}(),Va=function(){var l=Math,q=l.sin,r=l.cos,e=l.tan,g=l.asin,j=l.atan2,p=l.PI,o=180/p,C=357.5291/o,H=0.98560028/o,P=1.9148/o,I=0.02/o,Z=3.0E-4/o,W=102.9372/o,D=23.45/o,ha=280.16/o,$=360.9856235/o;return function(w,s,A){A=-A/o;s=s/o;w=w.valueOf()/864E5-0.5+2440588;var L=C+H*(w-2451545),F=P*q(L)+I*q(2*L)+Z*q(3*L);F=L+W+F+p;L=g(q(F)*q(D));F=j(q(F)*r(D),r(F));A=ha+$*(w-2451545)-A-F;return{altitude:g(q(s)*q(L)+r(s)*r(L)*
r(A)),azimuth:j(q(A),r(A)*q(s)-e(L)*r(s))-p/2}}}(),ma=Math.PI,Oa=ma/2,Wa=ma/4,Xa=180/ma,Ya=256,Ha=14,na="latitude",oa="longitude",R=0,M=1,S=2,ca=3,ya=4,ia=5,aa=6;n.OSMBuildings=function(l){function q(a){var d=xa.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering="optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;a.appendChild(d);a=d.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=false}catch(b){}return d}
function r(a,d){var b={};a/=pa;d/=pa;b[na]=d<=0?90:d>=1?-90:Xa*(2*Ua(Qa(ma*(1-2*d)))-Oa);b[oa]=(a===1?1:(a%1+1)%1)*360-180;return b}function e(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(b,c){return d[c]})}function g(a,d,b,c,h){a=la(Ga(a,d),b);return la(Ga(c+(a-d)/(b-d)*(h-c),c),h)}function j(a,d){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&d(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}
function p(){if(!(!Ia||O<Ha)){var a=r(F-A,da-L),d=r(F+w+A,da+s+L);za&&za.abort();za=j(e(Ia,{w:a[oa],n:a[na],e:d[oa],s:d[na],z:O}),o)}}function o(a){var d,b,c,h=[],f,i=f=0;qa=Ha;Z(O);za=null;if(!(!a||a.meta.z!==O)){c=a.meta;b=a.data;if(E&&B&&E.z===c.z){f=E.x-c.x;i=E.y-c.y;a=0;for(d=B.length;a<d;a++)h[a]=B[a][S][0]+f+","+(B[a][S][1]+i)}E=c;B=[];a=0;for(d=b.length;a<d;a++){c=[];if(!(b[a][M]>ra)){f=wa(b[a][S]);if(!(f.length<8)){c[S]=f;c[ya]=N(f);c[R]=la(b[a][R],ra);c[M]=b[a][M];f=c[S][0]+","+c[S][1];
c[ia]=!(h&&~h.indexOf(f));c[ca]=[];c[aa]=[];B.push(c)}}}W()}}function C(a,d){var b=[],c,h,f,i,m,k,x,G,y,z=Ja-O;c=0;for(h=a.length;c<h;c++){m=a[c];G=m[M]>>z;if(!(G>ra)){k=m[S];y=new Na(k.length);f=0;for(i=k.length-1;f<i;f+=2){x=k[f+1];var t=la(1,Ga(0,0.5-Ra(Fa(Wa+Oa*k[f]/180))/ma/2));x={x:(x/360+0.5)*pa<<0,y:t*pa<<0};y[f]=x.x;y[f+1]=x.y}y=wa(y);if(!(y.length<8)){i=[];i[S]=y;i[ya]=N(y);i[R]=la(m[R]>>z,ra);i[M]=G;i[ia]=d;i[ca]=m[ca];i[aa]=[];for(f=0;f<3;f++)if(i[ca][f])i[aa][f]=i[ca][f].adjustAlpha(T)+
"";b.push(i)}}}return b}function H(a,d){if(typeof a==="object")I(a,!d);else{var b=xa.documentElement,c=xa.createElement("script");n.jsonpCallback=function(h){delete n.jsonpCallback;b.removeChild(c);I(h,!d)};b.insertBefore(c,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function P(a,d,b){if(b===undefined)b=[];var c,h,f,i=a[0]?a:a.features,m,k,x,G,y,z=d?1:0,t=d?0:1;if(i){c=0;for(a=i.length;c<a;c++)P(i[c],d,b);return b}if(a.type==="Feature"){m=a.geometry;c=a.properties}if(m.type==="Polygon")k=
[m.coordinates];if(m.type==="MultiPolygon")k=m.coordinates;if(k){d=c.height;if(c.color||c.wallColor)G=Q.parse(c.color||c.wallColor);if(c.roofColor)y=Q.parse(c.roofColor);c=0;for(a=k.length;c<a;c++){i=k[c][0];x=[];h=m=0;for(f=i.length;h<f;h++){x.push(i[h][z],i[h][t]);m+=d||i[h][2]||0}if(m){h=[];f=S;var u=void 0,v=void 0,J=void 0,X=void 0,sa=0,Y=void 0,Pa=void 0;Y=0;for(Pa=x.length-3;Y<Pa;Y+=2){u=x[Y];v=x[Y+1];J=x[Y+2];X=x[Y+3];sa+=u*X-J*v}if((sa/2>0?"CW":"CCW")==="CW")x=x;else{u=[];for(v=x.length-
2;v>=0;v-=2)u.push(x[v],x[v+1]);x=u}h[f]=x;h[R]=m/i.length<<0;h[ca]=[G||null,G?G.adjustLightness(0.8):null,y?y:G?G.adjustLightness(1.2):ja];b.push(h)}}}return b}function I(a,d){if(a){ta=P(a,d);qa=0;Z(O);E={n:90,w:-180,s:-90,e:180,x:0,y:0,z:O};B=C(ta,true);W()}else{ta=null;D()}}function Z(a){var d,b,c;O=a;pa=Ya<<O;T=1-g(O,qa,Ja,0,0.3);Ka=ea.adjustAlpha(T)+"";Aa=Ba.adjustAlpha(T)+"";Ca=ja.adjustAlpha(T)+"";fa.setAlpha(T);if(B){a=0;for(d=B.length;a<d;a++){c=B[a];c[aa]=[];for(b=0;b<3;b++)if(c[ca][b])c[aa][b]=
c[ca][b].adjustAlpha(T)+""}}}function W(){clearInterval(La);ga=0;La=setInterval(function(){ga+=0.1;if(ga>1){clearInterval(La);ga=1;for(var a=0,d=B.length;a<d;a++)B[a][ia]=0}fa.render();D()},33)}function D(){U.clearRect(0,0,w,s);if(E&&B)if(!(O<qa||Da)){var a,d,b,c,h,f,i,m,k,x=F-E.x,G=da-E.y,y=[ua+x,va+G],z,t,u,v,J,X;B.sort(function(sa,Y){return K(Y[ya],y)/Y[R]-K(sa[ya],y)/sa[R]});a=0;for(d=B.length;a<d;a++){h=B[a];t=false;f=h[S];z=[];b=0;for(c=f.length-1;b<c;b+=2){z[b]=m=f[b]-x;z[b+1]=k=f[b+1]-G;t||
(t=m>0&&m<w&&k>0&&k<s)}if(t){b=h[ia]?h[R]*ga:h[R];f=ka/(ka-b);if(h[M]){b=h[ia]?h[M]*ga:h[M];i=ka/(ka-b)}m=[];b=0;for(c=z.length-3;b<c;b+=2){k=z[b];u=z[b+1];t=z[b+2];v=z[b+3];J=$(k,u,f);X=$(t,v,f);if(h[M]){u=$(k,u,i);v=$(t,v,i);k=u.x;u=u.y;t=v.x;v=v.y}if((t-k)*(J.y-u)>(J.x-k)*(v-u)){U.fillStyle=k<t&&u<v||k>t&&u>v?h[aa][1]||Aa:h[aa][0]||Ka;ha([t,v,k,u,J.x,J.y,X.x,X.y])}m[b]=J.x;m[b+1]=J.y}U.fillStyle=h[aa][2]||Ca;U.strokeStyle=h[aa][1]||Aa;ha(m,true)}}}}function ha(a,d){if(a.length){U.beginPath();U.moveTo(a[0],
a[1]);for(var b=2,c=a.length;b<c;b+=2)U.lineTo(a[b],a[b+1]);U.closePath();d&&U.stroke();U.fill()}}function $(a,d,b){return{x:(a-ua)*b+ua<<0,y:(d-va)*b+va<<0}}var w=0,s=0,A=0,L=0,F=0,da=0,O,pa,za,V,Ea,U,Ia,ea=new Q(200,190,180),Ba=ea.adjustLightness(0.8),ja=ea.adjustLightness(1.2),Ka=ea+"",Aa=Ba+"",Ca=ja+"",ta,E,B,ga=1,La,T=1,qa=Ha,Ja=20,ra,ua,va,ka,Da,fa={enabled:true,canvas:null,context:null,color:new Q(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.canvas=
q(a);this.context=this.canvas.getContext("2d")},render:function(){var a=this.context;a.clearRect(0,0,w,s);console.log("length:",this.length);if(this.enabled)if(E&&B)if(!(O<qa||Da))if(this.length){var d,b,c,h,f,i,m,k,x=F-E.x,G=da-E.y,y,z,t,u,v,J,X=[];a.beginPath();d=0;for(b=B.length;d<b;d++){f=B[d];z=false;i=f[S];y=[];c=0;for(h=i.length-1;c<h;c+=2){y[c]=m=i[c]-x;y[c+1]=k=i[c+1]-G;z||(z=m>0&&m<w&&k>0&&k<s)}if(z){i=f[ia]?f[R]*ga:f[R];if(f[M])i=f[ia]?f[M]*ga:f[M];m=null;c=0;for(h=y.length-3;c<h;c+=2){k=
y[c];t=y[c+1];z=y[c+2];u=y[c+3];v=this.project(k,t,i);J=this.project(z,u,i);if(f[M]){t=this.project(k,t,i);u=this.project(z,u,i);k=t.x;t=t.y;z=u.x;u=u.y}if((z-k)*(v.y-t)>(v.x-k)*(u-t)){m===1&&a.lineTo(k,t);m=0;c||a.moveTo(k,t);a.lineTo(z,u)}else{m===0&&a.lineTo(v.x,v.y);m=1;c||a.moveTo(v.x,v.y);a.lineTo(J.x,J.y)}}a.closePath();X.push(y)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(b=X.length;d<b;d++){f=X[d];a.moveTo(f[0],f[1]);c=2;for(h=f.length;c<
h;c+=2)a.lineTo(f[c],f[c+1]);a.lineTo(f[0],f[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,d,b){return{x:a+this.directionX*b,y:d+this.directionY*b}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=r(F+A,da+L);a=Va(a,d.latitude,d.longitude);if(a.altitude<=0){this.length=0;this.alpha=g(-a.altitude,0,1,0.2,0.7)}else{this.length=
1/Fa(a.altitude);this.alpha=0.4/this.length;this.directionX=Ta(a.azimuth)*this.length;this.directionY=Sa(a.azimuth)*this.length}this.color.a=this.alpha;this.colorStr=this.color+"";this.render()},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d},destroy:function(){this.canvas.parentNode.removeChild(this.canvas)}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ea=Q.parse(a.color||a.wallColor);Ka=ea.adjustAlpha(T)+"";Ba=ea.adjustLightness(0.8);Aa=Ba.adjustAlpha(T)+"";ja=
ea.adjustLightness(1.2);Ca=ja.adjustAlpha(T)+""}if(a.roofColor){ja=Q.parse(a.roofColor);Ca=ja.adjustAlpha(T)+""}a.shadows!==undefined&&fa.setEnabled(a.shadows);D();return this};this.geoJSON=function(a,d){H(a,d);return this};this.setCamOffset=function(a,d){ua=A+a;va=s+d};this.setMaxZoom=function(a){Ja=a};this.setDate=function(a){fa.setDate(a);return this};this.createContainer=function(a){V=xa.createElement("DIV");V.style.pointerEvents="none";V.style.position="absolute";V.style.left=0;V.style.top=0;
fa.init(V);Ea=q(V);U=Ea.getContext("2d");a.appendChild(V);return V};this.destroyContainer=function(){V.parentNode.removeChild(V)};this.loadData=p;this.onMoveEnd=function(){var a=r(F,da),d=r(F+w,da+s);fa.render();D();if(E&&(a[na]>E.n||a[oa]<E.w||d[na]<E.s||d[oa]>E.e))p()};this.onZoomEnd=function(a){Da=false;Z(a.zoom);if(ta){B=C(ta);D()}else{D();p()}};this.onZoomStart=function(){Da=true;fa.render();D()};this.setOrigin=function(a,d){F=a;da=d};this.setSize=function(a,d){w=a;s=d;A=w/2<<0;L=s/2<<0;ua=A;
va=s;ka=w/1.5/Fa(45)<<0;fa.setSize(w,s);Ea.width=w;Ea.height=s;ra=ka-50};this.setZoom=Z;this.render=D;Ia=l};n.OSMBuildings.VERSION="0.1.8a";n.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(n){n=n||{};n.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,n)},setOrigin:function(){var n=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),K=this.map.resolution,N=this.maxExtent;this.osmb.setOrigin(Math.round((n.lon-N.left)/K),Math.round((N.top-
n.lat)/K))},setMap:function(n){if(!this.map){OpenLayers.Layer.prototype.setMap(n);this.osmb=new OSMBuildings(this.options.url);this.osmb.createContainer(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(n){this.osmb.destroyContainer();this.osmb=null;OpenLayers.Layer.prototype.removeMap(n)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(n,K,N){n=OpenLayers.Layer.prototype.moveTo(n,K,N);if(!N){N=parseInt(this.map.layerContainerDiv.style.left,10);var wa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-N+"px";this.div.style.top=-wa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);K?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return n},moveByPx:function(n,K){this.dxSum+=n;this.dySum+=K;var N=OpenLayers.Layer.prototype.moveByPx(n,K);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return N},geoJSON:function(n,K){return this.osmb.geoJSON(n,K)},setStyle:function(n){return this.osmb.setStyle(n)},setDate:function(n){return this.osmb.setDate(n)}});
