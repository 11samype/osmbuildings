(function(o){function L(m,u){var x=m[0]-u[0],g=m[1]-u[1];return x*x+g*g}function Q(m){for(var u=0,x=0,g=0,i=m.length-3;g<i;g+=2){u+=m[g];x+=m[g+1]}m=(m.length-2)*2;return[u/m<<0,x/m<<0]}function Aa(m){var u=m.length/2,x=new Na(u),g=0,i=u-1,k,s,p,D,J=[],S=[],K=[];for(x[g]=x[i]=1;i;){s=0;for(k=g+1;k<i;k++){p=m[k*2];var aa=m[k*2+1],X=m[g*2],F=m[g*2+1],ja=m[i*2],Y=m[i*2+1],y=ja-X,q=Y-F,A=void 0;if(y!==0||q!==0){A=((p-X)*y+(aa-F)*q)/(y*y+q*q);if(A>1){X=ja;F=Y}else if(A>0){X+=y*A;F+=q*A}}y=p-X;q=aa-F;p=
y*y+q*q;if(p>s){D=k;s=p}}if(s>2){x[D]=1;J.push(g);S.push(D);J.push(D);S.push(i)}g=J.pop();i=S.pop()}for(k=0;k<u;k++)x[k]&&K.push(m[k*2],m[k*2+1]);return K}var Oa=Oa||Array,Na=Na||Array,da=Math,Ra=da.exp,Sa=da.log,Ta=da.sin,Ua=da.cos,Ha=da.tan,Va=da.atan,oa=da.min,Ia=da.max,Ba=o.document,T=function(){function m(g,i,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return g+(i-g)*6*k;if(k<0.5)return i;if(k<2/3)return g+(i-g)*(2/3-k)*6;return g}function u(g,i,k,s){this.r=g;this.g=i;this.b=k;this.a=arguments.length<
4?1:s}var x=u.prototype;x.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};x.adjustLightness=function(g){var i=T.toHSLA(this);i.l*=g;i.l=Math.min(1,Math.max(0,i.l));var k,s;if(i.s===0)g=k=s=i.l;else{s=i.l<0.5?i.l*(1+i.s):i.l+i.s-i.l*i.s;var p=2*i.l-s;g=m(p,s,i.h+1/3);k=m(p,s,i.h);s=m(p,s,i.h-1/3)}return new T(g*255<<0,k*255<<0,s*255<<0,i.a)};x.adjustAlpha=function(g){return new T(this.r,this.g,this.b,this.a*g)};u.parse=function(g){g+="";if(~g.indexOf("#")){g=
g.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new T(parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16),g[4]?parseInt(g[4],16)/255:1)}if(g=g.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new T(parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10),g[4]?parseFloat(g[5],10):1)};u.toHSLA=function(g){var i=g.r/255,k=g.g/255,s=g.b/255,p=Math.max(i,k,s),D=Math.min(i,k,s),J,S=(p+D)/2,K;if(p===D)J=D=0;else{K=p-D;D=S>0.5?K/(2-p-D):K/(p+D);switch(p){case i:J=(k-s)/K+(k<s?6:0);break;case k:J=
(s-i)/K+2;break;case s:J=(i-k)/K+4;break}J/=6}return{h:J,s:D,l:S,a:g.a}};return u}(),Wa=function(){var m=Math,u=m.sin,x=m.cos,g=m.tan,i=m.asin,k=m.atan2,s=m.PI,p=180/s,D=357.5291/p,J=0.98560028/p,S=1.9148/p,K=0.02/p,aa=3.0E-4/p,X=102.9372/p,F=23.45/p,ja=280.16/p,Y=360.9856235/p;return function(y,q,A){A=-A/p;q=q/p;y=y.valueOf()/864E5-0.5+2440588;var M=D+J*(y-2451545),G=S*u(M)+K*u(2*M)+aa*u(3*M);G=M+X+G+s;M=i(u(G)*u(F));G=k(u(G)*x(F),x(G));A=ja+Y*(y-2451545)-A-G;return{altitude:i(u(q)*u(M)+x(q)*x(M)*
x(A)),azimuth:k(u(A),x(A)*u(q)-g(M)*x(q))-s/2}}}(),pa=Math.PI,Pa=pa/2,Xa=pa/4,Ya=180/pa,Za=256,Ja=14,qa="latitude",ra="longitude",I=0,N=1,R=2,ea=3,Ca=4,ka=5,U=6;o.OSMBuildings=function(m){function u(a){var d=Ba.createElement("CANVAS");d.style.webkitTransform="translate3d(0,0,0)";d.style.imageRendering="optimizeSpeed";d.style.position="absolute";d.style.left=0;d.style.top=0;a.appendChild(d);a=d.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=false}catch(c){}return d}
function x(a,d){var c={};a/=sa;d/=sa;c[qa]=d<=0?90:d>=1?-90:Ya*(2*Va(Ra(pa*(1-2*d)))-Pa);c[ra]=(a===1?1:(a%1+1)%1)*360-180;return c}function g(a,d){return a.replace(/\{ *([\w_]+) *\}/g,function(c,b){return d[b]})}function i(a,d,c,b,h){a=oa(Ia(a,d),c);return oa(Ia(b+(a-d)/(c-d)*(h-b),b),h)}function k(a,d){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState===4)!c.status||c.status<200||c.status>299||c.responseText&&d(JSON.parse(c.responseText))};c.open("GET",a);c.send(null);return c}
function s(){if(!(!Ka||O<Ja)){var a=x(G-A,ba-M),d=x(G+y+A,ba+q+M);Da&&Da.abort();Da=k(g(Ka,{w:a[ra],n:a[qa],e:d[ra],s:d[qa],z:O}),p)}}function p(a){var d,c,b,h=[],e,f=e=0;ma=Ja;aa(O);Da=null;if(!(!a||a.meta.z!==O)){b=a.meta;c=a.data;if(B&&z&&B.z===b.z){e=B.x-b.x;f=B.y-b.y;a=0;for(d=z.length;a<d;a++)h[a]=z[a][R][0]+e+","+(z[a][R][1]+f)}B=b;z=[];a=0;for(d=c.length;a<d;a++){b=[];if(!(c[a][N]>ta)){e=Aa(c[a][R]);if(!(e.length<8)){b[R]=e;b[Ca]=Q(e);b[I]=oa(c[a][I],ta);b[N]=c[a][N];e=b[R][0]+","+b[R][1];
b[ka]=!(h&&~h.indexOf(e));b[ea]=[];b[U]=[];z.push(b)}}}X()}}function D(a,d){var c=[],b,h,e,f,l,j,v,H,C,r=La-O;b=0;for(h=a.length;b<h;b++){l=a[b];H=l[N]>>r;if(!(H>ta)){j=l[R];C=new Oa(j.length);e=0;for(f=j.length-1;e<f;e+=2){v=j[e+1];var n=oa(1,Ia(0,0.5-Sa(Ha(Xa+Pa*j[e]/180))/pa/2));v={x:(v/360+0.5)*sa<<0,y:n*sa<<0};C[e]=v.x;C[e+1]=v.y}C=Aa(C);if(!(C.length<8)){f=[];f[R]=C;f[Ca]=Q(C);f[I]=oa(l[I]>>r,ta);f[N]=H;f[ka]=d;f[ea]=l[ea];f[U]=[];for(e=0;e<3;e++)if(f[ea][e])f[U][e]=f[ea][e].adjustAlpha(V)+
"";c.push(f)}}}return c}function J(a,d){if(typeof a==="object")K(a,!d);else{var c=Ba.documentElement,b=Ba.createElement("script");o.jsonpCallback=function(h){delete o.jsonpCallback;c.removeChild(b);K(h,!d)};c.insertBefore(b,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function S(a,d,c){if(c===undefined)c=[];var b,h,e,f=a[0]?a:a.features,l,j,v,H,C,r=d?1:0,n=d?0:1;if(f){b=0;for(a=f.length;b<a;b++)S(f[b],d,c);return c}if(a.type==="Feature"){l=a.geometry;b=a.properties}if(l.type==="Polygon")j=
[l.coordinates];if(l.type==="MultiPolygon")j=l.coordinates;if(j){d=b.height;if(b.color||b.wallColor)H=T.parse(b.color||b.wallColor);if(b.roofColor)C=T.parse(b.roofColor);b=0;for(a=j.length;b<a;b++){f=j[b][0];v=[];h=l=0;for(e=f.length;h<e;h++){v.push(f[h][r],f[h][n]);l+=d||f[h][2]||0}if(l){h=[];e=R;var t=void 0,w=void 0,E=void 0,Z=void 0,ca=0,P=void 0,Qa=void 0;P=0;for(Qa=v.length-3;P<Qa;P+=2){t=v[P];w=v[P+1];E=v[P+2];Z=v[P+3];ca+=t*Z-E*w}if((ca/2>0?"CW":"CCW")==="CW")v=v;else{t=[];for(w=v.length-
2;w>=0;w-=2)t.push(v[w],v[w+1]);v=t}h[e]=v;h[I]=l/f.length<<0;h[ea]=[H||null,H?H.adjustLightness(0.8):null,C?C:H?H.adjustLightness(1.2):la];c.push(h)}}}return c}function K(a,d){if(a){ua=S(a,d);ma=0;aa(O);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:O};z=D(ua,true);X()}else{ua=null;F()}}function aa(a){var d,c,b;O=a;sa=Za<<O;V=1-i(O,ma,La,0,0.4);Ea=fa.adjustAlpha(V)+"";va=Fa.adjustAlpha(V)+"";wa=la.adjustAlpha(V)+"";ga.setAlpha(V);if(z){a=0;for(d=z.length;a<d;a++){b=z[a];b[U]=[];for(c=0;c<3;c++)if(b[ea][c])b[U][c]=
b[ea][c].adjustAlpha(V)+""}}}function X(){clearInterval(Ma);ha=0;Ma=setInterval(function(){ha+=0.1;if(ha>1){clearInterval(Ma);ha=1;for(var a=0,d=z.length;a<d;a++)z[a][ka]=0}ga.render();F()},33)}function F(){W.clearRect(0,0,y,q);na.render();if(!(!B||!z||O<ma||xa)){var a,d,c,b,h,e,f,l,j,v=G-B.x,H=ba-B.y,C=[ya+v,za+H],r,n,t,w,E,Z;z.sort(function(ca,P){return L(P[Ca],C)/P[I]-L(ca[Ca],C)/ca[I]});a=0;for(d=z.length;a<d;a++){h=z[a];if(!(h[I]<=na.maxHeight)){n=false;e=h[R];r=[];c=0;for(b=e.length-1;c<b;c+=
2){r[c]=l=e[c]-v;r[c+1]=j=e[c+1]-H;n||(n=l>0&&l<y&&j>0&&j<q)}if(n){c=h[ka]?h[I]*ha:h[I];e=ia/(ia-c);if(h[N]){c=h[ka]?h[N]*ha:h[N];f=ia/(ia-c)}l=[];c=0;for(b=r.length-3;c<b;c+=2){j=r[c];t=r[c+1];n=r[c+2];w=r[c+3];E=Y(j,t,e);Z=Y(n,w,e);if(h[N]){t=Y(j,t,f);w=Y(n,w,f);j=t.x;t=t.y;n=w.x;w=w.y}if((n-j)*(E.y-t)>(E.x-j)*(w-t)){W.fillStyle=j<n&&t<w||j>n&&t>w?h[U][1]||va:h[U][0]||Ea;ja([n,w,j,t,E.x,E.y,Z.x,Z.y])}l[c]=E.x;l[c+1]=E.y}W.fillStyle=h[U][2]||wa;W.strokeStyle=h[U][1]||va;ja(l,true)}}}}}function ja(a,
d){if(a.length){W.beginPath();W.moveTo(a[0],a[1]);for(var c=2,b=a.length;c<b;c+=2)W.lineTo(a[c],a[c+1]);W.closePath();d&&W.stroke();W.fill()}}function Y(a,d,c){return{x:(a-ya)*c+ya<<0,y:(d-za)*c+za<<0}}var y=0,q=0,A=0,M=0,G=0,ba=0,O,sa,Da,$,Ga,W,Ka,fa=new T(200,190,180),Fa=fa.adjustLightness(0.8),la=fa.adjustLightness(1.2),Ea=fa+"",va=Fa+"",wa=la+"",ua,B,z,ha=1,Ma,V=1,ma=Ja,La=20,ta,ya,za,ia,xa,ga={enabled:true,canvas:null,context:null,color:new T(0,0,0),colorStr:this.color+"",alpha:1,length:0,directionX:0,
directionY:0,init:function(a){this.canvas=u(a);this.context=this.canvas.getContext("2d")},render:function(){var a=this.context;a.clearRect(0,0,y,q);if(!(!this.enabled||!B||!z||O<ma||xa||!this.length)){var d,c,b,h,e,f,l,j,v=G-B.x,H=ba-B.y,C=na.maxHeight,r,n,t,w,E,Z,ca=[],P=[];a.beginPath();d=0;for(c=z.length;d<c;d++){e=z[d];n=false;f=e[R];r=[];b=0;for(h=f.length-1;b<h;b+=2){r[b]=l=f[b]-v;r[b+1]=j=f[b+1]-H;n||(n=l>0&&l<y&&j>0&&j<q)}if(n){f=e[ka]&&e[I]>C?e[I]*ha:e[I];if(e[N])f=e[ka]?e[N]*ha:e[N];l=null;
b=0;for(h=r.length-3;b<h;b+=2){j=r[b];t=r[b+1];n=r[b+2];w=r[b+3];E=this.project(j,t,f);Z=this.project(n,w,f);if(e[N]){t=this.project(j,t,f);w=this.project(n,w,f);j=t.x;t=t.y;n=w.x;w=w.y}if((n-j)*(E.y-t)>(E.x-j)*(w-t)){l===1&&a.lineTo(j,t);l=0;b||a.moveTo(j,t);a.lineTo(n,w)}else{l===0&&a.lineTo(E.x,E.y);l=1;b||a.moveTo(E.x,E.y);a.lineTo(Z.x,Z.y)}}a.closePath();e[I]>C?ca.push(r):P.push(r)}}a.fillStyle=this.colorStr;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=ca.length;d<
c;d++){e=ca[d];a.moveTo(e[0],e[1]);b=2;for(h=e.length;b<h;b+=2)a.lineTo(e[b],e[b+1]);a.lineTo(e[0],e[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over";na.renderWalls(a,P)}},project:function(a,d,c){return{x:a+this.directionX*c,y:d+this.directionY*c}},setAlpha:function(a){this.colorStr=this.color.adjustAlpha(a)+"";this.render()},setEnabled:function(a){this.enabled=!!a;this.render()},setDate:function(a){var d=x(G+A,ba+M);a=Wa(a,d.latitude,d.longitude);if(a.altitude<=
0){this.length=0;this.alpha=i(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Ha(a.altitude);this.alpha=0.4/this.length;this.directionX=Ua(a.azimuth)*this.length;this.directionY=Ta(a.azimuth)*this.length}this.color.a=this.alpha;this.colorStr=this.color+"";this.render()},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d}},na={enabled:true,canvas:null,context:null,maxHeight:8,init:function(a){this.canvas=u(a);this.canvas.id="flat";this.context=this.canvas.getContext("2d")},render:function(){var a=
this.context;a.clearRect(0,0,y,q);if(!(!this.enabled||!B||!z||O<ma||xa)){var d,c,b,h,e,f,l,j,v,H=G-B.x,C=ba-B.y,r,n;l=ia/(ia-this.maxHeight);a.beginPath();d=0;for(c=z.length;d<c;d++){e=z[d];if(!(e[I]>this.maxHeight)){n=false;f=e[R];r=[];b=0;for(h=f.length-1;b<h;b+=2){r[b]=j=f[b]-H;r[b+1]=v=f[b+1]-C;n||(n=j>0&&j<y&&v>0&&v<q)}if(n){b=0;for(h=r.length-3;b<h;b+=2){f=r[b];j=r[b+1];f=Y(f,j,l);b?a.lineTo(f.x,f.y):a.moveTo(f.x,f.y)}a.closePath()}}}a.fillStyle=e[U][2]||wa;a.strokeStyle=e[U][1]||va;a.stroke();
a.fill()}},renderWalls:function(a,d){if(this.enabled){var c,b,h,e,f;a.beginPath();b=0;for(h=d.length;b<h;b++){c=d[b];a.moveTo(c[0],c[1]);e=2;for(f=c.length;e<f;e+=2)a.lineTo(c[e],c[e+1]);a.lineTo(c[0],c[1]);a.closePath()}a.fillStyle=Ea;a.fill()}},setSize:function(a,d){this.canvas.width=a;this.canvas.height=d}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){fa=T.parse(a.color||a.wallColor);Ea=fa.adjustAlpha(V)+"";Fa=fa.adjustLightness(0.8);va=Fa.adjustAlpha(V)+"";la=fa.adjustLightness(1.2);
wa=la.adjustAlpha(V)+""}if(a.roofColor){la=T.parse(a.roofColor);wa=la.adjustAlpha(V)+""}a.shadows!==undefined&&ga.setEnabled(a.shadows);F();return this};this.geoJSON=function(a,d){J(a,d);return this};this.setCamOffset=function(a,d){ya=A+a;za=q+d};this.setMaxZoom=function(a){La=a};this.setDate=function(a){ga.setDate(a);return this};this.appendTo=function(a){$=Ba.createElement("DIV");$.style.pointerEvents="none";$.style.position="absolute";$.style.left=0;$.style.top=0;ga.init($);na.init($);Ga=u($);
W=Ga.getContext("2d");a.appendChild($);return $};this.loadData=s;this.onMoveEnd=function(){var a=x(G,ba),d=x(G+y,ba+q);ga.render();F();if(B&&(a[qa]>B.n||a[ra]<B.w||d[qa]<B.s||d[ra]>B.e))s()};this.onZoomEnd=function(a){xa=false;aa(a.zoom);if(ua){z=D(ua);F()}else{F();s()}};this.onZoomStart=function(){xa=true;ga.render();F()};this.setOrigin=function(a,d){G=a;ba=d};this.setSize=function(a,d){y=a;q=d;A=y/2<<0;M=q/2<<0;ya=A;za=q;ia=y/1.5/Ha(45)<<0;ga.setSize(y,q);na.setSize(y,q);Ga.width=y;Ga.height=q;
ta=ia-50};this.setZoom=aa;this.render=F;Ka=m};o.OSMBuildings.VERSION="0.1.8a";o.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(o){o=o||{};o.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,o)},setOrigin:function(){var o=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),L=this.map.resolution,Q=this.maxExtent;this.osmb.setOrigin(Math.round((o.lon-Q.left)/L),Math.round((Q.top-
o.lat)/L))},setMap:function(o){this.map||OpenLayers.Layer.prototype.setMap(o);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(o){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(o)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(o,L,Q){o=OpenLayers.Layer.prototype.moveTo(o,L,Q);if(!Q){Q=parseInt(this.map.layerContainerDiv.style.left,10);var Aa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-Q+"px";this.div.style.top=-Aa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);L?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return o},moveByPx:function(o,L){this.dxSum+=o;this.dySum+=L;var Q=OpenLayers.Layer.prototype.moveByPx(o,
L);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return Q},geoJSON:function(o,L){return this.osmb.geoJSON(o,L)},setStyle:function(o){return this.osmb.setStyle(o)},setDate:function(o){return this.osmb.setDate(o)}});
